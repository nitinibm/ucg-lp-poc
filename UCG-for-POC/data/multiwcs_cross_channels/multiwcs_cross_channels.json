[{"id":"72cea9e2.279df","type":"tab","label":"State-farm","disabled":false,"info":""},{"id":"178b1591.56303a","type":"tab","label":"GoogleDialogFlow","disabled":false,"info":""},{"id":"453809ed.2e486","type":"tab","label":"WA-Calls-token-sdk-http","disabled":false,"info":""},{"id":"65dbf2c8.fdf124","type":"tab","label":"Populate Router Workspace","disabled":false,"info":""},{"id":"35062497.981924","type":"tab","label":"Smooch-flow-Router-WCS","disabled":false,"info":""},{"id":"b6773c98.30a0f","type":"tab","label":"Multiple-WCS-NLC","disabled":false,"info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-   \n\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"   \n   c) WorkspaceTag - must not include include blanks   \n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTagThe flow assumes, \n      all Workspaces are listed under Setup Workspace and those will be used, \n      to create training data set. \n      There is no limit on number of workspaces which can be included under \n      Setup Workspace, as long as above rules are followed. \n      In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS-NLC\"; if this     \n      needs to have different name, then pl. remember to update name in    \n      'get-ready' node.    \n\n2) The flow needs to NLC classifer ID, which can also be defined in   \n   setup workspace with special intent as 'NLC_Classifier_ID' and example    \n   will have NLC traning set value. The flow will update NLC Classifer ID in    \n   example, once generated.       T\n   The flow will delete existing NLC Classifer, before running   new training set.  \n\n3) The flow also assumes, all workspaces have same set of   credentials and are defined in 'get-ready' node. The flow, can be    modified to pickup credentials from SOE Environment file.   "},{"id":"832c3c55.8de598","type":"tab","label":"Smooch Flow-Multiple-WCS","disabled":true,"info":""},{"id":"b6f9906e.c78c18","type":"tab","label":"Multiple-WCS-NLC-bak","disabled":true,"info":""},{"id":"cb130c7a.1c52d8","type":"tab","label":"Create-NLC-Training-Set","disabled":true,"info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"\n   c) WorkspaceTag - must not include include blanks\n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTag\n\nThe flow assumes, all Workspaces are listed under Setup Workspace and \nthose will be used, to create training data set. There is no limit on \nnumber of workspaces which can be included under Setup Workspace, \nas long as above rules are followed.\n   \n    In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS\"; if this \n    needs to have different name, then pl. remember to update name in\n    'get-ready' node.\n    \n\n2) The flow needs to NLC classifer ID, which can also be defined in\n   setup workspace with special intent as 'NLC_Classifier_ID' and example \n   will have NLC traning set value. The flow will update NLC Classifer ID in \n   example, once generated. \n   \n   The flow will delete existing NLC Classifer, before running\n   new training set.  \n\n3) The flow also assumes, all workspaces have same set of\n   credentials and are defined in 'get-ready' node. The flow, can be \n   modified to pickup credentials from SOE Environment file.\n   \n"},{"id":"f3565267.58f28","type":"tab","label":"Create-NLC-WorkArea","disabled":true,"info":""},{"id":"bb7facc8.aee828","type":"tab","label":"Flow 1","disabled":true,"info":""},{"id":"ff67537b.e2624","type":"tab","label":"Load","disabled":false,"info":""},{"id":"401cee62.babb8","type":"tab","label":"Mobile","disabled":false,"info":""},{"id":"9f54b786.c40c38","type":"tab","label":"Alexa","disabled":false,"info":""},{"id":"8a20faf1.e98998","type":"tab","label":"Slack","disabled":false},{"id":"724cdd96.923cdc","type":"tab","label":"Smooch","disabled":false},{"id":"fabc60c3.885ec8","type":"tab","label":"GoogleHome","disabled":false},{"id":"813a4efe.8f8558","type":"tab","label":"GoogleHomeV2","disabled":false,"info":""},{"id":"e3247ffc.0f34","type":"tab","label":"SIP","disabled":false,"info":""},{"id":"c6a09361.94c2b","type":"tab","label":"LivePerson","disabled":false,"info":""},{"id":"ebe88beb.81da2","type":"tab","label":"TwilioSMS","disabled":false},{"id":"8183a83c.27793","type":"tab","label":"MSSQL","disabled":false},{"id":"68b0d95d.ae26b8","type":"tab","label":"Discovery","disabled":true,"info":""},{"id":"22659eb7.a53b82","type":"tab","label":"General","disabled":false},{"id":"251a792.3f5ec06","type":"tab","label":"FD-SIP","disabled":false,"info":""},{"id":"a434a319.cafa2","type":"tab","label":"USPS","disabled":true,"info":""},{"id":"d8b750b4.55a42","type":"tab","label":"Flow 2","disabled":false,"info":""},{"id":"440e09de.708d78","type":"subflow","name":"Get Redis Session","info":"","in":[{"x":33.48760986328125,"y":71.6234130859375,"wires":[{"id":"10e14f30.833389"}]}],"out":[{"x":789.051643371582,"y":74.23785018920898,"wires":[{"id":"42344d59.a7b4b4","port":0}]}]},{"id":"3875b180.c934ee","type":"subflow","name":"Set NodeRed Session","info":"","in":[{"x":53.5,"y":55,"wires":[{"id":"5224d9c7.26b42"}]}],"out":[]},{"id":"3c4552a3.b77ad6","type":"subflow","name":"Set Cloundant Session","info":"","in":[{"x":35,"y":46,"wires":[{"id":"57c7b107.17d028"}]}],"out":[]},{"id":"13cf4536.6ed6fb","type":"subflow","name":"Set Redis Session","info":"","in":[{"x":51.76470947265625,"y":56.88235092163086,"wires":[{"id":"f5486872.e3dce"}]}],"out":[]},{"id":"a39d88cb.3e3638","type":"subflow","name":"Set Session","info":"","in":[{"x":64.9444580078125,"y":40.222259521484375,"wires":[{"id":"5c99b9fa.0aae08"}]}],"out":[{"x":384.9444580078125,"y":40.222259521484375,"wires":[{"id":"5c99b9fa.0aae08","port":0}]}]},{"id":"4fb1364d.094cf8","type":"subflow","name":"Get NodeRed Session","info":"","in":[{"x":65.5,"y":62,"wires":[{"id":"e278a123.79404"}]}],"out":[{"x":365.5,"y":62,"wires":[{"id":"e278a123.79404","port":0}]}]},{"id":"b8bcf4c.143c608","type":"subflow","name":"Get Cloudant Session","info":"","in":[{"x":41,"y":45,"wires":[{"id":"385e652a.bebb42"}]}],"out":[{"x":734,"y":45,"wires":[{"id":"13b1b3fd.bb3b6c","port":0}]}]},{"id":"5e5f60e7.f240c8","type":"subflow","name":"Get Session","info":"","in":[{"x":53.983917236328125,"y":43.61785888671875,"wires":[{"id":"cd98f957.07401"}]}],"out":[{"x":393.9839172363281,"y":43.61785888671875,"wires":[{"id":"cd98f957.07401","port":0}]}]},{"id":"b9f2f318.8796b","type":"subflow","name":"Get Mssql Session","info":"","in":[{"x":43,"y":41,"wires":[{"id":"4497a643.aac0e8"}]}],"out":[{"x":800,"y":41,"wires":[{"id":"27c236ba.867442","port":0}]}]},{"id":"3041e49.e69119c","type":"subflow","name":"Set Mssql Session","info":"","in":[{"x":62,"y":47,"wires":[{"id":"cc8c5102.27289"}]}],"out":[{"x":647,"y":47,"wires":[{"id":"d8a5c56e.de761","port":0}]}]},{"id":"4e8a84dc.f232fc","type":"subflow","name":"Dynamic WCS Router","info":"","in":[{"x":43.499996185302734,"y":37.069942474365234,"wires":[{"id":"772274fc.063df4"},{"id":"50bec6a6.e7d2c"}]}],"out":[{"x":1097.2349081039429,"y":105.98232078552246,"wires":[{"id":"4f4c4043.23b748","port":0}]}]},{"id":"7e2111b.f0b9e7","type":"subflow","name":"Override Workspace","info":"","in":[{"x":60,"y":60,"wires":[{"id":"9b8a1d96.c503a8"}]}],"out":[{"x":340,"y":60,"wires":[{"id":"9b8a1d96.c503a8","port":0}]}]},{"id":"af0dd578.89a848","type":"subflow","name":"Log Error","info":"","in":[{"x":50,"y":30,"wires":[{"id":"2bfac983.53ec26"}]}],"out":[{"x":310.92309951782227,"y":29.692319869995117,"wires":[{"id":"2bfac983.53ec26","port":0}]}]},{"id":"544bc80b.e141f8","type":"subflow","name":"Add Tone","info":"","in":[{"x":36.000003814697266,"y":33.33333396911621,"wires":[{"id":"31e8f876.ee1738"}]}],"out":[{"x":456.00000381469727,"y":33.33333396911621,"wires":[{"id":"561e63d0.6ebbec","port":0}]}]},{"id":"8d1a3e5b.b49e8","type":"subflow","name":"Get Answer","info":"","in":[{"x":47.92173194885254,"y":74.29412078857422,"wires":[{"id":"f2d3f3e6.7021e8"}]}],"out":[{"x":1484.5320510864258,"y":63.48297119140625,"wires":[{"id":"4e66541b.3021ec","port":0},{"id":"d1217ce2.b2b02","port":0},{"id":"ed908b1a.828858","port":0}]}]},{"id":"8cd40462.d0391","type":"subflow","name":"Do Actions","info":"","in":[{"x":52.52941131591797,"y":80.41175842285156,"wires":[{"id":"6edf3a9d.fde9c4"}]}],"out":[{"x":1310,"y":87,"wires":[{"id":"94ec912a.2c973","port":0},{"id":"ea5ced44.44a6","port":1}]}]},{"id":"c14accc6.1cca2","type":"subflow","name":"Check-WCS-Setup","info":"","in":[{"x":100,"y":260,"wires":[{"id":"d82a198.b7a5168"}]}],"out":[{"x":700,"y":300,"wires":[{"id":"f9ff9da2.38272","port":1},{"id":"4ea5e466.97b10c","port":0}]}]},{"id":"9f8a000b.6be7d","type":"subflow","name":"Check-Router-WCS-Setup","info":"","in":[{"x":50,"y":30,"wires":[{"id":"a3369fca.793e58"}]}],"out":[{"x":720,"y":260,"wires":[{"id":"1aa87e9a.9b7721","port":0},{"id":"590a5e85.b8153","port":1}]}]},{"id":"b81ce29e.69f168","type":"twilio-api","z":"","sid":"AC01bb5650b0ed32794375e201a2ed542d","from":"+18442310002","name":""},{"id":"c18e1f49.cc86a8","type":"MSSQL-CN","z":"","name":"ucg-mssql","server":"ucg-mssql.database.windows.net","encyption":true,"database":"ucg"},{"id":"b6af8384.179058","type":"MSSQL-UCG-CN","z":"","name":"","server":"","port":"","encyption":true,"database":""},{"id":"878e13f5.8a2ae8","type":"debug","z":"832c3c55.8de598","name":"Rcvd from Chat","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":158,"y":117,"wires":[]},{"id":"4851550b.a93574","type":"debug","z":"832c3c55.8de598","name":"Input  Message to WCS","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":431.2142105102539,"y":124.4444580078125,"wires":[]},{"id":"d7ddbd6e.705068","type":"http in","z":"832c3c55.8de598","name":"Mobile HTTP in","url":"/smooch<removemetouse>","method":"post","upload":false,"swaggerDoc":"","x":106.21427917480469,"y":267.00000286102295,"wires":[["bc367e04.275b08","878e13f5.8a2ae8","ccf25c59.7f9328"]]},{"id":"1b318053.6c2c1","type":"watson-conversation-v1","z":"832c3c55.8de598","name":"Base Conv","workspaceid":"","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"","x":650,"y":240,"wires":[["ea5c3c86.f84fd8","aaf4fb86.979ea","3dc15dac.09bf42"]]},{"id":"bc367e04.275b08","type":"function","z":"832c3c55.8de598","name":"Set Params ","func":"\nmsg.save_payload = msg.payload;\nnode.error(\"Nak-Incoming Message\");\nnode.error(msg);\n\nvar wcs_0 = \"d58fb5ae-24db-4225-8977-b0a6f7634a10\";\nvar wcs_1 = \"44beeefd-e0e9-4d90-980c-3d2b7de7c516\";\nvar wcs_username = \"d3708ec5-e3d5-420b-a9bd-7e55987146e0\";\nvar wcs_password = \"6QzbimbHOvao\";\n\nvar m_regions_workspace_id = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\nvar m_regions_username = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nvar m_regions_password = \"UplCjXHkuLgj\";\n\nvar m_cur_wcs_id = \"\";\nvar m_wcs_username = \"\";\nvar m_wcs_password = \"\";\n\n\nvar user_glob_var = \"wcs_\" + msg.payload.appUser._id ;\n//node.error(\"NAK user_glob_var ==>[\" + user_glob_var +\"]\");\n\nif (typeof global.get('\"'+user_glob_var+'\"') !== 'undefined' ) {\nvar m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n//node.error(\"Check Global Var: [\" + m_get_wcs_id + \"]\");\n}\nelse {\n       global.set('\"'+user_glob_var+'\"',\"0\");\n       m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       \n}\nvar m_wcs_num = \"\";\n//       node.error(\"Here-0\");\nif (typeof m_get_wcs_id !== 'undefined' ) {\n        m_wcs_num = m_get_wcs_id;\n//        node.error(\"NAK - WCS Num Retrived m_wcs_num : \" + m_wcs_num);\n}        \nelse {\n//       node.error(\"Here-2\");\n        global.set('\"'+user_glob_var+'\"',\"3\");\n        var m_check = global.set('\"'+user_glob_var+'\"');\n        m_wcs_num = m_check;\n//        node.error(\"NAK - WCS Numm Set m_wcs_num : \" + m_wcs_num);\n}\n\n//Set WCS ID \nmsg.curr_wcs_num = m_wcs_num;\nnode.error(\"Current WCS Num being used : [\" + m_wcs_num + \"]\");\nswitch (m_wcs_num) {\n    case \"0\" :\n      m_cur_wcs_id = wcs_0;\n      m_wcs_username = wcs_username;\n      m_wcs_password = wcs_password;\n      break;\n    case \"1\" :\n      m_cur_wcs_id = wcs_1;\n      m_wcs_username = wcs_username;\n      m_wcs_password = wcs_password;\n      break;    \n//    default :\n//      m_cur_wcs_id = m_regions_workspace_id;\n//      m_wcs_username = m_regions_username;\n//      m_wcs_password = m_regions_password;\n}\n\n//node.error(\"NAK-Current Workspace : m_cur_wcs_id ==> \" + m_cur_wcs_id);\n\n//var workspace_id = msg.req.query.workspace_id;\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\n//var user = msg.payload.appUser._id;\n//var input = msg.payload.messages[0].text;\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     user = msg.payload.appUser._id;  \n   }\n}\n\nvar test  = JSON.stringify(msg.payload);\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n\nmsg.app = \"RegionsAssist\";\nvar workspace_id = global.get(\"workspace_id\" + user);\n \n\n\nvar params = {\n//     context: context,\n     workspace_id : m_cur_wcs_id,\n     username: m_wcs_username,\n     password: m_wcs_password\n}\nvar additional_context = {\n    fname: fname,\n    map : map,\n    button: button \n    \n};\n\nif (input.lastIndexOf('/') >= 0 ) {\n     var myindex = input.lastIndexOf('/')\n     node.log(\"index at: \" + myindex)\n     var dateString = input\n     node.log(\"dateString : \" + dateString)\n     \n     var d = new Date(dateString)\n     node.log(\"d : \" + d)\n     var now = new Date()\n     node.log(\"today: \" + now)\n     var years = now.getFullYear() - d.getFullYear()\n     node.log(\"years: \" + years)\n     \n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     node.log(\"days: \" + days)\n     var age = years + days /365\n    \n     additional_context.age = Math.round(age *100)/100\n     node.log(\"age: \"+ context.age)\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     additional_context.ageEOY = Math.round(ageEOY * 100)/100\n     node.log(\"ageEOY: \"+ context.ageEOY)\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     additional_context.ageBOY = Math.round(ageBOY * 100)/100\n     node.log(\"ageBOY: \"+ context.ageBOY)\n}\nmsg.payload = input;\nmsg.params = params;\nmsg.user = user;\n \nmsg.additional_context = additional_context;\n\nif (typeof global.get(\"global_Check_context\") !== 'undefined') {\n    if (global.get(\"global_Check_context\") === \"Yes\" ) {\n//        node.error(\"Set Context Variables from prior dialog\");\n//        node.error(msg);\n        if (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n        }\n        msg.params.context.Root = global.get(\"global_Root\");\n        msg.params.context.Child = global.get(\"global_Child\");\n        global.set(\"global_Check_context\", \"No\");\n        \n    }\n}\nmsg.tmp_Switch_workspace = \"No\"; \nreturn msg;","outputs":1,"noerr":0,"x":410,"y":240,"wires":[["4851550b.a93574","1b318053.6c2c1"]]},{"id":"48226c93.ce7f6c","type":"function","z":"832c3c55.8de598","name":"Response Msg","func":"node.error(\"Inside Response MSG\");\n//node.error(msg);\n\n//if (typeof msg.payload.output.text[0] == 'undefined') {\n//    msg.payload.output.text[0] = \"Sorry I am not trained on this topic yet; try asking some other question\";\n//}\n\nmsg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'     \n};\n\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\n\nif (typeof msg.payload.output.text === 'undefined') {\n    msg.payload.output.text = \"Nitin K\";\n}\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n Newmsg = texts[i]; \n //node.error(\"Newmsg :[\"+ i+\"]\"+Newmsg);\n var component = \"\";\n var mapStr = \"\";\n var actions = {};\n var actionsArr = [];\n var actionsRArr = [];\n var buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n //simple buttons\n if (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n }\n\n //json map\n //var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\n if (typeof Watson_contextOBJ.map != 'undefined') {\n     mapjsonObj = Watson_contextOBJ.map;\n     if (typeof mapjsonObj.values != \"undefined\") {\n        //node.log(\"mapjson: \" + mapjsonStr);\n        //if (mapjsonStr  !== null){\n        component = \"map\";\n        for (var c in mapjsonObj.values) {\n            mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n            actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n        }\n   }\n }\n\n //json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n // Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n //var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\n var found_link = 0;\n //node.log(\"buttonjson: \" + buttonjsonStr);\n if (typeof Watson_contextOBJ.button != 'undefined') {\n    buttonjsonObj = Watson_contextOBJ.button;\n    if (typeof buttonjsonObj.values != \"undefined\") {\n       for (var c in buttonjsonObj.values) {\n           buttonStr = buttonjsonObj.values[c];\n           if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n              found_link = 1;\n              buttonItems = buttonStr.split(\"|\");\n              button_title = buttonItems[0];\n              button_url = buttonItems[1];\n              actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n            }\n            else {\n              button_title = buttonStr;  \n              actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n            }\n        }  \n        if (found_link > 0) {\n           component = \"buttonLink\"; \n        }else {\n           component = \"buttonReply\";   \n        }\n    }\n}\n\n //old maps\n if (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n } \n\n // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n Newmsg = Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n Newmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n// node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Newmsg)\n\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\n\nvar nk_texts = msg.payload.output.text\n\n//if (nk_texts == \"\") {\n//    nk_texts = \"Sorry I am not trained on that topic yet\";\n//}\n\n \nfor (i = 0; i < nk_texts.length; i++) {\n nk_Newmsg = nk_texts[i]; \n //node.error(\"nk_Newmsg :[\"+ i+\"]\"+nk_Newmsg);\n nk_Newmsg = nk_Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n nk_Newmsg = nk_Newmsg.replace(/<[^>]+>/g, \"\");\n switch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : nk_Newmsg,\n        email: \"watson40985@gmail.com\",\n        actions : actionsArr};\n }\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n\n//node.error(\"Response-2\");\n  msg.payload = response;\n//node.error(msg);  \n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n \n }\n}\n//node.error(\"Before sending response\");\n//node.error(msg);\nreturn [null,msg];","outputs":2,"noerr":0,"x":1040,"y":300,"wires":[["4ad07bc8.2383f4","7499c072.f0f96"],["8a45aa80.0734b8"]]},{"id":"8af6d43a.7cc6b","type":"debug","z":"832c3c55.8de598","name":"Response msg payload smooch","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1250,"y":460,"wires":[]},{"id":"9958a188.4cdac8","type":"http request","z":"832c3c55.8de598","name":"","method":"POST","ret":"txt","url":"","tls":"","x":583.7143249511719,"y":680.0000257492065,"wires":[["4497e91f.918bd"]]},{"id":"29690091.2d7de","type":"function","z":"832c3c55.8de598","name":"Send post message","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g'\n     };\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + \"02aaa89716d5b27e3a37aab3\" + \"/messages\";\n\nvar response = {\n    role : \"appMaker\",\n    type : \"text\",\n    text : \"hey what's up!!!\",\n    email: \"watson40985@gmail.com\",\n    //email: \"dennisnoto@gmail.com\",\n    actions : []\n};\n\nmsg.payload = response;\n\nreturn msg;","outputs":1,"noerr":0,"x":348.7143096923828,"y":680.0000066757202,"wires":[["9958a188.4cdac8"]]},{"id":"4497e91f.918bd","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"payload","x":786.7142944335938,"y":678.9999952316284,"wires":[]},{"id":"63d69142.4778d8","type":"inject","z":"832c3c55.8de598","name":"","topic":"go","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":110.71430969238281,"y":685.0000066757202,"wires":[["29690091.2d7de"]]},{"id":"ccf25c59.7f9328","type":"http response","z":"832c3c55.8de598","name":"HTTP-Postback","statusCode":"","headers":{},"x":314.7142791748047,"y":320.00000286102295,"wires":[]},{"id":"4ad07bc8.2383f4","type":"debug","z":"832c3c55.8de598","name":"smooch out of response msg","active":true,"tosidebar":true,"console":false,"complete":"true","x":1340.7142333984375,"y":204,"wires":[]},{"id":"ea5c3c86.f84fd8","type":"debug","z":"832c3c55.8de598","name":"smooch out of convo","active":false,"tosidebar":true,"console":false,"complete":"payload","x":1044.1309814453125,"y":103.86109924316406,"wires":[]},{"id":"5659c9b2.118b78","type":"http in","z":"832c3c55.8de598","name":"Postbacks","url":"/smooch-postback","method":"post","swaggerDoc":"","x":108.71430969238281,"y":376.12502574920654,"wires":[["51d46954.b41ad","ccf25c59.7f9328","e247de65.36e018"]]},{"id":"e247de65.36e018","type":"function","z":"832c3c55.8de598","name":"actionPayload","func":"msg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'\n     };\n\nmsg.user = msg.payload.appUser.userId;\n//msg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\nmsg.actionPayload = msg.payload.postbacks[0].action.payload;\n\nresponse = {\n        role : \"appUser\",\n        type : \"text\",\n        text : msg.actionPayload\n};\n\nmsg.payload = response;\nreturn msg;","outputs":1,"noerr":0,"x":162.9834976196289,"y":468.9999990463257,"wires":[[]]},{"id":"740463ff.d52b04","type":"http request","z":"832c3c55.8de598","name":"HTTPS-2","method":"POST","ret":"txt","url":"","tls":"","x":371.7527160644531,"y":470.4615783691406,"wires":[[]]},{"id":"f445b642.b953e","type":"debug","z":"832c3c55.8de598","name":"GetSession","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":770,"y":60,"wires":[]},{"id":"51d46954.b41ad","type":"debug","z":"832c3c55.8de598","name":"PostBack Messsage","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":328,"y":396,"wires":[]},{"id":"4370609a.e3913","type":"debug","z":"832c3c55.8de598","name":"smooch msg to convo","active":true,"console":"false","complete":"true","x":510.2142791748047,"y":578,"wires":[]},{"id":"a6157fa1.2ff5f8","type":"function","z":"832c3c55.8de598","name":"Prepare Log to write","func":"//fill in log obj\n\nvar currentIntent = \" \";\nvar currentEntity = \" \";\nvar currentConfidence =\"\";\nvar currentInputText =\"\";\nvar currentOutputText =\"\";\nvar startTimeStamp =\"\";\nvar conversationID=\"\";\n\n\nif (msg.payload.context.conversation_id!==undefined){\n    conversationID=msg.payload.context.conversation_id\n}\nif ((msg.payload.intents!==undefined)&&(msg.payload.intents[0]!==undefined)){\n    if (msg.payload.intents[0].intent!==undefined){\n        currentIntent= msg.payload.intents[0].intent\n    }\n    if (msg.payload.intents[0].confidence!==undefined){\n        currentConfidence=msg.payload.intents[0].confidence\n    }\n}\n\nif ((msg.payload.entities!==undefined)&&(msg.payload.entities[0]!==undefined)){\n    if (msg.payload.entities[0].entity!==undefined){\n        currentEntity= msg.payload.entities[0].entity\n    }\n    if (msg.payload.entities[0].confidence!==undefined){\n        currentConfidence=msg.payload.entities[0].confidence\n    }\n}\nif (msg.payload.input.text!==undefined){\n    currentInputText=msg.payload.input.text\n}\nif (msg.payload.output.text!==undefined){\n    currentOutputText=msg.payload.output.text[0]\n}\n\n\nvar date1 = new Date();\n\nvar newLogData= {\n\t dateTimeStamp : date1,\n\t intent : currentIntent,\n\t entity : currentEntity,\n\t confidence : currentConfidence,\n\t inputText : currentInputText,\n     outputText : currentOutputText,\n     conversation_id: conversationID\n\n};\nmsg.payload.LogData = newLogData;\nreturn msg;\n\n\n\n\n","outputs":1,"noerr":0,"x":920,"y":520,"wires":[["a7cda076.d421f","fcd8f32.8a9749"]]},{"id":"a7cda076.d421f","type":"function","z":"832c3c55.8de598","name":"put log into payload","func":"msg.payload = msg.payload.LogData;\nreturn msg;","outputs":1,"noerr":0,"x":1154,"y":541.75,"wires":[["109cd441.06b5ac"]]},{"id":"fcd8f32.8a9749","type":"debug","z":"832c3c55.8de598","name":"log-message","active":true,"console":"false","complete":"payload","x":1075,"y":586.5,"wires":[]},{"id":"109cd441.06b5ac","type":"debug","z":"832c3c55.8de598","name":"log-payload","active":true,"console":"false","complete":"payload","x":1373,"y":531.5,"wires":[]},{"id":"87f7d364.8a8268","type":"csv","z":"832c3c55.8de598","name":"NK1-test","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\r\\n","temp":"_id,_rev,dateTimeStamp,intent,entity,confidence,inputText,outputText,conversation_id","skip":0,"x":1260,"y":740,"wires":[["57942a8a.e41824"]]},{"id":"57942a8a.e41824","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"false","x":1430,"y":738.5,"wires":[]},{"id":"1cd756fe.7ab511","type":"http in","z":"832c3c55.8de598","name":"","url":"/getchatdata","method":"get","swaggerDoc":"","x":150,"y":1220,"wires":[["46ea79f.1cf3808"]]},{"id":"46ea79f.1cf3808","type":"http response","z":"832c3c55.8de598","name":"","x":590,"y":1220,"wires":[]},{"id":"50f64ef0.ddfda","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":590,"y":1280,"wires":[]},{"id":"7e25d9fa.745658","type":"inject","z":"832c3c55.8de598","name":"","topic":"02b79c84-2504-4e96-a48e-eeac02f5e368","payload":"8163b5e5-0b90-4270-9c2a-c660eae3c2e9","payloadType":"str","repeat":"","crontab":"","once":false,"x":150,"y":1280,"wires":[[]]},{"id":"b79f3d37.bee708","type":"natural-language-understanding","z":"832c3c55.8de598","name":"alchemy_test","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":true,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":385,"y":1341,"wires":[["6259f5ef.b2df6c"]]},{"id":"3e31c2b3.81ee0e","type":"inject","z":"832c3c55.8de598","name":"","topic":"","payload":"Boss this is Nitin","payloadType":"str","repeat":"","crontab":"","once":false,"x":136,"y":1339.75,"wires":[["b79f3d37.bee708","2185736b.2d8454"]]},{"id":"6259f5ef.b2df6c","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":710,"y":1340,"wires":[]},{"id":"89ddc793.3b549","type":"natural-language-understanding","z":"832c3c55.8de598","name":"extract concepts","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":false,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":1990,"y":400,"wires":[["64753c1f.281fbc","e14205c6.5548"]]},{"id":"2185736b.2d8454","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":346,"y":1397,"wires":[]},{"id":"4f3b6442.ed0c2c","type":"switch","z":"832c3c55.8de598","name":"ALC or Reg","property":"m_node_path","propertyType":"global","rules":[{"t":"eq","v":"Alc","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1541,"y":406.25,"wires":[["59ee202e.447bf","fa5548c9.1d0ee"],["1cbbc75c.b96971"]]},{"id":"59ee202e.447bf","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":1689,"y":353,"wires":[]},{"id":"aaf4fb86.979ea","type":"debug","z":"832c3c55.8de598","name":"NK-SWTCH","active":false,"tosidebar":true,"console":false,"complete":"true","x":1095,"y":172.5,"wires":[]},{"id":"64753c1f.281fbc","type":"debug","z":"832c3c55.8de598","name":"post_WNLU_message","active":true,"console":"false","complete":"true","x":2117,"y":270,"wires":[]},{"id":"fa5548c9.1d0ee","type":"function","z":"832c3c55.8de598","name":"Transform payload","func":"var m_name = msg.payload;\nmsg.payload = m_name;\nmsg.payload.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"x":1738,"y":400.25,"wires":[["a97292d3.a9d838","89ddc793.3b549"]]},{"id":"a97292d3.a9d838","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":1910,"y":329,"wires":[]},{"id":"1cbbc75c.b96971","type":"debug","z":"832c3c55.8de598","name":"NAKNAK","active":true,"console":"false","complete":"true","x":1601,"y":489,"wires":[]},{"id":"e14205c6.5548","type":"function","z":"832c3c55.8de598","name":"push message","func":"//var m_entity_type = msg.features.entities.type[0];\n//var m_entity_name = msg.features.entities.text[0];\nvar acl_payload = global.get(\"prev_msg\");\nvar m_user_name = \" \";\nvar m_cnt = 0;\n/**\n\n\nif (\"text\" in msg.features.keywords[0]) {\n  m_user_name = msg.features.keywords[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"2nd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"2nd-else compare\";\n}\n\n\nif (m_cnt === 0 ) {\nif (\"text\" in msg.features.entities[0]) {\n  m_user_name = msg.features.entities[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"3rd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"3rd-else compare\";\n}\n}\nelse {\n     msg.additional_context.joyName =\"4th-else compare\";\n}\n**/\n\nif (typeof(msg.features.keywords) !== \"undefined\") { \n    node.error(\"I am here-1\");\nif (typeof(msg.features.keywords[0]) !== \"undefined\") { \n      node.error(\"I am here-2\");\n    msg.additional_context.joyName =\"1st compare\";\n    m_user_name = msg.features.keywords[0].text; \n   node.error(\"I am here-3\", msg.features.keywords[0].text);\n    m_cnt = 1;\n}\n}\n\nif (m_cnt === 0) {\n    if (typeof(msg.features.entities) !== \"undefined\") {\n            node.error(\"I am here-4\");\nif (typeof(msg.features.entities[0].text) !== \"undefined\") { \n                node.error(\"I am here-41\");\n         m_user_name = msg.features.entities[0].text; \n         m_cnt = 2;\n          msg.additional_context.joyName =\"4th compare\";\n                        node.error(\"I am here-42\", msg.features.entities[0].text);\n}\n}\n}\n\nif (m_cnt === 0) {\n    m_user_name = \"there\";\n}\n\nmsg.payload = acl_payload;\nmsg.payload.text = \"Hello \" + m_user_name + \"..!! What can I do for you today\";\n//node.send(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2240,"y":400,"wires":[["12d2016c.56124f"]]},{"id":"12d2016c.56124f","type":"debug","z":"832c3c55.8de598","name":"","active":true,"console":"false","complete":"true","x":2163,"y":321,"wires":[]},{"id":"1864a009.e80f","type":"watson-conversation-v1","z":"832c3c55.8de598","name":"","workspaceid":"","multiuser":false,"context":true,"x":492,"y":746.5,"wires":[[]]},{"id":"9086926e.a45d58","type":"http request","z":"832c3c55.8de598","name":"","method":"POST","ret":"txt","url":"","tls":"","x":1290,"y":380,"wires":[["8af6d43a.7cc6b"]]},{"id":"72c1f993.74f89","type":"function","z":"832c3c55.8de598","name":"Response Msg_old","func":"msg.headers = {\n// QL: 'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTM5NmM5NGE4YzE0ZjY1MDAwZjJkMTEifQ.eyJzY29wZSI6ImFwcCJ9._Zt5vt6zg9lCHvC5xYYa0QorhyerPjkkzaQS4UyaLzk' \n'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81YWE1YThlOTRlNmVhODAwMjIyYTkxOTAifQ.eyJzY29wZSI6ImFwcCJ9.GRIwtUbEgmfDa8NjSkGsSpdmFHAEpob5yojS7Uj-GMo',\n      'content-type': 'application/json'\n};\n\n/** Added by Nitin to extract name using Watson API **/\nvar outTexts = \" \";\nvar uppercase_text;\noutTexts = msg.payload.output.text[0];\nuppercase_text = outTexts.toUpperCase();\nvar m_call_alchylme = \"No\";\nglobal.set(\"m_node_path\",\"Reg\");\nmsg.additional_context.angerName = \"m_node_path - Reg\";\nmsg.additional_context.disgustName= uppercase_text;\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nnode.error(\"Delay - Begin\");\n\nif (uppercase_text.lastIndexOf(\"YOUR NAME\") >= 0 ) {\n    global.set(\"ask_name_next\",\"YES\");\n    msg.additional_context.fearName = \"ask_name_next - YES\";\n}\n else {\n     var m_last_val = global.get(\"ask_name_next\");\n     msg.additional_context.fearName = \"m_last_val\" + m_last_val;\n     switch(m_last_val) {\n        case 'YES':\n           var get_name = msg.payload.input.text;\n           var m_call_alchylme = \"Yes\";\n           global.set(\"m_node_path\",\"Alc\");\n           //msg.additional_context = \"Alc\";\n           global.set(\"ask_name_next\", \"NO\");\n           msg.payload = \"my name is \" + get_name;\n             node.send(msg); \n           break;\n     }\n }\n\n\n/** Added upto Here ****/\n\n\n\n//if (m_call_alchylme.lastIndexOf(\"No\") >= 0) {\nif (m_call_alchylme == \"No\") { \nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\nnode.log(\"****context**** \" + Watson_context);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar typeMsg = \" \";   /* Added by NAK */\nvar response = {};\nvar component = \"\";\nnode.log(\"*********** Output is ************\" + Myresponse);\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n     node.log(\"Found a old maps at index:\", findindex);\n     node.log(Myresponse);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n     Newmsg = texts[i]; \n     node.log(\"**********  length ******* \" + texts.length);\n     node.log(\"start with \" + Newmsg);\nvar component = \"\";\nvar mapStr = \"\";\nvar actions = {};\nvar actionsArr = [];\nvar actionsRArr = [];\nvar buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\nvar m_url = \"\";\n//simple buttons\nif (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     node.log(\"Found a buttons at index:\", findindex);\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n    \n     /* Added by NAK */\n     /** Check Type encoded between <> e.g. <button>,<link>,<image> */\n     /** Check Lable encoded between {} e.g. {lable1},{lable2} */\n     type_findindex = Newmsg.lastIndexOf(\"<\");\n     type_findLastindex = Newmsg.lastIndexOf(\">\");\n     lable_findindex = Newmsg.lastIndexOf(\"{\");\n     lable_findLastindex = Newmsg.lastIndexOf(\"}\");\n     /* Added by NAK Upto Here */\n     \n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     \n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n     /* Added by NAK - Look for optional lable */\n     if ((lable_findindex > 0) && (lable_findLastindex > 0) ){\n          var buttonLableArr  = tempStr.substring(lable_findindex+1, lable_findLastindex).split(\",\");\n    } else {\n        var buttonLableArr = buttonArr;\n     }\n     \n     if (tempStr.lastIndexOf(\"<button>\") >= 0 ) {\n         typeMsg = \"button\";\n     }\n     else {\n       if (tempStr.lastIndexOf(\"<link>\") >= 0 ) {\n          typeMsg = \"link\";\n       }\n       else \n         if (tempStr.lastIndexOf(\"<image>\") >= 0 ) {\n            typeMsg = \"image\";\n         }\n         else {\n          typeMsg = \"button\";\n      }\n     }\n      \n        \n    /* Added by NAK Upto Here */\n    switch(typeMsg) {\n    case 'button':\n        for (a = 0; a < buttonArr.length; a++) { \n           actionsArr.push({\"type\": \"reply\",\"text\": buttonLableArr[a],\"payload\": buttonArr[a]});\n        }\n        break;\n    case 'link': \n        component = \"buttonLink\";\n        actionsArr.push({\"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n        break;\n    case 'image':\n        component = \"buttonImage\";\n        m_url = buttonArr[0];\n        actionsArr.push({\"_id\" : msg.user, \"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n\n   }\n     actions = {\"actions\" : actionsArr};\n\n    // Added by Nitin K from Here\n /*   if (typeMsg == \"link\") {\n       component = \"buttonlink\";\n       actionsArr.push({\"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n    }*/\n}\n\n/* Commented by NAK\nif (Newmsg.lastIndexOf(\"{\") >= 0 ) {\n     component = \"buttonlink\";\n     findindex = Newmsg.lastIndexOf(\"{\");\n     node.log(\"Found a buttons at index:\", findindex);\n     findLastindex = Newmsg.lastIndexOf(\"}\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\"|\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n    //    actionsArr.push({\"type\": \"link\",\"text\": buttonArr[a],\"uri\": buttonArr[a]});\n        actionsArr.push({\"type\": \"link\",\"text\": \"Link\",\"uri\": buttonArr[a]});\n     \n         \n     }\n     actions = {\"actions\" : actionsArr};\n}\nCommented upto Here **/\n// Added by Nitin K upto Here\n\n//json map\nnode.log(\"context: \" + Watson_context);\n//var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\nmapjsonObj = Watson_contextOBJ.map;\nif (typeof mapjsonObj.values != \"undefined\") {\n//node.log(\"mapjson: \" + mapjsonStr);\n//if (mapjsonStr  !== null){\n    component = \"map\";\n    for (var c in mapjsonObj.values) {\n      mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n      node.log(\"Found Json map str: \" + mapStr);\n      actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n //     actions = {\"actions\" : actionsArr };\n    }\n}\n\n//json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n// Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n//var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\nvar found_link = 0;\n//node.log(\"buttonjson: \" + buttonjsonStr);\nbuttonjsonObj = Watson_contextOBJ.button;\nif (typeof buttonjsonObj.values != \"undefined\") {\n  \n    for (var c in buttonjsonObj.values) {\n      buttonStr = buttonjsonObj.values[c];\n      node.log(\"NK-buttonStr :\", buttonStr);\n      if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n        found_link = 1;\n        buttonItems = buttonStr.split(\"|\");\n        button_title = buttonItems[0];\n        button_url = buttonItems[1];\n        \n        actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n      }\n      else {\n        button_title = buttonStr;  \n        actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n       //actionsArr.push({\"type\": \"postback\",\"text\": button_title,\"payload\": button_title}); \n      }\n    }  \n    if (found_link > 0) {\n       component = \"buttonLink\"; \n    }else {\n      component = \"buttonReply\";   \n    }\n}\n\n//old maps\nif (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n     node.log(\"Found a maps at index:\", findindex);\n     node.log(Newmsg);\n} \n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nNewmsg = Newmsg.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nNewmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n//msg.url = \"https://api.smooch.io/sdk/apps/5aa5a6e072b44a0022f43c5c/appusers/\"+msg.save_payload.appUser._id+\"/messages\";// + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/5aa5a6e072b44a0022f43c5c/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n//msg.url = msg.save_payload.fromUrl;\nnode.error(\"NK-Component :\", component + Newmsg);\nnode.error(msg);\nswitch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"nitin421505-1@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",  //\"text\",\n        //payload : actionsRArr,\n        text : Newmsg,\n        //email: \"nitin421505-3@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'buttonImage':\n     response = {\n        _id  : msg.user,\n        role : \"appMaker\",\n        type : \"image\",   \n        text : Newmsg,\n        mediaUrl : m_url,\n        mediaType : \"image\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"nitin421505@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appUser\",\n        type : \"text\",\n        text : \"Ack from Application\", //msg.payload.output.text,\n        email: \"watson40985@gmail.com\"\n        //,\n        //actions : actionsArr\n        }\n}\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n node.error(\"****First Send: ******* \" + JSON.stringify(response));\n  msg.payload = response;\n  node.error(msg);\n  global.set(\"prev_msg\",msg.payload);\n//  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"nitin421505@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    node.log(\"****Second Send: ******* \" + JSON.stringify(response));\n    msg.payload = response;\n    global.set(\"prev_msg\",msg.payload);\n    node.send(msg);  \n  }\n }\n}\n}\nreturn null;","outputs":"1","noerr":0,"x":890,"y":780,"wires":[[]]},{"id":"9d64bdf0.752b8","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"str","repeat":"300","crontab":"","once":false,"onceDelay":"","x":110,"y":260,"wires":[[]]},{"id":"627dc52f.5422d4","type":"http request","z":"f3565267.58f28","name":"Recent Quakes","method":"GET","url":"https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/significant_week.csv","tls":"","x":280,"y":260,"wires":[["cd1e8ce0.fa628"]]},{"id":"cd1e8ce0.fa628","type":"csv","z":"f3565267.58f28","name":"","sep":",","hdrin":true,"hdrout":"","multi":"one","ret":"\\n","temp":"","skip":0,"x":450,"y":260,"wires":[["443f72a5.1867bc","6d5f230.a006edc"]]},{"id":"443f72a5.1867bc","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"complete":false,"x":610,"y":260,"wires":[]},{"id":"6d5f230.a006edc","type":"switch","z":"f3565267.58f28","name":"","property":"payload.mag","propertyType":"msg","rules":[{"t":"gte","v":"7","vt":"num"}],"checkall":"true","outputs":1,"x":490,"y":320,"wires":[["9e8de0d8.bbbce8"]]},{"id":"9e8de0d8.bbbce8","type":"change","z":"f3565267.58f28","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"PANIC!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":630,"y":380,"wires":[["7f14c3f7.0823cc"]]},{"id":"7f14c3f7.0823cc","type":"debug","z":"f3565267.58f28","name":"","active":true,"complete":false,"x":750,"y":320,"wires":[]},{"id":"7499c072.f0f96","type":"delay","z":"832c3c55.8de598","name":"Send one message at a time","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1320,"y":320,"wires":[["9086926e.a45d58"]]},{"id":"10e14f30.833389","type":"function","z":"440e09de.708d78","name":"Save payload","func":"msg.savePayload = msg.payload\n\n//msg.payload = [msg.user]\n\nreturn msg;","outputs":1,"noerr":0,"x":170.20188903808594,"y":73.05198097229004,"wires":[["3d2716f.d97fcea"]]},{"id":"42344d59.a7b4b4","type":"function","z":"440e09de.708d78","name":"Set Session","func":"if (typeof msg.payload.convoUser !== \"undefined\" )\n  {msg.session = msg.payload\n  \n  }\nelse \n  { \n      \n}\n   \n//reset payload from channel to continue flow\nmsg.payload = msg.savePayload\nreturn msg;","outputs":1,"noerr":0,"x":657.7659225463867,"y":73.88070869445801,"wires":[[]]},{"id":"1afe7748.4f7899","type":"json","z":"440e09de.708d78","name":"","pretty":false,"x":500.9051742553711,"y":74.14072799682617,"wires":[["42344d59.a7b4b4"]]},{"id":"3d2716f.d97fcea","type":"function","z":"440e09de.708d78","name":"Redis GET","func":"var redis = global.get('redis');\nvar options = {enable_offline_queue:false};\n\nvar redisClient = global.get(\"redisClient\");\n\nif (typeof redisClient == \"undefined\") {\n  redisClient = new redis('redis://admin:XFRLCLICWCFQXPXA@sl-us-south-1-portal.5.dblayer.com:35110',options);\n// redisClient = new redis('redis://admin:IVKPWZBPOAJYQCRR@bluemix-sandbox-dal-9-portal.7.dblayer.com:27247',options);\n  global.set(\"redisClient\",redisClient);\n  node.log(\"New RedisClient connection in GetSession\")\n}\n\nredisClient.on(\"error\", function (err) {\n    node.error(\"Error \" + err);\n//    client.disconnect(); \n});\n\n redisClient.get(msg.user,function (err,result) {\n  if (err) \n      node.error(\"Error \" + err);\n    else {\n      msg.payload = result;\n      if (msg.payload === null){\n          msg.payload = \"{}\";}\n//      node.log(\"payload \" + JSON.stringify(msg.payload))\n      node.send(msg);\n    }\n//  client.disconnect();\n});\n\n","outputs":1,"noerr":0,"x":346.5,"y":74,"wires":[["1afe7748.4f7899"]]},{"id":"4c7599c2.e11638","type":"subflow:440e09de.708d78","z":"f3565267.58f28","name":"","x":370,"y":140,"wires":[[]]},{"id":"bb96af.60e1c95","type":"subflow:440e09de.708d78","z":"832c3c55.8de598","name":"","x":510,"y":60,"wires":[["f445b642.b953e"]]},{"id":"4766b565.1e4de4","type":"inject","z":"832c3c55.8de598","name":"@start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"","x":110,"y":60,"wires":[["922fa2fc.5acf38"]]},{"id":"922fa2fc.5acf38","type":"function","z":"832c3c55.8de598","name":"clear global_var","func":"var m1 = undefined;\nnode.error(m1);\nglobal.set(\"wcs_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"global_Check_context\",m1);\nvar m2 = global.get(\"wcs_02aaa89716d5b27e3a37aab3\");\nif (typeof m2 == 'undefined' ){\n    node.error(\"'undefined'\");\n}\nvar m2 = global.get(\"global_Check_context\");\nif (typeof m2 == 'undefined' ){\n    node.error(\"'undefined'\");\n}\n//node.error(m2);\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":40,"wires":[[]]},{"id":"8a45aa80.0734b8","type":"switch","z":"832c3c55.8de598","name":"","property":"tmp_Switch_Workspace","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1030,"y":420,"wires":[["7b96335a.dd60c4"],[]]},{"id":"76df31a9.ea3548","type":"debug","z":"832c3c55.8de598","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":350,"y":540,"wires":[]},{"id":"77ab3c38.69a68c","type":"function","z":"832c3c55.8de598","name":"WCS-Rest Call- to try","func":"/* New param to added to all front-ends - wcs_region = USSOUTH, GERMANY\nWill be used to set the url\nUSSOUTH - https://gateway.watsonplatform.net/conversation/api\nGERMANY - https://gateway-fra.watsonplatform.net/conversation/api\n*/\nvar watson = global.get('watson');\nmsg.params.input = {\n      text: msg.payload\n    };\n\n//if (msg.region === \"US-SOUTH\"){ \n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n//}\n//else if (msg.region === \"GERMANY\"){\n//    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n//}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  workspace_id : msg.params.workspace_id,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 15 second time out\", msg)}, 15000 );\n\nconversation.message(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":140,"wires":[[]]},{"id":"ffcbc9c0.9ef5d","type":"function","z":"832c3c55.8de598","name":"Set Params - old","func":"\nmsg.save_payload = msg.payload;\nnode.error(\"Nak\");\nnode.error(msg);\n\nvar wcs_0 = \"d58fb5ae-24db-4225-8977-b0a6f7634a10\";\nvar wcs_1 = \"44beeefd-e0e9-4d90-980c-3d2b7de7c516\";\nvar wcs_username = \"d3708ec5-e3d5-420b-a9bd-7e55987146e0\";\nvar wcs_password = \"6QzbimbHOvao\";\n\nvar m_regions_workspace_id = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\nvar m_regions_username = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nvar m_regions_password = \"UplCjXHkuLgj\";\n\nvar m_cur_wcs_id = \"\";\nvar m_wcs_username = \"\";\nvar m_wcs_password = \"\";\n\n\nvar user_glob_var = \"wcs_\" + msg.payload.appUser._id ;\nnode.error(\"NAK user_glob_var ==>[\" + user_glob_var +\"]\");\n\nif (typeof global.get('\"'+user_glob_var+'\"') !== 'undefined' ) {\nvar m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\nnode.error(\"Check Global Var: [\" + m_get_wcs_id + \"]\");\n}\nelse {\n       global.set('\"'+user_glob_var+'\"',\"0\");\n       m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       \n}\nvar m_wcs_num = \"\";\n       node.error(\"Here-0\");\nif (typeof m_get_wcs_id !== 'undefined' ) {\n        m_wcs_num = m_get_wcs_id;\n        node.error(\"NAK - WCS Num Retrived m_wcs_num : \" + m_wcs_num);\n}        \nelse {\n       node.error(\"Here-2\");\n        global.set('\"'+user_glob_var+'\"',\"3\");\n        var m_check = global.set('\"'+user_glob_var+'\"');\n        m_wcs_num = m_check;\n        node.error(\"NAK - WCS Numm Set m_wcs_num : \" + m_wcs_num);\n}\n\n//Set WCS ID \nswitch (m_wcs_num) {\n    case \"0\" :\n      m_cur_wcs_id = wcs_0;\n      m_wcs_username = wcs_username;\n      m_wcs_password = wcs_password;\n      break;\n    case \"1\" :\n      m_cur_wcs_id = wcs_1;\n      m_wcs_username = wcs_username;\n      m_wcs_password = wcs_password;\n      break;    \n    default :\n      m_cur_wcs_id = m_regions_workspace_id;\n      m_wcs_username = m_regions_username;\n      m_wcs_password = m_regions_password;\n}\n\nnode.error(\"NAK : m_cur_wcs_id ==> \" + m_cur_wcs_id);\n\n//var workspace_id = msg.req.query.workspace_id;\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\n//var user = msg.payload.appUser._id;\n//var input = msg.payload.messages[0].text;\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     user = msg.payload.appUser._id;  \n   }\n}\n\nvar test  = JSON.stringify(msg.payload);\nnode.log(test)\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n//if ((input.toUpperCase().substring(0,5) == \"HELLO\") && (input.length > 5)){\n       // workspace_id = \"755b62ba-ce44-4ecf-ad18-432be1be8c8c\";\n       // app = \"BankAssist\";\n        //workspace_id = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\n        workspace_id = m_get_wcs_id;\n        app = \"RegionsAssist\";\n//        msg.user = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\n/*\nswitch(input.toUpperCase()) {\n    case 'HELLO BANK ASSIST':\n        workspace_id = \"755b62ba-ce44-4ecf-ad18-432be1be8c8c\";\n        app = \"BankAssist\";\n        break;\n    case 'HELLO INSURE ASSIST':\n        workspace_id = \"17df222b-bf8c-41fc-8bec-da21317d993c\";\n        app = \"InsureAssist\";\n        break;\n    case 'HELLO INSURE CALL CENTER ASSIST':\n        workspace_id = \"d6598934-675d-4fe1-b2c9-9e0ebc4c1e69\";\n        app = \"InsureCCAssist\";\n        break;\n    case 'HELLO WEALTH ASSIST':\n        workspace_id = \"2fb924dd-27c4-4668-8ac3-be7add1065c1\";\n        app = \"WealthAssist\";\n        break;\n    case 'HELLO METLIFE ASSIST':\n        workspace_id = \"5fd7c1c7-9ea2-4fc8-b6fa-7920e10aad5a\";\n        app = \"MetLifeAssist\";\n        break;\n    case 'HELLO FIDELITY ASSIST':\n       // fidelity space  workspace_id = \"46975d17-120f-4757-8fe8-4a6649b3a257\";\n       // Fidelity space  app = \"FidelityAssist\";\n        workspace_id = \"1555159e-fa59-4d8d-bfba-b10a19144e22\";\n        app = \"WealthAssist\";\n        break;\n     case 'HELLO REGIONS ASSIST':\n        workspace_id = \"321e996d-efee-42a0-8aed-3dc93006a026\";\n        app = \"RegionsAssist\";\n        break;\n     case 'HELLO REGIONS UAT ASSIST':\n        workspace_id = \"de1089d8-46e6-4a7d-b5ed-03c5338b7b0a\";\n        app = \"RegionsUATAssist\";\n        break;\n     case 'HELLO LIBERTY MUTUAL ASSIST':\n        workspace_id = \"893ec9b6-bfc8-426a-8fd1-592a2e6ebaa8\";\n        app = \"LibertyMutualAssist\";\n        break;\n     case 'HELLO FANNIE MAE ASSIST':\n        workspace_id = \"0a7cb606-7488-4b3e-88ae-abcdaafb1c0a\";\n        app = \"FannieMaeAssist\";\n        break;   \n    default: \n        workspace_id = \"17df222b-bf8c-41fc-8bec-da21317d993c\";\n        app = \"InsureAssist\";\n } \n commented by Nitin K */\n \n //global.set(\"app\",app);\n //global.set(\"workspace_id\",workspace_id);\n \n// global.set(\"ask_name_next\", \"No\");\n// global.set(\"ask_user_name\", \" \");\n global.set(\"workspace_id\"+ user,workspace_id);\n global.set(\"app\"+ user,app);\n \n node.log(\"app name: \" + \"app\" + user + \" app value: \" + app);\n node.log(\"workspace name: \" + \"workspace_id\" + user + \" workspace_id value: \" +  workspace_id);\n//}\n\n//msg.app = global.get(\"app\");\n//var workspace_id = global.get(\"workspace_id\");\n\nmsg.app = global.get(\"app\"+ user);\nvar workspace_id = global.get(\"workspace_id\" + user);\n\nvar params = {\n//     context: context,\n     workspace_id : m_cur_wcs_id,\n     username: m_wcs_username,\n     password: m_wcs_password\n}\nvar additional_context = {\n    fname: fname,\n    map : map,\n    button: button \n    \n};\n\nif (input.lastIndexOf('/') >= 0 ) {\n     var myindex = input.lastIndexOf('/')\n     node.log(\"index at: \" + myindex)\n     var dateString = input\n     node.log(\"dateString : \" + dateString)\n     \n     var d = new Date(dateString)\n     node.log(\"d : \" + d)\n     var now = new Date()\n     node.log(\"today: \" + now)\n     var years = now.getFullYear() - d.getFullYear()\n     node.log(\"years: \" + years)\n     \n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     node.log(\"days: \" + days)\n     var age = years + days /365\n    \n     additional_context.age = Math.round(age *100)/100\n     node.log(\"age: \"+ context.age)\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     additional_context.ageEOY = Math.round(ageEOY * 100)/100\n     node.log(\"ageEOY: \"+ context.ageEOY)\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     additional_context.ageBOY = Math.round(ageBOY * 100)/100\n     node.log(\"ageBOY: \"+ context.ageBOY)\n}\n\n\n\nmsg.payload = input;\nmsg.params = params;\nmsg.user = user;\n//msg.params.context = {\"timezone\" :  \"America/Chicago\"};\nmsg.additional_context = additional_context;\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":160,"wires":[[]]},{"id":"3dc15dac.09bf42","type":"function","z":"832c3c55.8de598","name":"Check","func":"node.error(\"Inside Check Node - Response from WCS\");\n//node.error(msg);\nmsg.tmp_Switch_Workspace = \"No\";\nif (typeof msg.payload.context.Switch_Workspace !== 'undefined') {\n    //node.error(\"Check-1\");\n    if (msg.payload.context.Switch_Workspace.length > 0 ) {\n        msg.tmp_Switch_Workspace = \"Yes\";\n         //node.error(\"Check-2\");\n    }\n}\nif (msg.tmp_Switch_Workspace === \"Yes\") {\n    if (msg.curr_wcs_num === msg.payload.context.Switch_Workspace) {\n        msg.tmp_Switch_Workspace = \"No\";\n    }\n    else {\n       var user_glob_var = \"wcs_\" + msg.save_payload.appUser._id ;\n       var m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       if (msg.payload.context.Switch_Workspace !== \"\") {\n           global.set('\"'+user_glob_var+'\"',msg.payload.context.Switch_Workspace);\n           global.set(\"global_Check_context\", \"Yes\");\n           global.set(\"global_Root\", msg.payload.context.Root);\n           global.set(\"global_Child\",msg.payload.context.Child);\n           node.error(\"Workspace Swtiched initiated\");\n       } \n        \n    }\n}\nnode.error(\"Check - Switch Workspace ? \" + msg.tmp_Switch_Workspace);\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":280,"wires":[["48226c93.ce7f6c"]]},{"id":"7b96335a.dd60c4","type":"function","z":"832c3c55.8de598","name":"Restore MSG Payload","func":"msg.payload = msg.save_payload;\nmsg.payload.messages[0].text = \" \";\nnode.error(\"Switch workspace Restore msg \");\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":380,"wires":[["bc367e04.275b08"]]},{"id":"ef04f933.41515","type":"debug","z":"b6f9906e.c78c18","name":"Rcvd from Chat","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":380,"y":180,"wires":[]},{"id":"6a4f0efc.e5346","type":"debug","z":"b6f9906e.c78c18","name":"Input  Message to WCS","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":653.2142105102539,"y":187.4444580078125,"wires":[]},{"id":"135c7a4e.6c2086","type":"http in","z":"b6f9906e.c78c18","name":"Mobile HTTP in","url":"/smooch-bak","method":"post","upload":false,"swaggerDoc":"","x":328.2142791748047,"y":330.00000286102295,"wires":[["6f59f744.003318","ef04f933.41515","6616f3cd.c4614c"]]},{"id":"28f6d677.644052","type":"watson-conversation-v1","z":"b6f9906e.c78c18","name":"Base Conv","workspaceid":"","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"","x":1150,"y":360,"wires":[["69dec4e9.7e27ac","baf33bf9.790c38","e72ef55d.309ff8"]]},{"id":"6f59f744.003318","type":"function","z":"b6f9906e.c78c18","name":"Set Params-NLC","func":"msg.save_payload = msg.payload;\nnode.error(\"Nak-Incoming Message-NLC\");\nnode.error(msg);\n\nvar user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n\n\nif (typeof global.get('\"'+user_glob_Check_NLC+'\"') !== 'undefined') {\n    msg.Check_NLC = global.get('\"'+user_glob_Check_NLC+'\"');\n} else {\n    msg.Check_NLC = \"Yes\";\n}\n//var m_input = msg.payload.messages[0].text;\nif  (msg.Check_NLC === \"Yes\") {\n    msg.payload = msg.payload.messages[0].text;\n    node.error(\"Calling NLC\");\n} else { node.error(\"Skipping NLC Call\"); }\n\n//*** Restore Context from previous dialog **//\n\nif (typeof msg.params  == 'undefined') {\n            msg.params  = {};\n}\nif (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n}\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    msg.params.context = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(msg);\n}\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":300,"wires":[["6a4f0efc.e5346","fd7e6d06.4cd97"]]},{"id":"e72ef55d.309ff8","type":"function","z":"b6f9906e.c78c18","name":"Response Msg","func":"node.error(\"Inside Response MSG\");\nnode.error(msg);\n\n//if (typeof msg.payload.output.text[0] == 'undefined') {\n//    msg.payload.output.text[0] = \"Sorry I am not trained on this topic yet; try asking some other question\";\n//}\n\nif (typeof msg.payload.context.Check_NLC !== 'undefined') {\n    if (msg.payload.context.Check_NLC === \"Yes\") {\n        var user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n        global.set('\"'+user_glob_Check_NLC+'\"',\"Yes\");\n    }\n}\n\n\nmsg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'     \n};\n\n//*** store context to global variable ***//\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nglobal.set('\"'+user_glob_Context+'\"',msg.payload.context);\n\nmsg.Skip_Output = \"No\";\nif (typeof msg.payload.context.Skip_Output !== 'undefined') {\n    msg.Skip_Output = msg.payload.context.Skip_Output;\n}\nif (msg.payload.context.skip_loop_break === \"Yes\" ) {\n    node.error(\"Breaking skip loop\");\n    msg.Skip_Output = \"No\";\n    //msg.payload.output.text = \"Sorry I am not trained on this topic\";\n}\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\n\n//if (typeof msg.payload.output.text === 'undefined') {\n//    msg.payload.output.text = \"Nitin K\";\n//}\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n Newmsg = texts[i]; \n //node.error(\"Newmsg :[\"+ i+\"]\"+Newmsg);\n var component = \"\";\n var mapStr = \"\";\n var actions = {};\n var actionsArr = [];\n var actionsRArr = [];\n var buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n //simple buttons\n if (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n }\n\n //json map\n //var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\n if (typeof Watson_contextOBJ.map != 'undefined') {\n     mapjsonObj = Watson_contextOBJ.map;\n     if (typeof mapjsonObj.values != \"undefined\") {\n        //node.log(\"mapjson: \" + mapjsonStr);\n        //if (mapjsonStr  !== null){\n        component = \"map\";\n        for (var c in mapjsonObj.values) {\n            mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n            actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n        }\n   }\n }\n\n //json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n // Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n //var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\n var found_link = 0;\n //node.log(\"buttonjson: \" + buttonjsonStr);\n if (typeof Watson_contextOBJ.button != 'undefined') {\n    buttonjsonObj = Watson_contextOBJ.button;\n    if (typeof buttonjsonObj.values != \"undefined\") {\n       for (var c in buttonjsonObj.values) {\n           buttonStr = buttonjsonObj.values[c];\n           if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n              found_link = 1;\n              buttonItems = buttonStr.split(\"|\");\n              button_title = buttonItems[0];\n              button_url = buttonItems[1];\n              actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n            }\n            else {\n              button_title = buttonStr;  \n              actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n            }\n        }  \n        if (found_link > 0) {\n           component = \"buttonLink\"; \n        }else {\n           component = \"buttonReply\";   \n        }\n    }\n}\n\n //old maps\n if (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n } \n\n // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n Newmsg = Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n Newmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n// node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Newmsg)\n\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\n\nvar nk_texts = msg.payload.output.text\n\n//if (nk_texts == \"\") {\n//    nk_texts = \"Sorry I am not trained on that topic yet\";\n//}\n\n \nfor (i = 0; i < nk_texts.length; i++) {\n nk_Newmsg = nk_texts[i]; \n //node.error(\"nk_Newmsg :[\"+ i+\"]\"+nk_Newmsg);\n nk_Newmsg = nk_Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n nk_Newmsg = nk_Newmsg.replace(/<[^>]+>/g, \"\");\n switch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : nk_Newmsg,\n        email: \"watson40985@gmail.com\",\n        actions : actionsArr};\n }\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n\n//node.error(\"Response-2\");\n  msg.payload = response;\n//node.error(msg);  \n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n \n }\n}\n//node.error(\"Before sending response\");\n//node.error(msg);\nreturn [null,msg];","outputs":2,"noerr":0,"x":1360,"y":360,"wires":[["d277eeb8.c1dc48","9fc0df6.b7381a"],["47235bf6.ba53bc"]]},{"id":"d1bd252c.b21a18","type":"debug","z":"b6f9906e.c78c18","name":"Response msg payload smooch","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1550,"y":520,"wires":[]},{"id":"7ce832d7.e85c94","type":"http request","z":"b6f9906e.c78c18","name":"","method":"POST","ret":"txt","url":"","tls":"","x":805.7143249511719,"y":743.0000257492065,"wires":[["e6c64026.d1f56"]]},{"id":"11510b14.dc291d","type":"function","z":"b6f9906e.c78c18","name":"Send post message","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g'\n     };\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + \"02aaa89716d5b27e3a37aab3\" + \"/messages\";\n\nvar response = {\n    role : \"appMaker\",\n    type : \"text\",\n    text : \"hey what's up!!!\",\n    email: \"watson40985@gmail.com\",\n    //email: \"dennisnoto@gmail.com\",\n    actions : []\n};\n\nmsg.payload = response;\n\nreturn msg;","outputs":1,"noerr":0,"x":570.7143096923828,"y":743.0000066757202,"wires":[["7ce832d7.e85c94"]]},{"id":"e6c64026.d1f56","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"payload","x":1008.7142944335938,"y":741.9999952316284,"wires":[]},{"id":"6034a5d9.828d84","type":"inject","z":"b6f9906e.c78c18","name":"","topic":"go","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":332.7143096923828,"y":748.0000066757202,"wires":[["11510b14.dc291d"]]},{"id":"6616f3cd.c4614c","type":"http response","z":"b6f9906e.c78c18","name":"HTTP-Postback","statusCode":"","headers":{},"x":536.7142791748047,"y":383.00000286102295,"wires":[]},{"id":"d277eeb8.c1dc48","type":"debug","z":"b6f9906e.c78c18","name":"smooch out of response msg","active":true,"tosidebar":true,"console":false,"complete":"true","x":1700,"y":300,"wires":[]},{"id":"69dec4e9.7e27ac","type":"debug","z":"b6f9906e.c78c18","name":"smooch out of convo","active":false,"tosidebar":true,"console":false,"complete":"payload","x":1560,"y":180,"wires":[]},{"id":"fbaf7fad.aabf68","type":"http in","z":"b6f9906e.c78c18","name":"Postbacks","url":"/smooch-postback","method":"post","swaggerDoc":"","x":330.7143096923828,"y":439.12502574920654,"wires":[["768c4794.b22bf","6616f3cd.c4614c","90d6ab1.6189958"]]},{"id":"90d6ab1.6189958","type":"function","z":"b6f9906e.c78c18","name":"actionPayload","func":"msg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'\n     };\n\nmsg.user = msg.payload.appUser.userId;\n//msg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\nmsg.actionPayload = msg.payload.postbacks[0].action.payload;\n\nresponse = {\n        role : \"appUser\",\n        type : \"text\",\n        text : msg.actionPayload\n};\n\nmsg.payload = response;\nreturn msg;","outputs":1,"noerr":0,"x":384.9834976196289,"y":531.9999990463257,"wires":[[]]},{"id":"482b58d7.0d1868","type":"http request","z":"b6f9906e.c78c18","name":"HTTPS-2","method":"POST","ret":"txt","url":"","tls":"","x":593.7527160644531,"y":533.4615783691406,"wires":[[]]},{"id":"768c4794.b22bf","type":"debug","z":"b6f9906e.c78c18","name":"PostBack Messsage","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":550,"y":459,"wires":[]},{"id":"14457601.872312","type":"debug","z":"b6f9906e.c78c18","name":"smooch msg to convo","active":true,"console":"false","complete":"true","x":732.2142791748047,"y":641,"wires":[]},{"id":"e4dcad96.7cac38","type":"function","z":"b6f9906e.c78c18","name":"Prepare Log to write","func":"//fill in log obj\n\nvar currentIntent = \" \";\nvar currentEntity = \" \";\nvar currentConfidence =\"\";\nvar currentInputText =\"\";\nvar currentOutputText =\"\";\nvar startTimeStamp =\"\";\nvar conversationID=\"\";\n\n\nif (msg.payload.context.conversation_id!==undefined){\n    conversationID=msg.payload.context.conversation_id\n}\nif ((msg.payload.intents!==undefined)&&(msg.payload.intents[0]!==undefined)){\n    if (msg.payload.intents[0].intent!==undefined){\n        currentIntent= msg.payload.intents[0].intent\n    }\n    if (msg.payload.intents[0].confidence!==undefined){\n        currentConfidence=msg.payload.intents[0].confidence\n    }\n}\n\nif ((msg.payload.entities!==undefined)&&(msg.payload.entities[0]!==undefined)){\n    if (msg.payload.entities[0].entity!==undefined){\n        currentEntity= msg.payload.entities[0].entity\n    }\n    if (msg.payload.entities[0].confidence!==undefined){\n        currentConfidence=msg.payload.entities[0].confidence\n    }\n}\nif (msg.payload.input.text!==undefined){\n    currentInputText=msg.payload.input.text\n}\nif (msg.payload.output.text!==undefined){\n    currentOutputText=msg.payload.output.text[0]\n}\n\n\nvar date1 = new Date();\n\nvar newLogData= {\n\t dateTimeStamp : date1,\n\t intent : currentIntent,\n\t entity : currentEntity,\n\t confidence : currentConfidence,\n\t inputText : currentInputText,\n     outputText : currentOutputText,\n     conversation_id: conversationID\n\n};\nmsg.payload.LogData = newLogData;\nreturn msg;\n\n\n\n\n","outputs":1,"noerr":0,"x":1142,"y":583,"wires":[["d190fb45.a4ce6","cc7235fe.737b5"]]},{"id":"d190fb45.a4ce6","type":"function","z":"b6f9906e.c78c18","name":"put log into payload","func":"msg.payload = msg.payload.LogData;\nreturn msg;","outputs":1,"noerr":0,"x":1376,"y":604.75,"wires":[["1541c5bf.bbae72"]]},{"id":"cc7235fe.737b5","type":"debug","z":"b6f9906e.c78c18","name":"log-message","active":true,"console":"false","complete":"payload","x":1297,"y":649.5,"wires":[]},{"id":"1541c5bf.bbae72","type":"debug","z":"b6f9906e.c78c18","name":"log-payload","active":true,"console":"false","complete":"payload","x":1595,"y":594.5,"wires":[]},{"id":"463218d7.7248a8","type":"csv","z":"b6f9906e.c78c18","name":"NK1-test","sep":",","hdrin":"","hdrout":true,"multi":"one","ret":"\\r\\n","temp":"_id,_rev,dateTimeStamp,intent,entity,confidence,inputText,outputText,conversation_id","skip":0,"x":1482,"y":803,"wires":[["128315ae.f22a8a"]]},{"id":"128315ae.f22a8a","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"false","x":1652,"y":801.5,"wires":[]},{"id":"a1693cac.421fb","type":"http in","z":"b6f9906e.c78c18","name":"","url":"/getchatdata","method":"get","swaggerDoc":"","x":372,"y":1283,"wires":[["bc8c34c5.c6b42"]]},{"id":"bc8c34c5.c6b42","type":"http response","z":"b6f9906e.c78c18","name":"","x":812,"y":1283,"wires":[]},{"id":"7114c59d.6153bc","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":812,"y":1343,"wires":[]},{"id":"8011337a.d225b","type":"inject","z":"b6f9906e.c78c18","name":"","topic":"02b79c84-2504-4e96-a48e-eeac02f5e368","payload":"8163b5e5-0b90-4270-9c2a-c660eae3c2e9","payloadType":"str","repeat":"","crontab":"","once":false,"x":372,"y":1343,"wires":[[]]},{"id":"40a0748d.473114","type":"natural-language-understanding","z":"b6f9906e.c78c18","name":"alchemy_test","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":true,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":607,"y":1404,"wires":[["f9336e30.aad29"]]},{"id":"80e5bc3f.98885","type":"inject","z":"b6f9906e.c78c18","name":"","topic":"","payload":"Boss this is Nitin","payloadType":"str","repeat":"","crontab":"","once":false,"x":358,"y":1402.75,"wires":[["40a0748d.473114","796789e5.a618e"]]},{"id":"f9336e30.aad29","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":932,"y":1403,"wires":[]},{"id":"598b1be9.200a44","type":"natural-language-understanding","z":"b6f9906e.c78c18","name":"extract concepts","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":false,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":2212,"y":463,"wires":[["5962022d.fb59ac","5f13d07e.4921a"]]},{"id":"796789e5.a618e","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":568,"y":1460,"wires":[]},{"id":"2de1fdfa.1a1f9a","type":"switch","z":"b6f9906e.c78c18","name":"ALC or Reg","property":"m_node_path","propertyType":"global","rules":[{"t":"eq","v":"Alc","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1763,"y":469.25,"wires":[["e7f4850f.a144a8","dae6b582.407f3"],["f98d338f.048568"]]},{"id":"e7f4850f.a144a8","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":1911,"y":416,"wires":[]},{"id":"baf33bf9.790c38","type":"debug","z":"b6f9906e.c78c18","name":"NK-SWTCH","active":false,"tosidebar":true,"console":false,"complete":"true","x":1530,"y":220,"wires":[]},{"id":"5962022d.fb59ac","type":"debug","z":"b6f9906e.c78c18","name":"post_WNLU_message","active":true,"console":"false","complete":"true","x":2339,"y":333,"wires":[]},{"id":"dae6b582.407f3","type":"function","z":"b6f9906e.c78c18","name":"Transform payload","func":"var m_name = msg.payload;\nmsg.payload = m_name;\nmsg.payload.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"x":1960,"y":463.25,"wires":[["96dc3a1a.35eea","598b1be9.200a44"]]},{"id":"96dc3a1a.35eea","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":2132,"y":392,"wires":[]},{"id":"f98d338f.048568","type":"debug","z":"b6f9906e.c78c18","name":"NAKNAK","active":true,"console":"false","complete":"true","x":1823,"y":552,"wires":[]},{"id":"5f13d07e.4921a","type":"function","z":"b6f9906e.c78c18","name":"push message","func":"//var m_entity_type = msg.features.entities.type[0];\n//var m_entity_name = msg.features.entities.text[0];\nvar acl_payload = global.get(\"prev_msg\");\nvar m_user_name = \" \";\nvar m_cnt = 0;\n/**\n\n\nif (\"text\" in msg.features.keywords[0]) {\n  m_user_name = msg.features.keywords[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"2nd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"2nd-else compare\";\n}\n\n\nif (m_cnt === 0 ) {\nif (\"text\" in msg.features.entities[0]) {\n  m_user_name = msg.features.entities[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"3rd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"3rd-else compare\";\n}\n}\nelse {\n     msg.additional_context.joyName =\"4th-else compare\";\n}\n**/\n\nif (typeof(msg.features.keywords) !== \"undefined\") { \n    node.error(\"I am here-1\");\nif (typeof(msg.features.keywords[0]) !== \"undefined\") { \n      node.error(\"I am here-2\");\n    msg.additional_context.joyName =\"1st compare\";\n    m_user_name = msg.features.keywords[0].text; \n   node.error(\"I am here-3\", msg.features.keywords[0].text);\n    m_cnt = 1;\n}\n}\n\nif (m_cnt === 0) {\n    if (typeof(msg.features.entities) !== \"undefined\") {\n            node.error(\"I am here-4\");\nif (typeof(msg.features.entities[0].text) !== \"undefined\") { \n                node.error(\"I am here-41\");\n         m_user_name = msg.features.entities[0].text; \n         m_cnt = 2;\n          msg.additional_context.joyName =\"4th compare\";\n                        node.error(\"I am here-42\", msg.features.entities[0].text);\n}\n}\n}\n\nif (m_cnt === 0) {\n    m_user_name = \"there\";\n}\n\nmsg.payload = acl_payload;\nmsg.payload.text = \"Hello \" + m_user_name + \"..!! What can I do for you today\";\n//node.send(msg);\nreturn msg;","outputs":1,"noerr":0,"x":2462,"y":463,"wires":[["5ce57b93.af96ec"]]},{"id":"5ce57b93.af96ec","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"console":"false","complete":"true","x":2385,"y":384,"wires":[]},{"id":"3f41bb7d.6d852c","type":"watson-conversation-v1","z":"b6f9906e.c78c18","name":"","workspaceid":"","multiuser":false,"context":true,"x":714,"y":809.5,"wires":[[]]},{"id":"ace586f1.65b638","type":"http request","z":"b6f9906e.c78c18","name":"","method":"POST","ret":"txt","url":"","tls":"","x":1512,"y":443,"wires":[["d1bd252c.b21a18"]]},{"id":"2ddf4092.269658","type":"function","z":"b6f9906e.c78c18","name":"Response Msg_old","func":"msg.headers = {\n// QL: 'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTM5NmM5NGE4YzE0ZjY1MDAwZjJkMTEifQ.eyJzY29wZSI6ImFwcCJ9._Zt5vt6zg9lCHvC5xYYa0QorhyerPjkkzaQS4UyaLzk' \n'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81YWE1YThlOTRlNmVhODAwMjIyYTkxOTAifQ.eyJzY29wZSI6ImFwcCJ9.GRIwtUbEgmfDa8NjSkGsSpdmFHAEpob5yojS7Uj-GMo',\n      'content-type': 'application/json'\n};\n\n/** Added by Nitin to extract name using Watson API **/\nvar outTexts = \" \";\nvar uppercase_text;\noutTexts = msg.payload.output.text[0];\nuppercase_text = outTexts.toUpperCase();\nvar m_call_alchylme = \"No\";\nglobal.set(\"m_node_path\",\"Reg\");\nmsg.additional_context.angerName = \"m_node_path - Reg\";\nmsg.additional_context.disgustName= uppercase_text;\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nnode.error(\"Delay - Begin\");\n\nif (uppercase_text.lastIndexOf(\"YOUR NAME\") >= 0 ) {\n    global.set(\"ask_name_next\",\"YES\");\n    msg.additional_context.fearName = \"ask_name_next - YES\";\n}\n else {\n     var m_last_val = global.get(\"ask_name_next\");\n     msg.additional_context.fearName = \"m_last_val\" + m_last_val;\n     switch(m_last_val) {\n        case 'YES':\n           var get_name = msg.payload.input.text;\n           var m_call_alchylme = \"Yes\";\n           global.set(\"m_node_path\",\"Alc\");\n           //msg.additional_context = \"Alc\";\n           global.set(\"ask_name_next\", \"NO\");\n           msg.payload = \"my name is \" + get_name;\n             node.send(msg); \n           break;\n     }\n }\n\n\n/** Added upto Here ****/\n\n\n\n//if (m_call_alchylme.lastIndexOf(\"No\") >= 0) {\nif (m_call_alchylme == \"No\") { \nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\nnode.log(\"****context**** \" + Watson_context);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar typeMsg = \" \";   /* Added by NAK */\nvar response = {};\nvar component = \"\";\nnode.log(\"*********** Output is ************\" + Myresponse);\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n     node.log(\"Found a old maps at index:\", findindex);\n     node.log(Myresponse);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n     Newmsg = texts[i]; \n     node.log(\"**********  length ******* \" + texts.length);\n     node.log(\"start with \" + Newmsg);\nvar component = \"\";\nvar mapStr = \"\";\nvar actions = {};\nvar actionsArr = [];\nvar actionsRArr = [];\nvar buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\nvar m_url = \"\";\n//simple buttons\nif (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     node.log(\"Found a buttons at index:\", findindex);\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n    \n     /* Added by NAK */\n     /** Check Type encoded between <> e.g. <button>,<link>,<image> */\n     /** Check Lable encoded between {} e.g. {lable1},{lable2} */\n     type_findindex = Newmsg.lastIndexOf(\"<\");\n     type_findLastindex = Newmsg.lastIndexOf(\">\");\n     lable_findindex = Newmsg.lastIndexOf(\"{\");\n     lable_findLastindex = Newmsg.lastIndexOf(\"}\");\n     /* Added by NAK Upto Here */\n     \n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     \n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n     /* Added by NAK - Look for optional lable */\n     if ((lable_findindex > 0) && (lable_findLastindex > 0) ){\n          var buttonLableArr  = tempStr.substring(lable_findindex+1, lable_findLastindex).split(\",\");\n    } else {\n        var buttonLableArr = buttonArr;\n     }\n     \n     if (tempStr.lastIndexOf(\"<button>\") >= 0 ) {\n         typeMsg = \"button\";\n     }\n     else {\n       if (tempStr.lastIndexOf(\"<link>\") >= 0 ) {\n          typeMsg = \"link\";\n       }\n       else \n         if (tempStr.lastIndexOf(\"<image>\") >= 0 ) {\n            typeMsg = \"image\";\n         }\n         else {\n          typeMsg = \"button\";\n      }\n     }\n      \n        \n    /* Added by NAK Upto Here */\n    switch(typeMsg) {\n    case 'button':\n        for (a = 0; a < buttonArr.length; a++) { \n           actionsArr.push({\"type\": \"reply\",\"text\": buttonLableArr[a],\"payload\": buttonArr[a]});\n        }\n        break;\n    case 'link': \n        component = \"buttonLink\";\n        actionsArr.push({\"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n        break;\n    case 'image':\n        component = \"buttonImage\";\n        m_url = buttonArr[0];\n        actionsArr.push({\"_id\" : msg.user, \"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n\n   }\n     actions = {\"actions\" : actionsArr};\n\n    // Added by Nitin K from Here\n /*   if (typeMsg == \"link\") {\n       component = \"buttonlink\";\n       actionsArr.push({\"type\": \"link\",\"text\": buttonLableArr[0],\"uri\": buttonArr[0]});  \n    }*/\n}\n\n/* Commented by NAK\nif (Newmsg.lastIndexOf(\"{\") >= 0 ) {\n     component = \"buttonlink\";\n     findindex = Newmsg.lastIndexOf(\"{\");\n     node.log(\"Found a buttons at index:\", findindex);\n     findLastindex = Newmsg.lastIndexOf(\"}\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\"|\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n    //    actionsArr.push({\"type\": \"link\",\"text\": buttonArr[a],\"uri\": buttonArr[a]});\n        actionsArr.push({\"type\": \"link\",\"text\": \"Link\",\"uri\": buttonArr[a]});\n     \n         \n     }\n     actions = {\"actions\" : actionsArr};\n}\nCommented upto Here **/\n// Added by Nitin K upto Here\n\n//json map\nnode.log(\"context: \" + Watson_context);\n//var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\nmapjsonObj = Watson_contextOBJ.map;\nif (typeof mapjsonObj.values != \"undefined\") {\n//node.log(\"mapjson: \" + mapjsonStr);\n//if (mapjsonStr  !== null){\n    component = \"map\";\n    for (var c in mapjsonObj.values) {\n      mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n      node.log(\"Found Json map str: \" + mapStr);\n      actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n //     actions = {\"actions\" : actionsArr };\n    }\n}\n\n//json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n// Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n//var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\nvar found_link = 0;\n//node.log(\"buttonjson: \" + buttonjsonStr);\nbuttonjsonObj = Watson_contextOBJ.button;\nif (typeof buttonjsonObj.values != \"undefined\") {\n  \n    for (var c in buttonjsonObj.values) {\n      buttonStr = buttonjsonObj.values[c];\n      node.log(\"NK-buttonStr :\", buttonStr);\n      if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n        found_link = 1;\n        buttonItems = buttonStr.split(\"|\");\n        button_title = buttonItems[0];\n        button_url = buttonItems[1];\n        \n        actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n      }\n      else {\n        button_title = buttonStr;  \n        actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n       //actionsArr.push({\"type\": \"postback\",\"text\": button_title,\"payload\": button_title}); \n      }\n    }  \n    if (found_link > 0) {\n       component = \"buttonLink\"; \n    }else {\n      component = \"buttonReply\";   \n    }\n}\n\n//old maps\nif (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n     node.log(\"Found a maps at index:\", findindex);\n     node.log(Newmsg);\n} \n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nNewmsg = Newmsg.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nNewmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n//msg.url = \"https://api.smooch.io/sdk/apps/5aa5a6e072b44a0022f43c5c/appusers/\"+msg.save_payload.appUser._id+\"/messages\";// + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/5aa5a6e072b44a0022f43c5c/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n//msg.url = msg.save_payload.fromUrl;\nnode.error(\"NK-Component :\", component + Newmsg);\nnode.error(msg);\nswitch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"nitin421505-1@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",  //\"text\",\n        //payload : actionsRArr,\n        text : Newmsg,\n        //email: \"nitin421505-3@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'buttonImage':\n     response = {\n        _id  : msg.user,\n        role : \"appMaker\",\n        type : \"image\",   \n        text : Newmsg,\n        mediaUrl : m_url,\n        mediaType : \"image\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"nitin421505@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appUser\",\n        type : \"text\",\n        text : \"Ack from Application\", //msg.payload.output.text,\n        email: \"watson40985@gmail.com\"\n        //,\n        //actions : actionsArr\n        }\n}\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n node.error(\"****First Send: ******* \" + JSON.stringify(response));\n  msg.payload = response;\n  node.error(msg);\n  global.set(\"prev_msg\",msg.payload);\n//  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"nitin421505@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    node.log(\"****Second Send: ******* \" + JSON.stringify(response));\n    msg.payload = response;\n    global.set(\"prev_msg\",msg.payload);\n    node.send(msg);  \n  }\n }\n}\n}\nreturn null;","outputs":"1","noerr":0,"x":1112,"y":843,"wires":[[]]},{"id":"9fc0df6.b7381a","type":"delay","z":"b6f9906e.c78c18","name":"Send one message at a time","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1640,"y":360,"wires":[["ace586f1.65b638"]]},{"id":"33d61eeb.f3dbe2","type":"inject","z":"b6f9906e.c78c18","name":"@start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"","x":330,"y":100,"wires":[["2599b06a.f77f"]]},{"id":"2599b06a.f77f","type":"function","z":"b6f9906e.c78c18","name":"clear global_var","func":"var m1 = undefined;\nnode.error(m1);\nglobal.set(\"wcs_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"global_Check_context\",m1);\nglobal.set(\"wcs_tag_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"wcs_id_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"Check_NLC_02aaa89716d5b27e3a37aab3\", m1);\nglobal.set(\"Save_Context_02aaa89716d5b27e3a37aab3\",m1);\n\nglobal.set(\"wcs_tag_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"wcs_id_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"Check_NLC_846ebb6b596dbe429b3e1c87\", m1)\nglobal.set(\"Save_Context_846ebb6b596dbe429b3e1c87\",m1);\n\nglobal.set(\"wcs_tag_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"wcs_id_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"Check_NLC_5ab2aac0df704a0022810445\", m1)\nglobal.set(\"Save_Context_5ab2aac0df704a0022810445\",m1);\n\nglobal.set(\"wcs_tag_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"wcs_id_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"Check_NLC_5ab2a36c8716ad0023ae4beb\", m1)\nglobal.set(\"Save_Context_5ab2a36c8716ad0023ae4beb\",m1);\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":100,"wires":[[]]},{"id":"47235bf6.ba53bc","type":"switch","z":"b6f9906e.c78c18","name":"","property":"Skip_Output","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1252,"y":483,"wires":[["5f522d51.282a4c"],["dae14bc6.30b298"]]},{"id":"fbf25ea7.89aaf8","type":"debug","z":"b6f9906e.c78c18","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":572,"y":603,"wires":[]},{"id":"b00ee72d.01f3e8","type":"function","z":"b6f9906e.c78c18","name":"Check","func":"node.error(\"Inside Check Node - Response from WCS\");\n//node.error(msg);\nmsg.tmp_Switch_Workspace = \"No\";\nif (typeof msg.payload.context.Switch_Workspace !== 'undefined') {\n    //node.error(\"Check-1\");\n    if (msg.payload.context.Switch_Workspace.length > 0 ) {\n        msg.tmp_Switch_Workspace = \"Yes\";\n         //node.error(\"Check-2\");\n    }\n}\nif (msg.tmp_Switch_Workspace === \"Yes\") {\n    if (msg.curr_wcs_num === msg.payload.context.Switch_Workspace) {\n        msg.tmp_Switch_Workspace = \"No\";\n    }\n    else {\n       var user_glob_var = \"wcs_\" + msg.save_payload.appUser._id ;\n       var m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       if (msg.payload.context.Switch_Workspace !== \"\") {\n           global.set('\"'+user_glob_var+'\"',msg.payload.context.Switch_Workspace);\n           global.set(\"global_Check_context\", \"Yes\");\n           global.set(\"global_Root\", msg.payload.context.Root);\n           global.set(\"global_Child\",msg.payload.context.Child);\n           node.error(\"Workspace Swtiched initiated\");\n       } \n        \n    }\n}\nnode.error(\"Check - Switch Workspace ? \" + msg.tmp_Switch_Workspace);\n\nreturn msg;","outputs":1,"noerr":0,"x":1450,"y":280,"wires":[[]]},{"id":"5f522d51.282a4c","type":"function","z":"b6f9906e.c78c18","name":"Restore MSG Payload","func":"msg.payload = msg.save_payload;\n//msg.payload.messages[0].text = \" \";\nnode.error(\"Skipping output\");\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1072,"y":443,"wires":[["6f59f744.003318"]]},{"id":"58141dc2.37bd5c","type":"debug","z":"b6f9906e.c78c18","name":"NLC-Output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1170,"y":100,"wires":[]},{"id":"9d973372.77774","type":"watson-natural-language-classifier","z":"b6f9906e.c78c18","name":"Check NLC / Get WCS ID","mode":"classify","language":"en","classifier":"2fc15ax329-nlc-497","default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/natural-language-classifier/api","x":950,"y":240,"wires":[["58141dc2.37bd5c","5f249a5d.fc2a74"]]},{"id":"24a124f3.076784","type":"function","z":"b6f9906e.c78c18","name":"Set Params-WCS","func":"node.error(\"Nak-Inside setparms wcs\");\nnode.error(msg);\n\nvar wcs_username = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nvar wcs_password = \"UplCjXHkuLgj\";\n\n\nvar m_cur_wcs_tag = \"\";\nvar m_cur_wcs_id = \"\";\nvar m_wcs_username = \"\";\nvar m_wcs_password = \"\";\n\nif (msg.Check_NLC !== \"Yes\") {\n    node.error(\"Retrived prior wcs ID\");\n    var user_glob_wcs_tag = \"wcs_tag_\" + msg.save_payload .appUser._id ;\n    var user_glob_wcs_id = \"wcs_id_\" + msg.save_payload .appUser._id ;\n    var user_glob_var = \"wcs_\" + msg.payload.appUser._id ;\n    if (typeof global.get('\"'+user_glob_wcs_tag+'\"') !== 'undefined' ) {\n      m_cur_wcs_tag = global.get('\"'+user_glob_wcs_tag+'\"');\n      m_cur_wcs_id  = global.get('\"'+user_glob_wcs_id+'\"');\n    }          \n    else {\n      m_cur_wcs_tag = global.get(\"global_default_wcs_tag\");\n      m_cur_wcs_id  = global.get(\"global_default_wcs_id\");\n    }  \n    msg.cur_wcs_tag = m_cur_wcs_tag;\n    msg.cur_wcs_id  = m_cur_wcs_id;\n}\n\n\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\n//var user = msg.payload.appUser._id;\n//var input = msg.payload.messages[0].text;\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     user = msg.payload.appUser._id;  \n   }\n}\n\nvar test  = JSON.stringify(msg.payload);\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n\nmsg.app = \"RegionsAssist\";\n\n\n//var params = {\n//     context: context,\n//     workspace_id : msg.cur_wcs_id,\n//     username: wcs_username,\n//     password: wcs_password\n//}\nvar additional_context = {\n    fname: fname,\n    map : map,\n    button: button \n    \n};\n\nif (input.lastIndexOf('/') >= 0 ) {\n     var myindex = input.lastIndexOf('/')\n     node.log(\"index at: \" + myindex)\n     var dateString = input\n     node.log(\"dateString : \" + dateString)\n     \n     var d = new Date(dateString)\n     node.log(\"d : \" + d)\n     var now = new Date()\n     node.log(\"today: \" + now)\n     var years = now.getFullYear() - d.getFullYear()\n     node.log(\"years: \" + years)\n     \n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     node.log(\"days: \" + days)\n     var age = years + days /365\n    \n     additional_context.age = Math.round(age *100)/100\n     node.log(\"age: \"+ context.age)\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     additional_context.ageEOY = Math.round(ageEOY * 100)/100\n     node.log(\"ageEOY: \"+ context.ageEOY)\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     additional_context.ageBOY = Math.round(ageBOY * 100)/100\n     node.log(\"ageBOY: \"+ context.ageBOY)\n}\nmsg.payload = input;\nmsg.params.workspace_id = msg.cur_wcs_id;\nmsg.params.username = wcs_username;\nmsg.params.password = wcs_password;\nmsg.user = user;\nmsg.additional_context = additional_context;\n\n// Restore Context from global variable **/\n/*\nif (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n        }\n        \nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    msg.params.context = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(msg);\n}\n**/\ndelete msg.params.context.Check_NLC;\ndelete msg.params.context.Skip_Output; \n\n//msg.cur_wcs_tag = m_wcs_tag;\n/**\nif (typeof msg.params.context.last_wcs_tag === 'undefined') {\n    msg.params.context.last_wcs_tag = \"\";\n    msg.params.context.last_user_input = \"\";\n    msg.params.context.last_nlc_repeat_count = 0;\n    msg.params.context.skip_loop_break = \"No\";\n}\n\nif (msg.params.context.last_user_input === input) {\n    msg.params.context.last_nlc_repeat_count++;\n    msg.params.context.last_wcs_tag = msg.params.context.last_wcs_tag + \";\" + msg.cur_wcs_tag;\n} else {\n    msg.params.context.last_nlc_repeat_count = 1;\n    msg.params.context.last_wcs_tag = msg.cur_wcs_tag;\n    msg.params.context.last_user_input = input;\n}  \n**/\n/**\nif (typeof global.get(\"global_Check_context\") !== 'undefined') {\n    if (global.get(\"global_Check_context\") === \"Yes\" ) {\n//        node.error(\"Set Context Variables from prior dialog\");\n//        node.error(msg);\n        if (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n        }\n        msg.params.context.Root = global.get(\"global_Root\");\n        msg.params.context.Child = global.get(\"global_Child\");\n        global.set(\"global_Check_context\", \"No\");\n        \n    }\n}\n*/\nmsg.Check_NLC = \"No\"; \nnode.error(\"msg object - input to WCS\");\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":970,"y":300,"wires":[["28f6d677.644052"]]},{"id":"fd7e6d06.4cd97","type":"switch","z":"b6f9906e.c78c18","name":"","property":"Check_NLC","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":240,"wires":[["9d973372.77774"],["24a124f3.076784"]]},{"id":"5f249a5d.fc2a74","type":"function","z":"b6f9906e.c78c18","name":"Get WCS","func":"var wcs_1_tag = \"Regions_NK_Test_1_Greeter\";\nvar wcs_1_id  = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\"\nvar wcs_2_tag = \"Regions-NK-Test-2-OLB\"\nvar wcs_2_id  = \"9e53d515-48de-4a7b-9af3-27f74a4bf043\"\nvar wcs_3_tag = \"Regions_NK_Test_3_FeeRefund\"\nvar wcs_3_id  = \"fa66ecc7-1528-45ea-9094-135b2f513fab\";\n\nglobal.set(\"global_default_wcs_tag\", wcs_1_tag);\nglobal.set(\"global_default_wcs_id\", wcs_1_id);\nnode.error(\"Inside Get WCS\");\nvar class_array = msg.payload.classes\nvar m_wcs_tag = \"\";\nvar m_wcs_id = \"\";\nvar m_wcs_confidence = 0;\n\nvar m_string = \"\"; \nvar m_validate_repeat = \"No\";\nvar m_proceed = \"Yes\";\n\nif (typeof msg.params.context.last_wcs_tag === 'undefined') {\n    msg.params.context.last_wcs_tag = \"\";\n    msg.params.context.last_user_input = \"\";\n    msg.params.context.last_nlc_repeat_count = 0;\n    msg.params.context.skip_loop_break = \"No\";\n}\nelse {\n   if (msg.params.context.last_user_input === msg.save_payload.messages[0].text) {\n      m_validate_repeat = \"Yes\";\n      m_string = msg.params.context.last_wcs_tag;\n      msg.params.context.last_nlc_repeat_count++;\n      node.error(\"Validate Repeat - Yes [\" + m_string + \"]\" );\n   }\n   else {\n      msg.params.context.last_nlc_repeat_count = 1;\n      msg.params.context.last_user_input = msg.save_payload.messages[0].text;\n   }\n}\n\nfor (i = 0; i < class_array.length; i++) {\n    if (m_validate_repeat === \"Yes\") {\n        if (m_string.indexOf(class_array[i].class_name) >= 0) {\n            m_proceed = \"No\";\n        }\n    }   \n    if (m_proceed === \"Yes\") {\n        switch (class_array[i].class_name) {\n           case  \"Regions_NK_Test_1_Greeter\" :\n           case  \"Regions-NK-Test-1-Greeter\" :\n               if (class_array[i].confidence > m_wcs_confidence) {\n                   m_wcs_tag = class_array[i].class_name;\n                   m_wcs_confidence = class_array[i].confidence;\n                   m_wcs_id = wcs_1_id;\n               }   \n               break;\n           case  \"Regions_NK_Test_2_OLB\" :\n           case  \"Regions-NK-Test-2-OLB\" :\n               if (class_array[i].confidence > m_wcs_confidence) {\n                   m_wcs_tag = class_array[i].class_name;\n                   m_wcs_confidence = class_array[i].confidence;\n                   m_wcs_id = wcs_2_id;\n               }   \n               break;\n           case  \"Regions_NK_Test_3_FeeRefund\" :\n           case  \"Regions-NK-Test-3-FeeRefund\" :\n               if (class_array[i].confidence > m_wcs_confidence) {\n                   m_wcs_tag = class_array[i].class_name;\n                   m_wcs_confidence = class_array[i].confidence;\n                   m_wcs_id = wcs_3_id;\n               } \n               break;\n       }\n    } else {m_proceed = \"Yes\";}\n}\n\nnode.error(\"m_wcs_tag \" + m_wcs_tag);\nif (m_wcs_tag === \"\") {\n    if (m_validate_repeat === \"Yes\") {\n        msg.params.context.skip_loop_break = \"Yes\";\n        node.error(\"Set for loop break\");\n    }\n    m_wcs_tag = global.get(\"global_default_wcs_tag\");\n    m_wcs_id  = global.get(\"global_default_wcs_id\");\n}    \nelse {\n     msg.params.context.skip_loop_break = \"No\";\n     if (m_validate_repeat === \"Yes\") {\n        msg.params.context.last_wcs_tag = msg.params.context.last_wcs_tag + \";\" + m_wcs_tag;\n     } \n     else { \n        msg.params.context.last_wcs_tag = m_wcs_tag; \n     }\n}    \nmsg.cur_wcs_tag=m_wcs_tag;\nvar user_glob_wcs_tag = \"wcs_tag_\" + msg.save_payload .appUser._id ;\nvar user_glob_wcs_id = \"wcs_id_\" + msg.save_payload .appUser._id ;\nvar user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n\n//node.error(\"NAK user_glob_var ==>[\" + user_glob_var +\"]\");\nglobal.set('\"'+user_glob_wcs_tag+'\"',m_wcs_tag);\nglobal.set('\"'+user_glob_wcs_id+'\"',m_wcs_id);\nglobal.set('\"'+user_glob_Check_NLC+'\"',\"No\");\n\nvar m_get_wcs_tag = global.get('\"'+user_glob_wcs_tag+'\"');\nvar m_get_wcs_id = global.get('\"'+user_glob_wcs_id+'\"');\nnode.error(\"Global Var : \" + m_get_wcs_tag + \"==> WCS Tag ==> \" + m_get_wcs_tag + \" [\"+m_get_wcs_id+\"]\");\nmsg.cur_wcs_tag = m_wcs_tag;\nmsg.cur_wcs_id  = m_wcs_id;\n\n//Restore msg.payload\n\nmsg.payload = msg.save_payload;\n    \nreturn msg;","outputs":1,"noerr":0,"x":1180,"y":240,"wires":[["24a124f3.076784"]]},{"id":"dae14bc6.30b298","type":"debug","z":"b6f9906e.c78c18","name":"None","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1280,"y":540,"wires":[]},{"id":"48188696.e4ff28","type":"function","z":"f3565267.58f28","name":"get global variable","func":"const nodeNameTitleMap = global.get('node_name_title_map')\nmsg.payload = nodeNameTitleMap\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":780,"wires":[["e29f680e.3f2828"]]},{"id":"16282e3c.6921ea","type":"function","z":"f3565267.58f28","name":"GET Watson Dialog Names","func":"const watson = global.get(\"watson\");\n//node.warn(watson)\n//const workspace_id = global.get(\"global_conv_wks\")\n//const username = global.get(\"global_conv_usr\")\n//const password = global.get(\"global_conv_pass\")\n\nconst workspace_id = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\nconst username = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nconst password = \"UplCjXHkuLgj\";\nnode.warn('setting up conversation to get dialog')\n//node.warn(username)\n//node.warn(password)\n//node.warn(workspace_id)\n\nconst conversation = watson.conversation({\n  username,\n  password,\n  version: 'v1',\n  version_date: '2017-05-26'\n});\n//node.warn(JSON.stringify(conversation, null, 2))\nconversation.getDialogNodes({workspace_id, page_limit: 10000}, (err, response) => {\n  if (err) {\n    node.warn('in error')\n    node.err(msg, err)\n  } else {\n    node.warn('in response')\n    let payload = response.dialog_nodes.reduce((outputObj, node) => {\n      outputObj[node.dialog_node] = node.title\n      return outputObj\n    }, {})\n    global.set(\"node_name_title_map\", payload);\n    node.send(msg)\n  }\n})","outputs":1,"noerr":0,"x":369.2858657836914,"y":778.1428890228271,"wires":[["48188696.e4ff28"]]},{"id":"99423fde.b3e648","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":740,"wires":[["16282e3c.6921ea"]]},{"id":"e29f680e.3f2828","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":800,"y":900,"wires":[]},{"id":"6a2811f5.e1f338","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":730,"y":580,"wires":[]},{"id":"f76f8ab4.342ac","type":"function","z":"f3565267.58f28","name":"prepare data for NLC","func":"node.error(\"inside nlc\");\n//node.error(msg);\nvar m_nlc = {intents:[]};\n\n\nvar i = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    //node.error(msg.payload.intents[i]);\n    if (i===0) {\n       m_nlc.intents.push({\n           \"intent\":\"intent\",\n           \"description\":\"description\",\n           \"wcsname\":\"wcsname\"\n       })\n    }\n    m_nlc.intents.push({\n        \"intent\" : msg.payload.intents[i].intent,\n        \"description\": msg.payload.intents[i].description,\n        \"wcsname\" : \"naktestwcs\"\n    })\n}\nmsg.payload = m_nlc;\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":620,"wires":[["70c7765.8165788","b80d975e.f300c8"]]},{"id":"893d523a.a90ef8","type":"function","z":"f3565267.58f28","name":"get intentsnunull","func":"var watson2 = context.global.watson; //require('watson-developer-cloud');\n//const watson = global.get(\"watson\");\n\nconst workspace_id2 = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\nconst username2 = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nconst password2 = \"UplCjXHkuLgj\";\n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2\n  //,\n  //intent: 'Hello'\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      node.error(response);\n      msg.payload = response;\n      node.send(msg);\n    //console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":440,"y":540,"wires":[["f76f8ab4.342ac"]]},{"id":"258dc151.fea416","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":560,"wires":[["893d523a.a90ef8"]]},{"id":"c50fa107.c77d5","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":940,"wires":[]},{"id":"97e7e21e.7df248","type":"function","z":"f3565267.58f28","name":"prepare data for NLC","func":"node.error(\"inside nlc\");\n//node.error(msg);\nvar m_nlc = {intents:[]};\nvar m_nlc_array = msg.payload;\nmsg.payload = [];\nvar i = 0;\nfor (i=0; i<m_nlc_array.intents.length;i++) {\n    //node.error(m_nlc_array.intents[i]);\n    msg.payload.push({\n        \"intent\" : m_nlc_array.intents[i].intent,\n        \"description\": m_nlc_array.intents[i].description,\n        \"wcsname\" : \"naktestwcs\"\n    })\n    \n\n}\nnode.error(\"shownlc\");\n//node.error(m_nlc);\n//msg.payload = m_nlc;\nmsg.username = '6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.password = 'sWVYahvWPb8j';\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":920,"wires":[["ef0041c0.c1e44","8e5e2e38.af5308"]]},{"id":"5de987cd.4728a","type":"function","z":"f3565267.58f28","name":"get intentsnunull","func":"var watson2 = context.global.watson; //require('watson-developer-cloud');\n//const watson = global.get(\"watson\");\n\nconst workspace_id2 = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\";\nconst username2 = \"3461c175-52b5-4c38-b1be-e9f3d458a701\";\nconst password2 = \"UplCjXHkuLgj\";\n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n \nvar params = {\n  workspace_id: workspace_id2\n  //,\n  //intent: 'Hello'\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      node.error(response);\n      msg.payload = response;\n      node.send(msg);\n    //console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":340,"y":860,"wires":[["97e7e21e.7df248"]]},{"id":"534bfa9b.41e79c","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":1020,"wires":[["5de987cd.4728a"]]},{"id":"b80d975e.f300c8","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":690,"y":520,"wires":[]},{"id":"70c7765.8165788","type":"csv","z":"f3565267.58f28","name":"","sep":",","hdrin":true,"hdrout":true,"multi":"mult","ret":"\\n","temp":"intent,description,wcsname","skip":"0","x":620,"y":680,"wires":[["6a2811f5.e1f338"]]},{"id":"5120468e.dd5f98","type":"csv","z":"f3565267.58f28","name":"","sep":",","hdrin":true,"hdrout":"","multi":"one","ret":"\\n","temp":"","skip":"0","x":760,"y":720,"wires":[["6a2811f5.e1f338"]]},{"id":"ef0041c0.c1e44","type":"csv","z":"f3565267.58f28","name":"","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\n","temp":"intent,description,wcsname","skip":"2","x":550,"y":920,"wires":[["c50fa107.c77d5","d5459de4.69be3"]]},{"id":"f6f0a102.8109b","type":"watson-natural-language-classifier","z":"f3565267.58f28","name":"Check NLC / Get WCS ID","mode":"create","language":"en","classifier":"2fc15ax329-nlc-497","default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/natural-language-classifier/api","x":510,"y":1000,"wires":[["497ff2a4.293cdc"]]},{"id":"497ff2a4.293cdc","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":730,"y":1000,"wires":[]},{"id":"bc9e8d47.d0721","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":1220,"wires":[["8264aeb.e0dc65"]]},{"id":"6f06b2da.fcf9ac","type":"function","z":"f3565267.58f28","name":"Get NLC Status","func":"//var watson2 = context.global.watson; //require('watson-developer-cloud');\n\nvar NaturalLanguageClassifierV1 = context.global.nlclib; //require('watson-developer-cloud/natural-language-classifier/v1');\n\nvar naturalLanguageClassifier = new NaturalLanguageClassifierV1({\n  username: '6d3138e7-c168-4a1b-bebe-be00e647e364',\n  password: 'sWVYahvWPb8j'\n});\n\nnaturalLanguageClassifier.getClassifier({\n  classifier_id: '2fc15ax329-nlc-497' },\n  function(err, response) {\n    if (err)\n      console.log('error:', err);\n    else\n    node.error(\"nak\");\n    node.error(response);\n      console.log(JSON.stringify(response, null, 2));\n});\n\nreturn msg;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":560,"y":1080,"wires":[[]]},{"id":"3a453f64.cee4e","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":1160,"wires":[]},{"id":"cc089be.4b07b68","type":"function","z":"f3565267.58f28","name":"Create Classifer","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\nmsg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.password= 'sWVYahvWPb8j'\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.username,\n  password: msg.password\n});\n \nvar params = {\n    metadata: JSON.stringify({language: 'en',name: 'My-Classifier-710'}),\n    training_data: fs.createReadStream('./nlcdev.csv')\n};\nnode.error(\"before calling\");\n//natural_language_classifier.create(params, \nnatural_language_classifier.createClassifier(params, \nfunction\n(err, response) {\nif\n (err) console.log(err);\nelse\n      msg.payload = response;\n      node.send(msg);\n\n});\n\nreturn msg;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":480,"y":1160,"wires":[["3a453f64.cee4e"]]},{"id":"d5459de4.69be3","type":"file","z":"f3565267.58f28","name":"/usr/src/node-red/keyfiles/nlcdev.csv","filename":"/usr/src/node-red/keyfiles/nlcdev.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","x":740,"y":860,"wires":[[]]},{"id":"5224d9c7.26b42","type":"function","z":"3875b180.c934ee","name":"Set Session","func":"global.set(\"session_\" + msg.payload.convoUser, msg.payload);\n\nreturn msg;","outputs":1,"noerr":0,"x":179.5,"y":54,"wires":[[]]},{"id":"57c7b107.17d028","type":"http request","z":"3c4552a3.b77ad6","name":"Cloudant-HTTPS","method":"POST","ret":"txt","url":"https://bdea5362-c793-408b-9b0a-698c42002903-bluemix.cloudant.com/session","tls":"","x":205,"y":46,"wires":[[]]},{"id":"5c99b9fa.0aae08","type":"function","z":"a39d88cb.3e3638","name":"Define Session","func":"//New Database Seesion Mgt\n// convoUser - Unique user id across channels\n// ConvoTS - Timestamp of actual WCS Call\n// convoSource - Source Channel Name, will be used in Convo\n//             - Examples (Alexa,Google Home, Slack, Phone, WebChat, Mobile)\n//convoPayload - actual return from WCS\n// Database document will be calles session\n// -- Index on convoUser and convoTS\n// -- We will write all WCS turns into the table\n// -- On retrieval  of the user session\n//    -- We will search by index put back last 5 documents sorted by convoTS descending\n//    -- assures first document will be the latest WCS user convo\n//\n// New fields for Reporting\n// convoDialog - <context.system.dialog_stack[0].dialog_node> from WSC\n// convoIntent - Root Vertical node. (Set ROOT-<name> in root vertical dialog node title in WCS that are applicable)\n// convoDialogType - Type of node - for business scoring SUCCESS, FAIL, etc. (Set SUCCESS-<name> or FAIL-<name> in dialog node title in WCS) \n// convoCounter - unique counter after change of Root Vertical\n// convoDialogElement - Intent or Entity name\n// conovDialogConfidence - confidence score\n// convoTransID = <username><convoIntent><date><convoCounter>     example:  dennisnoto-ROOT-ClaimStatus201701010823\n//   Unique ID for convo to summarize statistics\n// convoUtterance - user utterance\n// convoAnswer - Watson answer\n\n// Can chain  ROOT and FAIL  example ROOT-FAIL-<name>  This would signify a ROOT Vertical node with FAIL as the Type\n// Can chain  ROOT and SUCCESS  example ROOT-SUCCESS-<name>  This would signify a ROOT Vertical node with SUCCESS as the Type\n\nvar d = new Date();\n// MST Time Zone - 6 hours off UTC/GMT\nvar milliMST = 6*60*60*1000;\nvar localeDate = new Date(d.getTime()-milliMST);\nvar foundIntent = false;\nvar foundEntity = false;\nmsg.convoDialogIntents = \" \";\nmsg.convoDialogEntities = \" \";\n\n// Set Utterance\nif (typeof msg.payload.input !== \"undefined\") \n {msg.convoUtterance = msg.payload.input.text;}\n\n//Set Answer\nif (typeof msg.payload.output !== \"undefined\") \n { //msg.convoAnswer = msg.payload.output.text[0]\n  msg.convoAnswer = \"\";\n  var texts = msg.payload.output.text;\n  for (i = 0; i < texts.length; i++) \n    {msg.convoAnswer = msg.convoAnswer + \" \" + texts[i]; }\n     msg.convoAnswer = msg.convoAnswer.replace(/\\[(.*?)\\]/g, \"\");\n  }\n// Set DialogIntents and DialogEntities\nif (typeof msg.payload.intents[0] !== \"undefined\")\n { foundIntent = true;\n   for (i = 0; i < msg.payload.intents.length; i++) \n   { msg.convoDialogIntents = msg.convoDialogIntents + msg.payload.intents[i].intent + \",\"; }  \n }\n\nif (typeof msg.payload.entities[0] !== \"undefined\")\n { foundEntity = true;\n   for (i = 0; i < msg.payload.entities.length; i++) \n   { msg.convoDialogEntities = msg.convoDialogEntities + msg.payload.entities[i].entity + \",\"; }\n }\n// Set confidence\nif (foundIntent === true && foundEntity === true) \n    {msg.convoDialogConfidence = (msg.payload.intents[0].confidence + msg.payload.entities[0].confidence)/2; }\nelse if (foundIntent === true)  \n    {msg.convoDialogConfidence = msg.payload.intents[0].confidence;}\nelse if (foundEntity === true)     \n    {msg.convoDialogConfidence = msg.payload.entities[0].confidence;}\nelse \n    {msg.convoDialogConfidence = 0;}\n\n// Set and change convoIntent by identifying Root Vertical Nodes. (Set ROOT-<name> in root vertical dialog node title in WCS that are applicable)\n// Could find if node is ROOT by calling WCS api for dialog-node, but would be an extra api\nif (typeof msg.payload.context.system.dialog_stack[0] !== \"undefined\") \n {msg.convoDialogNode = msg.payload.context.system.dialog_stack[msg.payload.context.system.dialog_stack.length - 1].dialog_node;\n  \n  if (msg.convoDialogNode === \"root\")\n    {msg.convoDialogNode = msg.payload.output.nodes_visited[msg.payload.output.nodes_visited.length - 1];}   \n }\nelse\n  msg.convoDialogNode = \" \";\n  \n// Find convoIntent\nif (typeof msg.session == \"undefined\") \n     if (msg.convoDialogNode.match(/ROOT-/g) )\n         {msg.convoIntent = msg.convoDialogNode;\n          msg.convoCounter = 1;}   \n    else \n         {msg.convoIntent = \"\";\n          msg.convoCounter = 0;} \n       \nelse if (msg.convoDialogNode.match(/ROOT-/g) )\n   \n   if (msg.convoDialogNode !== msg.session.convoIntent || msg.session.convoIntent === \"\") \n       {msg.convoIntent = msg.convoDialogNode;\n        msg.convoCounter = msg.session.convoCounter + 1;}\n    else  \n       {msg.convoIntent = msg.session.convoIntent;\n        msg.convoCounter = msg.session.convoCounter;}\nelse\n   {msg.convoIntent = msg.session.convoIntent;\n    msg.convoCounter = msg.session.convoCounter;}\n\n// Set node type for scoring. (Set SUCCESS-<name> or FAIL-<name> in dialog node title in WCS) \nif (msg.convoDialogNode.match(/SUCCESS-/g) )\n    {msg.convoDialogType = \"SUCCESS\";\n     msg.convoContainmentScore = 100;}\nelse if (msg.convoDialogNode.match(/FAIL-/g) )\n         {msg.convoDialogType = \"FAIL\";\n          msg.convoContainmentScore = -100;}\nelse if (msg.convoDialogConfidence >= 0.7 )\n         {msg.convoDialogType = \"High_Confidence\";\n          msg.convoContainmentScore = 10;}\nelse if (msg.convoDialogConfidence >= 0.4 && msg.convoDialogConfidence < 0.7)\n         {msg.convoDialogType = \"Medium_Confidence\";\n          msg.convoContainmentScore = 5;}\nelse if (msg.convoDialogConfidence >= 0.2 && msg.convoDialogConfidence < 0.4)\n         {msg.convoDialogType = \"Low_Confidence\";\n          msg.convoContainmentScore = -5;}\nelse if (msg.convoDialogConfidence > 0 && msg.convoDialogConfidence < 0.2)\n         {msg.convoDialogType = \"No_Confidence\";\n          msg.convoContainmentScore = -10;}\nelse {msg.convoDialogType = \"UNKNOWN\";\n      msg.convoContainmentScore = 0;}\n         \n         \nvar sessionMsg = {\n    payload : {\n    convoUser : msg.user,\n    wcs_user_name : msg.params.username,\n    wcs_password : msg.params.password,\n    workspace_id : msg.params.workspace_id,\n    convoTS : localeDate,\n    convoSource : msg.source,\n    convoIntent : msg.convoIntent,\n    convoDialogNode : msg.convoDialogNode,\n    convoDialogType : msg.convoDialogType,\n    convoDialogIntents : msg.convoDialogIntents,\n    convoDialogEntities : msg.convoDialogEntities,\n    convoDialogConfidence : msg.convoDialogConfidence,\n    convoContainmentScore : msg.convoContainmentScore,\n    convoCounter : msg.convoCounter,\n    convoTransID : msg.user + msg.convoIntent + localeDate.getFullYear()+ localeDate.getMonth()+1 + localeDate.getDate() + localeDate.getHours() + msg.convoCounter.toString(), \n    convoUtterance : msg.convoUtterance,\n    convoAnswer : msg.convoAnswer,\n    convoPayload : msg.payload\n    }\n};\n\nreturn [msg,sessionMsg];","outputs":"2","noerr":0,"x":224.9444580078125,"y":40.222259521484375,"wires":[[],["8090f129.371b78"]]},{"id":"8090f129.371b78","type":"subflow:13cf4536.6ed6fb","z":"a39d88cb.3e3638","x":441.9765625,"y":101.17121887207031,"wires":[]},{"id":"20995e55.5ab1e2","type":"subflow:3c4552a3.b77ad6","z":"a39d88cb.3e3638","name":"SetCloudantSession","x":456,"y":156,"wires":[]},{"id":"4627cef6.0a68a8","type":"subflow:3875b180.c934ee","z":"a39d88cb.3e3638","x":456.5,"y":214,"wires":[]},{"id":"a1725972.abe638","type":"comment","z":"a39d88cb.3e3638","name":"Wire up a Session storage subflow","info":"For prototyping use SetNodeRedSession\n\nFor Enterprise use either Redis or Cloudant\n\nNote you will need a Redis/Cloudant service if\npick one of the Enterprise methods.","x":164.5,"y":148,"wires":[]},{"id":"e278a123.79404","type":"function","z":"4fb1364d.094cf8","name":"Get Session","func":"msg.session = global.get(\"session_\" + msg.user); \n\nreturn msg;","outputs":1,"noerr":0,"x":215.5,"y":62,"wires":[[]]},{"id":"8c2e60ad.ed68b","type":"comment","z":"b8bcf4c.143c608","name":"Must have cloudant Index on convoUser and convoTS ","info":"","x":329.48028564453125,"y":99.02044677734375,"wires":[]},{"id":"385e652a.bebb42","type":"function","z":"b8bcf4c.143c608","name":"Get Session","func":"msg.savePayload = msg.payload\n\nmsg.headers = {\"Content-type\" : \"application/json\"}\n\n\n//testing new users\n//msg.user = \"dennisnoto@gmail.com\"\n\nmsg.payload = {selector: {\n     convoUser: {$eq: msg.user}     },\n     sort: [{convoUser:\"desc\"},{convoTS: \"desc\"}],    \n     limit: 5\n}\n\n\n\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":174.3333396911621,"y":45.44444561004639,"wires":[["f4fefe9d.3fe03"]]},{"id":"13b1b3fd.bb3b6c","type":"function","z":"b8bcf4c.143c608","name":"Set Session","func":"//sesion object from Cloudant DB\n\nif (typeof msg.payload.docs !== \"undefined\")\n  {msg.session = msg.payload.docs[0]}\nelse \n  { \n      \n}\n   \n//reset payload from channel to continue flow\nmsg.payload = msg.savePayload\nreturn msg;","outputs":1,"noerr":0,"x":584,"y":45,"wires":[[]]},{"id":"f4fefe9d.3fe03","type":"http request","z":"b8bcf4c.143c608","name":"Cloudant-HTTPS","method":"POST","ret":"obj","url":"https://bdea5362-c793-408b-9b0a-698c42002903-bluemix.cloudant.com/session/_find","tls":"","x":392,"y":46,"wires":[["13b1b3fd.bb3b6c"]]},{"id":"cd98f957.07401","type":"subflow:440e09de.708d78","z":"5e5f60e7.f240c8","name":"","x":222.872802734375,"y":43.61785697937012,"wires":[[]]},{"id":"a4e909aa.cc69a8","type":"subflow:b8bcf4c.143c608","z":"5e5f60e7.f240c8","x":231.92857360839844,"y":109.01022052764893,"wires":[[]]},{"id":"f3906077.a41628","type":"subflow:4fb1364d.094cf8","z":"5e5f60e7.f240c8","name":"","x":227.92857360839844,"y":177.85714530944824,"wires":[[]]},{"id":"a3641738.9f0268","type":"comment","z":"5e5f60e7.f240c8","name":"Wire up at least one of the Session functions","info":"Choose \n   GetNodeRedSession for prototyping\n   \nEnterprise use\nChoose \n   GetCloudantSeesion for DB Session\nor\n   GetRedisSession for Memory Cache\n   \nPlease note that you will need to wire up the\ncorresponding Set Session subflow","x":227.5,"y":349,"wires":[]},{"id":"c357c92f.d7001","type":"http in","z":"401cee62.babb8","name":"Mobile HTTP in","url":"/mobile","method":"post","swaggerDoc":"","x":100,"y":101.25000190734863,"wires":[["b4cbc31a.23856"]]},{"id":"86725611.f9f488","type":"function","z":"401cee62.babb8","name":"Set Params","func":"msg.source = \"Mobile\"\nvar temp_msg = msg.payload.input\nvar workspace_id = msg.payload.workspace_id\nvar wcs_user_name = msg.payload.wcs_username\nvar wcs_password = msg.payload.wcs_password\n\n// Uncomment when New param to added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.payload.fname\nvar lname = msg.payload.lname\nvar nname = msg.payload.nname\nvar cvalue1 = msg.payload.cvalue1\nvar cvalue2 = msg.payload.cvalue2\nvar cvalue3 = msg.payload.cvalue3\n\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id \n   }\n   \nif (typeof context.button == \"object\"){\n    delete context.button\n}\nif (typeof context.map == \"object\"){\n    delete context.map\n}\nif (typeof context.movie == \"object\"){\n    delete context.movie\n}\nif (typeof context.checkbox == \"object\"){\n    delete context.checkbox\n}\nif (typeof context.barscore == \"object\"){\n    delete context.barscore\n}\n\n\nif (temp_msg.substring(0,2) == 'Hi') {\n   //Uncomment if you want the convo to start at begining when app starts\n   //context = {}\n}\n\ncontext.username = msg.user\ncontext.fname = fname\ncontext.lname = lname\ncontext.nname = nname\ncontext.cvalue1 = cvalue1\ncontext.cvalue2 = cvalue2\ncontext.cvalue3 = cvalue3 \ncontext.source = msg.source\n\n//node.log(JSON.stringify(msg.payload));\nmsg.payload = temp_msg;\n\nvar params = {\n     context: context, \n     workspace_id : workspace_id,\n     username : wcs_user_name,\n     password : wcs_password\n}\n\nmsg.payload = temp_msg\nmsg.params = params\n\nreturn msg\n","outputs":1,"noerr":0,"x":643.333366394043,"y":100.0694408416748,"wires":[["e793fb97.299798","d7a80257.f71f5"]]},{"id":"5b46afe9.35a93","type":"function","z":"401cee62.babb8","name":"Response Msg","func":"var Watson_msg = msg.payload;\n\nvar Watson_response = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nnode.log(Watson_response)\n\nMyresponse = Watson_response.substring(2,Watson_response.length-2);\n\nif (Myresponse.substring(0,Myresponse,2) == \"\\\",\\\"\") {\n     Myresponse = Myresponse.substring(3,Myresponse.length)\n}\n    \n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n\nvar response = {\n    text: Myresponse,\n    username: \"Watson\",\n    context: Watson_context\n};\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Myresponse)\n\nmsg.payload = response\n\nreturn msg","outputs":1,"noerr":0,"x":1052.958366394043,"y":219.88888549804688,"wires":[["cc74f995.02057","44086e3c.da78b8"]]},{"id":"cc74f995.02057","type":"http response","z":"401cee62.babb8","name":"Http Response","statusCode":"","headers":{},"x":1304.9722709655762,"y":217.66665935516357,"wires":[]},{"id":"561e63d0.6ebbec","type":"function","z":"544bc80b.e141f8","name":"add Tone","func":"\n\nmsg.params.context.angerName = msg.response.document_tone.tone_categories[0].tones[0].tone_name;\nmsg.params.context.angerScore = msg.response.document_tone.tone_categories[0].tones[0].score.toFixed(3);\nmsg.params.context.disgustName = msg.response.document_tone.tone_categories[0].tones[1].tone_name;\nmsg.params.context.disgustScore = msg.response.document_tone.tone_categories[0].tones[1].score.toFixed(3);\nmsg.params.context.fearName = msg.response.document_tone.tone_categories[0].tones[2].tone_name;\nmsg.params.context.fearScore = msg.response.document_tone.tone_categories[0].tones[2].score.toFixed(3);\nmsg.params.context.joyName = msg.response.document_tone.tone_categories[0].tones[3].tone_name;\nmsg.params.context.joyScore = msg.response.document_tone.tone_categories[0].tones[3].score.toFixed(3);\nmsg.params.context.sadnessName = msg.response.document_tone.tone_categories[0].tones[4].tone_name;\nmsg.params.context.sadnessScore = msg.response.document_tone.tone_categories[0].tones[4].score.toFixed(3);\n\nmsg.params.context.analyticalName = msg.response.document_tone.tone_categories[1].tones[0].tone_name;\nmsg.params.context.analyticalScore = msg.response.document_tone.tone_categories[1].tones[0].score.toFixed(3);\nmsg.params.context.confidentName = msg.response.document_tone.tone_categories[1].tones[1].tone_name;\nmsg.params.context.confidentScore = msg.response.document_tone.tone_categories[1].tones[1].score.toFixed(3);\nmsg.params.context.tentativeName = msg.response.document_tone.tone_categories[1].tones[2].tone_name;\nmsg.params.context.tentativeScore = msg.response.document_tone.tone_categories[1].tones[2].score.toFixed(3);\n\nmsg.params.context.OpenName = msg.response.document_tone.tone_categories[2].tones[0].tone_name;\nmsg.params.context.OpenScore = msg.response.document_tone.tone_categories[2].tones[0].score.toFixed(3);\nmsg.params.context.conTitle = msg.response.document_tone.tone_categories[2].tones[1].tone_name;\nmsg.params.context.conScore = msg.response.document_tone.tone_categories[2].tones[1].score.toFixed(3);\nmsg.params.context.extName = msg.response.document_tone.tone_categories[2].tones[2].tone_name;\nmsg.params.context.extScore = msg.response.document_tone.tone_categories[2].tones[2].score.toFixed(3);\nmsg.params.context.agreeName = msg.response.document_tone.tone_categories[2].tones[3].tone_name;\nmsg.params.context.agreeScore = msg.response.document_tone.tone_categories[2].tones[3].score.toFixed(3);\nmsg.params.context.emoName = msg.response.document_tone.tone_categories[2].tones[4].tone_name;\nmsg.params.context.emoScore = msg.response.document_tone.tone_categories[2].tones[4].score.toFixed(3);\n\nreturn msg;\n","outputs":1,"noerr":0,"x":316.00000381469727,"y":33.33333396911621,"wires":[[]]},{"id":"b4cbc31a.23856","type":"function","z":"401cee62.babb8","name":"Get User","func":"\nmsg.user = msg.payload.username;\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":100,"wires":[["efb71e90.5ec"]]},{"id":"365d7b45.655e74","type":"http in","z":"ff67537b.e2624","name":"Load HTTP in","url":"/load","method":"post","upload":false,"swaggerDoc":"","x":97.47254180908203,"y":117.63736057281494,"wires":[["a41c42cd.11b3c"]]},{"id":"93b050e4.cebef","type":"function","z":"ff67537b.e2624","name":"Set Params","func":"msg.source = \"Load\";\n\nvar workspace_id = msg.req.query.workspace_id;\nvar wcs_user_name = msg.req.query.wcs_username;\nvar wcs_password = msg.req.query.wcs_password;\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname;\n\n//create a null context and test for session existance\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id \n   }\n \nvar newmsg = msg.req.query.text\nnewmsg = newmsg.replace(/'/g, \"\");  \nmsg.payload = newmsg\n\ncontext.fname = fname\n\nvar params = {\n    context: context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password\n};\n\nmsg.payload = newmsg\nmsg.params = params\n\nreturn msg\n","outputs":1,"noerr":0,"x":610.3296813964844,"y":117.63736915588379,"wires":[["12944cd3.d6e903","acebf2cb.3aecf"]]},{"id":"e57d91ca.5da908","type":"function","z":"ff67537b.e2624","name":"Respone Msg","func":"var Watson_msg = msg.payload;\nvar Watson_response = JSON.stringify(msg.payload.output.text);\n\nvar texts = msg.payload.output.text\ntotalText = \"\"\nfor (i = 0; i < texts.length; i++) {\n    \n    if (texts[i].lastIndexOf(\"[\") >= 0 ) {\n       findindex = texts[i].lastIndexOf(\"[\");\n       texts[i] = texts[i].substring(0,findindex);\n    } \n \n  // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n   texts[i] = texts[i].replace(/\\\\/g, \"\");\n  //Dennis - Remove XML SSML tags from chat systems\n   texts[i] =  texts[i].replace(/<[^>]+>/g, \"\");\n \n  if (texts[i].lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = texts[i].lastIndexOf(\"InsMap\")\n     texts[i] = texts[i].substring(0,findindex)\n  } \n  \n  totalText = totalText + \" \" + texts[i]\n}\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + totalText)\n\nmsg.payload = totalText;\n\nreturn msg;","outputs":"1","noerr":0,"x":1087.154037475586,"y":237.0989170074463,"wires":[["80eb081c.315c58","29adcec8.7c3032"]]},{"id":"a41c42cd.11b3c","type":"function","z":"ff67537b.e2624","name":"Get User","func":"\nmsg.user =  msg.req.query.user_id;\n\nreturn msg;","outputs":1,"noerr":0,"x":254.61540985107422,"y":116.92308044433594,"wires":[["e6a252cd.e53bf"]]},{"id":"80eb081c.315c58","type":"http response","z":"ff67537b.e2624","name":"Http Response","x":1322.8498992919922,"y":235.00366020202637,"wires":[]},{"id":"47f28e60.a6b14","type":"http in","z":"9f54b786.c40c38","name":"Alexa Request","url":"/Alexa","method":"post","swaggerDoc":"","x":81.42857360839844,"y":140.15872192382812,"wires":[["b581fbc7.b563d8"]]},{"id":"b581fbc7.b563d8","type":"switch","z":"9f54b786.c40c38","name":"Sort Request","property":"payload.request.type","propertyType":"msg","rules":[{"t":"eq","v":"LaunchRequest","vt":"str"},{"t":"eq","v":"IntentRequest","vt":"str"},{"t":"eq","v":"SessionEndedRequest","vt":"str"},{"t":"else"}],"checkall":"true","outputs":4,"x":257.8253936767578,"y":138.84127044677734,"wires":[["1238d7e5.e1611"],["7ba4e715.70d27"],[],[]]},{"id":"26687dab.932f6a","type":"function","z":"9f54b786.c40c38","name":"Set Params","func":"msg.source = \"Alexa\"\nvar fname = msg.req.query.fname;\nvar workspace_id = msg.req.query.workspace_id;\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n\nif (msg.payload.request.type ==\"LaunchRequest\") {\n   var temp_msg = \"Hello\";\n   //Uncomment if you want the convo to start at begining when a Launch is dedected\n   //context = {}\n}\nelse {\n   var temp_msg = msg.payload.request.intent.slots.command.value; \n}\n\n//Zero out maps \nvar map = JSON.parse(\"{}\");  \n\nvar newmsg = temp_msg.replace(\"Watson\", \"\");\nmsg.payload = newmsg;\n\n\nglobal.set(\"last_question\",newmsg);\n\ncontext.fname = fname\ncontext.map = map\n\nvar params = {\n    context : context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password,\n    source : msg.source\n};\n\nmsg.payload = newmsg\nmsg.params = params\n\nreturn msg\n\n","outputs":1,"noerr":0,"x":910.0893135070801,"y":121.51785087585449,"wires":[["1b3ce958.917b3f","48382bcb.9a68bc"]]},{"id":"7ba4e715.70d27","type":"switch","z":"9f54b786.c40c38","name":"Sort by Intent","property":"payload.request.intent.name","propertyType":"msg","rules":[{"t":"eq","v":"CallWatson","vt":"str"},{"t":"eq","v":"Fradulent_Trancation","vt":"str"},{"t":"else"}],"checkall":"true","outputs":3,"x":405.3332824707031,"y":247.11111450195312,"wires":[["1238d7e5.e1611"],["1238d7e5.e1611"],[]]},{"id":"1b3ce958.917b3f","type":"debug","z":"9f54b786.c40c38","name":"","active":true,"console":"false","complete":"true","x":1071.2360649108887,"y":45,"wires":[]},{"id":"f23f76b0.e54888","type":"function","z":"9f54b786.c40c38","name":"Response Msg","func":"//var Watson_msg = msg.payload;\n//var Watson_response = JSON.stringify(msg.payload.output.text);\n//var Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n//node.log(Watson_response);\n//Myresponse = Watson_response.substring(2,Watson_response.length-2);\n\nvar texts = msg.payload.output.text\n\ntotalText = \"\"\nfor (i = 0; i < texts.length; i++) {\n    \n    if (texts[i].lastIndexOf(\"[\") >= 0 ) {\n       findindex = texts[i].lastIndexOf(\"[\");\n       texts[i] = texts[i].substring(0,findindex);\n    } \n  \n  texts[i] = texts[i].replace(/\\\\/g, \"\");\n  texts[i] = texts[i].replace('=\\\"number\\\" format=\\\"telephone\\\"', '=\\\"digits\\\"');\n  \n  totalText = totalText + \" \" + texts[i]\n}\n\nvar myquestion = global.get(\"last_question\");\n\nvar myEndSession = false;    \n\nif (myquestion.lastIndexOf(\"goodbye\") >= 0 )\n   {myEndSession = true}\n\n\nvar response = {\n    version : \"1.0\",\n    response : { \n       outputSpeech : { \n          //type : \"PlainText\",\n          type : \"SSML\",\n          ssml: \"<speak>\" + totalText + \"</speak>\"\n        },        \n    shouldEndSession : myEndSession,\n   // context: Watson_context\n    }\n};\n\n\n//json map\n//var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\nvar mapjsonObj = Watson_contextOBJ.map;\nif (typeof mapjsonObj.values != \"undefined\") {\n//node.log(\"mapjson: \" + mapjsonStr);\n//if (mapjsonStr  !== null){\n    component = \"map\";\n    for (var c in mapjsonObj.values) {\n      mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n    \n    response = {\n      version : \"1.0\",\n      response : { \n         outputSpeech : { \n            type : \"SSML\",\n            ssml: \"<speak>\" + totalText + \" Check your Alexa app for the map\" + \"</speak>\"\n          },        \n      card: {\n        type: \"Standard\",\n        title: \"Google Map\",\n        text: \"\",\n        image: {\n          smallImageUrl: mapjsonObj.values[c] + \"&size=500x300\",\n          largeImageUrl: mapjsonObj.values[c] + \"&size=600x400\"\n        }\n      },\n      shouldEndSession : myEndSession,\n   // context: Watson_context\n      }\n    \n     };   \n    \n   }\n}\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + totalText)\n\nmsg.payload = response\n\nreturn  msg;","outputs":1,"noerr":0,"x":1290.7856750488281,"y":237.571439743042,"wires":[["7066d285.ef8374","bfed9bb2.4c9588"]]},{"id":"7066d285.ef8374","type":"http response","z":"9f54b786.c40c38","name":"Http Response","statusCode":"","headers":{},"x":1522.7499885559082,"y":238.9999942779541,"wires":[]},{"id":"bfed9bb2.4c9588","type":"debug","z":"9f54b786.c40c38","name":"","active":true,"console":"false","complete":"payload","x":1484.8066291809082,"y":169.78635597229004,"wires":[]},{"id":"1238d7e5.e1611","type":"function","z":"9f54b786.c40c38","name":"Get User","func":"\nvar user_temp = msg.payload.session.user.userId;\nmsg.user =  user_temp.substring(user_temp.length-10, user_temp.length);\nreturn msg;","outputs":1,"noerr":0,"x":567.8571166992188,"y":120,"wires":[["b36ff609.60c37"]]},{"id":"4207e4ed.045c64","type":"http in","z":"8a20faf1.e98998","name":"Slack HTTP in","url":"/slack","method":"post","swaggerDoc":"","x":85,"y":121.25000095367432,"wires":[["43c56e2a.3f8e8"]]},{"id":"43c56e2a.3f8e8","type":"function","z":"8a20faf1.e98998","name":"slackVars","func":"var channel = msg.payload.channel_name;\nvar username = msg.payload.user_name;\nvar team = msg.payload.team_domain;\nvar text = msg.payload.text;\n\nnode.log(\"Team:\" + team);\nnode.log(\"username:\" + username);\nnode.log(\"channel:\" + channel);\nnode.log(\"text:\" + text);\n\nif(username == \"slackbot\") {\n    global.set(\"tlength\",0);}\nelse\n{global.set(\"tlength\",text.length); }\n\nvar test = global.get(\"tlength\")\nnode.log(\"length:\" + test);\n\nreturn msg;","outputs":1,"noerr":0,"x":261.25,"y":121.25,"wires":[["92a6ace2.4db4f"]]},{"id":"92a6ace2.4db4f","type":"switch","z":"8a20faf1.e98998","name":"","property":"tlength","propertyType":"global","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"false","outputs":2,"x":428.75,"y":120.62500095367432,"wires":[["1752eb77.2b2ad5"],["257c274c.9f004"]]},{"id":"223c5fea.7e4b58","type":"function","z":"8a20faf1.e98998","name":"Set Params","func":"msg.source = \"Slack\"\nvar channel = msg.payload.channel_name;\nvar team = msg.payload.team_domain;\nvar workspace_id = msg.req.query.workspace_id;\nvar wcs_user_name = msg.req.query.wcs_username;\nvar wcs_password = msg.req.query.wcs_password;\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n   \nvar temp_msg = msg.payload.text;\nvar newmsg = temp_msg.replace(\"Watson\", \"\");\nmsg.payload = newmsg;\n\nglobal.set(\"last_question\",newmsg);\nglobal.set(\"user\",msg.user);\ncontext.fname = fname\n\nvar params = {\n    context: context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password,\n    source : msg.source\n};\n\nmsg.payload = newmsg\nmsg.params = params\n\nreturn msg","outputs":1,"noerr":0,"x":921.2499771118164,"y":100.62500190734863,"wires":[["69dbcf69.4a6198","584a230d.5686b4"]]},{"id":"257c274c.9f004","type":"function","z":"8a20faf1.e98998","name":"unhandled chat","func":"node.log(msg.payload.text);","outputs":1,"noerr":0,"x":598.75,"y":160.62500095367432,"wires":[[]]},{"id":"b59e73f2.e516c8","type":"function","z":"8a20faf1.e98998","name":"1st Level msg","func":"//var Watson_msg = msg.payload;\n//var Watson_response = JSON.stringify(msg.payload.output.text);\n//Myresponse = Watson_response.substring(2,Watson_response.length-2);\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n//Myresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\n//Myresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n//var texts = Myresponse.split(\"\\\",\\\"\");\n\nvar texts = msg.payload.output.text\n\nfor (i = 0; i < texts.length; i++) {\n   Myresponse = texts[i];\n\n// causing issues for multiple output responses\n//if (Myresponse.match(\"\\\",\\\"\")) {\n  if (Myresponse.substring(0,Myresponse,2) == \"\\\",\\\"\") {\n     Myresponse = Myresponse.substring(3,Myresponse.length)\n}\n \nif (Myresponse.lastIndexOf(\"[\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"[\")\n     Myresponse = Myresponse.substring(0,findindex)\n} \nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\")\n     Myresponse = Myresponse.substring(0,findindex)\n} \n\n\nif (Myresponse.lastIndexOf(\"future training\") >= 0) {\n var response = {\n    text: \"Sorry I can't answer this question. Escalating to Second Level Support, please stand by\" ,\n    question: Myresponse,\n    escalate: \"Yes\",\n    username: \"Watson\",\n    icon_url: \"https://developer.ibm.com/watson/wp-content/uploads/sites/19/2015/01/IBM_Watson_avatar_pos.png\"\n};}\n\nelse {\n var response = {\n    text: Myresponse,\n    username: \"Watson\",\n    icon_url: \"https://developer.ibm.com/watson/wp-content/uploads/sites/19/2015/01/IBM_Watson_avatar_pos.png\"\n};}\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Myresponse)\nmsg.payload = response;\n\nnode.send([msg,msg]);\n}\nreturn null;\n","outputs":"2","noerr":0,"x":1167.7499923706055,"y":261.6250057220459,"wires":[["d2aaafcd.6094d","cd89a428.1949b"],["13201bc.ac608e4"]]},{"id":"d2aaafcd.6094d","type":"http request","z":"8a20faf1.e98998","name":"Slack Response","method":"POST","ret":"txt","url":"https://hooks.slack.com/services/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","tls":"","x":1422.527847290039,"y":256.06947898864746,"wires":[[]]},{"id":"cd89a428.1949b","type":"debug","z":"8a20faf1.e98998","name":"Level 1 message","active":true,"console":"false","complete":"payload.text","x":1429.7501373291016,"y":305.9027919769287,"wires":[]},{"id":"13201bc.ac608e4","type":"function","z":"8a20faf1.e98998","name":"2nd Level Msg","func":"\nnode.log(\"text:\" + msg.payload.text);\n\nif (msg.payload.escalate == \"Yes\"){\n  \nvar response = {\n    text: \"Level 1 Support member, \" + global.get(\"user\") + \", asked: \" + global.get(\"last_question\"),\n    username: \"Watson\",\n    icon_url: \"https://developer.ibm.com/watson/wp-content/uploads/sites/19/2015/01/IBM_Watson_avatar_pos.png\"\n};\n\nvar newMsg = {payload: response};}\n\nelse {\n    newMsg = null;\n}\nreturn newMsg;","outputs":1,"noerr":0,"x":1167.7499923706055,"y":361.6250057220459,"wires":[["5ecb6b56.f7c6fc","e235513c.27f808"]]},{"id":"5ecb6b56.f7c6fc","type":"http request","z":"8a20faf1.e98998","name":"Escalate 2ndLevell","method":"POST","ret":"txt","url":"https://hooks.slack.com/services/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","tls":"","x":1437.7499923706055,"y":361.6250057220459,"wires":[[]]},{"id":"e235513c.27f808","type":"debug","z":"8a20faf1.e98998","name":"Level 2 message","active":true,"console":"false","complete":"payload.text","x":1437.7499923706055,"y":421.6250057220459,"wires":[]},{"id":"1752eb77.2b2ad5","type":"function","z":"8a20faf1.e98998","name":"Get User","func":"\nmsg.user = msg.payload.user_id;\n\nreturn msg;","outputs":1,"noerr":0,"x":578.75,"y":100.62500095367432,"wires":[["99cc0b1a.6c986"]]},{"id":"b383e796.80281","type":"http in","z":"724cdd96.923cdc","name":"Mobile HTTP in","url":"/smooch","method":"post","swaggerDoc":"","x":85,"y":188.00000286102295,"wires":[["dca454aa.4948d","c8aff1ed.d33a68"]]},{"id":"7ff2b4db.6e9c7c","type":"function","z":"724cdd96.923cdc","name":"Set Params","func":"msg.source = \"WebChat\"\nvar workspace_id = msg.req.query.workspace_id;\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param to added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n  \n}else {\n   input = msg.payload.messages[0].text; \n}\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n\ncontext.fname = fname\ncontext.map = map\ncontext.button = button\ncontext.source = msg.source\n\nvar params = {\n     context: context,\n     workspace_id : workspace_id,\n     username : wcs_user_name,\n     password : wcs_password\n}\n\nmsg.payload = input;\nmsg.params = params;\n\nreturn msg;","outputs":1,"noerr":0,"x":631.2499771118164,"y":139.99998569488525,"wires":[["31af5cb5.59db04","6d100f22.afe078"]]},{"id":"6ddcf4.7e0eab0c","type":"function","z":"724cdd96.923cdc","name":"Response Msg","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81ODc5YWQ3NWQ2Y2MwMjJkMDAzOWQ4MzkifQ.eyJzY29wZSI6ImFwcCJ9.B3vjbL3IP1nZwndfWF9jr8V9XzsGIiRfQ_Hoq5ya9p8'\n     };\n\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\n\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n Newmsg = texts[i]; \n var component = \"\";\n var mapStr = \"\";\n var actions = {};\n var actionsArr = [];\n var actionsRArr = [];\n var buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n //simple buttons\n if (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n }\n\n //json map\n //var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\n mapjsonObj = Watson_contextOBJ.map;\n if (typeof mapjsonObj.values != \"undefined\") {\n //node.log(\"mapjson: \" + mapjsonStr);\n //if (mapjsonStr  !== null){\n    component = \"map\";\n    for (var c in mapjsonObj.values) {\n      mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n      actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n    }\n }\n\n //json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n // Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n //var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\n var found_link = 0;\n //node.log(\"buttonjson: \" + buttonjsonStr);\n buttonjsonObj = Watson_contextOBJ.button;\n if (typeof buttonjsonObj.values != \"undefined\") {\n  \n    for (var c in buttonjsonObj.values) {\n      buttonStr = buttonjsonObj.values[c];\n      if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n        found_link = 1;\n        buttonItems = buttonStr.split(\"|\");\n        button_title = buttonItems[0];\n        button_url = buttonItems[1];\n        \n        actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n      }\n      else {\n        button_title = buttonStr;  \n        actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n      }\n    }  \n    if (found_link > 0) {\n       component = \"buttonLink\"; \n    }else {\n      component = \"buttonReply\";   \n    }\n }\n\n //old maps\n if (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n } \n\n // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n Newmsg = Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n Newmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Newmsg)\n\n msg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\n\n switch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr};\n }\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n\n  msg.payload = response;\n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n}\n\nreturn null;","outputs":"1","noerr":0,"x":1280,"y":280,"wires":[["b19d471.e0073b8","33b4ad27.970a2a"]]},{"id":"2efa9463.f59314","type":"http request","z":"724cdd96.923cdc","name":"","method":"POST","ret":"txt","url":"","tls":"","x":1721.2499885559082,"y":279.9999952316284,"wires":[["29dde831.12b75"]]},{"id":"29dde831.12b75","type":"debug","z":"724cdd96.923cdc","name":"Call to Smooch","active":true,"console":"false","complete":"payload","x":1760,"y":180,"wires":[]},{"id":"e81778d2.6bced","type":"function","z":"724cdd96.923cdc","name":"Send post message","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81ODc5YWQ3NWQ2Y2MwMjJkMDAzOWQ4MzkifQ.eyJzY29wZSI6ImFwcCJ9.B3vjbL3IP1nZwndfWF9jr8V9XzsGIiRfQ_Hoq5ya9p8'\n     };\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + \"2e62e92fdee34a6ebd225c5a\" + \"/messages\";\n\nvar response = {\n    role : \"appMaker\",\n    type : \"text\",\n    text : \"hey what's up!!!\",\n    email: \"dennisnoto@gmail.com\",\n    actions : []\n};\n\nmsg.payload = response;\n\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":600,"wires":[["140cee13.c74e82"]]},{"id":"a6f10aca.ce49f","type":"inject","z":"724cdd96.923cdc","name":"","topic":"go","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":110,"y":600,"wires":[["e81778d2.6bced"]]},{"id":"dca454aa.4948d","type":"http response","z":"724cdd96.923cdc","name":"","x":270,"y":240,"wires":[]},{"id":"b19d471.e0073b8","type":"debug","z":"724cdd96.923cdc","name":"","active":true,"console":"false","complete":"payload","x":1430,"y":160,"wires":[]},{"id":"5acf166c.90f7c","type":"http in","z":"724cdd96.923cdc","name":"Postbacks","url":"/smooch-postback","method":"post","swaggerDoc":"","x":87.50003051757812,"y":297.12502574920654,"wires":[["dca454aa.4948d","70949ba.9c78664"]]},{"id":"70949ba.9c78664","type":"function","z":"724cdd96.923cdc","name":"actionPayload","func":"msg.headers = {\n    'app-token': '7788i215s5s6si7bp23uv33o9'\n     };\n\nmsg.user = msg.payload.appUser.userId;\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nmsg.actionPayload = msg.payload.postbacks[0].action.payload;\n\nresponse = {\n        role : \"appUser\",\n        type : \"text\",\n        text : msg.actionPayload\n};\n\nmsg.payload = response;\nreturn msg;","outputs":1,"noerr":0,"x":141.76921844482422,"y":389.9999990463257,"wires":[["d75a3f52.e7c6d"]]},{"id":"d75a3f52.e7c6d","type":"http request","z":"724cdd96.923cdc","name":"","method":"POST","ret":"txt","url":"","tls":"","x":360.53843688964844,"y":391.4615783691406,"wires":[[]]},{"id":"33b4ad27.970a2a","type":"delay","z":"724cdd96.923cdc","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1490,"y":280,"wires":[["2efa9463.f59314"]]},{"id":"f4977c9b.add4d8","type":"function","z":"724cdd96.923cdc","name":"Possible Reg only Response Message","func":"\nvar incomingTexts = msg.payload.output.text\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   currentCommand = msg.actionPayload;  \n}else {\n   currentCommand = \"\"; \n}\ncurrentCommand = currentCommand.toUpperCase();\nfor (i = 0; i < incomingTexts.length; i++) {\n     var instring = incomingTexts[i];\n     if ((instring.includes(\"my name is \")||instring.includes(\"my name's \")||instring.includes(\"I name is \")||instring.includes(\"My name is \")||instring.includes(\"My name's \"))&&( currentCommand == \"HELLO REGIONS ASSIST\")){\n    if (instring.includes(\"my name is \"))instring = instring.replace(\"my name is \",\"\");\n    if (instring.includes(\"my name's \"))instring = instring.replace(\"my name's \",\"\");\n    if (instring.includes(\"My name is \"))instring = instring.replace(\"My name is \",\"\");\n    if (instring.includes(\"My name's \"))instring = instring.replace(\"My name's \",\"\");\n    if (instring.includes(\"I name is\"))instring = instring.replace(\"I name is \",\"\");\n    node.warn(\"before parse msg is \"+instring);\n    msg.payload.output.text[i] = instring;\n    \n    }\n}\n\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81ODc5YWQ3NWQ2Y2MwMjJkMDAzOWQ4MzkifQ.eyJzY29wZSI6ImFwcCJ9.B3vjbL3IP1nZwndfWF9jr8V9XzsGIiRfQ_Hoq5ya9p8'\n     };\n\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\nnode.log(\"****context**** \" + Watson_context);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\nnode.log(\"*********** Output is ************\" + Myresponse);\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n     node.log(\"Found a old maps at index:\", findindex);\n     node.log(Myresponse);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n     Newmsg = texts[i]; \n     node.log(\"**********  length ******* \" + texts.length);\n     node.log(\"start with \" + Newmsg);\nvar component = \"\";\nvar mapStr = \"\";\nvar actions = {};\nvar actionsArr = [];\nvar actionsRArr = [];\nvar buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n//simple buttons\nif (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     node.log(\"Found a buttons at index:\", findindex);\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n}\n\n//json map\nnode.log(\"context: \" + Watson_context);\n//var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\nmapjsonObj = Watson_contextOBJ.map;\nif (typeof mapjsonObj.values != \"undefined\") {\n//node.log(\"mapjson: \" + mapjsonStr);\n//if (mapjsonStr  !== null){\n    component = \"map\";\n    for (var c in mapjsonObj.values) {\n      mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n      node.log(\"Found Json map str: \" + mapStr);\n      actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n //     actions = {\"actions\" : actionsArr };\n    }\n}\n\n//json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n// Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n//var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\nvar found_link = 0;\n//node.log(\"buttonjson: \" + buttonjsonStr);\nbuttonjsonObj = Watson_contextOBJ.button;\nif (typeof buttonjsonObj.values != \"undefined\") {\n  \n    for (var c in buttonjsonObj.values) {\n      buttonStr = buttonjsonObj.values[c];\n      if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n        found_link = 1;\n        buttonItems = buttonStr.split(\"|\");\n        button_title = buttonItems[0];\n        button_url = buttonItems[1];\n        \n        actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n      }\n      else {\n        button_title = buttonStr;  \n        actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n       //actionsArr.push({\"type\": \"postback\",\"text\": button_title,\"payload\": button_title}); \n      }\n    }  \n    if (found_link > 0) {\n       component = \"buttonLink\"; \n    }else {\n      component = \"buttonReply\";   \n    }\n}\n\n//old maps\nif (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n     node.log(\"Found a maps at index:\", findindex);\n     node.log(Newmsg);\n} \n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nNewmsg = Newmsg.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nNewmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\n\nswitch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr};\n}\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n node.log(\"****First Send: ******* \" + JSON.stringify(response));\n  msg.payload = response;\n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    node.log(\"****Second Send: ******* \" + JSON.stringify(response));\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n}\n\nreturn null;","outputs":1,"noerr":0,"x":193.75000762939453,"y":674.3749675750732,"wires":[[]]},{"id":"140cee13.c74e82","type":"http response","z":"724cdd96.923cdc","name":"","x":490,"y":600,"wires":[]},{"id":"c8aff1ed.d33a68","type":"function","z":"724cdd96.923cdc","name":"Get User","func":"\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   msg.user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     msg.user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     msg.user = msg.payload.appUser._id;  \n   }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["e005073f.a3e798"]]},{"id":"23ea8966.68881e","type":"http in","z":"fabc60c3.885ec8","name":"GoogleHome","url":"/GoogleHome","method":"post","swaggerDoc":"","x":90,"y":100,"wires":[["7cea192.369b368","ce9baf58.f01ff8"]]},{"id":"363802b0.d706ae","type":"function","z":"fabc60c3.885ec8","name":"Response Msg","func":"/* Example Payload for Google\n{\n  \"speech\": \"...\",  // ASCII characters only\n  \"displayText\": \"...\",\n  \"data\": {\n    \"google\": {\n      \"expect_user_response\": true,\n      \"is_ssml\": true,\n      \"permissions_request\": {\n        \"opt_context\": \"...\",\n        \"permissions\": [\n          \"NAME\",\n          \"DEVICE_COARSE_LOCATION\",\n          \"DEVICE_PRECISE_LOCATION\"\n        ]\n      }\n    }\n  },\n  \"contextOut\": [...],\n}*/\n\nmsg.headers = {\"Content-type\" : \"application/json\"}\nvar input = msg.payload.input.text\nvar texts = msg.payload.output.text\n\nvar myEndSession = true;    \n\ntotalText = \"\"\nfor (i = 0; i < texts.length; i++) {\n    \n    if (texts[i].lastIndexOf(\"[\") >= 0 ) {\n       findindex = texts[i].lastIndexOf(\"[\");\n       texts[i] = texts[i].substring(0,findindex);\n    } \n  totalText = totalText + \" \" + texts[i]\n}\n\nif (msg.tellGoogleNoWorries) \n{totalText = \"Okay, you're information is safe with me.\" + totalText\n  msg.tellGoogleNoWorries = false  \n}\n\n\nif (input.toUpperCase().substring(0,5) == \"LATER\" ||\n    totalText.lastIndexOf(\"wonderful day\") >= 0 ||\n    totalText.lastIndexOf(\"great day\") >= 0\n)\n   {myEndSession = false}\n\n\n\nmyResponse = {\n    \"speech\": totalText,  // ASCII characters only\n    \"displayText\": \"\",\n    \"data\": {\n      \"google\": {\n        \"expect_user_response\": myEndSession,\n        \"is_ssml\": false\n        }\n     }\n}\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + totalText)\nmsg.payload = myResponse \nnode.send(msg);\n    \n\nreturn null;\n","outputs":1,"noerr":0,"x":1437.7916297912598,"y":441.0833435058594,"wires":[["4474f478.71c32c","d53285fa.07016"]]},{"id":"4474f478.71c32c","type":"http response","z":"fabc60c3.885ec8","name":"Http Response","statusCode":"","headers":{},"x":1659.8749885559082,"y":302.12499618530273,"wires":[]},{"id":"c5d5b95c.4e6c8","type":"function","z":"fabc60c3.885ec8","name":"Set Params","func":"msg.source = \"GoogleHome\"\nvar workspace_id = msg.req.query.workspace_id\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n\ncontext.flowName = \"GoogleHome\"\n\n\nvar params = {\n    context : context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password,\n    source : msg.source\n};\n\nvar additional_context = {};\nvar googleIntent = \"\"\nvar googleIName = \"\"\nvar googleContext = \"\"\nif (typeof msg.payload.originalRequest.data.user.profile !== \"undefined\"){\n     context.fname = msg.payload.originalRequest.data.user.profile.given_name   \n    }\n\nif (typeof msg.payload.originalRequest.data.inputs !== \"undefined\"){\n     googleIntent = msg.payload.originalRequest.data.inputs[0].intent\n    }\n\nif (typeof msg.payload.originalRequest.data.inputs[0].arguments[0] !== \"undefined\"){\n     \n     if (typeof msg.payload.originalRequest.data.inputs[0].arguments[0].name !== \"undefined\"){\n       googleIName =  msg.payload.originalRequest.data.inputs[0].arguments[0].name \n     }\n    }\n\nif (typeof msg.payload.result.contexts[0] !== \"undefined\") {\n    \n     if (msg.payload.result.contexts[0].name.lastIndexOf(\"actions\") >= 0) {\n        \n        if (typeof msg.payload.result.contexts[1] !== \"undefined\"){\n           googleContext = msg.payload.result.contexts[1].name \n        }\n     }\n     else {\n        googleContext = msg.payload.result.contexts[0].name \n     }\n}\n\nmsg.payload = msg.payload.result.resolvedQuery\nmsg.params = params\nmsg.googleIntent = googleIntent\nmsg.googleIName = googleIName\nmsg.googleContext = googleContext\n\nreturn msg;","outputs":1,"noerr":0,"x":654.9999771118164,"y":100,"wires":[["241f7e58.f071fa","9e133318.b0cf2"]]},{"id":"d53285fa.07016","type":"debug","z":"fabc60c3.885ec8","name":"","active":true,"console":"false","complete":"payload","x":1665.6249885559082,"y":438.791654586792,"wires":[]},{"id":"bd4306d7.6b0cb","type":"switch","z":"fabc60c3.885ec8","name":"Intents","property":"googleIntent","propertyType":"msg","rules":[{"t":"eq","v":"assistant.intent.action.PERMISSION","vt":"str"},{"t":"eq","v":"assistant.intent.action.MAIN","vt":"str"},{"t":"eq","v":"claim-status","vt":"str"},{"t":"eq","v":"claim-process","vt":"str"},{"t":"eq","v":"deductibles","vt":"str"},{"t":"else"}],"checkall":"true","outputs":6,"x":245.625,"y":366.87499618530273,"wires":[["3553f633.a3a42a"],["e3ee5815.a98a1"],["244f3b58.ca57bc"],["244f3b58.ca57bc"],["244f3b58.ca57bc"],["92dca23a.f4fa1"]]},{"id":"e3ee5815.a98a1","type":"function","z":"fabc60c3.885ec8","name":"Ask Permission","func":"\nmsg.headers = {\"Content-type\" : \"application/json\"}\n\nmyResponse = {\n    \"speech\": \"Send Permission Request\",  // ASCII characters only\n    \"displayText\": \"\",\n    \"data\": {\n      \"google\": {\n        \"expect_user_response\": false,\n        \"is_ssml\": false,\n        \"permissions_request\": {\n        \"opt_context\": \"Before we get started.\",\n        \"permissions\": [\"NAME\", \"DEVICE_COARSE_LOCATION\", \"DEVICE_PRECISE_LOCATION\"]\n         }\n        }\n     }\n}\n\nmsg.payload = myResponse \nnode.send(msg);\n\nreturn null;\n","outputs":1,"noerr":0,"x":744.75,"y":302.125,"wires":[["4474f478.71c32c"]]},{"id":"3553f633.a3a42a","type":"function","z":"fabc60c3.885ec8","name":"Handle Permission","func":"if (msg.payload.toUpperCase().lastIndexOf(\"NO\") >= 0 \n)\n   {msg.tellGoogleNoWorries = true}\nelse\n   {msg.tellGoogleNoWorries = false}\n   \nif (msg.googleContext.lastIndexOf(\"claim-status\") >= 0 ) {\n    msg.payload = \"get a status of my claim\"\n}\n\nelse if (msg.googleContext.lastIndexOf(\"claim-process\") >= 0 ) {\n    msg.payload = \"how do claims work\"\n}\nelse if (msg.googleContext.lastIndexOf(\"claim-deductible\") >= 0 ) {\n    msg.payload = \"what are my deductibles and limits\"\n}\n\n\nelse {\n    msg.payload =  \"Hello\"\n}    \n    \nreturn msg;","outputs":1,"noerr":0,"x":748.7499771118164,"y":249.37499523162842,"wires":[["92dca23a.f4fa1"]]},{"id":"244f3b58.ca57bc","type":"switch","z":"fabc60c3.885ec8","name":"trigger?","property":"googleIName","propertyType":"msg","rules":[{"t":"eq","v":"trigger_query","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":580,"y":380,"wires":[["e3ee5815.a98a1"],["92dca23a.f4fa1"]]},{"id":"7cea192.369b368","type":"function","z":"fabc60c3.885ec8","name":"Get User","func":"\nmsg.user = msg.payload.sessionId\nreturn msg;","outputs":1,"noerr":0,"x":293.75,"y":100.00000095367432,"wires":[["b245d4b7.3b97c8"]]},{"id":"b1d85812.44768","type":"http in","z":"e3247ffc.0f34","name":"SIP HTTP in","url":"/sip","method":"post","upload":false,"swaggerDoc":"","x":87.99998474121094,"y":107.30158996582031,"wires":[["e72e91a1.ec2d9","c65699f4.9e1ab"]]},{"id":"becd2cc8.4f33e","type":"http response","z":"e3247ffc.0f34","name":"Http Response","x":1440.6249694824219,"y":225.35713815689087,"wires":[]},{"id":"131a23e4.57b884","type":"function","z":"e3247ffc.0f34","name":"Set Params","func":"msg.source = \"Phone\"\nvar workspace_id = msg.req.query.workspace_id\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\nvar stt_user_name = msg.req.query.stt_username\nvar stt_password = msg.req.query.stt_password\nvar tts_user_name = msg.req.query.tts_username\nvar tts_password = msg.req.query.tts_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar input = msg.payload.input.text;\nvar fname = \"Jane\"; \n\nmsg.testPhone = \"\"\nmsg.testPhone = msg.payload.context.vgwSIPToURI.match(/\\b(18447276206|18442310002|18445047115|18552164158|18442011910|18445845275)\\b/g);\n\nif (input === \"\") {\n  if (msg.testPhone == \"18447276206\" || msg.testPhone == \"18442310002\"){\n    input = \"Ask Me Please\"\n  }\n  else {\n    input = \"Hi\" \n  }    \n\n}\n    \nif ((input == \"vgwHangUp\")||(input==\"cgwHangUp\")) {\n    input = \"goodbye from SIP\"\n} \n\nif ((input == \"vgwPostResponseTimeout\")||(input == \"cgwPostResponseTimeout\")) {\n    input = \"silence\"\n} \n\n\n//var context = msg.payload.context;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id \n   }\n   \ncontext.fname = fname\n\nif (typeof context.vgwIsDTMF !== \"undefined\"){\n  if (context.vgwIsDTMF.trim().toUpperCase() == \"NO\") {\n      context.dtmfCount = 0\n      context.dtmfValue = \"\"\n  }\n  else {if (input.trim() ==\"#\" || input.trim() ==\"*\" ){\n          input = context.dtmfValue\n      }\n      else {\n          context.dtmfCount = context.dtmfCount + 1\n          context.dtmfValue.concat(dtmfValue)\n      }\n  }\n}\n\ncontext.cgwPostResponseTimeoutCount = \"30000\"\ncontext.cgwSessionInactivityTimeout = \"5\"\ncontext.vgwPostResponseTimeoutCount = \"30000\"\ncontext.vgwSessionInactivityTimeout = \"5\"\ncontext.vgwAllowDTMF = \"YES\"\ncontext.vgwSIPToURI= msg.payload.context.vgwSIPToURI\ncontext.vgwSIPFromURI = msg.payload.context.vgwSIPFromURI\ncontext.vgwSessionID = msg.payload.context.vgwSessionID\ncontext.vgwSIPCallID = msg.payload.context.vgwSIPCallID\ncontext.vgwSIPRequestURI = msg.payload.context.vgwSIPRequestURI\ncontext.stt_user_name = stt_user_name\ncontext.stt_password = stt_password\ncontext.tts_user_name = tts_user_name\ncontext.tts_password = tts_password\nif (typeof msg.req.query.stt_customization_id !== \"undefined\") {\n  context.stt_customization_id = msg.req.query.stt_customization_id\n}\nelse {\n  context.stt_customization_id = \"NA\"  \n}\nif (typeof msg.req.query.tts_customization_id !== \"undefined\") {\n  context.tts_customization_id = msg.req.query.tts_customization_id\n}\nelse {\n  context.tts_customization_id = \"NA\"  \n}\n\n\nvar params = {\n     context: context,\n     workspace_id : workspace_id,\n     username : wcs_user_name,\n     password : wcs_password,\n     source : msg.source\n}\n\n\nmsg.payload = input;\nmsg.params = params;\nreturn msg;","outputs":1,"noerr":0,"x":610.6249618530273,"y":107.85714435577393,"wires":[["30a81690.0b9672","4a0c3b79.0ccbb4"]]},{"id":"710f03b5.874e54","type":"function","z":"e3247ffc.0f34","name":"Response Msg","func":"var Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Mymsg = Watson_msg.substring(2,Watson_msg.length-2);\n\n//Going forward, if you want to add buttons for convo for sip, use JSON only. NO []!!!!\n\nnode.log(\"start with \" + Mymsg);\n\nif (Mymsg.lastIndexOf(\"[\") >= 0 ) {\n     findindex = Mymsg.lastIndexOf(\"[\")\n     msg.payload.output.text = [Mymsg.substring(0,findindex-1)]\n} \nif (Mymsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Mymsg.lastIndexOf(\"InsMap\")\n     msg.payload.output.text = '[\"' + Mymsg.substring(0,findindex-1) + '\"]'\n} \n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + msg.payload.output.text)\n\n//new actions array for VGW\nvar bargeIn = \"No\";\n\nif (typeof msg.payload.context.BargeIn !== 'undefined'){\n   bargeIn = msg.payload.context.BargeIn;\n}\n\n\n\nvar sttConfig = {\n      \"command\": \"vgwActSetSTTConfig\",\n      \"parameters\": {\n              \"credentials\": {\n                \"url\": \"https://stream.watsonplatform.net/speech-to-text/api\",\n                \"username\": msg.payload.context.stt_user_name,\n                \"password\": msg.payload.context.stt_password\n              },\n              \"config\": {\n                  \"x-watson-learning-opt-out\": true,\n                  \"model\": \"en-US_NarrowbandModel\",\n                  \"profanity_filter\": true,\n                  \"customization_id\": msg.payload.context.stt_customization_id,\n                  \"firmup_silence_time\": 1, \n                  \"max_alternatives\":6,\n                  \"smart_formatting\": true\n              }\n          }\n        }\nif (sttConfig.parameters.config.customization_id == \"NA\") {\n    delete sttConfig.parameters.config.customization_id\n}\n\nvar ttsConfig = {\n        \"command\": \"vgwActSetTTSConfig\",\n        \"parameters\": {\n              \"credentials\": {\n                \"url\":  \"https://stream.watsonplatform.net/text-to-speech/api\",\n                \"username\": msg.payload.context.tts_user_name,\n                \"password\": msg.payload.context.tts_password\n              },\n              \"config\": {\n                  \"x-watson-learning-opt-out\": true,\n                  \"customization_id\": msg.payload.context.tts_customization_id,                  \n                  \"voice\": \"en-US_MichaelVoice\"\n              },\n              \"jitterBufferDelay\": 200,\n              \"cacheTimeToLive\": 336\n            }\n        }\nif (ttsConfig.parameters.config.customization_id == \"NA\") {\n    delete ttsConfig.parameters.config.customization_id\n}\n\nvar dtmfConfig = {\n        \"command\": \"vgwActCollectDtmf\",\n           \"parameters\": {\n              \"dtmfCount\": 10 //example for a phone number, set based on what you want to wait for\n            }\n        }\n\n\nvar playText = {\n        \"command\":\"vgwActPlayText\",\n            \"parameters\": {\n                \"text\" : msg.payload.output.text\n            }\n        }\n\nvgAction = []\nvgAction.push(sttConfig)\nvgAction.push(ttsConfig)\n//vgAction.push(dtmfConfig) \n\nif (bargeIn === \"No\") {\n vgAction.push({\"command\":\"vgwActDisableSTTDuringPlayback\"})\n} \nvgAction.push(playText)\n\nmsg.payload.output.vgwActionSequence = vgAction;\n\nreturn msg;","outputs":1,"noerr":0,"x":1189.999984741211,"y":227.8571434020996,"wires":[["becd2cc8.4f33e","3c33a856.b99de8"]]},{"id":"30a81690.0b9672","type":"debug","z":"e3247ffc.0f34","name":"","active":true,"console":"false","complete":"true","x":779.9999847412109,"y":47.85714340209961,"wires":[]},{"id":"5e3dcd55.34fcec","type":"http in","z":"ebe88beb.81da2","name":"","url":"/twiliosms","method":"post","swaggerDoc":"","x":100,"y":160,"wires":[["ab924a8a.43c438"]]},{"id":"66746784.9c085","type":"function","z":"ebe88beb.81da2","name":"Set Params","func":"msg.source = \"SMS\"\nvar workspace_id = msg.req.query.workspace_id;\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n\n//if (flow.get(msg.payload.From)){\n// msg.params.context = flow.get(msg.payload.From); \n//}\n\nflow.set ('From', msg.payload.From);\n\nvar params = {\n    context: context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password\n};\n\ncontext.fname = fname\ncontext.source = msg.source\n\nmsg.payload = msg.payload.Body;\nmsg.user = user;\nreturn msg;","outputs":1,"noerr":0,"x":378.75,"y":159.9999942779541,"wires":[["b0527b4a.7b5bd","8b1a28cc.949178"]]},{"id":"b0527b4a.7b5bd","type":"debug","z":"ebe88beb.81da2","name":"","active":true,"console":"false","complete":"true","x":470,"y":80,"wires":[]},{"id":"6b9fe547.7ceaac","type":"function","z":"ebe88beb.81da2","name":"Response Msg","func":"var From = flow.get('From');\n\nvar Watson_msg = msg.payload;\nvar Watson_response = JSON.stringify(msg.payload.output.text.join());\nvar Watson_context = JSON.stringify(msg.payload.context);\nnode.log(Watson_response);\n\nMyresponse = Watson_response.substring(2,Watson_response.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\n\nnode.log(\"context-intents \" +  msg.payload.intents[0].intent + \" with confidence of \" + msg.payload.intents[0].confidence)\n\nmsg.topic = From;\nflow.set(From, msg.payload.context);\n\nmsg.payload = Watson_response;\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":280,"wires":[["7c8a6be.eefe194","f1705e03.2ed148"]]},{"id":"7c8a6be.eefe194","type":"twilio out","z":"ebe88beb.81da2","service":"_ext_","twilio":"b81ce29e.69f168","from":"","number":"","name":"","x":1136.249984741211,"y":278.7499952316284,"wires":[]},{"id":"f1705e03.2ed148","type":"debug","z":"ebe88beb.81da2","name":"","active":false,"console":"false","complete":"payload","x":1119.2307586669922,"y":188.46153450012207,"wires":[]},{"id":"ab924a8a.43c438","type":"function","z":"ebe88beb.81da2","name":"Get User","func":"var user_temp = msg.payload.From;\nmsg.user = user_temp.substring(user_temp.length-7, user_temp.length);\nreturn msg;","outputs":1,"noerr":0,"x":137.5,"y":299,"wires":[["98f16af.3202898"]]},{"id":"e6a252cd.e53bf","type":"subflow:5e5f60e7.f240c8","z":"ff67537b.e2624","name":"Get Session","x":427.74041748046875,"y":116.92308044433594,"wires":[["93b050e4.cebef"]]},{"id":"bbb3fca0.f440e","type":"subflow:a39d88cb.3e3638","z":"ff67537b.e2624","name":"","x":895.9866714477539,"y":236.49575805664062,"wires":[["e57d91ca.5da908"]]},{"id":"efb71e90.5ec","type":"subflow:5e5f60e7.f240c8","z":"401cee62.babb8","name":"","x":466.25,"y":100.00000095367432,"wires":[["86725611.f9f488"]]},{"id":"ec702d75.af3078","type":"subflow:a39d88cb.3e3638","z":"401cee62.babb8","name":"","x":853.3749771118164,"y":220.9999942779541,"wires":[["5b46afe9.35a93"]]},{"id":"b36ff609.60c37","type":"subflow:5e5f60e7.f240c8","z":"9f54b786.c40c38","x":738.1249771118164,"y":119.9999942779541,"wires":[["26687dab.932f6a"]]},{"id":"366069a.20f8296","type":"subflow:a39d88cb.3e3638","z":"9f54b786.c40c38","x":1089,"y":239,"wires":[["f23f76b0.e54888"]]},{"id":"99cc0b1a.6c986","type":"subflow:5e5f60e7.f240c8","z":"8a20faf1.e98998","x":748.75,"y":100.62500095367432,"wires":[["223c5fea.7e4b58"]]},{"id":"fa5fbfcc.8cf84","type":"subflow:a39d88cb.3e3638","z":"8a20faf1.e98998","x":977.3194351196289,"y":261.791729927063,"wires":[["b59e73f2.e516c8"]]},{"id":"e005073f.a3e798","type":"subflow:5e5f60e7.f240c8","z":"724cdd96.923cdc","x":452.5,"y":140.62499332427979,"wires":[["7ff2b4db.6e9c7c"]]},{"id":"4bc06ad1.ba1b14","type":"subflow:a39d88cb.3e3638","z":"724cdd96.923cdc","x":1090,"y":280,"wires":[["6ddcf4.7e0eab0c"]]},{"id":"b245d4b7.3b97c8","type":"subflow:5e5f60e7.f240c8","z":"fabc60c3.885ec8","x":473.125,"y":100.62500095367432,"wires":[["c5d5b95c.4e6c8"]]},{"id":"5730355d.27fdec","type":"subflow:a39d88cb.3e3638","z":"fabc60c3.885ec8","x":1241.1249618530273,"y":441.7500305175781,"wires":[["363802b0.d706ae"]]},{"id":"98f16af.3202898","type":"subflow:5e5f60e7.f240c8","z":"ebe88beb.81da2","x":325.125,"y":299.99999618530273,"wires":[["66746784.9c085"]]},{"id":"ea065a9c.29329","type":"subflow:a39d88cb.3e3638","z":"ebe88beb.81da2","x":710,"y":280,"wires":[["6b9fe547.7ceaac"]]},{"id":"80509007.89d4f8","type":"MSSQL","z":"8183a83c.27793","mssqlCN":"c18e1f49.cc86a8","name":"ucg-mssql","query":"SELECT * FROM information_schema.tables;","outField":"payload","x":281,"y":49,"wires":[["66b39117.2b428"]]},{"id":"48b2fd76.fd08f4","type":"inject","z":"8183a83c.27793","name":"List Tables","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":101,"y":49,"wires":[["80509007.89d4f8"]]},{"id":"66b39117.2b428","type":"debug","z":"8183a83c.27793","name":"","active":true,"console":"false","complete":"false","x":457,"y":50,"wires":[]},{"id":"d8a5c56e.de761","type":"MSSQL","z":"3041e49.e69119c","mssqlCN":"c18e1f49.cc86a8","name":"SetMssqlSession","query":"insert into session_ver3 VALUES ('{{{payload.convoUser}}}',\n                            '{{{payload.wcs_user_name}}}',\n                            '{{{payload.wcs_password}}}',\n                            '{{{payload.workspace_id}}}',\n                            '{{{payload.convoTS}}}',\n                            '{{{payload.convoSource}}}',\n                            '{{{payload.convoIntent}}}',\n                            '{{{payload.convoDialogNode}}}',   \n                            '{{{payload.convoDialogType}}}',\n                            '{{{payload.convoDialogIntents}}}',\n                            '{{{payload.convoDialogEntities}}}',\n                            '{{{payload.convoDialogConfidence}}}',\n                            '{{{payload.convoContainmentScore}}}',\n                            '{{{payload.convoCounter}}}',\n                            '{{{payload.convoTransID}}}',\n                            '{{{payload.convoUtterance}}}',\n                            '{{payload.convoAnswer}}',\n                            '{{payload.convoPayload}}')\n","outField":"payload","x":489,"y":47,"wires":[[]]},{"id":"38204aa9.3e8196","type":"inject","z":"8183a83c.27793","name":"sesion Json","topic":"","payload":"{\"convoUser\":\"Den1\",\"convoTS\":\"08/1/2017 11:15:37\",\"convoSource\":\"Load\",\"convoPayload\":\"contextstring2\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":98,"y":130,"wires":[["2e788eb8.26d2da"]]},{"id":"26f8f135.5d60de","type":"debug","z":"8183a83c.27793","name":"","active":true,"console":"false","complete":"false","x":480,"y":130,"wires":[]},{"id":"996e6ba4.c26df","type":"debug","z":"8183a83c.27793","name":"","active":true,"console":"false","complete":"true","x":655,"y":210,"wires":[]},{"id":"3644704.a25dd1","type":"MSSQL","z":"b9f2f318.8796b","mssqlCN":"c18e1f49.cc86a8","name":"GetMssqlSession","query":"SELECT TOP 1\nconvoUser,\nwcs_user_name,\nwcs_password,\nworkspace_id,\nconvoTS,\nconvoSource,\nconvoIntent,\nconvoDialogNode,\nconvoDialogType,\nconvoDialogIntents,\nconvoDialogEntities,\nconvoDialogConfidence,\nconvoCounter,\nconvoTransID,\nconvoUtterance,\nREPLACE(convoAnswer,'&#39;','''') as convoAnswer,\nREPLACE(REPLACE(convoPayload,'&quot;','\"'),'&#39;','') as convoPayload\n\nFROM session_ver3  where convoUser = '{{{payload}}}'  ORDER BY convoTS DESC","outField":"payload","x":364,"y":41,"wires":[["27c236ba.867442"]]},{"id":"10855342.f390bd","type":"inject","z":"8183a83c.27793","name":"User","topic":"","payload":"dfn2","payloadType":"str","repeat":"","crontab":"","once":false,"x":116,"y":210,"wires":[["bcf53175.f56918"]]},{"id":"e58b79c1.1b19b","type":"comment","z":"8183a83c.27793","name":"Need the nodred-contrib-mssql node installed via the palette","info":"","x":286.5,"y":284,"wires":[]},{"id":"ec4a842e.117e6","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"WDSResults","x":479,"y":112,"wires":[]},{"id":"25b5f586.defc42","type":"inject","z":"68b0d95d.ae26b8","name":"","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":90,"y":100,"wires":[["89efdfb3.d11048"]]},{"id":"92d09c72.cda38","type":"subflow:b9f2f318.8796b","z":"8183a83c.27793","name":"","x":468,"y":210,"wires":[["996e6ba4.c26df"]]},{"id":"2e788eb8.26d2da","type":"subflow:3041e49.e69119c","z":"8183a83c.27793","x":290,"y":130,"wires":[["26f8f135.5d60de"]]},{"id":"b06880f0.d20cd8","type":"subflow:b9f2f318.8796b","z":"5e5f60e7.f240c8","x":227.92857360839844,"y":248.42856979370117,"wires":[[]]},{"id":"24d1019f.c8f016","type":"subflow:3041e49.e69119c","z":"a39d88cb.3e3638","x":450.5,"y":281,"wires":[[]]},{"id":"bcf53175.f56918","type":"function","z":"8183a83c.27793","name":"Set msg.user","func":"msg.user = msg.payload\nreturn msg;","outputs":1,"noerr":0,"x":270.5,"y":210,"wires":[["92d09c72.cda38"]]},{"id":"4497a643.aac0e8","type":"function","z":"b9f2f318.8796b","name":"Get Session","func":"msg.savePayload = msg.payload\n\nmsg.payload = [msg.user]\n\nreturn msg;","outputs":1,"noerr":0,"x":168.5,"y":41,"wires":[["3644704.a25dd1"]]},{"id":"cc8c5102.27289","type":"function","z":"3041e49.e69119c","name":"Fix Date/ConvoPayload","func":"var d = msg.payload.convoTS\n\nnewdstr = d.getMonth()+1 + \"/\" + d.getDate() + \"/\" + d.getFullYear() + \" \" + d.getHours() + \":\" + d.getMinutes() + \":\" + d.getSeconds() + \":\" + d.getMilliseconds()\nmsg.payload.convoTS = newdstr\n\nmsg.payload.convoPayload = JSON.stringify(msg.payload.convoPayload)\nreturn msg;","outputs":1,"noerr":0,"x":254.5,"y":48,"wires":[["d8a5c56e.de761"]]},{"id":"27c236ba.867442","type":"function","z":"b9f2f318.8796b","name":"Set Session in subflow","func":"if (typeof msg.payload[0] !== \"undefined\" )\n   {\n    msg.payload[0].convoPayload = JSON.parse(msg.payload[0].convoPayload)   \n    msg.session = msg.payload[0]\n   }\nelse \n  { \n      \n}\n   \n//reset payload from channel to continue flow\nmsg.payload = msg.savePayload\n\nreturn msg;","outputs":1,"noerr":0,"x":617.5,"y":41,"wires":[[]]},{"id":"d9eeeb48.936ee8","type":"inject","z":"ff67537b.e2624","name":"Start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":91.48529815673828,"y":326.6764736175537,"wires":[["2a7ad8f0.61eac"]]},{"id":"2a7ad8f0.61eac","type":"http request","z":"ff67537b.e2624","name":"Get Dialog Node","method":"GET","ret":"obj","url":"https://gateway.watsonplatform.net/conversation/api/v1/workspaces/56cfca8a-b459-447f-ab35-e94511f6f7bc/dialog_nodes/ROOT-Claim-Status?version=2017-05-26","tls":"","x":273.25,"y":327.50000953674316,"wires":[["8e429b69.232018"]]},{"id":"8e429b69.232018","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"true","x":446.83334732055664,"y":326.958309173584,"wires":[]},{"id":"db7fb279.76c6f8","type":"function","z":"4e8a84dc.f232fc","name":"Test Ping","func":"if (typeof msg.payload.workspaces === \"undefined\") \n   {\n    node.error(msg.region + \" WCS failed, switching region for user: \" + msg.user) \n    msg.region = \"GERMANY\"\n   }\n else  \n   {msg.region = \"US-SOUTH\"\n   } \n\nmsg.payload = msg.savePayload\n\nreturn msg;","outputs":1,"noerr":0,"x":771.8301162719727,"y":35.46736526489258,"wires":[["4f4c4043.23b748"]]},{"id":"772274fc.063df4","type":"function","z":"4e8a84dc.f232fc","name":"Check for Session","func":"msg.savePayload = msg.payload\n\nif (typeof msg.session === \"undefined\") \n  msg.checkService = \"Yes\"\nelse\n  msg.checkService = \"No\"\n\nif (msg.params.username === \"c3a84de4-c0cf-43b6-98a1-8c2bd16fdc1f\"){\n        msg.region = \"GERMANY\" \n}\nelse {\n        msg.region = \"US-SOUTH\"\n}    \n\nmsg.headers = {}\nreturn msg;","outputs":1,"noerr":0,"x":181.5,"y":37.069942474365234,"wires":[["9ab03a23.56cdd8"]]},{"id":"387cd93e.126fa6","type":"inject","z":"22659eb7.a53b82","name":"Execute","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":135.03846740722656,"y":53.23076820373535,"wires":[["210a67da.6d58"]]},{"id":"210a67da.6d58","type":"http request","z":"22659eb7.a53b82","name":"Workspaces Ping","method":"GET","ret":"obj","url":"https://gateway.watsonplatform.net/conversation/api/v1/workspaces?version=2017-05-26","tls":"","x":319.5,"y":53,"wires":[["89cb433a.a4d648"]]},{"id":"89cb433a.a4d648","type":"debug","z":"22659eb7.a53b82","name":"","active":true,"console":"false","complete":"true","x":512.2692337036133,"y":53.30769348144531,"wires":[]},{"id":"d746116f.269da8","type":"inject","z":"8183a83c.27793","name":"List Tables","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":101.5,"y":404,"wires":[["4afaee7.1f11a9"]]},{"id":"eb812759.0b0e2","type":"debug","z":"8183a83c.27793","name":"","active":true,"console":"false","complete":"true","x":828.5,"y":408,"wires":[]},{"id":"9f9d33ca.670898","type":"http in","z":"251a792.3f5ec06","name":"SIP HTTP in","url":"/SIPGateway/v1/workspaces/0000/message","method":"post","upload":false,"swaggerDoc":"","x":132,"y":63,"wires":[["26cbdfa8.0bfb","c286ae04.364af8"]]},{"id":"32e27e47.746e1a","type":"watson-conversation-v1","z":"251a792.3f5ec06","name":"Conversation","workspaceid":"109901be-2ab8-45e5-9a63-1fc20201e5b6","multiuser":false,"context":false,"default-endpoint":true,"service-endpoint":"","x":890,"y":320,"wires":[["44c94f1.a05b2b","2dfa363.f75ae4a"]]},{"id":"da10b4af.eeaa58","type":"http response","z":"251a792.3f5ec06","name":"Http Response","x":1339.8791103363037,"y":222.0915117263794,"wires":[]},{"id":"1e0ef0c7.9ab3a7","type":"function","z":"251a792.3f5ec06","name":"Set Params","func":"//node.warn(\"msg: \" + msg);\n//node.warn(\"msg.payload: \" + msg.payload);\n//node.warn(\"msg.payload.input: \" + msg.payload.input);\n//  Sip gateway is controlling wcs context and workspace\nmsg.source = \"Phone\"\n//var workspace_id = \"3f760edd-0ddc-43fa-aead-610e455fb580\";\n//var app = \"\";\nvar input = global.get(\"input\");\n//var fname = \"Jane\"\n\nif (input === \"\")\n{input =  \"Hi\"}\n  \nif ((input == \"vgwHangUp\")||(input==\"cgwHangUp\")) {\n    input = \"goodbye from SIP\"\n} \n\nif ((input == \"vgwPostResponseTimeout\")||(input == \"cgwPostResponseTimeout\")) {\n    input = \"silence\"\n} \n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context}\n   \n\n\n//var context = msg.payload;//.context;\n//context.conversation_id = global.get(\"conversationId\");\n\nif (typeof context.vgwIsDTMF !== \"undefined\"){\n  if (context.vgwIsDTMF.trim().toUpperCase() == \"NO\") {\n      context.dtmfCount = 0\n      context.dtmfValue = \"\"\n  }\n  else {if (input.trim() ==\"#\" || input.trim() ==\"*\" ){\n          input = context.dtmfValue\n      }\n      else {\n          context.dtmfCount = context.dtmfCount + 1\n          context.dtmfValue.concat(dtmfValue)\n      }\n  }\n}\n\ncontext.cgwPostResponseTimeoutCount = \"30000\"\ncontext.cgwSessionInactivityTimeout = \"5\"\ncontext.vgwPostResponseTimeoutCount = \"30000\"\ncontext.vgwSessionInactivityTimeout = \"5\"\ncontext.vgwAllowDTMF = \"YES\"\ncontext.Device = \"FD 130\";\ncontext.Connection_Type = \"Dial\";\n\nvar params = {\n     context: context\n\n}\n\nmsg.payload = input;\n//msg.workspace_id = workspace_id;\nmsg.params = params;\nreturn msg;","outputs":1,"noerr":0,"x":460.88883209228516,"y":164.44445133209229,"wires":[["9cb1e268.8e2148","9898b874.c322f"]]},{"id":"6d16e835.7a842","type":"function","z":"251a792.3f5ec06","name":"Response Msg","func":"var Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Mymsg = Watson_msg.substring(2,Watson_msg.length-2);\n\n//Going forward, if you want to add buttons for convo for sip, use JSON only. NO []!!!!\n\nnode.log(\"start with \" + Mymsg);\n\nif (Mymsg.lastIndexOf(\"[\") >= 0 ) {\n     findindex = Mymsg.lastIndexOf(\"[\")\n     msg.payload.output.text = [Mymsg.substring(0,findindex-1)]\n     node.log(\"Found a buttons at index: \" + findindex)\n     node.log(msg.payload.output.text)\n} \nif (Mymsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Mymsg.lastIndexOf(\"InsMap\")\n     msg.payload.output.text = '[\"' + Mymsg.substring(0,findindex-1) + '\"]'\n     node.log(\"Found a maps at index: \"+ findindex)\n     node.log(msg.payload.output.text)\n} \n\n\nreturn msg;","outputs":1,"noerr":0,"x":1124.6569004058838,"y":222.53595447540283,"wires":[["da10b4af.eeaa58","138f44be.8cc96b","6f5b02c3.bedf54"]]},{"id":"138f44be.8cc96b","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"payload.output.text","x":1212.7677841186523,"y":117.98038959503174,"wires":[]},{"id":"9cb1e268.8e2148","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":608.6666469573975,"y":95,"wires":[]},{"id":"6f5b02c3.bedf54","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":1306.545735359192,"y":341.0915222167969,"wires":[]},{"id":"44c94f1.a05b2b","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":913.5457992553711,"y":477.0915274620056,"wires":[]},{"id":"26cbdfa8.0bfb","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":347.16667556762695,"y":64.8888931274414,"wires":[]},{"id":"9898b874.c322f","type":"function","z":"251a792.3f5ec06","name":"Set Call ID","func":"msg.call_id = \"3333333\"; //msg.payload.context.vgwSessionID;\nvar userToUser = msg.payload.context.vgwSIPCustomInviteHeader;\n//vgwSIPCustomInviteHeader: \"0430333333313938382D323431322D343263662D393364642D666131316565326263643537;encoding=hex\"\nvar conversationId = msg.payload.context.conversation_id;\nglobal.set(\"conversationId\", conversationId);\nglobal.set(\"input\", msg.payload.input.text);\n\nvar callIdHex = userToUser.toString().substring(2, 74);\nvar greetingCode = hex2a(userToUser.toString().substring(74, 78));\nvar callId = hex2a(callIdHex);\nnode.warn(\"callId: \" + callId);\nnode.warn(\"greetingCode: \" + greetingCode);\n\nmsg.call_id = callId;\nmsg.headers = {\"Content-Type\": \"application/json\"}\n//node.warn(\"msg.call_id: \" + msg.call_id);\n//node.warn(\"msg: \" + msg);\n\nmsg.url = \"https://MiddleWareApps.CATO.FDVS.1DC.COM/FDVS/Services/Hydration/WEBAPI/api/WatsonHydrate?call_id=\" + msg.call_id;\nreturn msg;\n// Need better way to do this - too resource intensive - Den/Etay\nfunction hex2a(hexx) {\n    //node.warn(\"hexx: \" + hexx);\n    var hex = hexx.toString();//force conversion\n    var str = '';\n    for (var i = 0; i < hex.length; i += 2)\n    {\n        //node.log(\"hexx val: \" + hex.substr(i, 2));\n        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n        \n    }\n    return str;\n}","outputs":1,"noerr":0,"x":240.16666412353516,"y":287.7777557373047,"wires":[["7e8b196d.41d3e","60b90d2a.0bdffc"]]},{"id":"e5bb06a6.5bc5b","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"false","x":672,"y":463,"wires":[]},{"id":"7e8b196d.41d3e","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":451.0000190734863,"y":254.66665649414062,"wires":[]},{"id":"d0cc2f0d.2d119","type":"inject","z":"251a792.3f5ec06","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":82,"y":383,"wires":[["8608866a.160708"]]},{"id":"8608866a.160708","type":"function","z":"251a792.3f5ec06","name":"Test","func":"var userToUser = \"0435383833346337372D336635392D343262622D623130382D3961343135336263303233373031;encoding=hex\";\n\nvar callIdHex = userToUser.toString().substring(2, 74);\nvar callId = hex2a(callIdHex);\nnode.warn(\"callId: \" + callId);\n\nmsg.call_id = callId;\nmsg.headers = {\"Content-Type\": \"application/json\"}\n\nmsg.url = \"https://MiddleWareApps.CATO.FDVS.1DC.COM/FDVS/Services/Hydration/WEBAPI/api/WatsonHydrate?call_id=\" + msg.call_id;\n//msg.payload.alternateIntents = false;\n//msg.payload.input.text = \"\";\n//msg.payload.context.vgwSIPCustomInviteHeader = \"0435383833346337372D336635392D343262622D623130382D3961343135336263303233373031;encoding=hex\";\n//msg.payload.context.vgwSessionID = \"0a4adc9ca3e7123156fb357200\";\n\nmsg.payload = { \"context\" : \n                 { \"vgwSIPCustomInviteHeader\" : \"043\",\n                   \"vgwSessionID\" : \"0a4\" },\n                 \"alternateIntents\" : false,\n                 \"input\": \"\"}\n\n\nreturn msg;\n\n// Need better way to do this - too resource intensive - Den/Etay\nfunction hex2a(hexx) {\n  //  node.warn(\"hexx: \" + hexx);\n    var hex = hexx.toString();//force conversion\n    var str = '';\n    for (var i = 0; i < hex.length; i += 2)\n    {\n      //  node.log(\"hexx val: \" + hex.substr(i, 2));\n        str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));\n        \n    }\n    return str;\n}","outputs":1,"noerr":0,"x":216.5,"y":447,"wires":[["60b90d2a.0bdffc","5196ff93.0afc48"]]},{"id":"5196ff93.0afc48","type":"debug","z":"251a792.3f5ec06","name":"","active":true,"console":"false","complete":"true","x":360.5,"y":523,"wires":[]},{"id":"60b90d2a.0bdffc","type":"www-request","z":"251a792.3f5ec06","name":"","method":"GET","ret":"obj","url":"","tls":"","x":448.8888931274414,"y":338.33334827423096,"wires":[["e5bb06a6.5bc5b","c4a7fdc7.7b6fa"]]},{"id":"c286ae04.364af8","type":"function","z":"251a792.3f5ec06","name":"Get User","func":"\nmsg.user = msg.payload.context.vgwSessionID;\n\nreturn msg;","outputs":1,"noerr":0,"x":113.66666030883789,"y":165.33330821990967,"wires":[["c818811d.44af08"]]},{"id":"c818811d.44af08","type":"subflow:5e5f60e7.f240c8","z":"251a792.3f5ec06","x":286.33333587646484,"y":163.99997425079346,"wires":[["1e0ef0c7.9ab3a7"]]},{"id":"2dfa363.f75ae4a","type":"subflow:a39d88cb.3e3638","z":"251a792.3f5ec06","name":"","x":938.9999809265137,"y":222.6666774749756,"wires":[["6d16e835.7a842"]]},{"id":"c4a7fdc7.7b6fa","type":"function","z":"251a792.3f5ec06","name":"Add Hydro context vars","func":"\nmsg.params.context.xxx = \"xxxx\"\n\nreturn msg;","outputs":1,"noerr":0,"x":684.4444732666016,"y":269.99998474121094,"wires":[["32e27e47.746e1a"]]},{"id":"f5486872.e3dce","type":"function","z":"13cf4536.6ed6fb","name":"Redis Set","func":"var redis = global.get('redis');\nvar options = {enable_offline_queue:false};\n   \nvar redisClient = global.get(\"redisClient\");\nif (typeof redisClient == \"undefined\") {\n  redisClient = new redis('redis://admin:XFRLCLICWCFQXPXA@sl-us-south-1-portal.5.dblayer.com:35110',options);\n//  redisClient = new redis('redis://admin:IVKPWZBPOAJYQCRR@bluemix-sandbox-dal-9-portal.7.dblayer.com:27247',options);\n  global.set(\"redisClient\",redisClient);\n  node.log(\"New RedisClient connection in SetSession\")\n}\n\n\nredisClient.on(\"error\", function (err) {\n    node.error(\"Error \" + err);\n//    client.disconnect(); \n});\n\nredisClient.set(msg.payload.convoUser,JSON.stringify(msg.payload), function (err, response) {\n   if (err) \n      node.error(\"Error \" + err);\n    else \n      msg.payload = response;\n//   client.disconnect(); \n   node.send(msg);\n});","outputs":1,"noerr":0,"x":181.5,"y":57,"wires":[[]]},{"id":"4afaee7.1f11a9","type":"function","z":"8183a83c.27793","name":"set config","func":"msg.user = \"ucgadmin\"\nmsg.password = \"Hockey1234\"\nmsg.port = \"1433\"\nmsg.server = \"ucg-mssql.database.windows.net\"\nmsg.database = \"ucg\"\nreturn msg;","outputs":1,"noerr":0,"x":283.5,"y":404,"wires":[["51be15fb.49d0a4","a7bc72f2.e71dc"]]},{"id":"51be15fb.49d0a4","type":"MSSQL-UCG","z":"8183a83c.27793","mssqlCN":"b6af8384.179058","name":"New UCG MSSQL with params sent via msg","query":"insert into session VALUES ('dddd15', '10/01/2017', 'load', 'test')\n\n","outField":"payload","x":568.5,"y":407,"wires":[["eb812759.0b0e2"]]},{"id":"9ab03a23.56cdd8","type":"switch","z":"4e8a84dc.f232fc","name":"First Turn","property":"checkService","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"eq","v":"No","vt":"str"}],"checkall":"true","outputs":2,"x":326.9615592956543,"y":100.69231033325195,"wires":[["1e76d979.d9aadf"],["4f4c4043.23b748"]]},{"id":"913ee700.0dec68","type":"catch","z":"4e8a84dc.f232fc","name":"Catch API Errors","scope":["4f4c4043.23b748","1e76d979.d9aadf"],"x":454.0237922668457,"y":191.68085861206055,"wires":[["63d98b1c.9df68c"]]},{"id":"63d98b1c.9df68c","type":"function","z":"4e8a84dc.f232fc","name":"Log error and Switch Regions","func":"node.error(msg.region + \" WCS failed switching region for user \" + msg.user + ' Error: '+ msg.error.message);\n\nif (msg.region === \"US-SOUTH\") {\n    msg.region = \"GERMANY\"\n} \nelse if (msg.region === \"GERMANY\"){\n    msg.region = \"US-SOUTH\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":703.7051849365234,"y":193.60253715515137,"wires":[["4f4c4043.23b748"]]},{"id":"2bfac983.53ec26","type":"function","z":"af0dd578.89a848","name":"Log Error","func":"var err_msg = \"UCG received an error from \" + msg.error.source.name + ' stating '+ msg.error.message;\n\nif (!msg.error.message.match(\"Can't set headers after they are sent\")){\nnode.error(err_msg);\nmsg.payload = err_msg;\n\nreturn msg;\n}","outputs":1,"noerr":0,"x":186.3076992034912,"y":30.4615535736084,"wires":[[]]},{"id":"94ab8b7e.09f27","type":"inject","z":"ff67537b.e2624","name":"Start","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":83.5,"y":410,"wires":[["2f5e9bac.ecbe7c"]]},{"id":"2f5e9bac.ecbe7c","type":"function","z":"ff67537b.e2624","name":"Get ENV","func":"var process = global.get('process');\nmsg.payload = process.env\n\n\nreturn msg;","outputs":1,"noerr":0,"x":245.5,"y":410,"wires":[["34cd4eb3.870d22"]]},{"id":"34cd4eb3.870d22","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"false","x":409.5,"y":410,"wires":[]},{"id":"345d9ab7.e84c5e","type":"http in","z":"c6a09361.94c2b","name":"Load HTTP in","url":"/liveperson","method":"post","upload":false,"swaggerDoc":"","x":103.57142639160156,"y":98.57143020629883,"wires":[["9ee760b6.19cba8"]]},{"id":"58d3ffc6.718f88","type":"function","z":"c6a09361.94c2b","name":"Set Params","func":"msg.source = \"LivePerson\"\nvar workspace_id = msg.req.query.workspace_id\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname\n\n//create a null context and test for session existance\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id \n   }\n \nvar newmsg = msg.req.query.text\nnewmsg = newmsg.replace(/'/g, \"\");  \n\nvar map = JSON.parse(\"{}\");\nvar image = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\nmsg.payload = newmsg\n\ncontext.fname = fname;\ncontext.map = map;\ncontext.image = image;\ncontext.button = button;\ncontext.source = msg.source\n\nvar params = {\n    context: context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password\n};\n\n// node.log(\"User *** \" + msg.user + \" Said *** \" + newmsg)\n\nmsg.payload = newmsg\nmsg.params = params\n\nreturn msg\n","outputs":1,"noerr":0,"x":611.2499771118164,"y":100.62500095367432,"wires":[["ee330c43.d5ba","c4f18989.df299"]]},{"id":"d06a385e.b72448","type":"function","z":"c6a09361.94c2b","name":"Respone Msg","func":"var Watson_msg = msg.payload;\nvar Watson_response = JSON.stringify(msg.payload.output.text);\nvar Watson_contextOBJ = msg.payload.context;\nvar belementArr = []\nvar totalText = []\nvar texts = msg.payload.output.text\n\nfor (i = 0; i < texts.length; i++) {\n\n  // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n  texts[i] = texts[i].replace(/\\\\/g, \"\");\n  //Dennis - Remove XML SSML tags from chat systems\n  texts[i] =  texts[i].replace(/<[^>]+>/g, \"\");\n \n  if (texts[i].lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = texts[i].lastIndexOf(\"InsMap\")\n     texts[i] = texts[i].substring(0,findindex)\n  } \n   totalText.push(texts[i]);\n}  \n\n\n  //simple buttons\n  if (totalText[totalText.length - 1].lastIndexOf(\"[\") >= 0 ) {\n     findindex = totalText[totalText.length - 1].lastIndexOf(\"[\");\n     findLastindex = totalText[totalText.length - 1].lastIndexOf(\"]\");\n     tempStr = totalText[totalText.length - 1];\n     totalText[totalText.length - 1]  = totalText[totalText.length - 1].substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n     for (a = 0; a < buttonArr.length; a++) { \n        belementArr.push({\"type\": \"button\",\"title\": buttonArr[a],\"click\":{\"actions\":[{\"type\":\"publishText\",\"name\":buttonArr[a], \"text\": buttonArr[a]}]}});\n     }\n  }\n\n  var found_link = 0;\n  var ielementArr = [{\"type\":\"text\"}]\n  //json map\n  mapjsonObj = Watson_contextOBJ.map;\n  if (typeof mapjsonObj.values != \"undefined\") {\n      for (var c in mapjsonObj.values) {\n        imageStr = mapjsonObj.values[c] + \"&size=700x500\" ;\n        node.log(\"Found Json map str: \" + imageStr);\n       ielementArr.push({\"type\":\"image\",\"url\": imageStr});\n      }\n  }\n  \n  \n  //json image\n  imagejsonObj = Watson_contextOBJ.image;\n  if (typeof imagejsonObj.values != \"undefined\") {\n      for (var c in imagejsonObj.values) {\n        imageStr = imagejsonObj.values[c];\n       ielementArr.push({\"type\":\"image\",\"url\": imageStr});\n      }\n  }\n\n  buttonjsonObj = Watson_contextOBJ.button;\n  if (typeof buttonjsonObj.values != \"undefined\") {\n      for (var c in buttonjsonObj.values) {\n        buttonStr = buttonjsonObj.values[c];\n        if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n          found_link = 1;\n          buttonItems = buttonStr.split(\"|\");\n          button_title = buttonItems[0];\n          button_url = buttonItems[1];\n        \n          belementArr.push({\"type\": \"button\",\"title\": button_title,\"click\":{\"actions\":[{\"type\":\"link\",\"name\":button_title, \"uri\": button_url}]}}); \n        }\n        else {\n          button_title = buttonStr;  \n          belementArr.push({\"type\": \"button\",\"title\": button_title,\"click\":{\"actions\":[{\"type\":\"publishText\",\"name\":button_title, \"text\": button_title}]}}); \n        }\n      }\n  }\n\n  node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + totalText)\n  \n  var content = {\"type\": \"vertical\"}\n  ielementArr[0].text = totalText;\n  content.elements = ielementArr;\n\n  if (belementArr.length > 0)  {\n      content.elements[ielementArr.length] = {\"type\": \"horizontal\", \"elements\" : belementArr}\n  }\n\n  if (ielementArr.length > 1 || belementArr.length > 0) {\n      response = {content : content}; \n  }\n  else {\n      response = {text: totalText};    \n  }\n\n  msg.payload = response;\n\n\nreturn msg;","outputs":"1","noerr":0,"x":1140,"y":200,"wires":[["9f46003a.bd0648","164219bd.d1ef7e"]]},{"id":"9ee760b6.19cba8","type":"function","z":"c6a09361.94c2b","name":"Get User","func":"msg.user =  msg.req.query.user_id;\n\nreturn msg;","outputs":1,"noerr":0,"x":260,"y":100,"wires":[["6310c388.ef27dc"]]},{"id":"9f46003a.bd0648","type":"http response","z":"c6a09361.94c2b","name":"Http Response","x":1377.499984741211,"y":198.1249942779541,"wires":[]},{"id":"e54a0e2a.aeb078","type":"subflow:a39d88cb.3e3638","z":"c6a09361.94c2b","x":950,"y":200,"wires":[["d06a385e.b72448"]]},{"id":"6310c388.ef27dc","type":"subflow:5e5f60e7.f240c8","z":"c6a09361.94c2b","name":"","x":435.0892868041992,"y":100.71428871154785,"wires":[["58d3ffc6.718f88"]]},{"id":"a7bc72f2.e71dc","type":"debug","z":"8183a83c.27793","name":"","active":true,"console":"false","complete":"true","x":510.5,"y":506,"wires":[]},{"id":"e72e91a1.ec2d9","type":"function","z":"e3247ffc.0f34","name":"Get User","func":"\nmsg.user = msg.payload.context.vgwSessionID\n\nreturn msg;","outputs":1,"noerr":0,"x":249.99998474121094,"y":107.85714340209961,"wires":[["b3a744fb.14ae08"]]},{"id":"b3a744fb.14ae08","type":"subflow:5e5f60e7.f240c8","z":"e3247ffc.0f34","name":"","x":421.4285583496094,"y":110.80356788635254,"wires":[["131a23e4.57b884"]]},{"id":"cfd2bb0f.d9bb9","type":"subflow:a39d88cb.3e3638","z":"e3247ffc.0f34","x":991.2499618530273,"y":228.4821376800537,"wires":[["710f03b5.874e54"]]},{"id":"9b8a1d96.c503a8","type":"function","z":"7e2111b.f0b9e7","name":"Find Workspace","func":"\nif (msg.payload.trim().toUpperCase().substring(0,6) == \"ASK ME\"){\n    msg.params.workspace_id = \"54141f49-ffa2-4f6b-887c-aac6aea5d42d\";\n    msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n    msg.params.password = \"k0gYo1FjJymP\";\n}\n//msg.payload = msg.payload.replace(/\\s+$/g,'')\nif ((msg.payload.toUpperCase().substring(0,5) == \"HELLO\") && (msg.payload.length > 5)){\n\n msg.testHello = msg.payload.toUpperCase().match(/\\b(BANK|INSURE|CALL CENTER|MONEY|HEALTH|METLIFE|FIDELITY|REGIONS|REGIONS TEST|LIBERTY|QUICKEN)\\b/g);\n if (msg.testHello !== null)\n   {msg.testHello = msg.testHello[0]}\n switch(msg.testHello) {\n    case 'BANK':\n        msg.params.workspace_id = \"d13cc96b-a323-43a1-b484-29d37679ac27\";\n        msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n        msg.params.password = \"k0gYo1FjJymP\";\n        break;\n    case 'INSURE':\n        msg.params.workspace_id = \"54141f49-ffa2-4f6b-887c-aac6aea5d42d\";\n        msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n        msg.params.password = \"k0gYo1FjJymP\";\n        break;\n    case 'CALL CENTER':\n        msg.params.workspace_id = \"faf6e421-43ae-474a-8f9e-e8e10e71e3df\";\n        msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n        msg.params.password = \"k0gYo1FjJymP\";\n        break;\n    case 'MONEY':\n        msg.params.workspace_id = \"c2777aef-fe89-4df5-8792-46880d6a0662\";\n        msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n        msg.params.password = \"k0gYo1FjJymP\";\n        break;\n    case 'HEALTH':\n        msg.params.workspace_id = \"17727c7a-6339-4bb8-a967-ccd8b12eed76\";\n        msg.params.username = \"e78c76ea-d8aa-4ed6-9fec-292455f3eb17\";\n        msg.params.password = \"UHJz4sZqu5Vq\";\n        break;    \n    case 'QUICKEN':\n        msg.params.workspace_id = \"20918e28-1c00-4611-8e88-60642ea77ebc\";\n        msg.params.username = \"0b41c42f-545b-4bb0-92a8-1824844b4e33\";\n        msg.params.password = \"S6zRVMYapwPy\";\n        break;    \n    case 'METLIFE':\n        msg.params.workspace_id = \"5fd7c1c7-9ea2-4fc8-b6fa-7920e10aad5a\";\n        msg.params.username = \"7d18e2e6-310b-4efc-9370-d9a8289e17dd\";\n        msg.params.password = \"UEVfKB4CLIyF\";\n        break;\n    case 'FIDELITY':\n        msg.params.workspace_id = \"1555159e-fa59-4d8d-bfba-b10a19144e22\";\n        msg.params.username = \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n        msg.params.password = \"k0gYo1FjJymP\";\n        break;\n     case 'REGIONS':\n        msg.params.workspace_id = \"321e996d-efee-42a0-8aed-3dc93006a026\";\n        msg.params.username = \"f40d2d94-d2e7-4dd1-a718-b57d93203aaa\";\n        msg.params.password = \"cYuHIo2dCmwf\";\n        break;\n     case 'REGIONS TEST':\n        msg.params.workspace_id = \"de1089d8-46e6-4a7d-b5ed-03c5338b7b0a\";\n        msg.params.username = \"271cc33b-4cf3-480c-8798-f4b3e980df00\";\n        msg.params.password = \"BlnizADsfAh8\";\n        break;\n    case 'LIBERTY':\n        msg.params.workspace_id = \"893ec9b6-bfc8-426a-8fd1-592a2e6ebaa8\";\n        msg.params.username = \"6c6eb782-c2ea-4b14-8912-072ac57eee3a\";\n        msg.params.password = \"Au5euZDUZBvO\";\n        break;\n    default: \n }\n}\n// check for date and compute age context vars\nif (msg.payload.lastIndexOf('/') >= 0 ) {\n     var myindex = msg.payload.lastIndexOf('/')\n     var dateString = msg.payload\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     var years = now.getFullYear() - d.getFullYear()\n\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var age = years + days /365\n    \n     msg.params.context.age = Math.round(age *100)/100\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     msg.params.context.ageEOY = Math.round(ageEOY * 100)/100\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     msg.params.context.ageBOY = Math.round(ageBOY * 100)/100\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":60,"wires":[[]]},{"id":"31af5cb5.59db04","type":"subflow:7e2111b.f0b9e7","z":"724cdd96.923cdc","x":845.6249771118164,"y":139.9999942779541,"wires":[["7491c6b3.83bbe"]]},{"id":"69dbcf69.4a6198","type":"subflow:7e2111b.f0b9e7","z":"8a20faf1.e98998","x":1133.1249771118164,"y":100.62500190734863,"wires":[["9334556b.82555"]]},{"id":"6a793fb5.5f7bd","type":"comment","z":"401cee62.babb8","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":357.5,"y":396.87499237060547,"wires":[]},{"id":"48f613a9.25af64","type":"comment","z":"9f54b786.c40c38","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":368.1249694824219,"y":377.49999237060547,"wires":[]},{"id":"3a399473.4215c4","type":"comment","z":"8a20faf1.e98998","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":355.625,"y":483.12499809265137,"wires":[]},{"id":"4e24249c.dc1c8c","type":"comment","z":"724cdd96.923cdc","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":363.75,"y":541.2500228881836,"wires":[]},{"id":"edb558c5.7a362","type":"comment","z":"fabc60c3.885ec8","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":361,"y":546.0000228881836,"wires":[]},{"id":"aea0b66f.802598","type":"comment","z":"e3247ffc.0f34","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":378.12498474121094,"y":375.3571357727051,"wires":[]},{"id":"bb230e28.6027e","type":"comment","z":"e3247ffc.0f34","name":"Using new SAAS VG, we control config and session","info":"","x":261.24998474121094,"y":33.48214340209961,"wires":[]},{"id":"3e18c23c.75d346","type":"comment","z":"c6a09361.94c2b","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":360.1666679382324,"y":457.6666717529297,"wires":[]},{"id":"ee330c43.d5ba","type":"subflow:7e2111b.f0b9e7","z":"c6a09361.94c2b","x":836.8749771118164,"y":99.37500095367432,"wires":[["82844058.e6f03"]]},{"id":"cd0cd877.391d78","type":"comment","z":"ebe88beb.81da2","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":364.49998474121094,"y":444.6666622161865,"wires":[]},{"id":"e793fb97.299798","type":"subflow:7e2111b.f0b9e7","z":"401cee62.babb8","x":850.6249771118164,"y":100,"wires":[["3e24f41c.eaa0cc"]]},{"id":"48382bcb.9a68bc","type":"subflow:7e2111b.f0b9e7","z":"9f54b786.c40c38","x":1154.3749809265137,"y":118.75,"wires":[["c5306307.23f5d"]]},{"id":"241f7e58.f071fa","type":"subflow:7e2111b.f0b9e7","z":"fabc60c3.885ec8","x":874.9999771118164,"y":99.37500095367432,"wires":[["bd4306d7.6b0cb"]]},{"id":"c4f18989.df299","type":"debug","z":"c6a09361.94c2b","name":"","active":true,"console":"false","complete":"payload","x":780,"y":40,"wires":[]},{"id":"164219bd.d1ef7e","type":"debug","z":"c6a09361.94c2b","name":"","active":true,"console":"false","complete":"payload","x":1366.6827239990234,"y":129.1826877593994,"wires":[]},{"id":"823868d7.b15ae8","type":"inject","z":"22659eb7.a53b82","name":"Execute","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":133.07691955566406,"y":140.00000190734863,"wires":[["6fc587a8.abad38"]]},{"id":"6fc587a8.abad38","type":"function","z":"22659eb7.a53b82","name":"Flush Redis Keys","func":"var redis = global.get('redis');\nvar options = {enable_offline_queue:false};\n   \nvar redisClient = global.get(\"redisClient\");\nif (typeof redisClient == \"undefined\") {\n  redisClient = new redis('redis://admin:XFRLCLICWCFQXPXA@sl-us-south-1-portal.5.dblayer.com:35110',options);\n//  redisClient = new redis('redis://admin:IVKPWZBPOAJYQCRR@bluemix-sandbox-dal-9-portal.7.dblayer.com:27247',options);\n  global.set(\"redisClient\",redisClient);\n  node.log(\"New RedisClient connection in SetSession\")\n}\n\n\nredisClient.on(\"error\", function (err) {\n    node.error(\"Error \" + err);\n//    client.disconnect(); \n});\n\nredisClient.flushdb( function (err, response) {\n   if (err) \n      node.error(\"Error \" + err);\n    else \n      msg.payload = response;\n//   client.disconnect(); \n   node.send(msg);\n});\n","outputs":1,"noerr":0,"x":316.1538391113281,"y":140.0000057220459,"wires":[["791e64be.57073c"]]},{"id":"791e64be.57073c","type":"debug","z":"22659eb7.a53b82","name":"","active":true,"console":"false","complete":"true","x":511.80770111083984,"y":139.69230937957764,"wires":[]},{"id":"31e8f876.ee1738","type":"watson-tone-analyzer-v3","z":"544bc80b.e141f8","name":"Tone","tones":"all","sentences":"true","contentType":"false","tone-method":"generalTone","interface-version":"2016-05-19","inputlang":"en","default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/tone-analyzer/api","x":166.00000381469727,"y":33.33333396911621,"wires":[["561e63d0.6ebbec"]]},{"id":"584a230d.5686b4","type":"debug","z":"8a20faf1.e98998","name":"","active":true,"console":"false","complete":"true","x":1101.2499809265137,"y":41.25000047683716,"wires":[]},{"id":"6d100f22.afe078","type":"debug","z":"724cdd96.923cdc","name":"","active":true,"console":"false","complete":"true","x":806.8749771118164,"y":80,"wires":[]},{"id":"9e133318.b0cf2","type":"debug","z":"fabc60c3.885ec8","name":"","active":true,"console":"false","complete":"true","x":784.3749771118164,"y":36.875,"wires":[]},{"id":"3c33a856.b99de8","type":"debug","z":"e3247ffc.0f34","name":"","active":true,"console":"false","complete":"true","x":1392.2115173339844,"y":146.75136375427246,"wires":[]},{"id":"12944cd3.d6e903","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"true","x":768.6470947265625,"y":56.94120788574219,"wires":[]},{"id":"29adcec8.7c3032","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"false","x":1268.6107177734375,"y":150,"wires":[]},{"id":"acebf2cb.3aecf","type":"subflow:7e2111b.f0b9e7","z":"ff67537b.e2624","x":822.84619140625,"y":116.923095703125,"wires":[["dd9bb457.e0f268"]]},{"id":"4a0c3b79.0ccbb4","type":"subflow:7e2111b.f0b9e7","z":"e3247ffc.0f34","x":825.2197723388672,"y":107.03296184539795,"wires":[["32544d81.474c8a"]]},{"id":"f0bd6ad0.31a008","type":"catch","z":"ff67537b.e2624","name":"","scope":null,"x":1103,"y":345,"wires":[["db84cefe.561548"]]},{"id":"5cef9dbd.cad934","type":"catch","z":"401cee62.babb8","name":"","scope":null,"x":916.9166488647461,"y":324.6057758331299,"wires":[["75577f.4780e88"]]},{"id":"67a97ce9.96b394","type":"catch","z":"9f54b786.c40c38","name":"","scope":null,"x":1149.9615287780762,"y":324.3846092224121,"wires":[["a2888224.6593c8"]]},{"id":"a80d2814.5d97b","type":"catch","z":"8a20faf1.e98998","name":"","scope":null,"x":1086.5961227416992,"y":202.39422607421875,"wires":[["1c265553.3134db"]]},{"id":"db84cefe.561548","type":"subflow:af0dd578.89a848","z":"ff67537b.e2624","x":1263.8460693359375,"y":344.076904296875,"wires":[[]]},{"id":"75577f.4780e88","type":"subflow:af0dd578.89a848","z":"401cee62.babb8","x":1083.278793334961,"y":324.60573959350586,"wires":[[]]},{"id":"a2888224.6593c8","type":"subflow:af0dd578.89a848","z":"9f54b786.c40c38","x":1317.846176147461,"y":325.009578704834,"wires":[[]]},{"id":"1c265553.3134db","type":"subflow:af0dd578.89a848","z":"8a20faf1.e98998","x":1246.5960693359375,"y":202.3942413330078,"wires":[[]]},{"id":"6b5e3b04.994be4","type":"catch","z":"724cdd96.923cdc","name":"","scope":null,"x":1359.1827239990234,"y":361.3461580276489,"wires":[["d380a49e.f7f708"]]},{"id":"d380a49e.f7f708","type":"subflow:af0dd578.89a848","z":"724cdd96.923cdc","x":1520.0480842590332,"y":359.4711265563965,"wires":[[]]},{"id":"e6837683.759fd","type":"catch","z":"fabc60c3.885ec8","name":"","scope":null,"x":1284.163330078125,"y":231.50961303710938,"wires":[["a0376b7e.214f38"]]},{"id":"a0376b7e.214f38","type":"subflow:af0dd578.89a848","z":"fabc60c3.885ec8","x":1460.605697631836,"y":230.75960731506348,"wires":[[]]},{"id":"fa8ba8a9.b8ff6","type":"catch","z":"e3247ffc.0f34","name":"","scope":null,"x":1065.8173522949219,"y":302.18404388427734,"wires":[["9837fc06.c95e48"]]},{"id":"9837fc06.c95e48","type":"subflow:af0dd578.89a848","z":"e3247ffc.0f34","x":1238.2692565917969,"y":302.0398178100586,"wires":[[]]},{"id":"992ce35.47570a","type":"catch","z":"c6a09361.94c2b","name":"","scope":null,"x":947.3557739257812,"y":277.35577392578125,"wires":[["6e6e927f.792604"]]},{"id":"6e6e927f.792604","type":"subflow:af0dd578.89a848","z":"c6a09361.94c2b","x":1107.4134521484375,"y":277.35577392578125,"wires":[[]]},{"id":"994cfbb6.67cce","type":"catch","z":"ebe88beb.81da2","name":"","scope":null,"x":782.6923065185547,"y":368.46154403686523,"wires":[["458e855d.cb20f4"]]},{"id":"458e855d.cb20f4","type":"subflow:af0dd578.89a848","z":"ebe88beb.81da2","x":943.4615384615382,"y":368.4615384615384,"wires":[[]]},{"id":"3e24f41c.eaa0cc","type":"subflow:544bc80b.e141f8","z":"401cee62.babb8","x":478.7083511352539,"y":219.00000381469727,"wires":[["60b94c87.7e5434"]]},{"id":"c5306307.23f5d","type":"subflow:544bc80b.e141f8","z":"9f54b786.c40c38","x":715.1666030883789,"y":239.9999942779541,"wires":[["fe6fb0f8.840018"]]},{"id":"9334556b.82555","type":"subflow:544bc80b.e141f8","z":"8a20faf1.e98998","x":608.3749465942383,"y":261.6250123977661,"wires":[["e06ae3d5.e93e4"]]},{"id":"7491c6b3.83bbe","type":"subflow:544bc80b.e141f8","z":"724cdd96.923cdc","x":725.3333129882812,"y":280.6666564941406,"wires":[["437a5c5b.a5766c"]]},{"id":"92dca23a.f4fa1","type":"subflow:544bc80b.e141f8","z":"fabc60c3.885ec8","x":854.9999809265137,"y":443.6666851043701,"wires":[["d1f93149.bb6458"]]},{"id":"32544d81.474c8a","type":"subflow:544bc80b.e141f8","z":"e3247ffc.0f34","x":620.9999618530273,"y":227.8571376800537,"wires":[["f65bc627.2b6de"]]},{"id":"82844058.e6f03","type":"subflow:544bc80b.e141f8","z":"c6a09361.94c2b","x":584.3333129882812,"y":200.00001525878906,"wires":[["85e4f327.6fa498"]]},{"id":"8b1a28cc.949178","type":"subflow:544bc80b.e141f8","z":"ebe88beb.81da2","x":566.124942779541,"y":160.0416660308838,"wires":[["ab295222.7eda5"]]},{"id":"a637b489.cde77","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":75,"y":1374.375036239624,"wires":[["f3ecba76.d282c8"]]},{"id":"3ca91518.6a8582","type":"http request","z":"68b0d95d.ae26b8","name":"WDS Delete Doc","method":"DELETE","ret":"txt","url":"","tls":"","x":455,"y":1374.375036239624,"wires":[["5b3f25f2.4f740c"]]},{"id":"5b3f25f2.4f740c","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"payload","x":655,"y":1374.375036239624,"wires":[]},{"id":"f1790e02.3bba48","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":589.9999732971191,"y":206.50002670288086,"wires":[["48a23271.e911a4"]]},{"id":"48a23271.e911a4","type":"function","z":"68b0d95d.ae26b8","name":"Build Single JSON Doc","func":"\n\n/*UCG enriched fields for WDS\n  Type  |   Fields\n--------|-----------------\nTerm    | Key = Term, Text = Definiition\nQA      | Key = Question, Text = Answer\nArticle | Key = Title, Text = Article\n*/\n\ndata = {Key  : \"Dennis Noto\",\n          Text : \"UCG Creator\",\n          Type : \"Term\",\n  }\n\nmsg.document_id = Type + \"-\" + Term\nmsg.payload =  data\nmsg.payload.filename = msg.document_id + \".json\"\n\nreturn msg;\n","outputs":1,"noerr":0,"x":791.9166870117188,"y":206.50007820129395,"wires":[["af8b05af.b2138"]]},{"id":"6344afd0.e9c8e","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":81.875,"y":260.75004959106445,"wires":[["54c0c1df.03aad8"]]},{"id":"54c0c1df.03aad8","type":"file in","z":"68b0d95d.ae26b8","name":"","filename":"/data/investopedia_terms.csv","format":"utf8","chunk":false,"sendError":false,"x":302.7960510253906,"y":260.2237358093262,"wires":[["39cfc4a5.658ffc"]]},{"id":"99af65d7.767f8","type":"comment","z":"68b0d95d.ae26b8","name":"Now in the Get Answer Subflow","info":"","x":150,"y":47.49999976158142,"wires":[]},{"id":"4109c6bd.a90ac8","type":"comment","z":"68b0d95d.ae26b8","name":"Used to delete a doc","info":"","x":105,"y":1314.375036239624,"wires":[]},{"id":"b1ba73e5.9e038","type":"comment","z":"68b0d95d.ae26b8","name":"Used to ingest docs from a CSV file via HTTP or NFS","info":"","x":226.75,"y":190.75005531311035,"wires":[]},{"id":"90bc7a69.9ef9c8","type":"comment","z":"68b0d95d.ae26b8","name":"Used to get Collection, Training Data, and Notices information","info":"","x":255,"y":650.8749561309814,"wires":[]},{"id":"f3ecba76.d282c8","type":"function","z":"68b0d95d.ae26b8","name":"Set Delete Doc","func":"\nmsg.collection_id = \"06bca61b-6cad-4573-a618-215ae55b643c\"\nmsg.environment_id = \"d40ba5ee-be86-4b59-8a67-f463f233367d\"\nmsg.doc_id = \"Article-Contact-credit-bureaus-if-are-a-victim-of-identity-theft\"\n\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/documents/\" + msg.doc_id + \"?version=2017-11-07\"\n\nreturn msg;","outputs":1,"noerr":0,"x":245,"y":1374.375036239624,"wires":[["3ca91518.6a8582"]]},{"id":"89efdfb3.d11048","type":"function","z":"68b0d95d.ae26b8","name":"WDS Search","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\nvar params = {\n    natural_language_query: \"How does a adjustable rate mortgage work\",\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    configuration_id: \"1d573129-7100-4405-b6a0-439cd8af2640\",\n    passages: true, //if you want to enable passages\n    passages_fields : \"Text\",\n    count : 10\n    //sort : \"Term\"\n   //  return: ''\n  //highlight: true //if you want to enable highlight\n\n}\n\ndiscovery.query(params, (error, results) => {\n    if (error) {\n      node.error(error);\n    } else {\n      msg.WDSResults = results; //your query results\n      node.send(msg);\n        \n    }\n});\n","outputs":1,"noerr":0,"x":250,"y":100,"wires":[["ec4a842e.117e6"]]},{"id":"874ef68e.57b2b8","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":84.99999618530273,"y":758.1249923706055,"wires":[["983bb298.2d575"]]},{"id":"4dd5e278.725c2c","type":"function","z":"68b0d95d.ae26b8","name":"WDS Training data Info URL","func":"\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/training_data?version=2017-11-07\"\n\nreturn msg;","outputs":1,"noerr":0,"x":471.99999618530273,"y":758.1249923706055,"wires":[["7bb32c7.27facd4"]]},{"id":"7bb32c7.27facd4","type":"http request","z":"68b0d95d.ae26b8","name":"Execute URL","method":"GET","ret":"obj","url":"","tls":"","x":720.9999961853027,"y":757.1249923706055,"wires":[["f5bb6aa3.877d28"]]},{"id":"f5bb6aa3.877d28","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"false","x":906.0000190734863,"y":756.1249799728394,"wires":[]},{"id":"444439e6.b20888","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":91,"y":962.8750228881836,"wires":[["f99dd623.3d872"]]},{"id":"f99dd623.3d872","type":"function","z":"68b0d95d.ae26b8","name":"Get doc by id","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\nvar params = {\n    query: \"_id:SIMPLE-IRA\",\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    configuration_id: \"1d573129-7100-4405-b6a0-439cd8af2640\",\n    passages: true\n}\n\ndiscovery.query(params, (error, results) => {\n    if (error) {\n      node.error(error);\n    } else {\n      msg.payload = results; //your query results\n      node.send(msg);\n        \n    }\n});","outputs":1,"noerr":0,"x":255,"y":962.8750228881836,"wires":[["12e820df.c28357"]]},{"id":"12e820df.c28357","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"false","x":442,"y":962.8750228881836,"wires":[]},{"id":"eb463de5.329a5","type":"function","z":"68b0d95d.ae26b8","name":"WDS Collection info URL","func":"\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"?version=2017-11-07\"\n\nreturn msg;","outputs":1,"noerr":0,"x":469.83333587646484,"y":711.4583129882812,"wires":[["7bb32c7.27facd4"]]},{"id":"6899132a.d95c74","type":"function","z":"68b0d95d.ae26b8","name":"WDS Get Notices URL","func":"\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/notices?version=2017-11-07\"\n\nreturn msg;","outputs":1,"noerr":0,"x":470.49999237060547,"y":804.7916870117188,"wires":[["7bb32c7.27facd4"]]},{"id":"983bb298.2d575","type":"function","z":"68b0d95d.ae26b8","name":"Set Params","func":"msg.collection_id = \"35835dcf-e873-4a43-9034-786210ffebf2\"\nmsg.environment_id = \"d40ba5ee-be86-4b59-8a67-f463f233367d\"\n\nreturn msg;","outputs":1,"noerr":0,"x":230.49999618530273,"y":758.1249923706055,"wires":[["4dd5e278.725c2c","eb463de5.329a5","6899132a.d95c74"]]},{"id":"8acf05fb.5a59a8","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":91.5,"y":1233.1250343322754,"wires":[["9e23b887.8e4738"]]},{"id":"9e23b887.8e4738","type":"function","z":"68b0d95d.ae26b8","name":"WDS Delete Training Example URL","func":"msg.collection_id = \"35835dcf-e873-4a43-9034-786210ffebf2\"\nmsg.environment_id = \"d40ba5ee-be86-4b59-8a67-f463f233367d\"\nmsg.query_id = \"321177599782e7d8cbe136dc25ec1626616648af\"\nmsg.examples_id = \"034cdf93-e7ce-4bd7-ac98-60b0896202ee\"\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/training_data/\" + msg.query_id + \"/examples/\" + msg.examples_id + \"?version=2017-11-07\"\n\nreturn msg;\n","outputs":1,"noerr":0,"x":313.5,"y":1233.1250343322754,"wires":[["cf72e58d.236ce8"]]},{"id":"cf72e58d.236ce8","type":"http request","z":"68b0d95d.ae26b8","name":"Execute URL","method":"DELETE","ret":"txt","url":"","tls":"","x":570.5,"y":1233.1250343322754,"wires":[["f4aa8576.fb93c8"]]},{"id":"f4aa8576.fb93c8","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"payload","x":769.5,"y":1233.1250343322754,"wires":[]},{"id":"4e66541b.3021ec","type":"switch","z":"8d1a3e5b.b49e8","name":"Answer Switch","property":"answerType","propertyType":"msg","rules":[{"t":"eq","v":"WCS","vt":"str"},{"t":"eq","v":"WDS","vt":"str"}],"checkall":"true","outputs":2,"x":760.7586822509766,"y":71.87337303161621,"wires":[[],["97fdddf1.9e811"]]},{"id":"d3bb15b1.8303c8","type":"function","z":"8d1a3e5b.b49e8","name":"Check WCS Confidence","func":"msg.answerType = \"WCS\" \nmsg.highIntent = false\nmsg.highEntity = false\nvar savIntentConf = 0\nvar savEntityConf = 0\nvar intentFound = false\nvar entityFound = false\nmsg.USE_WCS_ANSWER = false\nmsg.USE_WDS_ANSWER = false\nmsg.UCG_ANSWER_ROUTING = \"WCS-WDS\"\n/*\nUCG_ANSWER_ROUTING\n  This will be used to allow engineers to change the answer routing via a context var.\n  Possible Values:\n    WCS-WDS     - the default routing that uses a canned answer that replaces WCS's output.text array\n    WCS-WDS-WCS - routes back through WCS after calling WDS with new context vars\n              WDSResults - JSON object with payload from WDS\n              answerType - either WCS or WDS to indicate what where the answer came from.\n\nUSE_WDS_ANSWER\n   Used to override flow to send utterance to WDS for an answer\n\nUSE_WCS_ANSWER\n   Used to ensure that flow retains answer from WCS, thus by passing confidence/anything else checks\n  \n  WCS engineers need to set context var USE_WCS_ANSWER if the dialog condition statement:\n     1) does not use an intent or entity, like using tone score to give back an answer\n     2) use true to force node answer and a low confidence match comes back for an intent or entity\n\n*/\nif (typeof msg.payload.context !== \"undefined\"){ \n    if (typeof msg.payload.context.USE_WCS_ANSWER !== \"undefined\"){ \n        msg.USE_WCS_ANSWER = true\n        delete msg.payload.context.USE_WCS_ANSWER\n    }\n    if (typeof msg.payload.context.USE_WDS_ANSWER !== \"undefined\"){ \n        msg.USE_WDS_ANSWER = true\n        delete msg.payload.context.USE_WDS_ANSWER\n    }\n    if (typeof msg.payload.context.UCG_ANSWER_ROUTING !== \"undefined\"){ \n        msg.UCG_ANSWER_ROUTING = msg.payload.context.UCG_ANSWER_ROUTING\n    }\n    \n}    \n\nif (typeof msg.payload.intents[0] !== \"undefined\"){ \n    if (msg.payload.intents[0].confidence > .50){\n      \n         msg.highIntent = true\n    }\n    savIntentConf = msg.payload.intents[0].confidence\n    intentFound = true\n        \n    }\n\nif (typeof msg.payload.entities[0] !== \"undefined\"){\n    if (msg.payload.entities[0].confidence > .50){\n        msg.highEntity = true\n    }\n    savEntityConf = msg.payload.entities[0].confidence\n    entityFound = true\n}\n\n//if (!msg.USE_WCS_ANSWER) {\n // if (msg.highIntent || msg.highEntity ) {\n //   msg.answerType = \"WCS\"\n // }\n if (msg.payload.output.text.length > 0) {\n        // Anything else dialog node - make sure no intent or entity\n        if (msg.payload.output.text[0].toUpperCase().match(/\\b(FUTURE TRAINING|HAVING TROUBLE|HAVEN'T BEEN TRAINED)\\b/g))  {\n                msg.answerType = \"WDS\"\n        }\n        else {msg.answerType = \"WCS\"\n            \n        }\n    \n    /* Going to comment out for now because getting in the way of good answers\n       // Low intent conf     \n        if (intentFound) {\n            if (savIntentConf < .50 ) {\n                msg.answerType = \"WDS\"\n            }\n        }\n        // Low entity conf    \n        if (entityFound) {\n            if (savEntityConf < .50 ) {\n                msg.answerType = \"WDS\"\n            }\n        }\n    */    \n    }\n  else {\n        msg.answerType = \"WDS\" \n  }\n//}\n//else {\n//  msg.answerType = \"WCS\"   \n//}\nif (msg.USE_WCS_ANSWER) {\n  msg.answerType = \"WCS\"   \n} \nif (msg.USE_WDS_ANSWER) {\n  msg.answerType = \"WDS\"   \n}    \n\nmsg.params.context.answerType =  msg.answerType\n\nreturn msg;","outputs":1,"noerr":0,"x":526.323356628418,"y":72.25152778625488,"wires":[["4e66541b.3021ec"]]},{"id":"97fdddf1.9e811","type":"function","z":"8d1a3e5b.b49e8","name":"WDS Search","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\nvar params = {\n    natural_language_query: msg.payload.input.text,\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    configuration_id: \"1d573129-7100-4405-b6a0-439cd8af2640\",\n    passages: true, //if you want to enable passages\n    passages_fields : \"Text\"\n    //sort : \"Term\"\n   //  return: ''\n  //highlight: true //if you want to enable highlight\n\n}\n\ndiscovery.query(params, (error, results) => {\n    if (error) {\n      node.error(error);\n    } else {\n      msg.WDSResults = results; //your query results\n      msg.test = msg.payload.input.abc\n      node.send(msg);\n    }\n});","outputs":1,"noerr":0,"x":721.5738906860352,"y":159.32255268096924,"wires":[["a4df6893.a1584","9424f57d.cfe048"]]},{"id":"dd9bb457.e0f268","type":"subflow:8d1a3e5b.b49e8","z":"ff67537b.e2624","x":709.7856216430664,"y":235.96155738830566,"wires":[["bbb3fca0.f440e","90a0061a.51158"]]},{"id":"4df11fdb.244148","type":"subflow:4e8a84dc.f232fc","z":"8d1a3e5b.b49e8","x":191.1904754638672,"y":221.71429061889648,"wires":[[]]},{"id":"a2fb6c1c.21e1b","type":"comment","z":"8d1a3e5b.b49e8","name":"Can replace single Convo with Dynamic Router Subflow","info":"","x":241.5,"y":170.3333396911621,"wires":[]},{"id":"cc8da6f8.a03aa","type":"comment","z":"8d1a3e5b.b49e8","name":"Run through WCS first, Test confidence and go to WDS if confidence below 50%","info":"","x":325,"y":27.5,"wires":[]},{"id":"1bb80eac.3f8489","type":"comment","z":"68b0d95d.ae26b8","name":"Used to get info on a single document","info":"","x":175,"y":910.2500267028809,"wires":[]},{"id":"d3753744.b38b48","type":"comment","z":"68b0d95d.ae26b8","name":"Used to delete an example when you get a traing error found in a notice","info":"","x":295,"y":1166.6250677108765,"wires":[]},{"id":"d1217ce2.b2b02","type":"function","z":"8d1a3e5b.b49e8","name":"Enhance Answer","func":"if (msg.WDSResults.matching_results > 0){\n    if (typeof msg.WDSResults.results[0].Text !== \"undefined\"){\n        msg.newOutput = []\n        msg.arrayOutput = []\n        \n        msg.testOutput = msg.WDSResults.results[0].Text.split(\"\\r\")\n        if (msg.testOutput.length > 1) {\n            msg.arrayOutput = msg.testOutput\n        }\n        else {\n            msg.arrayOutput.push(msg.WDSResults.results[0].Text)\n        }\n        \n        if (msg.WDSResults.results[0].Type == \"Term\") {\n            msg.newOutput.push(\"I found this definition in my glossary for \" + msg.WDSResults.results[0].Key + \". \")\n        }\n        else if (msg.WDSResults.results[0].Type == \"Article\") {\n            msg.newOutput.push(\"I found this article entitled  \" + msg.WDSResults.results[0].Key + \".\")  \n        }\n        else {\n            \n        }\n        \n        for (i = 0; i < msg.arrayOutput.length; i++) {\n             msg.newOutput.push(msg.arrayOutput[i])\n        }\n        msg.newOutput.push(\"Do you have more questions for me?\")\n        msg.payload.output.text = msg.newOutput\n    }  \n}\nelse {\n   msg.payload.output.text[0] = \"Sorry, I tried many sources to answer your question, can you restate your question?\" \n}\nreturn msg;","outputs":1,"noerr":0,"x":1022.1664772033691,"y":117.0411024093628,"wires":[[]]},{"id":"5f83aed7.20f0b8","type":"function","z":"68b0d95d.ae26b8","name":"WDS Update Single Doc","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\ndata = {Term : \"Dennis Noto\",\n        Text : \"The man, the myth, the legend, he is the most masterful innovator of our time, not Steve Jobs, but Dennis Noto!\",\n        Type : \"Term\"\n  }\n\nvar params = {\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    configuration_id: \"1d573129-7100-4405-b6a0-439cd8af2640\",\n    document_id : \"6e1fab9c-7153-4646-a160-9ae1471d49ab\",\n    file : data\n\n}\n\ndiscovery.updateJsonDocument(params, (error, results) => {\n    if (error) {\n      node.error(error);\n    } else {\n      msg.payload = results;\n      node.send(msg);\n        \n    }\n});","outputs":1,"noerr":0,"x":282,"y":1094.7500324249268,"wires":[["f6255467.48a6b8"]]},{"id":"b8d8ece5.b0ac","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":87,"y":1094.7500324249268,"wires":[["5f83aed7.20f0b8"]]},{"id":"f6255467.48a6b8","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"false","x":514.3333206176758,"y":1094.7500038146973,"wires":[]},{"id":"caf209ae.7039b8","type":"comment","z":"68b0d95d.ae26b8","name":"Used to update a doc","info":"","x":115,"y":1049.7500324249268,"wires":[]},{"id":"af8b05af.b2138","type":"function","z":"68b0d95d.ae26b8","name":"WDS Update Doc","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\nvar params = {\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    configuration_id: \"1d573129-7100-4405-b6a0-439cd8af2640\",\n    document_id : msg.document_id,\n    file : msg.payload\n}\n\nif (msg.stop) {\n    return msg;\n}\n\ndiscovery.updateJsonDocument(params, (error, results) => {\n    if (error) {\n      node.error(error,msg);\n    } else {\n      msg.payload = results; //your query results\n      node.send(msg);\n        \n    }\n});","outputs":1,"noerr":0,"x":1067.3540420532227,"y":260.4605178833008,"wires":[["4afc153c.55351c","9dc707e5.7b9ae"]]},{"id":"9dc707e5.7b9ae","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"payload","x":1284.95263671875,"y":213.24243354797363,"wires":[]},{"id":"69af2ce5.f92cec","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":81.16696166992188,"y":484.50000381469727,"wires":[["e89689e8.a0988"]]},{"id":"e89689e8.a0988","type":"file in","z":"68b0d95d.ae26b8","name":"","filename":"/data/Articles_TrainingQueries.csv","format":"utf8","chunk":false,"sendError":false,"x":308.1113967895508,"y":484.4999876022339,"wires":[["20029ec1.7a3fca"]]},{"id":"20029ec1.7a3fca","type":"csv","z":"68b0d95d.ae26b8","name":"Convert Training CSV","sep":",","hdrin":true,"hdrout":"","multi":"mult","ret":"\\n","temp":"","x":608.833625793457,"y":484.5000104904175,"wires":[["2cfbf179.5bb6ce"]]},{"id":"2cfbf179.5bb6ce","type":"function","z":"68b0d95d.ae26b8","name":"Build JSON Training","func":"msg.collection_id = \"06bca61b-6cad-4573-a618-215ae55b643c\"\nmsg.environment_id = \"d40ba5ee-be86-4b59-8a67-f463f233367d\"\nvar processArray = msg.payload\nmsg.stop = false\n\nfor (i = 0; i < processArray.length + 1; i++) {\n//for (i = 0; i < 2; i++) { \n (function(i) { setTimeout(function() {\n            \n            if (i == processArray.length) {\n                     msg.stop = true\n                     msg.payload = {status : \"Finished\"}\n                     node.send(msg);\n            }\n            else {      \n                  \n                  data = {natural_language_query  : processArray[i].Query,\n                              examples : []\n                  }\n                  \n                 \n                  if (processArray[i].ReleventDoc1 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].ReleventDoc1, \"relevance\" : processArray[i].RScore1});\n                  }\n                 \n                  if (processArray[i].ReleventDoc2 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].ReleventDoc2, \"relevance\" : processArray[i].RScore2});\n                  }\n                \n                  if (processArray[i].ReleventDoc3 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].ReleventDoc3, \"relevance\" : processArray[i].RScore3});\n                  }\n                 \n                  if (processArray[i].NonReleventDoc1 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].NonReleventDoc1, \"relevance\" : processArray[i].NRScore1});\n                  }\n                  \n                  if (processArray[i].NonReleventDoc2 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].NonReleventDoc2, \"relevance\" : processArray[i].NRScore2});\n                  }\n                  \n                  if (processArray[i].NonReleventDoc3 != \"NA\" ) {\n                     data.examples.push({\"document_id\" : processArray[i].NonReleventDoc3, \"relevance\" : processArray[i].NRScore3});\n                  }\n                  msg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/training_data?version=2017-11-07\"\n                  msg.payload =  data;\n                  node.send(msg);\n                  \n            }\n                \n        }, 1000 * i);\n    })(i);\n}\n\n","outputs":"1","noerr":0,"x":862.2780838012695,"y":484.50000286102295,"wires":[["4ba3f47e.ae3a5c"]]},{"id":"ea5740ab.61d32","type":"http request","z":"68b0d95d.ae26b8","name":"Execute URL","method":"POST","ret":"obj","url":"","tls":"","x":1158.2780532836914,"y":692.2083835601807,"wires":[[]]},{"id":"721e4d91.e9418c","type":"function","z":"68b0d95d.ae26b8","name":"Build a single Query","func":"msg.collection_id = \"a3d865d3-f2b0-4dcb-8573-4c232dcb7fbc\"\nmsg.environment_id = \"d40ba5ee-be86-4b59-8a67-f463f233367d\"\n\n\ndata = {natural_language_query  : \"What is a zero coupon bond?\",\n        examples : [\n                              \n                    {\"document_id\" : \"Term-Zero-Coupon-Bond\", \"relevance\" : 100},\n                    {\"document_id\" : \"Term-Bond\", \"relevance\" : 90},\n                    {\"document_id\" : \"Term-Bond-Discount\", \"relevance\" : 0},\n                    {\"document_id\" : \"Term-Corporate-Bond\", \"relevance\" : 0},\n                   ]\n}\n\n\nmsg.url = \"https://gateway.watsonplatform.net/discovery/api/v1/environments/\" + msg.environment_id + \"/collections/\" + msg.collection_id + \"/training_data?version=2017-11-07\"\nmsg.payload =  data;\nreturn msg;","outputs":1,"noerr":0,"x":875.7919464111328,"y":425.1666593551636,"wires":[["4ba3f47e.ae3a5c"]]},{"id":"d66d08b3.d6b1e8","type":"inject","z":"68b0d95d.ae26b8","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":692.7919311523438,"y":425.66666984558105,"wires":[["721e4d91.e9418c"]]},{"id":"199a956d.0eb3bb","type":"comment","z":"68b0d95d.ae26b8","name":"Used to ingest training data from CSV file via HTTP or NFS","info":"","x":245,"y":417.2500591278076,"wires":[]},{"id":"60b94c87.7e5434","type":"subflow:8d1a3e5b.b49e8","z":"401cee62.babb8","name":"","x":654.6250076293945,"y":219.37500381469727,"wires":[["ec702d75.af3078","47e38ef0.8b2518"]]},{"id":"fe6fb0f8.840018","type":"subflow:8d1a3e5b.b49e8","z":"9f54b786.c40c38","x":900.7856826782227,"y":239.37499523162842,"wires":[["366069a.20f8296"]]},{"id":"e06ae3d5.e93e4","type":"subflow:8d1a3e5b.b49e8","z":"8a20faf1.e98998","x":789.9285659790039,"y":261.6250123977661,"wires":[["fa5fbfcc.8cf84"]]},{"id":"437a5c5b.a5766c","type":"subflow:8d1a3e5b.b49e8","z":"724cdd96.923cdc","x":909.3571548461914,"y":280.28571796417236,"wires":[["4bc06ad1.ba1b14"]]},{"id":"f65bc627.2b6de","type":"subflow:8d1a3e5b.b49e8","z":"e3247ffc.0f34","x":800.6428527832031,"y":227.85714721679688,"wires":[["cfd2bb0f.d9bb9","3a995c13.aff4d4"]]},{"id":"85e4f327.6fa498","type":"subflow:8d1a3e5b.b49e8","z":"c6a09361.94c2b","x":763.5,"y":200,"wires":[["e54a0e2a.aeb078","a6809a9.94b9fe8"]]},{"id":"ab295222.7eda5","type":"subflow:8d1a3e5b.b49e8","z":"ebe88beb.81da2","x":752.4999771118164,"y":160.99999332427979,"wires":[["ea065a9c.29329"]]},{"id":"d1f93149.bb6458","type":"subflow:8d1a3e5b.b49e8","z":"fabc60c3.885ec8","x":1042.6250038146973,"y":442.75,"wires":[["5730355d.27fdec","a5ca195a.10927"]]},{"id":"44086e3c.da78b8","type":"debug","z":"401cee62.babb8","name":"","active":true,"console":"false","complete":"true","x":1211.8750190734863,"y":135.00000190734863,"wires":[]},{"id":"d7a80257.f71f5","type":"debug","z":"401cee62.babb8","name":"","active":true,"console":"false","complete":"true","x":784.7916641235352,"y":34.16667366027832,"wires":[]},{"id":"f2d3f3e6.7021e8","type":"function","z":"8d1a3e5b.b49e8","name":"WCS","func":"/* New param to added to all front-ends - wcs_region = USSOUTH, GERMANY\nWill be used to set the url\nUSSOUTH - https://gateway.watsonplatform.net/conversation/api\nGERMANY - https://gateway-fra.watsonplatform.net/conversation/api\n*/\nvar watson = global.get('watson');\nmsg.params.input = {\n      text: msg.payload\n    };\n\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  workspace_id : msg.params.workspace_id,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 15 second time out\", msg)}, 15000 );\n\nconversation.message(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);\n","outputs":1,"noerr":0,"x":157.1660919189453,"y":74.16399717330933,"wires":[["a243238f.2a43a8"]]},{"id":"4f4c4043.23b748","type":"function","z":"4e8a84dc.f232fc","name":"WCS","func":"var watson = global.get('watson');\nmsg.params.input = {\n      text: msg.payload\n    };\n\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.workspace_id = msg.primary_workspace_id\n    msg.params.username = msg.primary_wcs_user_name\n    msg.params.password = msg.primary_wcs_password\n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n   \n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.workspace_id = \"a003413f-2973-4dba-b1ba-550b3fa09a71\";\n    msg.params.username = \"c3a84de4-c0cf-43b6-98a1-8c2bd16fdc1f\";\n    msg.params.password = \"GaZagvcNP3VG\";\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 15 second time out\", msg)}, 15000 );\n\nconversation.message(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);","outputs":1,"noerr":0,"x":932.083309173584,"y":106.6666612625122,"wires":[[]]},{"id":"50bec6a6.e7d2c","type":"debug","z":"4e8a84dc.f232fc","name":"","active":true,"console":"false","complete":"true","x":132.91666666666666,"y":218.33333333333331,"wires":[]},{"id":"a16ff365.933568","type":"comment","z":"4e8a84dc.f232fc","name":"Assumes US-SOUTH as the primary region, will remove when region goes into the session and front-ends start sending region param to set primary-region","info":"","x":602.0833435058594,"y":289.16669273376465,"wires":[]},{"id":"1e76d979.d9aadf","type":"function","z":"4e8a84dc.f232fc","name":"WCS Workspaces Ping","func":"var watson = global.get('watson');\n\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.username = msg.primary_wcs_user_name\n    msg.params.password = msg.primary_wcs_password\n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n   \n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.username = \"c3a84de4-c0cf-43b6-98a1-8c2bd16fdc1f\";\n    msg.params.password = \"GaZagvcNP3VG\";\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"WCS ListWorkSpaces API reached 15 second time out\", msg)}, 15000 );\n\nconversation.listWorkspaces(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);\n","outputs":1,"noerr":0,"x":552.0834503173828,"y":34.99998378753662,"wires":[["db7fb279.76c6f8"]]},{"id":"2fcc7209.a07b16","type":"inject","z":"ff67537b.e2624","name":"Start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":82.91666412353516,"y":472.49999809265137,"wires":[["550d50be.cecf48"]]},{"id":"550d50be.cecf48","type":"function","z":"ff67537b.e2624","name":"List workspaces","func":"var watson = global.get('watson');\nmsg.region = \"GERMANY\"\nmsg.primary_wcs_user_name = \"4acac659-e820-4ef6-8421-e88f517c9c4c\"\nmsg.primary_wcs_password = \"k0gYo1FjJymP\"\nmsg.params = {}\n\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.username = msg.primary_wcs_user_name\n    msg.params.password = msg.primary_wcs_password\n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n   \n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.username = \"c3a84de4-c0cf-43b6-98a1-8c2bd16fdc1f\";\n    msg.params.password = \"GaZagvcNP3VG\";\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"We timed out\", msg)}, 15000 );\n\nconversation.listWorkspaces(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);\n","outputs":1,"noerr":0,"x":251.24999237060547,"y":473.3333320617676,"wires":[["176e1c79.e25a5c"]]},{"id":"176e1c79.e25a5c","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"false","x":443.541690826416,"y":473.3333110809326,"wires":[]},{"id":"22f4657d.3640e2","type":"http in","z":"68b0d95d.ae26b8","name":"","url":"/LoadWDSTrainingData","method":"post","upload":true,"swaggerDoc":"","x":145,"y":550.9381408691406,"wires":[["7a66bfa2.6a8a"]]},{"id":"7a66bfa2.6a8a","type":"function","z":"68b0d95d.ae26b8","name":"Get File Buffer","func":"msg.payload = msg.req.files[0].buffer.toString('utf8')\n\nreturn msg;","outputs":1,"noerr":0,"x":383.9052429199219,"y":550.552809715271,"wires":[["20029ec1.7a3fca","fde0ea51.459bc"]]},{"id":"194716ac.9cb001","type":"debug","z":"68b0d95d.ae26b8","name":"","active":true,"console":"false","complete":"payload","x":1329.2943534851074,"y":446.38232612609863,"wires":[]},{"id":"fde0ea51.459bc","type":"function","z":"68b0d95d.ae26b8","name":"Send Start Msg","func":"msg.payload = \"Start Training data ingestion\"\nreturn msg;","outputs":1,"noerr":0,"x":629.5628051757812,"y":549.4584045410156,"wires":[["409ca907.d83068"]]},{"id":"376f0dda.6cca82","type":"http in","z":"68b0d95d.ae26b8","name":"","url":"/LoadWDSContent","method":"post","upload":true,"swaggerDoc":"","x":128.64584350585938,"y":311.2500877380371,"wires":[["e036fcfa.c9475"]]},{"id":"e036fcfa.c9475","type":"function","z":"68b0d95d.ae26b8","name":"Get File Buffer","func":"msg.payload = msg.req.files[0].buffer.toString('utf8')\n\nreturn msg;","outputs":1,"noerr":0,"x":353.645845413208,"y":311.8750867843628,"wires":[["ae89b931.16727","39cfc4a5.658ffc"]]},{"id":"ae89b931.16727","type":"function","z":"68b0d95d.ae26b8","name":"Send Start Msg","func":"msg.payload = \"Start Content data ingestion\"\nreturn msg;","outputs":1,"noerr":0,"x":602.3958511352539,"y":312.70840072631836,"wires":[["11596027.7090e"]]},{"id":"4afc153c.55351c","type":"json","z":"68b0d95d.ae26b8","name":"","pretty":false,"x":1269.8890800476074,"y":277.5556125640869,"wires":[["11596027.7090e"]]},{"id":"4ba3f47e.ae3a5c","type":"function","z":"68b0d95d.ae26b8","name":"WDS Add Training","func":"var watson = global.get('watson');\n\nvar discovery = new watson.DiscoveryV1({\n  username: \"578d5c5e-a713-44ad-bd8b-d3b8ba39c03c\",\n  password: \"NaFdTJluDnem\",\n  version_date: '2017-11-07'\n});\n\nvar params = {\n    environment_id: \"d40ba5ee-be86-4b59-8a67-f463f233367d\",\n    collection_id: \"35835dcf-e873-4a43-9034-786210ffebf2\",\n    natural_language_query : msg.payload.natural_language_query,\n    examples : msg.payload.examples\n}\n\nif (msg.stop) {\n    return msg;\n}\n\ndiscovery.addTrainingData(params, (error, results) => {\n    if (error) {\n      node.error(error, msg);\n    } else {\n      msg.payload = results; \n      node.send(msg);\n        \n    }\n});\n","outputs":1,"noerr":0,"x":1115.388931274414,"y":484.00008964538574,"wires":[["194716ac.9cb001","bf700d53.92c43"]]},{"id":"b2adc901.959648","type":"catch","z":"68b0d95d.ae26b8","name":"","scope":["2cfbf179.5bb6ce","20029ec1.7a3fca","4ba3f47e.ae3a5c"],"x":1117.888874053955,"y":575.5555267333984,"wires":[["a4690058.953338"]]},{"id":"a4690058.953338","type":"subflow:af0dd578.89a848","z":"68b0d95d.ae26b8","x":1289.8890380859375,"y":575.555567741394,"wires":[["409ca907.d83068"]]},{"id":"78869b91.5b0b74","type":"catch","z":"68b0d95d.ae26b8","name":"","scope":["7fe24eb8.04616","48a23271.e911a4","af8b05af.b2138"],"x":1098.5555801391602,"y":342.66669178009033,"wires":[["1028d0b8.7d52f7"]]},{"id":"1028d0b8.7d52f7","type":"subflow:af0dd578.89a848","z":"68b0d95d.ae26b8","x":1259.2222061157227,"y":341.55559730529785,"wires":[["11596027.7090e"]]},{"id":"bf700d53.92c43","type":"json","z":"68b0d95d.ae26b8","name":"","pretty":false,"x":1307.22216796875,"y":504.8888854980469,"wires":[["409ca907.d83068"]]},{"id":"a6809a9.94b9fe8","type":"debug","z":"c6a09361.94c2b","name":"","active":true,"console":"false","complete":"true","x":834.6078850241265,"y":388.4313830207374,"wires":[]},{"id":"cc143956.a0be58","type":"inject","z":"22659eb7.a53b82","name":"Execute","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":129.90196990966797,"y":222.15686893463135,"wires":[["d6055ccc.b963e"]]},{"id":"d6055ccc.b963e","type":"function","z":"22659eb7.a53b82","name":"Add Doc","func":"var d = new Date();\nvar milliMST = 6*60*60*1000;\nvar localeDate = new Date(d.getTime()-milliMST);\n\nvar addDoc = {\n    convoUser : \"QuickenLoansProfile\",\n    convoTS : localeDate,\n    Mortgage_Type : \"7 Year Fixed Rate Mortgage\",\n    Balance : \"$350,000\",\n    Payment : \"$300\",\n    Interest_Rate : \"4.5%\",\n    \n}\n    \nmsg.payload = addDoc\nreturn msg;","outputs":1,"noerr":0,"x":308.13726806640625,"y":223.92156791687012,"wires":[["e5cf0650.a7f09"]]},{"id":"e5cf0650.a7f09","type":"http request","z":"22659eb7.a53b82","name":"Write Cloudant","method":"POST","ret":"txt","url":"https://bdea5362-c793-408b-9b0a-698c42002903-bluemix.cloudant.com/session","tls":"","x":485.19602966308594,"y":223.7132339477539,"wires":[["a301a66c.e92e48"]]},{"id":"a301a66c.e92e48","type":"debug","z":"22659eb7.a53b82","name":"","active":true,"console":"false","complete":"false","x":698.1372528076172,"y":224.31372451782227,"wires":[]},{"id":"d6bac932.f82ec","type":"inject","z":"22659eb7.a53b82","name":"Execute","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":125.19608306884766,"y":286.27450942993164,"wires":[["14c1e5fd.d77222"]]},{"id":"14c1e5fd.d77222","type":"function","z":"22659eb7.a53b82","name":"Get Doc","func":"msg.headers = {\"Content-type\" : \"application/json\"}\n\nmsg.payload = {selector: {\n     convoUser: {$eq: \"QuickenLoansProfile\"}     },\n     sort: [{convoUser:\"desc\"},{convoTS: \"desc\"}],  \n     limit: 5\n}\nreturn msg;\n","outputs":1,"noerr":0,"x":306.96078300476074,"y":285.8823833465576,"wires":[["c373e500.ba8c"]]},{"id":"c373e500.ba8c","type":"http request","z":"22659eb7.a53b82","name":"Read Cloudant","method":"POST","ret":"obj","url":"https://bdea5362-c793-408b-9b0a-698c42002903-bluemix.cloudant.com/session/_find","tls":"","x":492.25490951538086,"y":286.07845306396484,"wires":[["b19dd8c3.0d2cc"]]},{"id":"b19dd8c3.0d2cc","type":"debug","z":"22659eb7.a53b82","name":"","active":true,"console":"false","complete":"false","x":686.9608573913574,"y":287.2549133300781,"wires":[]},{"id":"6edf3a9d.fde9c4","type":"function","z":"8cd40462.d0391","name":"Check Actions","func":"\n/* UCG Action JSON Object - type server is for open Whisk\n\"UCGactions\": [\n    {\n      \"name\":\"<actionName>\",\n      \"type\":\"client | server\",\n      \"parameters\": {\n        \"<parameter_name>\":\"<parameter_value>\",\n        \"<parameter_name>\":\"<parameter_value>\"\n      },\n      \"result_variable\": \"<result_variable_name>\",\n      \"credentials\": \"<reference_to_credentials>\"\n    }\n  ]\n*/\n\nmsg.savePayload = msg.payload\n\nif (typeof msg.payload.context !== \"undefined\"){ \n    if (typeof msg.payload.context.UCGactions !== \"undefined\"){ \n        \n       msg.UCGActions =  msg.payload.context.UCGactions\n       delete msg.payload.context.UCGactions\n       \n       for (i = 0; i < msg.UCGActions.length; i++) {\n \n        (function(i) { setTimeout(function() {\n            \n           if (msg.UCGActions[i].type == \"client\") {\n               msg.doAction = msg.UCGActions[i].name\n               msg.UCGAction = msg.UCGActions[i]\n               node.send(msg);\n                  \n            }\n                \n         }, 300 * i);\n        })(i);\n       }  \n    }\n} \n\n\nreturn msg;","outputs":1,"noerr":0,"x":197.54907899744353,"y":80.1960970093221,"wires":[["ea5ced44.44a6"]]},{"id":"ea5ced44.44a6","type":"switch","z":"8cd40462.d0391","name":"Action Router","property":"doAction","propertyType":"msg","rules":[{"t":"eq","v":"GetProfile","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":405.19620513916016,"y":80.78432321548462,"wires":[["e027be30.326c78"],[]]},{"id":"e027be30.326c78","type":"function","z":"8cd40462.d0391","name":"GetProfile Action","func":"\n\nmsg.payload = {selector: {\n     convoUser: {$eq: \"QuickenLoansProfile\"}     },\n     sort: [{convoUser:\"desc\"},{convoTS: \"desc\"}],  \n     limit: 5\n}\nreturn msg;","outputs":1,"noerr":0,"x":641.0785266651824,"y":55.68628112007576,"wires":[["9df048ee.7016e8"]]},{"id":"9df048ee.7016e8","type":"http request","z":"8cd40462.d0391","name":"Read Cloudant","method":"POST","ret":"obj","url":"https://bdea5362-c793-408b-9b0a-698c42002903-bluemix.cloudant.com/session/_find","tls":"","x":851.6667556762695,"y":55.294151306152344,"wires":[["94ec912a.2c973"]]},{"id":"94ec912a.2c973","type":"function","z":"8cd40462.d0391","name":"Set WCS Context","func":"myAnswer = msg.payload\nmsg.payload = msg.savePayload\n\nmsg.payload.context[msg.UCGAction.result_variable] = myAnswer.docs[0]\n\nreturn msg;","outputs":1,"noerr":0,"x":1082.8433456420898,"y":55.098082542419434,"wires":[[]]},{"id":"a243238f.2a43a8","type":"subflow:8cd40462.d0391","z":"8d1a3e5b.b49e8","x":310.66673278808594,"y":72.88049507141113,"wires":[["d3bb15b1.8303c8"]]},{"id":"7fe24eb8.04616","type":"function","z":"68b0d95d.ae26b8","name":"Build JSON Doc","func":"\nprocessArray = msg.payload\nmsg.stop = false\n/*UCG enriched fields for WDS\n  Type  |   Fields\n--------|-----------------\nTerm    | Key = Term, Text = Definiition\nQA      | Key = Question, Text = Answer\nArticle | Key = Title, Text = Article\n*/\n//for (i = 0; i < 100; i++) { \nfor (i = 0; i < processArray.length + 1; i++) {\n \n (function(i) { setTimeout(function() {\n               \n            if (i == processArray.length) {\n                msg.stop = true\n                msg.payload = {status : \"Finished\"}\n                node.send(msg);\n            }\n            else {\n                var myType = processArray[i].Type;\n                msg.data = {}\n                msg.myfields = Object.keys(processArray[i])\n                for (j = 0; j < msg.myfields.length + 1; j++) {\n                   \n                   msg.data[msg.myfields[j]] = processArray[i][msg.myfields[j]]\n                 \n                 \n               }\n\n                  msg.document_id = msg.data.Document_id\n                  \n                  msg.payload =  msg.data;\n                  msg.payload.filename = msg.document_id + \".json\";\n                  node.send(msg); \n                  \n            } \n                \n        }, 1000 * i);\n    })(i);\n}","outputs":1,"noerr":0,"x":821.0785064697266,"y":260.39215660095215,"wires":[["af8b05af.b2138"]]},{"id":"a5ca195a.10927","type":"debug","z":"fabc60c3.885ec8","name":"","active":true,"console":"false","complete":"false","x":1179.3137314740345,"y":523.3333318373734,"wires":[]},{"id":"ce9baf58.f01ff8","type":"debug","z":"fabc60c3.885ec8","name":"","active":true,"console":"false","complete":"true","x":229.5,"y":184,"wires":[]},{"id":"47e38ef0.8b2518","type":"debug","z":"401cee62.babb8","name":"","active":true,"console":"false","complete":"true","x":906.2500152587891,"y":426.6250065565109,"wires":[]},{"id":"a4df6893.a1584","type":"switch","z":"8d1a3e5b.b49e8","name":"Router","property":"UCG_ANSWER_ROUTING","propertyType":"msg","rules":[{"t":"eq","v":"WCS-WDS","vt":"str"},{"t":"eq","v":"WCS-WDS-WCS","vt":"str"}],"checkall":"true","outputs":2,"x":867.44482421875,"y":153.35375785827637,"wires":[["d1217ce2.b2b02"],["6dbe8ec7.a17ae"]]},{"id":"6dbe8ec7.a17ae","type":"function","z":"8d1a3e5b.b49e8","name":"Add WDS Context","func":"\n\nif (typeof msg.WDSResults.results[0].Text !== \"undefined\"){\n        msg.newOutput = []\n        msg.arrayOutput = []\n        \n        msg.testOutput = msg.WDSResults.results[0].Text.split(\"\\r\")\n        if (msg.testOutput.length > 1) {\n            msg.arrayOutput = msg.testOutput\n        }\n        else {\n            msg.arrayOutput.push(msg.WDSResults.results[0].Text)\n        }\n}\nmsg.WDSResults.output = msg.arrayOutput\nmsg.params.context.WDSResults = msg.WDSResults\n\nreturn msg;","outputs":1,"noerr":0,"x":1006.1377487182617,"y":211.7402000427246,"wires":[["a2e582bb.00f9f"]]},{"id":"a2e582bb.00f9f","type":"function","z":"8d1a3e5b.b49e8","name":"WCS for WDS","func":"/* New param to added to all front-ends - wcs_region = USSOUTH, GERMANY\nWill be used to set the url\nUSSOUTH - https://gateway.watsonplatform.net/conversation/api\nGERMANY - https://gateway-fra.watsonplatform.net/conversation/api\n*/\nvar watson = global.get('watson');\nmsg.params.input = {\n      text: \"Process WDS Answer\"\n    };\n\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n\nvar conversation = new watson.ConversationV1({\n  username : msg.params.username,\n  password : msg.params.password,\n  workspace_id : msg.params.workspace_id,\n  url : msg.params.endpoint,\n  version_date: '2017-05-26'\n});\n\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 15 second time out\", msg)}, 15000 );\n\nconversation.message(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);","outputs":1,"noerr":0,"x":1199.046257019043,"y":211.28268432617188,"wires":[["ed908b1a.828858"]]},{"id":"9424f57d.cfe048","type":"debug","z":"8d1a3e5b.b49e8","name":"","active":true,"console":"false","complete":"true","x":808.6126708984375,"y":377.5327453613281,"wires":[]},{"id":"ed908b1a.828858","type":"function","z":"8d1a3e5b.b49e8","name":"Add Ans Array","func":"var testArray = msg.payload.output.text\nmsg.fixOutput = []\nfor (i = 0; i < testArray.length; i++) {\n    if (testArray[i]== \"UCGWDSANSWER\"){\n        for (j = 0; j < msg.WDSResults.output.length; j++) {\n           msg.fixOutput.push(msg.WDSResults.output[j])\n        }\n    }\n    else {\n       msg.fixOutput.push(testArray[i]) \n    }\n}\nmsg.payload.output.text = msg.fixOutput\nreturn msg;","outputs":1,"noerr":0,"x":1382.6469268798828,"y":209.41176509857178,"wires":[[]]},{"id":"d4d3da5b.22486","type":"http in","z":"813a4efe.8f8558","name":"GoogleHome","url":"/GoogleHomeV2","method":"post","upload":false,"swaggerDoc":"","x":118,"y":140.125,"wires":[["a30f4b38.40723","57420d97.f8f53c"]]},{"id":"be455479.d382d","type":"function","z":"813a4efe.8f8558","name":"Response Msg","func":"/* Example Payload for Google\n{\n  \"speech\": \"...\",  // ASCII characters only\n  \"displayText\": \"...\",\n  \"data\": {\n    \"google\": {\n      \"expect_user_response\": true,\n      \"is_ssml\": true,\n      \"permissions_request\": {\n        \"opt_context\": \"...\",\n        \"permissions\": [\n          \"NAME\",\n          \"DEVICE_COARSE_LOCATION\",\n          \"DEVICE_PRECISE_LOCATION\"\n        ]\n      }\n    }\n  },\n  \"contextOut\": [...],\n}*/\n\nmsg.headers = {\"Content-type\" : \"application/json\"}\nvar input = msg.payload.input.text\nvar texts = msg.payload.output.text\n\nvar myEndSession = true;    \n\ntotalText = \"\"\nfor (i = 0; i < texts.length; i++) {\n    \n    if (texts[i].lastIndexOf(\"[\") >= 0 ) {\n       findindex = texts[i].lastIndexOf(\"[\");\n       texts[i] = texts[i].substring(0,findindex);\n    } \n  totalText = totalText + \" \" + texts[i]\n}\n\nif (msg.tellGoogleNoWorries) \n{totalText = \"Okay, you're information is safe with me.\" + totalText\n  msg.tellGoogleNoWorries = false  \n}\n\n\nif (input.toUpperCase().substring(0,5) == \"LATER\" ||\n    totalText.lastIndexOf(\"wonderful day\") >= 0 ||\n    totalText.lastIndexOf(\"great day\") >= 0\n)\n   {myEndSession = false}\n\n\n\nmyResponse = {\n    \"speech\": totalText,  // ASCII characters only\n    \"displayText\": \"\",\n    \"data\": {\n      \"google\": {\n        \"expect_user_response\": myEndSession,\n        \"is_ssml\": false\n        }\n     }\n}\n\nnode.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + totalText)\nmsg.payload = myResponse \nnode.send(msg);\n    \n\nreturn null;\n","outputs":1,"noerr":0,"x":1465.7916297912598,"y":481.2083435058594,"wires":[["139e7080.38266","8986109c.999f"]]},{"id":"139e7080.38266","type":"http response","z":"813a4efe.8f8558","name":"Http Response","statusCode":"","headers":{},"x":1687.8749885559082,"y":342.24999618530273,"wires":[]},{"id":"99bca939.ef7c48","type":"function","z":"813a4efe.8f8558","name":"Set Params","func":"msg.source = \"GoogleHome\"\nvar workspace_id = msg.req.query.workspace_id\nvar wcs_user_name = msg.req.query.wcs_username\nvar wcs_password = msg.req.query.wcs_password\n\n// Uncomment when New param is added to all front-ends and delete the default\n//var region = msg.req.query.primary_region\nmsg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_workspace_id = workspace_id;\nmsg.primary_wcs_user_name = wcs_user_name;\nmsg.primary_wcs_password = wcs_password;\nmsg.primary_region = msg.region;\n\nvar fname = msg.req.query.fname;\n\nvar context = {}\n\nif (typeof msg.session !== \"undefined\") \n   {context = msg.session.convoPayload.context\n    wcs_user_name = msg.session.wcs_user_name\n    wcs_password  = msg.session.wcs_password\n    workspace_id  = msg.session.workspace_id    \n   }\n\ncontext.flowName = \"GoogleHome\"\n\n\nvar params = {\n    context : context,\n    workspace_id : workspace_id,\n    username : wcs_user_name,\n    password : wcs_password,\n    source : msg.source\n};\n\nvar additional_context = {};\nvar googleIntent = \"\"\nvar googleIName = \"\"\nvar googleContext = \"\"\nif (typeof msg.payload.originalRequest.data.user.profile !== \"undefined\"){\n     context.fname = msg.payload.originalRequest.data.user.profile.givenName   \n    }\n\nif (typeof msg.payload.originalRequest.data.inputs !== \"undefined\"){\n     googleIntent = msg.payload.originalRequest.data.inputs[0].intent\n    }\n/*\nif (typeof msg.payload.originalRequest.data.inputs[0].arguments[0] !== \"undefined\"){\n     \n     if (typeof msg.payload.originalRequest.data.inputs[0].arguments[0].name !== \"undefined\"){\n       googleIName =  msg.payload.originalRequest.data.inputs[0].arguments[0].name \n     }\n    }\n*/\nif (typeof msg.payload.result.contexts[0] !== \"undefined\") {\n    \n     if (msg.payload.result.contexts[0].name.lastIndexOf(\"actions\") >= 0) {\n        \n        if (typeof msg.payload.result.contexts[1] !== \"undefined\"){\n           googleContext = msg.payload.result.contexts[1].name \n        }\n     }\n     else {\n        googleContext = msg.payload.result.contexts[0].name \n     }\n}\n\nmsg.payload = msg.payload.result.resolvedQuery\nmsg.params = params\nmsg.googleIntent = googleIntent\nmsg.googleIName = googleIName\nmsg.googleContext = googleContext\n\nreturn msg;","outputs":1,"noerr":0,"x":682.9999771118164,"y":140.125,"wires":[["b46ed583.a6303","d2fbcbe4.1b9d68"]]},{"id":"8986109c.999f","type":"debug","z":"813a4efe.8f8558","name":"","active":true,"console":"false","complete":"payload","x":1693.6249885559082,"y":478.916654586792,"wires":[]},{"id":"31f8cf8e.280f48","type":"switch","z":"813a4efe.8f8558","name":"Intents","property":"googleIntent","propertyType":"msg","rules":[{"t":"eq","v":"actions.intent.PERMISSION","vt":"str"},{"t":"eq","v":"actions.intent.MAIN","vt":"str"},{"t":"eq","v":"claim-status","vt":"str"},{"t":"eq","v":"claim-process","vt":"str"},{"t":"eq","v":"deductibles","vt":"str"},{"t":"else"}],"checkall":"true","outputs":6,"x":273.625,"y":406.99999618530273,"wires":[["10ac741b.0a5e9c"],["7b58515d.02784"],["624acb8f.abbe64"],["624acb8f.abbe64"],["624acb8f.abbe64"],["78e89372.774274"]]},{"id":"7b58515d.02784","type":"function","z":"813a4efe.8f8558","name":"Ask Permission","func":"\nmsg.headers = {\"Content-type\" : \"application/json\"}\n\nmyResponse = {\n  \"conversationToken\": \"{\\\"state\\\":null,\\\"data\\\":{}}\",\n  \"expectUserResponse\": true,\n  \"expectedInputs\": [\n    {\n      \"inputPrompt\": {\n        \"initialPrompts\": [\n          {\n            \"textToSpeech\": \"PLACEHOLDER_FOR_PERMISSION\"\n          }\n        ],\n        \"noInputPrompts\": []\n      },\n      \"possibleIntents\": [\n        {\n          \"intent\": \"actions.intent.PERMISSION\",\n          \"inputValueData\": {\n            \"@type\": \"type.googleapis.com/google.actions.v2.PermissionValueSpec\",\n            \"optContext\": \"To deliver your order\",\n            \"permissions\": [\n              \"NAME\",\n              \"DEVICE_PRECISE_LOCATION\"\n            ]\n          }\n        }\n      ]\n    }\n  ]\n}\n\n\n\nmsg.payload = myResponse \nnode.send(msg);\n\nreturn null;","outputs":1,"noerr":0,"x":763.75,"y":358.25,"wires":[["139e7080.38266","5acc8e3c.24a638"]]},{"id":"10ac741b.0a5e9c","type":"function","z":"813a4efe.8f8558","name":"Handle Permission","func":"if (msg.payload.toUpperCase().lastIndexOf(\"NO\") >= 0 \n)\n   {msg.tellGoogleNoWorries = true}\nelse\n   {msg.tellGoogleNoWorries = false}\n   \nif (msg.googleContext.lastIndexOf(\"claim-status\") >= 0 ) {\n    msg.payload = \"get a status of my claim\"\n}\n\nelse if (msg.googleContext.lastIndexOf(\"claim-process\") >= 0 ) {\n    msg.payload = \"how do claims work\"\n}\nelse if (msg.googleContext.lastIndexOf(\"claim-deductible\") >= 0 ) {\n    msg.payload = \"what are my deductibles and limits\"\n}\n\n\nelse {\n    msg.payload =  \"Hello\"\n}    \n    \nreturn msg;","outputs":1,"noerr":0,"x":773.75,"y":314.5,"wires":[["78e89372.774274"]]},{"id":"624acb8f.abbe64","type":"switch","z":"813a4efe.8f8558","name":"trigger?","property":"googleIName","propertyType":"msg","rules":[{"t":"eq","v":"trigger_query","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":608,"y":420.125,"wires":[["7b58515d.02784"],["78e89372.774274"]]},{"id":"a30f4b38.40723","type":"function","z":"813a4efe.8f8558","name":"Get User","func":"\nmsg.user = msg.payload.sessionId\nreturn msg;","outputs":1,"noerr":0,"x":321.75,"y":140.12500095367432,"wires":[["c562cace.6c1818"]]},{"id":"c9c6c808.c7964","type":"comment","z":"813a4efe.8f8558","name":"Front-End must pass in user_id,wcs_username,wcs_password,workspace_id,text,fname","info":"","x":389,"y":586.1250228881836,"wires":[]},{"id":"b46ed583.a6303","type":"subflow:7e2111b.f0b9e7","z":"813a4efe.8f8558","x":902.9999771118164,"y":139.50000095367432,"wires":[["31f8cf8e.280f48"]]},{"id":"d2fbcbe4.1b9d68","type":"debug","z":"813a4efe.8f8558","name":"","active":true,"console":"false","complete":"true","x":812.3749771118164,"y":77,"wires":[]},{"id":"3e876338.3e833c","type":"catch","z":"813a4efe.8f8558","name":"","scope":null,"x":1312.163330078125,"y":271.6346130371094,"wires":[["5d0c9b05.cb48ac"]]},{"id":"5d0c9b05.cb48ac","type":"subflow:af0dd578.89a848","z":"813a4efe.8f8558","x":1488.605697631836,"y":270.8846073150635,"wires":[[]]},{"id":"78e89372.774274","type":"subflow:544bc80b.e141f8","z":"813a4efe.8f8558","x":882.9999809265137,"y":483.7916851043701,"wires":[["44a151be.c376f"]]},{"id":"97e36f51.10df8","type":"debug","z":"813a4efe.8f8558","name":"","active":true,"console":"false","complete":"false","x":1207.3137314740343,"y":563.4583318373734,"wires":[]},{"id":"57420d97.f8f53c","type":"debug","z":"813a4efe.8f8558","name":"","active":true,"console":"false","complete":"true","x":257.5,"y":224.125,"wires":[]},{"id":"796bcb9f.34a62c","type":"function","z":"813a4efe.8f8558","name":"Ask Permission V2","func":"\nmsg.headers = {\"Content-type\" : \"application/json\"}\n\nmyResponse = {\n  \"conversationToken\": \"{\\\"state\\\":null,\\\"data\\\":{}}\",\n  \"expectUserResponse\": true,\n  \"expectedInputs\": [\n    {\n      \"inputPrompt\": {\n        \"initialPrompts\": [\n          {\n            \"textToSpeech\": \"PLACEHOLDER_FOR_PERMISSION\"\n          }\n        ],\n        \"noInputPrompts\": []\n      },\n      \"possibleIntents\": [\n        {\n          \"intent\": \"actions.intent.PERMISSION\",\n          \"inputValueData\": {\n            \"@type\": \"type.googleapis.com/google.actions.v2.PermissionValueSpec\",\n            \"optContext\": \"To deliver your order\",\n            \"permissions\": [\n              \"NAME\",\n              \"DEVICE_PRECISE_LOCATION\"\n            ]\n          }\n        }\n      ]\n    }\n  ]\n}\n\n\n\nmsg.payload = myResponse \nnode.send(msg);\n\nreturn null;","outputs":1,"noerr":0,"x":663.5,"y":688.125,"wires":[[]]},{"id":"44a151be.c376f","type":"subflow:8d1a3e5b.b49e8","z":"813a4efe.8f8558","x":1076.5,"y":484,"wires":[["a97c0813.118e98"]]},{"id":"a97c0813.118e98","type":"subflow:a39d88cb.3e3638","z":"813a4efe.8f8558","x":1271.5,"y":486,"wires":[["be455479.d382d"]]},{"id":"c562cace.6c1818","type":"subflow:5e5f60e7.f240c8","z":"813a4efe.8f8558","x":485.5,"y":138,"wires":[["99bca939.ef7c48"]]},{"id":"5acc8e3c.24a638","type":"debug","z":"813a4efe.8f8558","name":"","active":true,"console":"false","complete":"false","x":1060.5,"y":409,"wires":[]},{"id":"3a995c13.aff4d4","type":"debug","z":"e3247ffc.0f34","name":"","active":true,"console":"false","complete":"false","x":857.4999847412109,"y":358.8571434020996,"wires":[]},{"id":"c65699f4.9e1ab","type":"debug","z":"e3247ffc.0f34","name":"","active":true,"console":"false","complete":"true","x":312.49998474121094,"y":245.8571434020996,"wires":[]},{"id":"90a0061a.51158","type":"debug","z":"ff67537b.e2624","name":"","active":true,"console":"false","complete":"true","x":839.5,"y":473,"wires":[]},{"id":"e3e6b620.7897f","type":"switch","z":"22659eb7.a53b82","name":"Universal","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"a","vt":"str"},{"t":"eq","v":"b","vt":"str"},{"t":"eq","v":"c","vt":"str"}],"checkall":"true","outputs":3,"x":75.19831848144531,"y":464.6825485229492,"wires":[["6918cd79.7e6eec"],["92d4dee2.5f3bc8"],["39ae8959.ba6196"]]},{"id":"ce78180d.5b8c7","type":"function","z":"22659eb7.a53b82","name":"Gateway","func":"\nreturn msg;","outputs":1,"noerr":0,"x":408.7699089050293,"y":464.6825656890869,"wires":[[]]},{"id":"39ae8959.ba6196","type":"watson-conversation-v1","z":"22659eb7.a53b82","name":"Conversation","workspaceid":"","multiuser":false,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/conversation/api","x":233.92852783203125,"y":502.0635528564453,"wires":[["ce78180d.5b8c7"]]},{"id":"6918cd79.7e6eec","type":"natural-language-understanding","z":"22659eb7.a53b82","name":"Connection","categories":false,"concepts":false,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":false,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":false,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/natural-language-understanding/api","x":233.9285888671875,"y":427.9364824295044,"wires":[["ce78180d.5b8c7"]]},{"id":"92d4dee2.5f3bc8","type":"visual-recognition-util-v3","z":"22659eb7.a53b82","name":"     Cognitive  ","image-feature":"","x":234.48411178588867,"y":464.6825485229492,"wires":[["ce78180d.5b8c7"]]},{"id":"e5411e73.d5c32","type":"comment","z":"22659eb7.a53b82","name":"Display only - UCG Logo","info":"","x":143.05555725097656,"y":371.6666793823242,"wires":[]},{"id":"6e62b3a4.e74b24","type":"function","z":"f3565267.58f28","name":"DN","func":"var fs     = context.global.fsstream;\n\nmsg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.password= 'sWVYahvWPb8j'\nvar params = {\n  metadata: {language: 'en',name: 'My Classifier'},\n training_data: fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\n};\nmsg.url = \"https://gateway.watsonplatform.net/natural-language-classifier/api/v1/classifiers/\";\n\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n     \"Authorization\": \"Basic NmQzMTM4ZTctYzE2OC00YTFiLWJlYmUtYmUwMGU2NDdlMzY0OnNXVllhaHZXUGI4ag==\"\n  }\n\nmsg.payload = params;\n\n// var msg_param = \"?model_id=en-es&text=\"+m_string;\n//msg.url = \"https://gateway.watsonplatform.net/language-translator/api/v2/translate\"+ msg_param;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1080,"wires":[[]]},{"id":"8264aeb.e0dc65","type":"function","z":"f3565267.58f28","name":"Get","func":"var fs     = context.global.fsstream;\n\n//msg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\n//msg.password= 'sWVYahvWPb8j'\n\nvar params = {\n  metadata: {language: 'en',name: 'My Classifier'},\n training_data: fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\n};\n\nvar msg_param = \"?language=en-es&@training_data=fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\";\n\n\n\n\nmsg.url = \"https://gateway.watsonplatform.net/natural-language-classifier/api/v1/classifiers/\" + msg_param;\n\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n     \"Authorization\": \"Basic NmQzMTM4ZTctYzE2OC00YTFiLWJlYmUtYmUwMGU2NDdlMzY0OnNXVllhaHZXUGI4ag==\"\n  }\n\n// var msg_param = \"?model_id=en-es&text=\"+m_string;\n//msg.url = \"https://gateway.watsonplatform.net/language-translator/api/v2/translate\"+ msg_param;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1220,"wires":[["ef4801f0.66fd4","2fece7d8.c85f08"]]},{"id":"ef4801f0.66fd4","type":"http request","z":"f3565267.58f28","name":"","method":"GET","ret":"txt","url":"","x":590,"y":1220,"wires":[["2c7ef1c8.f9bd96"]]},{"id":"2fece7d8.c85f08","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":560,"y":1280,"wires":[]},{"id":"7cc1a4d5.fa6abc","type":"function","z":"f3565267.58f28","name":"Post","func":"var fs     = context.global.fsstream;\n\n//msg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\n//msg.password= 'sWVYahvWPb8j'\n\nvar msg_data = JSON.stringify(msg.payload);\nvar params = {\n  metadata: {language: 'en',name: 'My Classifier'},\n  training_data: msg.payload\n  //training_data: \"@fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\"\n};\n\nvar msg_param = \"?language=en-es&training_data=fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\";\n\n\n\n\nmsg.url = \"https://gateway.watsonplatform.net/natural-language-classifier/api/v1/createClassifier\";\n\n\nmsg.headers = {\n    \"Content-Type\": \"application/json\",\n    \"Accept\": \"application/json\",\n     \"Authorization\": \"Basic NmQzMTM4ZTctYzE2OC00YTFiLWJlYmUtYmUwMGU2NDdlMzY0OnNXVllhaHZXUGI4ag==\"\n  }\n\nmsg.payload = params;\n// var msg_param = \"?model_id=en-es&text=\"+m_string;\n//msg.url = \"https://gateway.watsonplatform.net/language-translator/api/v2/translate\"+ msg_param;\n\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1340,"wires":[["88088f71.51cab8","2fece7d8.c85f08"]]},{"id":"7b0ec224.5fc5fc","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":220,"y":1340,"wires":[["7cc1a4d5.fa6abc"]]},{"id":"88088f71.51cab8","type":"http request","z":"f3565267.58f28","name":"","method":"POST","ret":"txt","url":"","tls":"","x":550,"y":1340,"wires":[["eef6445c.7cde5"]]},{"id":"eef6445c.7cde5","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":700,"y":1340,"wires":[]},{"id":"462067c0.559b18","type":"inject","z":"f3565267.58f28","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":240,"y":1160,"wires":[["cc089be.4b07b68"]]},{"id":"2c7ef1c8.f9bd96","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":770,"y":1220,"wires":[]},{"id":"1b9f8a25.8733be","type":"watson-natural-language-classifier","z":"f3565267.58f28","name":"","mode":"classify","language":"en","classifier":"","default-endpoint":true,"service-endpoint":"https://gateway.watsonplatform.net/natural-language-classifier/api","x":540,"y":1500,"wires":[[]]},{"id":"f7a08a71.6235e","type":"function","z":"f3565267.58f28","name":"Create Classifer","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\n//var NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\nmsg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.password= 'sWVYahvWPb8j'\n\n//var naturalLanguageClassifier = new NaturalLanguageClassifierV1({\nvar naturalLanguageClassifier = new watson2.NaturalLanguageClassifierV1 ({\n  username: msg.username,\n  password: msg.password \n});\n \nvar params = {\n  metadata: {language: 'en',name: 'NK-Classifier'},\n  training_data: fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\n  //training_data: JSON.stringify(msg.paylod)\n};\nnode.error(\"before calling\");\nnaturalLanguageClassifier.createClassifier(params,\n  function(err, response) {\n    if (err)\n      console.log(err);\n    else\n      node.error(\"Inside-function\");\n      node.error(response);\n      msg.payload = response;\n      console.log(JSON.stringify(response, null, 2));\n      node.send(msg);\n});\n\nreturn msg;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":740,"y":1080,"wires":[[]]},{"id":"c225186c.631dc8","type":"function","z":"f3565267.58f28","name":"Create Classifer - works with warning","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\n//var NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\nmsg.username='6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.password= 'sWVYahvWPb8j'\n\n//var naturalLanguageClassifier = new NaturalLanguageClassifierV1({\nvar natural_language_classifier = watson2.natural_language_classifier({\n  username: msg.username,\n  password: msg.password,\n  version: 'v1'\n});\n \nvar params = {\n  \"language\": 'en',\n  \"name\": 'NKClassifier2',\n//  training_data: 'https://gist.github.com/snippet-java/044c616801cea023930bed41efed6488'\n    \"training_data\": fs.createReadStream('./nlcdev.csv')\n//    training_data: { 'text':\"How is weather today?, test1, testwcs\"}\n    //https://ibm.box.com/s/cxk8440a0khgj86ilfygzks0xprd48gh'\n // training_data: JSON.stringify(msg.paylod)\n \n  \n\n};\nnode.error(\"before calling\");\nnatural_language_classifier.create(params, \nfunction\n(err, response) {\nif\n (err) console.log(err);\nelse\n        console.log(JSON.stringify(response, null, 2));\n});\n\nreturn msg;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":430,"y":1120,"wires":[[]]},{"id":"f45455e0.3b713","type":"function","z":"cb130c7a.1c52d8","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'b5bf7394-2b9d-4ec6-853b-5ad8fb787d16';\nmsg.wcs_setup.setup_wcs_tag = 'UCG-Setup-WCS-NLC';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.nlc_classifier_id = \"\";            // This will be updated latter in the flow \nmsg.wcs_setup.nls_userid = '6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.wcs_setup.nls_password = 'sWVYahvWPb8j';\nmsg.wcs_setup.nls_start = Date();\n\nreturn msg;\n\n ","outputs":1,"noerr":0,"x":280,"y":400,"wires":[["9f20fa01.ab1fa8"]]},{"id":"9f20fa01.ab1fa8","type":"function","z":"cb130c7a.1c52d8","name":"Scan Setup Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      //node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":477,"y":400,"wires":[["dd93a11d.4b119","c83f75a.badbf88"]]},{"id":"7b42f90e.3765d8","type":"inject","z":"cb130c7a.1c52d8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":400,"wires":[["f45455e0.3b713"]]},{"id":"dd93a11d.4b119","type":"debug","z":"cb130c7a.1c52d8","name":"MSG-Setup-Response/Input","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":760,"y":360,"wires":[]},{"id":"c83f75a.badbf88","type":"function","z":"cb130c7a.1c52d8","name":"Prepare Data for NLC Scan","func":"//node.error(\"inside nlc\");\n//node.error(msg);\n \nvar i = 0;\nvar j_len = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    j_len = msg.payload.intents[i].examples.length;\n    if (j_len > 0) {\n        if (msg.payload.intents[i].intent === \"NLC_Classifier_ID\") {\n            msg.wcs_setup.nlc_classifier_id = msg.payload.intents[i].examples[j_len-1].text;\n        }\n        else {\n             if (typeof msg.wcs_setup.wcs_set === 'undefined') {\n                 msg.wcs_setup.wcs_set = [{}];\n                 msg.wcs_setup.wcs_set[0] = {\n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                }\n             }\n             else {\n                msg.wcs_setup.wcs_set.push({     \n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                })\n            }\n            msg.wcs_setup.wcs_count = msg.wcs_setup.wcs_count + 1;\n        }\n    }\n}\nmsg.wcs_setup.continue_flag = \"Yes\";\nif (msg.wcs_setup.wcs_count === 0) {\n    node.error(\"Pl. check WCS Setup Workspace - No Workspaces are defined for NLC Training set\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nif (msg.wcs_setup.nlc_classifier_id === \"\") {\n    node.error(\"Pl. check WCS Setup Workspace - NLC_Classifier_Id has not defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":400,"wires":[["82630945.6f1a3","ca5ce440.922c4"]]},{"id":"82630945.6f1a3","type":"debug","z":"cb130c7a.1c52d8","name":"MSG-Setup Workspaces","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1050,"y":360,"wires":[]},{"id":"ca5ce440.922c4","type":"switch","z":"cb130c7a.1c52d8","name":"Check if continue ?","property":"msg.wcs_setup.continue_flag","propertyType":"msg","rules":[{"t":"eq","v":"No","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":152,"y":496,"wires":[["2abed9a8.b4923e"],["d66177fd.ad7c18"]]},{"id":"2abed9a8.b4923e","type":"debug","z":"cb130c7a.1c52d8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":270,"y":440,"wires":[]},{"id":"d66177fd.ad7c18","type":"function","z":"cb130c7a.1c52d8","name":"Check current Count","func":"msg.wcs_setup.wcs_cur_wcs_id = \"\";\nif ( msg.wcs_setup.wcs_cur_count < msg.wcs_setup.wcs_count) { \n     msg.wcs_scan_flag = \"Yes\";\n     msg.wcs_setup.wcs_cur_wcs_id = msg.wcs_setup.wcs_set[msg.wcs_setup.wcs_cur_count].wcs_id;\n     msg.wcs_setup.wcs_cur_wcs_tag = msg.wcs_setup.wcs_set[msg.wcs_setup.wcs_cur_count].wcs_tag;\n} \nelse {\n    msg.wcs_scan_flag = \"No\";\n    msg.wcs_setup.wcs_cur_wcs_id = \"\";\n    msg.wcs_setup.wcs_cur_wcs_tag = \"\";\n}      \nreturn msg;","outputs":1,"noerr":0,"x":380,"y":502,"wires":[["ab202a.884d1fd8"]]},{"id":"ab202a.884d1fd8","type":"function","z":"cb130c7a.1c52d8","name":"Scan Workspace for NLC Prep","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.wcs_cur_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    node.error(\"Scan Workspace for NLC Prep - err\");\n    node.error(err);\n    node.send(err);\n    //console.error(err);\n  } else {\n      //node.error(response);\n      node.error(\"Scan Workspace for NLC Prep - response\");\n      node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":656,"y":502,"wires":[["50a51065.aabc38","a2ba40b3.d70c7"]]},{"id":"50a51065.aabc38","type":"debug","z":"cb130c7a.1c52d8","name":"MSG-Scan Workspace NLP","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":937,"y":460,"wires":[]},{"id":"a2ba40b3.d70c7","type":"function","z":"cb130c7a.1c52d8","name":"prepare data for NLC","func":"node.error(\"Prepare Data to send to nlc\");\n//node.error(msg);\nvar m_nlc_array = msg.payload;\nif (typeof msg.wcs_save_payload !== 'undefined') {\n    msg.payload=msg.wcs_save_payload;\n} \nelse {\n  msg.payload = []; \n}\n\nvar i = 0;\nvar j = 0;\nfor (i=0; i<m_nlc_array.intents.length;i++) {\n    for (j=0; j<m_nlc_array.intents[i].examples.length;j++) {\n        msg.payload.push({\n            \"wcs_intent\" : m_nlc_array.intents[i].intent,\n            \"wcs_utterance\": m_nlc_array.intents[i].examples[j].text,\n            \"wcs_tag\" : msg.wcs_setup.wcs_cur_wcs_tag\n        })\n    }\n}\n\nmsg.wcs_setup.wcs_cur_count = msg.wcs_setup.wcs_cur_count + 1;\nmsg.wcs_setup.loop_back = \"Yes\";\nif (msg.wcs_setup.wcs_cur_count === msg.wcs_setup.wcs_count) {\n    msg.wcs_setup.loop_back = \"No\";\n}\nif (msg.wcs_setup.loop_back === \"Yes\") {\n    msg.wcs_save_payload = msg.payload;\n}\nnode.error(\"WCS Workspaces Count - Current/Total=> \" + msg.wcs_setup.wcs_cur_count + \"/\" + msg.wcs_setup.wcs_count); \n//node.error(\"Counter Check :msg.wcs_setup.wcs_count=> \" + msg.wcs_setup.wcs_count );\n//node.error(\"msg.wcs_setup.loop_back ==> \" + msg.wcs_setup.loop_back);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":500,"wires":[["1c4ab33e.ff1015","223a498b.441b2e"]]},{"id":"1c4ab33e.ff1015","type":"debug","z":"cb130c7a.1c52d8","name":"NCL Data to be  writen to CSV","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1260,"y":460,"wires":[]},{"id":"e0e733ce.f354a8","type":"delay","z":"cb130c7a.1c52d8","name":"Wait till file is written","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":680,"y":620,"wires":[["d1aa24e9.707518","6da491c2.27907"]]},{"id":"223a498b.441b2e","type":"switch","z":"cb130c7a.1c52d8","name":"","property":"wcs_setup.loop_back","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":601,"wires":[["d66177fd.ad7c18"],["87712d8f.43359","3b3ef66f.fd6532"]]},{"id":"eafa49fa.b1ca7","type":"function","z":"cb130c7a.1c52d8","name":"Get NLC ID","func":"node.error(msg);\nmsg.wcs_setup.nlc_check_status = \"No\" \nif (msg.payload.status === \"Training\") {\n    msg.wcs_setup.nlc_check_status = \"Yes\" \n//    msg.wcs_setup.nlc_classifier_id = msg.payload.classifer_id;\n}\nmsg.wcs_setup.nlc_classifier_id = msg.payload.classifier_id;\nnode.error(\"Current NLC Status for NLC-ID : [\" + msg.payload.classifier_id+\"] ==>\" + msg.payload.status);\nreturn msg;","outputs":1,"noerr":0,"x":1150,"y":620,"wires":[["1a086fc8.16aae"]]},{"id":"8e5e2e38.af5308","type":"debug","z":"f3565267.58f28","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":550,"y":820,"wires":[]},{"id":"87712d8f.43359","type":"csv","z":"cb130c7a.1c52d8","name":"","sep":",","hdrin":false,"hdrout":false,"multi":"one","ret":"\\n","temp":"wcs_intent,wcs_utterance,wcs_tag","skip":"0","x":470,"y":607,"wires":[["c66d2892.409d2","e0e733ce.f354a8"]]},{"id":"c66d2892.409d2","type":"file","z":"cb130c7a.1c52d8","name":"Always overwrite file","filename":"/usr/src/node-red/keyfiles/nlcdev.csv","appendNewline":true,"createDir":false,"overwriteFile":"true","x":680,"y":580,"wires":[[]]},{"id":"d1aa24e9.707518","type":"function","z":"cb130c7a.1c52d8","name":"Create Classifer","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nnode.error(\"Inside - Create Classifer\");\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n    metadata: JSON.stringify({language: 'en',name: 'UCG-NLC-Classifer-Set'}),\n    training_data: fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\n};\nnode.error(\"before calling\");\n//natural_language_classifier.create(params, \nnatural_language_classifier.createClassifier(params, \nfunction\n(err, response) {\nif (err) {\n    node.error(\"Inside - Create Classifer - err\");\n    node.error(err);\n    //console.log(err);\n}\nelse\n  node.error(\"Inside- Create Classifer- Response\");\n  node.error(response);\n  msg.payload = response;\n  node.send(msg);\n});\n\nreturn null;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":920,"y":620,"wires":[["eafa49fa.b1ca7"]]},{"id":"ce383825.dbf8c","type":"function","z":"cb130c7a.1c52d8","name":"Delete Classifer","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nmsg.wcs_save_payload = msg.payload;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n    metadata: JSON.stringify({language: 'en',name: msg.wcs_setup.nlc_classifier_id}),\n    training_data: fs.createReadStream('./nlcdev.csv')\n};\n\nnatural_language_classifier.deleteClassifier({\n  classifier_id: msg.wcs_setup.nlc_classifier_id },\n  function(err, response) {\n    if (err) {\n      node.error(\"Inside - Delete Classifer - err \");\n      node.error(err);\n      console.log('error:', err);\n      msg.payload = msg.wcs_save_payload;\n      send(msg); \n    }\n    else {\n      node.error(\"Inside - Delete Classifer - response \");\n      node.error(response);\n      msg.payload = response;\n      node.send(msg);\n      //console.log(JSON.stringify(response, null, 2));\n    }\n});\n\nreturn null;\n\n\n\n\n\n\n\n\n\n","outputs":1,"noerr":0,"x":320,"y":780,"wires":[[]]},{"id":"78d07a50.c93174","type":"function","z":"cb130c7a.1c52d8","name":"Get info about Classifer","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\nnode.error(\"Before Get info about Classifer [\"+msg.wcs_setup.nlc_classifier_id+\"]\");\nnode.error(msg);\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n    metadata: JSON.stringify({language: 'en',name: msg.wcs_setup.nlc_classifier_id}),\n    training_data: fs.createReadStream('/usr/src/node-red/keyfiles/nlcdev.csv')\n};\nnatural_language_classifier.getClassifier({\n    classifier_id: msg.wcs_setup.nlc_classifier_id}, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\n\nreturn null;\n\n","outputs":1,"noerr":0,"x":1166,"y":694,"wires":[["f3b50a5c.0c14a"]]},{"id":"f3b50a5c.0c14a","type":"function","z":"cb130c7a.1c52d8","name":"Display Status","func":"msg.wcs_setup.nlc_check_status = \"No\" \nif (msg.payload.status === \"Training\") {\n    msg.wcs_setup.nlc_check_status = \"Yes\" \n//    msg.wcs_setup.nlc_classifier_id = msg.payload.classifer_id;\n}\nnode.error(\"Current NLC Status for NLC-ID : [\" + msg.payload.classifier_id+\"] ==>\" + msg.payload.status);\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":940,"wires":[["1a086fc8.16aae"]]},{"id":"1a086fc8.16aae","type":"switch","z":"cb130c7a.1c52d8","name":"Continue Checking Status ?","property":"wcs_setup.nlc_check_status","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":600,"y":700,"wires":[["9b0b9076.6a9a08"],["b8b078c7.319cd8"]]},{"id":"9b0b9076.6a9a08","type":"delay","z":"cb130c7a.1c52d8","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":694,"wires":[["78d07a50.c93174"]]},{"id":"6f1bcd19.894f34","type":"debug","z":"cb130c7a.1c52d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1030,"y":760,"wires":[]},{"id":"3b3ef66f.fd6532","type":"debug","z":"cb130c7a.1c52d8","name":"Input for csv","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":330,"y":660,"wires":[]},{"id":"b8b078c7.319cd8","type":"function","z":"cb130c7a.1c52d8","name":"Update Intent","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  intent: 'NLC_Classifier_ID',\n  new_examples: [\n    {\n      text: msg.wcs_setup.nlc_classifier_id\n    }\n  ],\n   new_description: 'NLC Create begin @' + msg.wcs_setup.nls_start + \" and completed @\" + Date()\n};\n\nconversation.updateIntent(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":820,"y":760,"wires":[["6f1bcd19.894f34"]]},{"id":"6da491c2.27907","type":"function","z":"cb130c7a.1c52d8","name":"Update Intent","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  intent: 'NLC_Classifier_ID',\n  new_description: 'NLC Create begin @' + msg.wcs_setup.nls_start + \" In Progress..\"\n};\n\nconversation.updateIntent(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    //msg.payload = response;\n    //node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":0,"noerr":0,"x":920,"y":580,"wires":[]},{"id":"e40244b.eb1a738","type":"comment","z":"cb130c7a.1c52d8","name":"This flow Generates NLC Training sets using WCS Intents","info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"\n   c) WorkspaceTag - must not include include blanks\n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTag\n\nThe flow assumes, all Workspaces are listed under Setup Workspace and \nthose will be used, to create training data set. There is no limit on \nnumber of workspaces which can be included under Setup Workspace, \nas long as above rules are followed.\n   \n    In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS\"; if this \n    needs to have different name, then pl. remember to update name in\n    'get-ready' node.\n    \n\n2) The flow needs to NLC classifer ID, which can also be defined in\n   setup workspace with special intent as 'NLC_Classifier_ID' and example \n   will have NLC traning set value. The flow will update NLC Classifer ID in \n   example, once generated. \n   \n   The flow will delete existing NLC Classifer, before running\n   new training set.  \n\n3) The flow also assumes, all workspaces have same set of\n   credentials and are defined in 'get-ready' node. The flow, can be \n   modified to pickup credentials from SOE Environment file.\n   \n","x":410,"y":80,"wires":[]},{"id":"4ea5e466.97b10c","type":"function","z":"c14accc6.1cca2","name":"Prepare Data for NLC Scan","func":"//node.error(\"inside nlc\");\n//node.error(msg);\n \nvar i = 0;\nvar j_len = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    j_len = msg.payload.intents[i].examples.length;\n    if (j_len > 0) {\n        if (msg.payload.intents[i].intent === \"NLC_Classifier_ID\") {\n            msg.wcs_setup.nlc_classifier_id = msg.payload.intents[i].examples[j_len-1].text;\n        }\n        else {\n             if (typeof msg.wcs_setup.wcs_set === 'undefined') {\n                 msg.wcs_setup.wcs_set = [{}];\n                 msg.wcs_setup.wcs_set[0] = {\n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                }\n             }\n             else {\n                msg.wcs_setup.wcs_set.push({     \n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                })\n            }\n            msg.wcs_setup.wcs_count = msg.wcs_setup.wcs_count + 1;\n            if (msg.payload.intents[i].intent === \"Default_WCS\") {\n               msg.wcs_setup.default_wcs_id = msg.payload.intents[i].examples[j_len-1].text;\n            }\n        }\n    }\n}\nmsg.wcs_setup.continue_flag = \"Yes\";\nif (msg.wcs_setup.wcs_count === 0) {\n    node.error(\"Pl. check WCS Setup Workspace - No Workspaces are defined for NLC Training set\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nif (msg.wcs_setup.nlc_classifier_id === \"\") {\n    node.error(\"Pl. check WCS Setup Workspace - NLC_Classifier_Id has not defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":680,"y":200,"wires":[[]]},{"id":"e6e1ece6.18a4b","type":"function","z":"c14accc6.1cca2","name":"Scan Setup Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      //node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":530,"y":120,"wires":[["4ea5e466.97b10c"]]},{"id":"6574ee5d.e3504","type":"function","z":"c14accc6.1cca2","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'b5bf7394-2b9d-4ec6-853b-5ad8fb787d16';\nmsg.wcs_setup.setup_wcs_tag = 'UCG-Setup-WCS';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.nlc_classifier_id = \"\";            // This will be updated latter in the flow \nmsg.wcs_setup.nls_userid = '6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.wcs_setup.nls_password = 'sWVYahvWPb8j';\nmsg.wcs_setup.nls_start = Date();\n\nreturn msg;\n\n ","outputs":1,"noerr":0,"x":440,"y":200,"wires":[["e6e1ece6.18a4b"]]},{"id":"d82a198.b7a5168","type":"function","z":"c14accc6.1cca2","name":"Check if WCS_setup to be loaded?","func":"if (typeof msg.wcs_setup !== 'undefined') {\n    msg.load_wcs_setup = \"No\";\n}\nelse {\n    msg.load_wcs_setup = \"Yes\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":120,"wires":[["f9ff9da2.38272"]]},{"id":"f9ff9da2.38272","type":"switch","z":"c14accc6.1cca2","name":"","property":"load_wcs_setup","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":260,"wires":[["6574ee5d.e3504"],[]]},{"id":"a63202ac.b2ac8","type":"debug","z":"b6773c98.30a0f","name":"Rcvd from Chat","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":300,"y":660,"wires":[]},{"id":"9e9f82c4.4b3db","type":"debug","z":"b6773c98.30a0f","name":"Input  Message to NLC","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":760,"y":440,"wires":[]},{"id":"3f6a4573.dfcbd2","type":"http in","z":"b6773c98.30a0f","name":"Mobile HTTP in","url":"/smooch2","method":"post","upload":false,"swaggerDoc":"","x":240,"y":580,"wires":[["a63202ac.b2ac8","aec7624.1a3772","f1c825ba.c44758"]]},{"id":"ce979e72.52805","type":"watson-conversation-v1","z":"b6773c98.30a0f","name":"Base Conv","workspaceid":"","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"","x":1170,"y":640,"wires":[["88af81b9.9db098","e2b49808.de4b1","c1193e9b.37786"]]},{"id":"37e9e54e.e3f33a","type":"function","z":"b6773c98.30a0f","name":"Set Params-NLC","func":"msg.payload = msg.save_payload;\n\n//*** Restore Context from previous dialog **//\n\nif (typeof msg.params  == 'undefined') {\n            msg.params  = {};\n}\nif (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n}\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    msg.params.context = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(msg);\n}\n\nif (typeof msg.params.context.Check_NLC !== 'undefined') {\n   msg.Check_NLC = msg.params.context.Check_NLC; \n}\n\nif (msg.Check_NLC === \"Yes\") {\n   msg.params.context.cur_wcs_id = \"\";\n   msg.params.context.cur_wcs_tag = \"\";\n}\nelse { \n      if (typeof msg.params.context.cur_wcs_id === 'undefined') {\n         msg.Check_NLC = \"Yes\";\n     } \n}\n\n//if (typeof msg.params.context.cur_wcs_id !== \n\n/**\nvar user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n\n\nif (typeof global.get('\"'+user_glob_Check_NLC+'\"') !== 'undefined') {\n    msg.Check_NLC = global.get('\"'+user_glob_Check_NLC+'\"');\n} else {\n    msg.Check_NLC = \"Yes\";\n}\n**/\n//var m_input = msg.payload.messages[0].text;\nif  (msg.Check_NLC === \"Yes\") {\n    msg.payload = msg.payload.messages[0].text;\n    node.error(\"Calling NLC\");\n} else { node.error(\"Skipping NLC Call\"); }\n\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":560,"wires":[["9e9f82c4.4b3db","b321f766.abd2d8"]]},{"id":"c1193e9b.37786","type":"function","z":"b6773c98.30a0f","name":"Response Msg","func":"node.error(\"Inside Response MSG\");\nnode.error(msg);\n\n//if (typeof msg.payload.output.text[0] == 'undefined') {\n//    msg.payload.output.text[0] = \"Sorry I am not trained on this topic yet; try asking some other question\";\n//}\n\nif (typeof msg.payload.context.Check_NLC !== 'undefined') {\n    if (msg.payload.context.Check_NLC === \"Yes\") {\n        var user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n        global.set('\"'+user_glob_Check_NLC+'\"',\"Yes\");\n    }\n}\n\n\nmsg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'     \n};\n\n//*** store context to global variable ***//\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nvar user_glob_wcs_setup = \"Save_wcs_setup_\" + msg.save_payload .appUser._id;\nvar user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload .appUser._id;\nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nglobal.set('\"'+user_glob_Context+'\"',msg.payload.context);\nglobal.set('\"'+user_glob_wcs_setup+'\"',msg.wcs_setup);\nglobal.set('\"'+user_glob_Context_time+'\"',cur_time);\n \n\nmsg.Skip_Output = \"No\";\nif (typeof msg.payload.context.Skip_Output !== 'undefined') {\n    msg.Skip_Output = msg.payload.context.Skip_Output;\n}\nif (msg.payload.context.skip_loop_break === \"Yes\" ) {\n    node.error(\"Breaking skip loop\");\n    msg.Skip_Output = \"No\";\n    //msg.payload.output.text = \"Sorry I am not trained on this topic\";\n}\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\n\n//if (typeof msg.payload.output.text === 'undefined') {\n//    msg.payload.output.text = \"Nitin K\";\n//}\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n Newmsg = texts[i]; \n //node.error(\"Newmsg :[\"+ i+\"]\"+Newmsg);\n var component = \"\";\n var mapStr = \"\";\n var actions = {};\n var actionsArr = [];\n var actionsRArr = [];\n var buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n //simple buttons\n if (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n }\n\n //json map\n //var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\n if (typeof Watson_contextOBJ.map != 'undefined') {\n     mapjsonObj = Watson_contextOBJ.map;\n     if (typeof mapjsonObj.values != \"undefined\") {\n        //node.log(\"mapjson: \" + mapjsonStr);\n        //if (mapjsonStr  !== null){\n        component = \"map\";\n        for (var c in mapjsonObj.values) {\n            mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n            actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n        }\n   }\n }\n\n //json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n // Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n //var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\n var found_link = 0;\n //node.log(\"buttonjson: \" + buttonjsonStr);\n if (typeof Watson_contextOBJ.button != 'undefined') {\n    buttonjsonObj = Watson_contextOBJ.button;\n    if (typeof buttonjsonObj.values != \"undefined\") {\n       for (var c in buttonjsonObj.values) {\n           buttonStr = buttonjsonObj.values[c];\n           if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n              found_link = 1;\n              buttonItems = buttonStr.split(\"|\");\n              button_title = buttonItems[0];\n              button_url = buttonItems[1];\n              actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n            }\n            else {\n              button_title = buttonStr;  \n              actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n            }\n        }  \n        if (found_link > 0) {\n           component = \"buttonLink\"; \n        }else {\n           component = \"buttonReply\";   \n        }\n    }\n}\n\n //old maps\n if (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n } \n\n // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n Newmsg = Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n Newmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n// node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Newmsg)\n\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\n\nvar nk_texts = msg.payload.output.text\n\n//if (nk_texts == \"\") {\n//    nk_texts = \"Sorry I am not trained on that topic yet\";\n//}\n\n \nfor (i = 0; i < nk_texts.length; i++) {\n nk_Newmsg = nk_texts[i]; \n //node.error(\"nk_Newmsg :[\"+ i+\"]\"+nk_Newmsg);\n nk_Newmsg = nk_Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n nk_Newmsg = nk_Newmsg.replace(/<[^>]+>/g, \"\");\n switch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : nk_Newmsg,\n        email: \"watson40985@gmail.com\",\n        actions : actionsArr};\n }\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n\n//node.error(\"Response-2\");\n  msg.payload = response;\n//node.error(msg);  \n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n \n }\n}\n//node.error(\"Before sending response\");\n//node.error(msg);\nreturn [null,msg];","outputs":2,"noerr":0,"x":1380,"y":640,"wires":[["4fd79685.de65b8","de76a675.e3439"],["d499df6e.3e932"]]},{"id":"62e8d4cf.b6eb54","type":"debug","z":"b6773c98.30a0f","name":"Response msg payload smooch","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1570,"y":800,"wires":[]},{"id":"d6c986fe.d575c8","type":"http request","z":"b6773c98.30a0f","name":"","method":"POST","ret":"txt","url":"","tls":"","x":847.0000305175781,"y":1261.0000305175781,"wires":[["79a08d27.0122fc"]]},{"id":"da59daeb.3163d","type":"function","z":"b6773c98.30a0f","name":"Send post message","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g'\n     };\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + \"02aaa89716d5b27e3a37aab3\" + \"/messages\";\n\nvar response = {\n    role : \"appMaker\",\n    type : \"text\",\n    text : \"hey what's up!!!\",\n    email: \"watson40985@gmail.com\",\n    //email: \"dennisnoto@gmail.com\",\n    actions : []\n};\n\nmsg.payload = response;\n\nreturn msg;","outputs":1,"noerr":0,"x":612.0000152587891,"y":1261.0000114440918,"wires":[["d6c986fe.d575c8"]]},{"id":"79a08d27.0122fc","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"payload","x":1050,"y":1260,"wires":[]},{"id":"2c1a5bba.57d694","type":"inject","z":"b6773c98.30a0f","name":"","topic":"go","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":374.00001525878906,"y":1266.0000114440918,"wires":[["da59daeb.3163d"]]},{"id":"aec7624.1a3772","type":"http response","z":"b6773c98.30a0f","name":"HTTP-Postback","statusCode":"","headers":{},"x":556.7142791748047,"y":663.000002861023,"wires":[]},{"id":"4fd79685.de65b8","type":"debug","z":"b6773c98.30a0f","name":"smooch out of response msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1720,"y":580,"wires":[]},{"id":"88af81b9.9db098","type":"debug","z":"b6773c98.30a0f","name":"smooch out of convo","active":false,"tosidebar":true,"console":false,"complete":"payload","x":1580,"y":460,"wires":[]},{"id":"6cbd4454.0c668c","type":"http in","z":"b6773c98.30a0f","name":"Postbacks","url":"/smooch-postback","method":"post","swaggerDoc":"","x":350.7143096923828,"y":719.1250257492065,"wires":[["1138d423.113564","aec7624.1a3772","9e9f1846.2beda"]]},{"id":"9e9f1846.2beda","type":"function","z":"b6773c98.30a0f","name":"actionPayload","func":"msg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'\n     };\n\nmsg.user = msg.payload.appUser.userId;\n//msg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\nmsg.actionPayload = msg.payload.postbacks[0].action.payload;\n\nresponse = {\n        role : \"appUser\",\n        type : \"text\",\n        text : msg.actionPayload\n};\n\nmsg.payload = response;\nreturn msg;","outputs":1,"noerr":0,"x":404.9834976196289,"y":811.9999990463257,"wires":[[]]},{"id":"1138d423.113564","type":"debug","z":"b6773c98.30a0f","name":"PostBack Messsage","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":570,"y":739,"wires":[]},{"id":"9ac0d3a.78d453","type":"http in","z":"b6773c98.30a0f","name":"","url":"/getchatdata","method":"get","swaggerDoc":"","x":432,"y":1363,"wires":[["b58868ef.c24148"]]},{"id":"b58868ef.c24148","type":"http response","z":"b6773c98.30a0f","name":"","x":872,"y":1363,"wires":[]},{"id":"e4f2a7e1.0988e","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":872,"y":1423,"wires":[]},{"id":"66b23dee.35392c","type":"inject","z":"b6773c98.30a0f","name":"","topic":"02b79c84-2504-4e96-a48e-eeac02f5e368","payload":"8163b5e5-0b90-4270-9c2a-c660eae3c2e9","payloadType":"str","repeat":"","crontab":"","once":false,"x":432,"y":1423,"wires":[[]]},{"id":"feebd297.0c6168","type":"natural-language-understanding","z":"b6773c98.30a0f","name":"alchemy_test","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":true,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":667,"y":1484,"wires":[["9e8c2272.40081"]]},{"id":"2a21fdac.21895a","type":"inject","z":"b6773c98.30a0f","name":"","topic":"","payload":"Boss this is Nitin","payloadType":"str","repeat":"","crontab":"","once":false,"x":418,"y":1482.75,"wires":[["feebd297.0c6168","b0f3c4f4.5a21f8"]]},{"id":"9e8c2272.40081","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":992,"y":1483,"wires":[]},{"id":"2b62992e.fbb12e","type":"natural-language-understanding","z":"b6773c98.30a0f","name":"extract concepts","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":false,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":1690,"y":1240,"wires":[["345ae7b0.1704f8","42037bad.026da4"]]},{"id":"b0f3c4f4.5a21f8","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":628,"y":1540,"wires":[]},{"id":"c359e161.524b5","type":"switch","z":"b6773c98.30a0f","name":"ALC or Reg","property":"m_node_path","propertyType":"global","rules":[{"t":"eq","v":"Alc","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1241,"y":1246.25,"wires":[["94d173ca.f52f08","b53f26a9.d55c88"],["3c1936f2.217f1a"]]},{"id":"94d173ca.f52f08","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":1389,"y":1193,"wires":[]},{"id":"e2b49808.de4b1","type":"debug","z":"b6773c98.30a0f","name":"NK-SWTCH","active":false,"tosidebar":true,"console":false,"complete":"true","x":1550,"y":500,"wires":[]},{"id":"345ae7b0.1704f8","type":"debug","z":"b6773c98.30a0f","name":"post_WNLU_message","active":true,"console":"false","complete":"true","x":1817,"y":1110,"wires":[]},{"id":"b53f26a9.d55c88","type":"function","z":"b6773c98.30a0f","name":"Transform payload","func":"var m_name = msg.payload;\nmsg.payload = m_name;\nmsg.payload.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"x":1438,"y":1240.25,"wires":[["9656db4a.ee73d8","2b62992e.fbb12e"]]},{"id":"9656db4a.ee73d8","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":1610,"y":1169,"wires":[]},{"id":"3c1936f2.217f1a","type":"debug","z":"b6773c98.30a0f","name":"NAKNAK","active":true,"console":"false","complete":"true","x":1301,"y":1329,"wires":[]},{"id":"42037bad.026da4","type":"function","z":"b6773c98.30a0f","name":"push message","func":"//var m_entity_type = msg.features.entities.type[0];\n//var m_entity_name = msg.features.entities.text[0];\nvar acl_payload = global.get(\"prev_msg\");\nvar m_user_name = \" \";\nvar m_cnt = 0;\n/**\n\n\nif (\"text\" in msg.features.keywords[0]) {\n  m_user_name = msg.features.keywords[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"2nd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"2nd-else compare\";\n}\n\n\nif (m_cnt === 0 ) {\nif (\"text\" in msg.features.entities[0]) {\n  m_user_name = msg.features.entities[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"3rd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"3rd-else compare\";\n}\n}\nelse {\n     msg.additional_context.joyName =\"4th-else compare\";\n}\n**/\n\nif (typeof(msg.features.keywords) !== \"undefined\") { \n    node.error(\"I am here-1\");\nif (typeof(msg.features.keywords[0]) !== \"undefined\") { \n      node.error(\"I am here-2\");\n    msg.additional_context.joyName =\"1st compare\";\n    m_user_name = msg.features.keywords[0].text; \n   node.error(\"I am here-3\", msg.features.keywords[0].text);\n    m_cnt = 1;\n}\n}\n\nif (m_cnt === 0) {\n    if (typeof(msg.features.entities) !== \"undefined\") {\n            node.error(\"I am here-4\");\nif (typeof(msg.features.entities[0].text) !== \"undefined\") { \n                node.error(\"I am here-41\");\n         m_user_name = msg.features.entities[0].text; \n         m_cnt = 2;\n          msg.additional_context.joyName =\"4th compare\";\n                        node.error(\"I am here-42\", msg.features.entities[0].text);\n}\n}\n}\n\nif (m_cnt === 0) {\n    m_user_name = \"there\";\n}\n\nmsg.payload = acl_payload;\nmsg.payload.text = \"Hello \" + m_user_name + \"..!! What can I do for you today\";\n//node.send(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1940,"y":1240,"wires":[["7a652b86.64e2e4"]]},{"id":"7a652b86.64e2e4","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"console":"false","complete":"true","x":1863,"y":1161,"wires":[]},{"id":"1711143e.80619c","type":"http request","z":"b6773c98.30a0f","name":"","method":"POST","ret":"txt","url":"","tls":"","x":1532,"y":723,"wires":[["62e8d4cf.b6eb54"]]},{"id":"de76a675.e3439","type":"delay","z":"b6773c98.30a0f","name":"Send one message at a time","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1660,"y":640,"wires":[["1711143e.80619c"]]},{"id":"e6014cf9.7b3f6","type":"inject","z":"b6773c98.30a0f","name":"@start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"","x":373,"y":109,"wires":[["90ca3b44.ebc8a"]]},{"id":"90ca3b44.ebc8a","type":"function","z":"b6773c98.30a0f","name":"clear global_var","func":"var m1 = undefined;\nnode.error(m1);\nglobal.set(\"wcs_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"global_Check_context\",m1);\nglobal.set(\"wcs_tag_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"wcs_id_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"Check_NLC_02aaa89716d5b27e3a37aab3\", m1);\nglobal.set(\"Save_Context_02aaa89716d5b27e3a37aab3\",m1);\n\nglobal.set(\"wcs_tag_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"wcs_id_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"Check_NLC_846ebb6b596dbe429b3e1c87\", m1)\nglobal.set(\"Save_Context_846ebb6b596dbe429b3e1c87\",m1);\n\nglobal.set(\"wcs_tag_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"wcs_id_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"Check_NLC_5ab2aac0df704a0022810445\", m1)\nglobal.set(\"Save_Context_5ab2aac0df704a0022810445\",m1);\n\nglobal.set(\"wcs_tag_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"wcs_id_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"Check_NLC_5ab2a36c8716ad0023ae4beb\", m1)\nglobal.set(\"Save_Context_5ab2a36c8716ad0023ae4beb\",m1);\n\nglobal.set(\"wcs_tag_43f74556a555baef5ef95b28\",m1);\nglobal.set(\"wcs_id_43f74556a555baef5ef95b28\",m1);\nglobal.set(\"Check_NLC_43f74556a555baef5ef95b28\", m1)\nglobal.set(\"Save_Context_43f74556a555baef5ef95b28\",m1);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":623,"y":109,"wires":[[]]},{"id":"d499df6e.3e932","type":"switch","z":"b6773c98.30a0f","name":"","property":"Skip_Output","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1272,"y":763,"wires":[["e3acfd1b.ffdb4"],["7cc53da5.fe0b4c"]]},{"id":"7a8dcc.38912a34","type":"function","z":"b6773c98.30a0f","name":"Check","func":"node.error(\"Inside Check Node - Response from WCS\");\n//node.error(msg);\nmsg.tmp_Switch_Workspace = \"No\";\nif (typeof msg.payload.context.Switch_Workspace !== 'undefined') {\n    //node.error(\"Check-1\");\n    if (msg.payload.context.Switch_Workspace.length > 0 ) {\n        msg.tmp_Switch_Workspace = \"Yes\";\n         //node.error(\"Check-2\");\n    }\n}\nif (msg.tmp_Switch_Workspace === \"Yes\") {\n    if (msg.curr_wcs_num === msg.payload.context.Switch_Workspace) {\n        msg.tmp_Switch_Workspace = \"No\";\n    }\n    else {\n       var user_glob_var = \"wcs_\" + msg.save_payload.appUser._id ;\n       var m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       if (msg.payload.context.Switch_Workspace !== \"\") {\n           global.set('\"'+user_glob_var+'\"',msg.payload.context.Switch_Workspace);\n           global.set(\"global_Check_context\", \"Yes\");\n           global.set(\"global_Root\", msg.payload.context.Root);\n           global.set(\"global_Child\",msg.payload.context.Child);\n           node.error(\"Workspace Swtiched initiated\");\n       } \n        \n    }\n}\nnode.error(\"Check - Switch Workspace ? \" + msg.tmp_Switch_Workspace);\n\nreturn msg;","outputs":1,"noerr":0,"x":1510,"y":360,"wires":[[]]},{"id":"e3acfd1b.ffdb4","type":"function","z":"b6773c98.30a0f","name":"Restore MSG Payload","func":"msg.payload = msg.save_payload;\n//msg.payload.messages[0].text = \" \";\nnode.error(\"Skipping output\");\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1092,"y":723,"wires":[["37e9e54e.e3f33a"]]},{"id":"2ed2cc.799c1d34","type":"debug","z":"b6773c98.30a0f","name":"NLC-Output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1190,"y":380,"wires":[]},{"id":"eb745038.41d63","type":"function","z":"b6773c98.30a0f","name":"Set Params-WCS","func":"node.error(\"Nak-Inside setparms wcs\");\nnode.error(msg);\n\nvar m_cur_wcs_tag = \"\";\nvar m_cur_wcs_id = \"\";\n\n/**\nif (msg.Check_NLC !== \"Yes\") {\n    node.error(\"Retrived prior wcs ID\");\n    var user_glob_wcs_tag = \"wcs_tag_\" + msg.save_payload .appUser._id ;\n    var user_glob_wcs_id = \"wcs_id_\" + msg.save_payload .appUser._id ;\n    var user_glob_var = \"wcs_\" + msg.payload.appUser._id ;\n    if (typeof global.get('\"'+user_glob_wcs_tag+'\"') !== 'undefined' ) {\n      m_cur_wcs_tag = global.get('\"'+user_glob_wcs_tag+'\"');\n      m_cur_wcs_id  = global.get('\"'+user_glob_wcs_id+'\"');\n    }          \n    else {\n      m_cur_wcs_tag = global.get(\"global_default_wcs_tag\");\n      m_cur_wcs_id  = global.get(\"global_default_wcs_id\");\n    }  \n    msg.cur_wcs_tag = m_cur_wcs_tag;\n    msg.cur_wcs_id  = m_cur_wcs_id;\n}\n**/\n\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\n//var user = msg.payload.appUser._id;\n//var input = msg.payload.messages[0].text;\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     user = msg.payload.appUser._id;  \n   }\n}\n\nvar test  = JSON.stringify(msg.payload);\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n\nmsg.app = \"RegionsAssist\";\n\nvar additional_context = {\n    fname: fname,\n    map : map,\n    button: button \n    \n};\n\nif (input.lastIndexOf('/') >= 0 ) {\n     var myindex = input.lastIndexOf('/')\n     node.log(\"index at: \" + myindex)\n     var dateString = input\n     node.log(\"dateString : \" + dateString)\n     \n     var d = new Date(dateString)\n     node.log(\"d : \" + d)\n     var now = new Date()\n     node.log(\"today: \" + now)\n     var years = now.getFullYear() - d.getFullYear()\n     node.log(\"years: \" + years)\n     \n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     node.log(\"days: \" + days)\n     var age = years + days /365\n    \n     additional_context.age = Math.round(age *100)/100\n     node.log(\"age: \"+ context.age)\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     additional_context.ageEOY = Math.round(ageEOY * 100)/100\n     node.log(\"ageEOY: \"+ context.ageEOY)\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     additional_context.ageBOY = Math.round(ageBOY * 100)/100\n     node.log(\"ageBOY: \"+ context.ageBOY)\n}\nmsg.payload = input;\nmsg.params.workspace_id = msg.params.context.cur_wcs_id;\nmsg.params.username = msg.wcs_setup.wcs_user       \nmsg.params.password = msg.wcs_setup.wcs_password;  \nmsg.user = user;\nmsg.additional_context = additional_context;\n\n// Restore Context from global variable **/\n/*\nif (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n        }\n        \nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    msg.params.context = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(msg);\n}\n**/\n//delete msg.params.context.Check_NLC;\n//delete msg.params.context.Skip_Output; \nmsg.params.context.Check_NLC = \"No\";\nmsg.params.context.Skip_Output = \"No\"; \n\n//msg.cur_wcs_tag = m_wcs_tag;\n/**\nif (typeof msg.params.context.last_wcs_tag === 'undefined') {\n    msg.params.context.last_wcs_tag = \"\";\n    msg.params.context.last_user_input = \"\";\n    msg.params.context.last_nlc_repeat_count = 0;\n    msg.params.context.skip_loop_break = \"No\";\n}\n\nif (msg.params.context.last_user_input === input) {\n    msg.params.context.last_nlc_repeat_count++;\n    msg.params.context.last_wcs_tag = msg.params.context.last_wcs_tag + \";\" + msg.cur_wcs_tag;\n} else {\n    msg.params.context.last_nlc_repeat_count = 1;\n    msg.params.context.last_wcs_tag = msg.cur_wcs_tag;\n    msg.params.context.last_user_input = input;\n}  \n**/\n/**\nif (typeof global.get(\"global_Check_context\") !== 'undefined') {\n    if (global.get(\"global_Check_context\") === \"Yes\" ) {\n//        node.error(\"Set Context Variables from prior dialog\");\n//        node.error(msg);\n        if (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n        }\n        msg.params.context.Root = global.get(\"global_Root\");\n        msg.params.context.Child = global.get(\"global_Child\");\n        global.set(\"global_Check_context\", \"No\");\n        \n    }\n}\n*/\nmsg.Check_NLC = \"No\"; \nnode.error(\"msg object - input to WCS\");\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":990,"y":580,"wires":[["ce979e72.52805"]]},{"id":"b321f766.abd2d8","type":"switch","z":"b6773c98.30a0f","name":"","property":"Check_NLC","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":520,"wires":[["99d268d7.b6068"],["eb745038.41d63"]]},{"id":"b9423364.46ecc","type":"function","z":"b6773c98.30a0f","name":"Get WCS","func":"var wcs_1_tag = \"Regions_NK_Test_1_Greeter\";\nvar wcs_1_id  = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\"\nvar wcs_2_tag = \"Regions-NK-Test-2-OLB\"\nvar wcs_2_id  = \"9e53d515-48de-4a7b-9af3-27f74a4bf043\"\nvar wcs_3_tag = \"Regions_NK_Test_3_FeeRefund\"\nvar wcs_3_id  = \"fa66ecc7-1528-45ea-9094-135b2f513fab\";\n\nglobal.set(\"global_default_wcs_tag\", wcs_1_tag);\nglobal.set(\"global_default_wcs_id\", wcs_1_id);\nnode.error(\"Inside Get WCS\");\nvar class_array = msg.payload.classes\nvar m_wcs_tag = \"\";\nvar m_wcs_id = \"\";\nvar m_wcs_confidence = 0;\n\nvar m_string = \"\"; \nvar m_validate_repeat = \"No\";\nvar m_proceed = \"Yes\";\n//var m_Skip_Output = \"No\";\nnode.error(\"Inside Get WCS\");\nif (typeof msg.params.context.last_wcs_tag === 'undefined') {\n    msg.params.context.last_wcs_tag = \"\";\n    msg.params.context.last_user_input = \"\";\n    msg.params.context.last_nlc_repeat_count = 0;\n    msg.params.context.skip_loop_break = \"No\";\n}\nelse {\n   if ((msg.params.context.last_user_input === msg.save_payload.messages[0].text) && (msg.params.context.Skip_Output === \"Yes\")) {\n      m_validate_repeat = \"Yes\";\n      //m_Skip_Output = \"Yes\";\n      m_string = msg.params.context.last_wcs_tag;\n      msg.params.context.last_nlc_repeat_count++;\n      node.error(\"Validate Repeat - Yes [\" + m_string + \"]\" );\n   }\n   else {\n      msg.params.context.last_nlc_repeat_count = 1;\n      msg.params.context.last_user_input = msg.save_payload.messages[0].text;\n   }\n}\n\nfor (i = 0; i < class_array.length; i++) {\n    if (m_validate_repeat === \"Yes\") {\n        if (m_string.indexOf(class_array[i].class_name) >= 0) {\n            m_proceed = \"No\";\n        }\n    }   \n    if (m_proceed === \"Yes\") {\n        \n        for (j=0;j<msg.wcs_setup.wcs_set.length;j++) {\n            if (class_array[i].class_name === msg.wcs_setup.wcs_set[j].wcs_tag &&\n               (class_array[i].confidence > m_wcs_confidence) ) {\n                m_wcs_tag = class_array[i].class_name;\n                m_wcs_confidence = class_array[i].confidence;\n                m_wcs_id = msg.wcs_setup.wcs_set[j].wcs_id;\n            }\n        }\n    } else {m_proceed = \"Yes\";}\n}\n\nnode.error(\"m_wcs_tag \" + m_wcs_tag);\nif (m_wcs_tag === \"\") {\n    if (m_validate_repeat === \"Yes\") {\n        msg.params.context.skip_loop_break = \"Yes\";\n        node.error(\"Set for loop break\");\n    }\n    m_wcs_tag = \"Default_WCS\";  \n    m_wcs_id  = msg.wcs_setup.default_wcs_id;\n}    \nelse {\n     msg.params.context.skip_loop_break = \"No\";\n     if (m_validate_repeat === \"Yes\") {\n        msg.params.context.last_wcs_tag = msg.params.context.last_wcs_tag + \";\" + m_wcs_tag;\n     } \n     else { \n        msg.params.context.last_wcs_tag = m_wcs_tag; \n     }\n}\n\nmsg.cur_wcs_tag=m_wcs_tag;\nmsg.params.context.cur_wcs_tag = m_wcs_tag;\nmsg.params.context.cur_wcs_id = m_wcs_id;\n\nvar user_glob_wcs_tag = \"wcs_tag_\" + msg.save_payload .appUser._id ;\nvar user_glob_wcs_id = \"wcs_id_\" + msg.save_payload .appUser._id ;\nvar user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n//node.error(\"NAK user_glob_var ==>[\" + user_glob_var +\"]\");\n/*\nglobal.set('\"'+user_glob_wcs_tag+'\"',m_wcs_tag);\nglobal.set('\"'+user_glob_wcs_id+'\"',m_wcs_id);\nglobal.set('\"'+user_glob_Check_NLC+'\"',\"No\");\n\nvar m_get_wcs_tag = global.get('\"'+user_glob_wcs_tag+'\"');\nvar m_get_wcs_id = global.get('\"'+user_glob_wcs_id+'\"');\nnode.error(\"Global Var : \" + m_get_wcs_tag + \"==> WCS Tag ==> \" + m_get_wcs_tag + \" [\"+m_get_wcs_id+\"]\");\n*/\nmsg.cur_wcs_tag = m_wcs_tag;\nmsg.cur_wcs_id  = m_wcs_id;\n\n//Restore msg.payload\n\nmsg.payload = msg.save_payload;\n    \nreturn msg;","outputs":1,"noerr":0,"x":1200,"y":520,"wires":[["eb745038.41d63"]]},{"id":"7cc53da5.fe0b4c","type":"debug","z":"b6773c98.30a0f","name":"None","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1300,"y":820,"wires":[]},{"id":"36051b80.19e244","type":"function","z":"b6773c98.30a0f","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'b5bf7394-2b9d-4ec6-853b-5ad8fb787d16';\nmsg.wcs_setup.setup_wcs_tag = 'UCG-Setup-WCS-NLC';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.nlc_classifier_id = \"\";            // This will be updated latter in the flow \nmsg.wcs_setup.nls_userid = '6d3138e7-c168-4a1b-bebe-be00e647e364';\nmsg.wcs_setup.nls_password = 'sWVYahvWPb8j';\nmsg.wcs_setup.nls_start = Date();\n\nreturn msg;\n\n ","outputs":1,"noerr":0,"x":380,"y":280,"wires":[["549be7bd.d5c38"]]},{"id":"549be7bd.d5c38","type":"function","z":"b6773c98.30a0f","name":"Scan Setup Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      //node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":590,"y":280,"wires":[["89890849.679378"]]},{"id":"89890849.679378","type":"function","z":"b6773c98.30a0f","name":"Prepare Data for NLC Scan","func":"//node.error(\"inside nlc\");\n//node.error(msg);\n \nvar i = 0;\nvar j_len = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    j_len = msg.payload.intents[i].examples.length;\n    if (j_len > 0) {\n        if (msg.payload.intents[i].intent === \"NLC_Classifier_ID\") {\n            msg.wcs_setup.nlc_classifier_id = msg.payload.intents[i].examples[j_len-1].text;\n        }\n        else {\n             if (typeof msg.wcs_setup.wcs_set === 'undefined') {\n                 msg.wcs_setup.wcs_set = [{}];\n                 msg.wcs_setup.wcs_set[0] = {\n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                }\n             }\n             else {\n                msg.wcs_setup.wcs_set.push({     \n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                })\n            }\n            msg.wcs_setup.wcs_count = msg.wcs_setup.wcs_count + 1;\n        }\n    }\n}\nmsg.wcs_setup.continue_flag = \"Yes\";\nif (msg.wcs_setup.wcs_count === 0) {\n    node.error(\"Pl. check WCS Setup Workspace - No Workspaces are defined for NLC Training set\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nif (msg.wcs_setup.nlc_classifier_id === \"\") {\n    node.error(\"Pl. check WCS Setup Workspace - NLC_Classifier_Id has not defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":860,"y":280,"wires":[["2da4dfb9.4618b"]]},{"id":"54e49dbe.0c09dc","type":"inject","z":"b6773c98.30a0f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":180,"wires":[["36051b80.19e244"]]},{"id":"2da4dfb9.4618b","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1060,"y":240,"wires":[]},{"id":"b9afafea.9e3718","type":"subflow:c14accc6.1cca2","z":"b6773c98.30a0f","name":"","x":450,"y":460,"wires":[["37e9e54e.e3f33a"]]},{"id":"b02eeb16.195108","type":"function","z":"b6773c98.30a0f","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nmsg.payload = \"overdraft charges on my account\" ;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":980,"y":860,"wires":[[]]},{"id":"c529d99d.8bf248","type":"inject","z":"b6773c98.30a0f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":620,"y":840,"wires":[["3dbbd5a0.24e67a"]]},{"id":"3dbbd5a0.24e67a","type":"subflow:c14accc6.1cca2","z":"b6773c98.30a0f","x":790,"y":780,"wires":[["b02eeb16.195108","26a9346b.66a11c"]]},{"id":"26a9346b.66a11c","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":980,"y":780,"wires":[]},{"id":"99d268d7.b6068","type":"function","z":"b6773c98.30a0f","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":980,"y":480,"wires":[["b9423364.46ecc"]]},{"id":"ad8da6d0.d0a31","type":"function","z":"b6773c98.30a0f","name":"dt1","func":"    var d = new Date();\n    var n = d.getTime();\n    node.error(n);\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":980,"wires":[["f25d5a05.7f66d"]]},{"id":"5a3390ea.3bd58","type":"inject","z":"b6773c98.30a0f","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":980,"wires":[["ad8da6d0.d0a31"]]},{"id":"51da86e.0f65078","type":"function","z":"b6773c98.30a0f","name":"dt2","func":"    var d = new Date();\n    var n = d.getTime();\n    node.error(n);\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1000,"wires":[[]]},{"id":"f25d5a05.7f66d","type":"delay","z":"b6773c98.30a0f","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":840,"y":1040,"wires":[["51da86e.0f65078"]]},{"id":"f1c825ba.c44758","type":"function","z":"b6773c98.30a0f","name":"Restore Context ?","func":"msg.save_payload = msg.payload;\nnode.error(\"Nak-Incoming Message-NLC\");\nnode.error(msg);\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nvar user_glob_wcs_setup = \"Save_wcs_setup_\" + msg.save_payload .appUser._id;\nvar user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload .appUser._id;\n\n//global.set('\"'+user_glob_Context+'\"',msg.payload.context);\n//global.set('\"'+user_glob_wcs_setup+'\"',msg.wcs_setup);\n//global.set('\"'+user_glob_Context_time+'\"',cur_time);\n \nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nif (typeof global.get('\"'+user_glob_Context_time+'\"') !== 'undefined') {\n    var m_time_elapsed = cur_time - global.get('\"'+user_glob_Context_time+'\"');\n    if (m_time_elapsed > 600000) {\n        var m1 = undefined;\n        global.set('\"'+user_glob_Context+'\"',m1);\n        global.set('\"'+user_glob_wcs_setup+'\"',m1);\n        global.set('\"'+user_glob_Context_time+'\"',m1);\n        node.error(\"Cleared old Context variables\");\n    }\n    else {\n        if (typeof global.get('\"'+user_glob_wcs_setup+'\"') !== 'undefined'){\n            msg.wcs_setup = global.get('\"'+user_glob_wcs_setup+'\"');\n            node.error(\"Restored from global context\");\n        }\n            \n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":370,"y":380,"wires":[["b9afafea.9e3718"]]},{"id":"14708a60.3dfb4e","type":"function","z":"bb7facc8.aee828","name":"Jim's code","func":"var base = msg.payload.profile;\nnode.error(\"1\");\nif (typeof msg.session !== 'undefined'){\n    node.error(\"1a\");\n    if (typeof msg.session.profile == 'undefined'){\n        msg.session.profile = msg.payload.profile;\n        msg.session.profilePassword = msg.payload.password;\n        node.error(\"2\");\n    }\n    else\n    {\n        //do nothing\n        node.error(\"3\");\n    }\n}\nelse\n{\n\n    var sess ={\n        profile : msg.payload.profile,\n        profilePassword : msg.payload.password,\n    }    \n    msg.session =sess;\n    node.error(\"4\");\n}\nif (typeof msg.payload.filetoencrypt !== 'undefined'){\n    node.error(\"5\");\n    var unencryptstring = base+\"_Unecrypted_URL\";\n    msg.session[unencryptstring] = msg.payload.filetoencrypt;\n\n}\nif (typeof msg.payload.encryptedfilename !== 'undefined'){\n    node.error(\"6\");\n    var encryptstring = base+\"_Encrypted_URL\";\n    msg.session[encryptstring] =msg.payload.encryptedfilename;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":260,"wires":[["5951d40a.7bb5bc"]]},{"id":"9de71585.39d1f","type":"inject","z":"bb7facc8.aee828","name":"","topic":"","payload":"{   \"_msgid\": \"db370314.b7cfb\",   \"topic\": \"\",   \"payload\": {     \"profile\": \"TEST\",     \"profilePass\": \"testpass\"   },   \"path\": \"makeKeys\" }","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":260,"wires":[["9ac7eac4.77336","14708a60.3dfb4e"]]},{"id":"9ac7eac4.77336","type":"debug","z":"bb7facc8.aee828","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":510,"y":160,"wires":[]},{"id":"5951d40a.7bb5bc","type":"debug","z":"bb7facc8.aee828","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":640,"y":300,"wires":[]},{"id":"6dd28d8f.d9465c","type":"function","z":"bb7facc8.aee828","name":"Jim's code","func":"var base = msg.payload.profile;\nnode.error(\"1\");\nif (msg.session !=\"undefined\"){\n    node.error(\"1a\");\n    if (msg.session.profile ==\" undefined\"){\n        msg.session.profile = msg.payload.profile;\n        msg.session.profilePassword = msg.payload.password;\n        node.error(\"2\");\n    }\n    else\n    {\n        //do nothing\n        node.error(\"3\");\n    }\n}\nelse\n{\n\n    var sess ={\n        profile : msg.payload.profile,\n        profilePassword : msg.payload.password,\n    }    \n    msg.session =sess;\n    node.error(\"4\");\n}\nif (msg.payload.filetoencrypt!= \"undefined\"){\n    node.error(\"5\");\n    var unencryptstring = base+\"_Unecrypted_URL\";\n    msg.session[unencryptstring] = msg.payload.filetoencrypt;\n\n}\nif (msg.payload.encryptedfilename != \"undefined\"){\n    node.error(\"6\");\n    var encryptstring = base+\"_Encrypted_URL\";\n    msg.session[encryptstring] =msg.payload.encryptedfilename;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":360,"wires":[[]]},{"id":"2458ff90.3a9498","type":"function","z":"b6773c98.30a0f","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\nmsg.payload = \"i received fee\" ;\nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":820,"y":1160,"wires":[["f9353b70.294058"]]},{"id":"37363960.bc1456","type":"subflow:c14accc6.1cca2","z":"b6773c98.30a0f","name":"","x":590,"y":1160,"wires":[["4ea9c676.ba36d8","2458ff90.3a9498"]]},{"id":"f9353b70.294058","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1010,"y":1120,"wires":[]},{"id":"de51e863.29888","type":"inject","z":"b6773c98.30a0f","name":"","topic":"","payload":"I received fee","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":390,"y":1160,"wires":[["37363960.bc1456"]]},{"id":"4ea9c676.ba36d8","type":"debug","z":"b6773c98.30a0f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":750,"y":1120,"wires":[]},{"id":"ce1cbe3d.33ae28","type":"comment","z":"b6773c98.30a0f","name":"Smooch Chat flow which uses multiple workspaces and NLC. - Readme before use","info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-   \n\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"   \n   c) WorkspaceTag - must not include include blanks   \n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTagThe flow assumes, \n      all Workspaces are listed under Setup Workspace and those will be used, \n      to create training data set. \n      There is no limit on number of workspaces which can be included under \n      Setup Workspace, as long as above rules are followed. \n      In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS-NLC\"; if this     \n      needs to have different name, then pl. remember to update name in    \n      'get-ready' node.    \n\n2) The flow needs to NLC classifer ID, which can also be defined in   \n   setup workspace with special intent as 'NLC_Classifier_ID' and example    \n   will have NLC traning set value. The flow will update NLC Classifer ID in    \n   example, once generated.       T\n   The flow will delete existing NLC Classifer, before running   new training set.  \n\n3) The flow also assumes, all workspaces have same set of   credentials and are defined in 'get-ready' node. The flow, can be    modified to pickup credentials from SOE Environment file.   ","x":630,"y":40,"wires":[]},{"id":"614e8707.d0b028","type":"comment","z":"cb130c7a.1c52d8","name":"The flow creates Training set for NLC leveraging Workspaes defined under setup Workspace - Readme before use","info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-   \n\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"   \n   c) WorkspaceTag - must not include include blanks   \n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTagThe flow assumes, \n      all Workspaces are listed under Setup Workspace and those will be used, \n      to create training data set. \n      There is no limit on number of workspaces which can be included under \n      Setup Workspace, as long as above rules are followed. \n      In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS\"; if this     \n      needs to have different name, then pl. remember to update name in    \n      'get-ready' node.    \n\n2) The flow needs to NLC classifer ID, which can also be defined in   \n   setup workspace with special intent as 'NLC_Classifier_ID' and example    \n   will have NLC traning set value. The flow will update NLC Classifer ID in    \n   example, once generated.       T\n   The flow will delete existing NLC Classifer, before running   new training set.  \n\n3) The flow also assumes, all workspaces have same set of   credentials and are defined in 'get-ready' node. The flow, can be    modified to pickup credentials from SOE Environment file.   ","x":450,"y":120,"wires":[]},{"id":"e3590dfa.472bb","type":"comment","z":"cb130c7a.1c52d8","name":"JSON for settingup \"setup workspace\"","info":"{\"name\":\"UCG-Setup-WCS\",\"intents\":[{\"intent\":\"WCS_OLB\",\"examples\":[{\"text\":\"9e53d515-48de-4a7b-9af3-27f74a4bf043\"}],\"description\":\"\"},{\"intent\":\"Default_WCS\",\"examples\":[{\"text\":\"ceb151b4-5702-48c8-8bd5-e1758852ec79\"}],\"description\":\"\"},{\"intent\":\"WCS_FeeRefund\",\"examples\":[{\"text\":\"fa66ecc7-1528-45ea-9094-135b2f513fab\"}],\"description\":\"\"},{\"intent\":\"NLC_Classifier_ID\",\"examples\":[{\"text\":\"539e6dx331-nlc-736\"}],\"description\":\"NLC Create begin @Wed Mar 28 2018 21:30:08 GMT+0000 (UTC) In Progress..\"}],\"entities\":[],\"language\":\"en\",\"metadata\":{\"api_version\":{\"major_version\":\"v1\",\"minor_version\":\"2017-05-26\"}},\"description\":\"This WCS will only have workspace names\",\"dialog_nodes\":[],\"workspace_id\":\"b5bf7394-2b9d-4ec6-853b-5ad8fb787d16\",\"counterexamples\":[],\"learning_opt_out\":false}","x":460,"y":180,"wires":[]},{"id":"78d3cbd1.3087ec","type":"inject","z":"cb130c7a.1c52d8","name":"","topic":"","payload":"{\"name\":\"UCG-Setup-WCS\",\"intents\":[{\"intent\":\"WCS_OLB\",\"examples\":[{\"text\":\"9e53d515-48de-4a7b-9af3-27f74a4bf043\"}],\"description\":\"\"},{\"intent\":\"Default_WCS\",\"examples\":[{\"text\":\"ceb151b4-5702-48c8-8bd5-e1758852ec79\"}],\"description\":\"\"},{\"intent\":\"WCS_FeeRefund\",\"examples\":[{\"text\":\"fa66ecc7-1528-45ea-9094-135b2f513fab\"}],\"description\":\"\"},{\"intent\":\"NLC_Classifier_ID\",\"examples\":[{\"text\":\"539e6dx331-nlc-736\"}],\"description\":\"NLC Create begin @Wed Mar 28 2018 21:30:08 GMT+0000 (UTC) In Progress..\"}],\"entities\":[],\"language\":\"en\",\"metadata\":{\"api_version\":{\"major_version\":\"v1\",\"minor_version\":\"2017-05-26\"}},\"description\":\"This WCS will only have workspace names\",\"dialog_nodes\":[],\"workspace_id\":\"b5bf7394-2b9d-4ec6-853b-5ad8fb787d16\",\"counterexamples\":[],\"learning_opt_out\":false}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":240,"wires":[["ccc07652.0e8c5"]]},{"id":"84dbf42c.42bf7","type":"debug","z":"cb130c7a.1c52d8","name":"JSON to create Setup Workspace","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":580,"y":240,"wires":[]},{"id":"ccc07652.0e8c5","type":"json","z":"cb130c7a.1c52d8","name":"","property":"payload","action":"","pretty":false,"x":310,"y":240,"wires":[["84dbf42c.42bf7"]]},{"id":"fcbcf984.3c2778","type":"function","z":"65dbf2c8.fdf124","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'cc312dbc-a4cf-4bc0-acae-3a303585142e';\nmsg.wcs_setup.setup_wcs_tag = 'UCG_Router_Setup_WCS';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.router_wcs_id = \"\";\nmsg.wcs_setup.nls_start = Date();\n\nreturn msg; \n\n ","outputs":1,"noerr":0,"x":300,"y":300,"wires":[["91d6201c.2212c8"]]},{"id":"91d6201c.2212c8","type":"function","z":"65dbf2c8.fdf124","name":"Scan Setup Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      //node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":530,"y":300,"wires":[["6fb2f256.e20c4c","dbed6cca.ed7898"]]},{"id":"6558ee64.485fc8","type":"inject","z":"65dbf2c8.fdf124","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":300,"wires":[["fcbcf984.3c2778"]]},{"id":"6fb2f256.e20c4c","type":"debug","z":"65dbf2c8.fdf124","name":"MSG-Setup-Response/Input","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":820,"y":260,"wires":[]},{"id":"dbed6cca.ed7898","type":"function","z":"65dbf2c8.fdf124","name":"Prepare Data for Router WCS population","func":"//node.error(\"inside nlc\");\n//node.error(msg);\n \nvar i = 0;\nvar j_len = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    j_len = msg.payload.intents[i].examples.length;\n    if (j_len > 0) {\n        if (msg.payload.intents[i].intent === \"Router_WCS\") {\n            msg.wcs_setup.router_wcs_id = msg.payload.intents[i].examples[j_len-1].text;\n        }\n        else {\n             if (typeof msg.wcs_setup.wcs_set === 'undefined') {\n                 msg.wcs_setup.wcs_set = [{}];\n                 msg.wcs_setup.wcs_set[0] = {\n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                }\n             }\n             else {\n                msg.wcs_setup.wcs_set.push({     \n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                })\n            }\n            msg.wcs_setup.wcs_count = msg.wcs_setup.wcs_count + 1;\n        }\n    }\n}\nmsg.wcs_setup.continue_flag = \"Yes\";\nif (msg.wcs_setup.wcs_count === 0) {\n    node.error(\"Pl. check WCS Setup Workspace - No UCG_Router_Setup_WCS has been defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nif (msg.wcs_setup.router_wcs_id === \"\") {\n    node.error(\"Pl. check WCS Setup Workspace - Router_WCS has not been defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":300,"wires":[["5f36e4ab.e50e6c","bc55963.bc74868"]]},{"id":"5f36e4ab.e50e6c","type":"debug","z":"65dbf2c8.fdf124","name":"MSG-Setup Workspaces","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1130,"y":260,"wires":[]},{"id":"bc55963.bc74868","type":"switch","z":"65dbf2c8.fdf124","name":"Check if continue ?","property":"msg.wcs_setup.continue_flag","propertyType":"msg","rules":[{"t":"eq","v":"No","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":190,"y":400,"wires":[["3d1980f7.ce1278"],["5dbf9c43.5edd6c"]]},{"id":"3d1980f7.ce1278","type":"debug","z":"65dbf2c8.fdf124","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":370,"y":340,"wires":[]},{"id":"395b42c.2ba4bbe","type":"function","z":"65dbf2c8.fdf124","name":"Check current Count","func":"msg.wcs_setup.wcs_cur_wcs_id = \"\";\nif ( msg.wcs_setup.wcs_cur_count < msg.wcs_setup.wcs_count) { \n     msg.wcs_scan_flag = \"Yes\";\n     msg.wcs_setup.wcs_cur_wcs_id = msg.wcs_setup.wcs_set[msg.wcs_setup.wcs_cur_count].wcs_id;\n     msg.wcs_setup.wcs_cur_wcs_tag = msg.wcs_setup.wcs_set[msg.wcs_setup.wcs_cur_count].wcs_tag;\n} \nelse {\n    msg.wcs_scan_flag = \"No\";\n//    msg.wcs_setup.wcs_cur_wcs_id = \"\";\n //   msg.wcs_setup.wcs_cur_wcs_tag = \"\";\n}      \nreturn msg;","outputs":1,"noerr":0,"x":200,"y":480,"wires":[["42fb3708.2224e8"]]},{"id":"42fb3708.2224e8","type":"function","z":"65dbf2c8.fdf124","name":"Scan Child Workspace to get intents","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.wcs_cur_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n   export:true\n}\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":510,"y":480,"wires":[["b3ceb46e.d48ba"]]},{"id":"b3ceb46e.d48ba","type":"function","z":"65dbf2c8.fdf124","name":"Store Intents","func":"node.error(msg);\n/*\nfor (i=0; i<msg.payload.intents.length;i++) {\n    if (typeof msg.payload.intents[i].description !== 'undefined') {\n        msg.payload.intents[i].description = msg.wcs_setup.wcs_cur_wcs_tag + \"_\" + msg.payload.intents[i].description;\n    }         \n    else {\n       msg.payload.intents[i].description = msg.wcs_setup.wcs_cur_wcs_tag;\n    }\n}\n*/\nif (typeof msg.intents !== 'undefined') {\n    //** Merge Unique Intents / Examples **//\n    //node.error(msg);\n    var dup_intent = '';\n    var dup_example = '';\n    var dup_int_num = -1;\n    var dup_example_num = -1;\n    for (i=0;i<msg.payload.intents.length;i++){\n        dup_intent = 'No';\n        dup_int_num = -1;\n        for (j=0;j<msg.intents.length;j++){\n            if(msg.payload.intents[i].intent === msg.intents[j].intent) {\n               //node.error(\"Dup Intent i/j : \" + i + \"/\" + j);    \n              dup_intent = \"Yes\";    \n              dup_int_num =j;\n            }\n        }\n        if (dup_intent === \"Yes\") {\n           //node.error(\"NAK-1: i=[\"+i+\"],dup_int_num=[\"+dup_int_num+\"]\");\n           for (k=0;k<msg.payload.intents[i].examples.length;k++) {\n               dup_example = 'No';\n               dup_example_num = -1;\n               //node.error(\"NAK-2: i=[\"+i+\"],dup_int_num=[\"+dup_int_num+\"], k=[\"+k+\"] \" + msg.payload.intents[i].examples[k].text );\n               for (m=0;m<msg.intents[dup_int_num].examples.length;m++) {\n                   //node.error(\"NAK-2-2: \" +msg.intents[dup_int_num].examples[m].text);\n                   if (msg.payload.intents[i].examples[k].text === msg.intents[dup_int_num].examples[m].text) {\n                      dup_example = \"Yes\";\n                       dup_example_num = m; \n                    }\n                }\n                if (dup_example !== \"Yes\"){\n                   //node.error(\"nak-3\");\n                   //node.error(msg.payload.intents[i].examples[k]);\n                   msg.intents[dup_int_num].examples.push(msg.payload.intents[i].examples[k]);\n                }\n            }\n        }\n        else {\n            msg.intents.push(msg.payload.intents[i]);\n        }\n    }\n}\nelse {\n       msg.intents = msg.payload.intents;\n} \n\nmsg.wcs_setup.wcs_cur_count = msg.wcs_setup.wcs_cur_count + 1;\nmsg.wcs_setup.loop_back = \"Yes\";\n\nif (msg.wcs_setup.wcs_cur_count === msg.wcs_setup.wcs_count) {\n    msg.wcs_setup.loop_back = \"No\";\n}\n//if (msg.wcs_setup.wcs_cur_count === 1) {\n//    msg.wcs_setup.loop_back = \"No\";\n//}\n\n//if (msg.wcs_setup.loop_back === \"Yes\") {\n //   msg.wcs_save_payload = msg.payload;\n//}\nnode.error(\"WCS Workspaces Count - Current/Total=> \" + msg.wcs_setup.wcs_cur_count + \"/\" + msg.wcs_setup.wcs_count); \nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":480,"wires":[["34e52690.684bd2","bae52cf6.1ddd38"]]},{"id":"34e52690.684bd2","type":"debug","z":"65dbf2c8.fdf124","name":"Display Intents","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1080,"y":480,"wires":[]},{"id":"bae52cf6.1ddd38","type":"switch","z":"65dbf2c8.fdf124","name":"","property":"wcs_setup.loop_back","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":154,"y":561,"wires":[["395b42c.2ba4bbe"],["61f66fae.260ca"]]},{"id":"92ddfcf6.81b64","type":"comment","z":"65dbf2c8.fdf124","name":"This flow populates Router Workspace using intents, entiries from other workspaces which are defined in 'Router_Setup_Workspace'","info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"\n   c) WorkspaceTag - must not include include blanks\n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTag\n\nThe flow assumes, all Workspaces are listed under Setup Workspace and \nthose will be used, to create training data set. There is no limit on \nnumber of workspaces which can be included under Setup Workspace, \nas long as above rules are followed.\n   \n    In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS\"; if this \n    needs to have different name, then pl. remember to update name in\n    'get-ready' node.\n    \n\n2) The flow needs to NLC classifer ID, which can also be defined in\n   setup workspace with special intent as 'NLC_Classifier_ID' and example \n   will have NLC traning set value. The flow will update NLC Classifer ID in \n   example, once generated. \n   \n   The flow will delete existing NLC Classifer, before running\n   new training set.  \n\n3) The flow also assumes, all workspaces have same set of\n   credentials and are defined in 'get-ready' node. The flow, can be \n   modified to pickup credentials from SOE Environment file.\n   \n","x":700,"y":20,"wires":[]},{"id":"2693c9a4.ca7a1e","type":"comment","z":"65dbf2c8.fdf124","name":"JSON for settingup \"setup workspace\"","info":"{\"name\":\"UCG-Setup-WCS\",\"intents\":[{\"intent\":\"WCS_OLB\",\"examples\":[{\"text\":\"9e53d515-48de-4a7b-9af3-27f74a4bf043\"}],\"description\":\"\"},{\"intent\":\"Default_WCS\",\"examples\":[{\"text\":\"ceb151b4-5702-48c8-8bd5-e1758852ec79\"}],\"description\":\"\"},{\"intent\":\"WCS_FeeRefund\",\"examples\":[{\"text\":\"fa66ecc7-1528-45ea-9094-135b2f513fab\"}],\"description\":\"\"},{\"intent\":\"NLC_Classifier_ID\",\"examples\":[{\"text\":\"539e6dx331-nlc-736\"}],\"description\":\"NLC Create begin @Wed Mar 28 2018 21:30:08 GMT+0000 (UTC) In Progress..\"}],\"entities\":[],\"language\":\"en\",\"metadata\":{\"api_version\":{\"major_version\":\"v1\",\"minor_version\":\"2017-05-26\"}},\"description\":\"This WCS will only have workspace names\",\"dialog_nodes\":[],\"workspace_id\":\"b5bf7394-2b9d-4ec6-853b-5ad8fb787d16\",\"counterexamples\":[],\"learning_opt_out\":false}","x":520,"y":120,"wires":[]},{"id":"788f338.d6a254c","type":"inject","z":"65dbf2c8.fdf124","name":"","topic":"","payload":"{\"name\":\"UCG_Router_Setup_WCS\",\"intents\":[{\"intent\":\"WCS_OLB\",\"examples\":[{\"text\":\"9e53d515-48de-4a7b-9af3-27f74a4bf043\"}],\"description\":null},{\"intent\":\"WCS_Misc\",\"examples\":[{\"text\":\"ceb151b4-5702-48c8-8bd5-e1758852ec79\"}],\"description\":null},{\"intent\":\"WCS_FeeRefund\",\"examples\":[{\"text\":\"fa66ecc7-1528-45ea-9094-135b2f513fab\"}],\"description\":null},{\"intent\":\"Router_WCS\",\"examples\":[{\"text\":\"7600044c-1659-487d-bbbf-5bc05122bfe1\"}],\"description\":\"\"}],\"entities\":[],\"language\":\"en\",\"metadata\":{\"api_version\":{\"major_version\":\"v1\",\"minor_version\":\"2017-05-26\"}},\"description\":\"This is a setup workspace for defining Router workspace and child workspaces\",\"dialog_nodes\":[],\"workspace_id\":\"cc312dbc-a4cf-4bc0-acae-3a303585142e\",\"counterexamples\":[],\"learning_opt_out\":false}","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":180,"wires":[["a6453c1d.3de0c"]]},{"id":"9bc0b4e.66df2c8","type":"debug","z":"65dbf2c8.fdf124","name":"JSON to create Setup Workspace","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":640,"y":180,"wires":[]},{"id":"a6453c1d.3de0c","type":"json","z":"65dbf2c8.fdf124","name":"","property":"payload","action":"","pretty":false,"x":370,"y":180,"wires":[["9bc0b4e.66df2c8"]]},{"id":"5dbf9c43.5edd6c","type":"function","z":"65dbf2c8.fdf124","name":"Load Dialogs from Router Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.router_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  page_limit : 10000,\n  include_count : true,\n  include_audit : true\n}\n\nconversation.listDialogNodes(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\n//return null;","outputs":1,"noerr":0,"x":510,"y":400,"wires":[["1092ed6c.f24dab"]]},{"id":"1092ed6c.f24dab","type":"function","z":"65dbf2c8.fdf124","name":"Save Router Workspace Data","func":"msg.dialogs = msg.payload.dialog_nodes;\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":400,"wires":[["395b42c.2ba4bbe"]]},{"id":"61f66fae.260ca","type":"function","z":"65dbf2c8.fdf124","name":"Create Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.router_wcs_id\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n//node.error(JSON.stringify(msg.intents));\n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  name: \"UCG_Current_Router_Workspace\",\n  description : \"UCG Router Workspace, which will be used in the SOE flow.\",\n  intents: msg.intents,     \n  dialog_nodes: msg.dialogs\n}\n\nconversation.createWorkspace(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":450,"y":567,"wires":[["aabc3d29.b38a28"]]},{"id":"d836e40.24db3a","type":"function","z":"65dbf2c8.fdf124","name":"Update UCG_Router_Setup_WCS for new Router Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  intent: 'Router_WCS',\n  new_examples: [\n    {\n      text: msg.payload.workspace_id\n    }\n  ],\n   new_description: 'Created new WCS Router workspace on :' + Date()\n};\n\nconversation.updateIntent(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":360,"y":640,"wires":[["aa26c886.243c9"]]},{"id":"aabc3d29.b38a28","type":"function","z":"65dbf2c8.fdf124","name":"Capture Result","func":"msg.new_router_wcs_id = msg.payload.workspace_id;\nreturn msg;","outputs":1,"noerr":0,"x":682,"y":566,"wires":[["d836e40.24db3a"]]},{"id":"a1817ad1.f386","type":"debug","z":"65dbf2c8.fdf124","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":770,"y":720,"wires":[]},{"id":"408dc96a.0ff54","type":"function","z":"65dbf2c8.fdf124","name":"Check Return value","func":"\nnode.error(\"Deleted previous router workspace and created New Workspace ID : \" + msg.new_router_wcs_id);\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":720,"wires":[["a1817ad1.f386"]]},{"id":"aa26c886.243c9","type":"function","z":"65dbf2c8.fdf124","name":"Delete previous Router Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.router_wcs_id\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n//node.error(JSON.stringify(msg.intents));\n\nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id : workspace_id2\n}\n\nconversation.deleteWorkspace(params, function(err, response) {\n  if (err) {\n    node.error(err);\n  } else {\n    msg.payload = response;\n    node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":280,"y":720,"wires":[["408dc96a.0ff54"]]},{"id":"4f6fc1aa.b94a48","type":"debug","z":"35062497.981924","name":"Rcvd from Chat","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":160,"y":660,"wires":[]},{"id":"866bff89.5c6968","type":"debug","z":"35062497.981924","name":"Input  Message to NLC","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":620,"y":440,"wires":[]},{"id":"ad6c438.06a70c","type":"http in","z":"35062497.981924","name":"Mobile HTTP in","url":"/smooch-router","method":"post","upload":false,"swaggerDoc":"","x":100,"y":580,"wires":[["4f6fc1aa.b94a48","d14f94bd.de80c","d44bfadc.4421d8"]]},{"id":"576eb557.db4b54","type":"watson-conversation-v1","z":"35062497.981924","name":"Base Conv","workspaceid":"","multiuser":true,"context":true,"empty-payload":false,"default-endpoint":true,"service-endpoint":"","x":1050,"y":580,"wires":[["b6ce05ce.cdbed","ebb091a5.85762","ea1ab6fc.7a7c3"]]},{"id":"76eacda7.a05a2c","type":"function","z":"35062497.981924","name":"Check-for-WCS-Change","func":"msg.payload = msg.save_payload;\n\n//*** Restore Context from previous dialog **//\n\nif (typeof msg.params  == 'undefined') {\n            msg.params  = {};\n}\nif (typeof msg.params.context == 'undefined') {\n            msg.params.context = {};\n}\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    msg.params.context = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(msg);\n}\n\nif (typeof msg.wcs_setup.cur_wcs_id == 'undefined' ) {\n   msg.wcs_setup.cur_wcs_id =  msg.wcs_setup.router_wcs_id;\n   msg.wcs_setup.cur_wcs_tag =  msg.wcs_setup.router_wcs_tag ;\n}\n\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":560,"wires":[["866bff89.5c6968","30765c4.3982724"]]},{"id":"82806c96.b2b9c","type":"function","z":"35062497.981924","name":"Response Msg","func":"node.error(\"Inside Response MSG\");\nnode.error(msg);\n\n//if (typeof msg.payload.output.text[0] == 'undefined') {\n//    msg.payload.output.text[0] = \"Sorry I am not trained on this topic yet; try asking some other question\";\n//}\n\n\n\nmsg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'     \n};\n\n//*** store context to global variable ***//\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nvar user_glob_wcs_setup = \"Save_wcs_setup_\" + msg.save_payload .appUser._id;\nvar user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload .appUser._id;\nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nglobal.set('\"'+user_glob_Context+'\"',msg.payload.context);\nglobal.set('\"'+user_glob_wcs_setup+'\"',msg.wcs_setup);\nglobal.set('\"'+user_glob_Context_time+'\"',cur_time);\n \n\nmsg.Skip_Output = \"No\";\nif (typeof msg.payload.context.Skip_Output !== 'undefined') {\n    msg.Skip_Output = msg.payload.context.Skip_Output;\n}\nif (msg.payload.context.skip_loop_break === \"Yes\" ) {\n    node.error(\"Breaking skip loop\");\n    msg.Skip_Output = \"No\";\n    //msg.payload.output.text = \"Sorry I am not trained on this topic\";\n}\nvar Watson_msg = JSON.stringify(msg.payload.output.text);\nvar Watson_context = JSON.stringify(msg.payload.context);\nvar Watson_contextOBJ = msg.payload.context;\n\nvar Myresponse = Watson_msg.substring(2,Watson_msg.length-2);\n\n// Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\nMyresponse = Myresponse.replace(/\\\\/g, \"\");\n//Dennis - Remove XML SSML tags from chat systems\nMyresponse = Myresponse.replace(/<[^>]+>/g, \"\");\n\nvar Newmsg = \"\";\nvar response = {};\nvar component = \"\";\n\n//if (typeof msg.payload.output.text === 'undefined') {\n//    msg.payload.output.text = \"Nitin K\";\n//}\n//Remove old maps\nif (Myresponse.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Myresponse.lastIndexOf(\"InsMap\");\n     Myresponse = Myresponse.substring(0,findindex);\n}\n//Found an array of outputs\nvar texts = msg.payload.output.text\n//var texts = Myresponse.split(\"\\\",\\\"\");\nfor (i = 0; i < texts.length; i++) {\n Newmsg = texts[i]; \n //node.error(\"Newmsg :[\"+ i+\"]\"+Newmsg);\n var component = \"\";\n var mapStr = \"\";\n var actions = {};\n var actionsArr = [];\n var actionsRArr = [];\n var buttonMTArr = [\"Here's your street view map\", \"Here's your satellite view map\"];\n //simple buttons\n if (Newmsg.lastIndexOf(\"[\") >= 0 ) {\n     component = \"button\";\n     findindex = Newmsg.lastIndexOf(\"[\");\n     findLastindex = Newmsg.lastIndexOf(\"]\");\n     tempStr = Newmsg;\n     Newmsg = Newmsg.substring(0,findindex); // Message without buttons\n     var buttonArr = tempStr.substring(findindex+1, findLastindex).split(\",\");\n    \n     for (a = 0; a < buttonArr.length; a++) { \n        actionsArr.push({\"type\": \"reply\",\"text\": buttonArr[a],\"payload\": buttonArr[a]});\n     }\n     actions = {\"actions\" : actionsArr};\n }\n\n //json map\n //var mapjsonStr = Watson_context.match(/\\\"map.*Yes\\\"/);\n if (typeof Watson_contextOBJ.map != 'undefined') {\n     mapjsonObj = Watson_contextOBJ.map;\n     if (typeof mapjsonObj.values != \"undefined\") {\n        //node.log(\"mapjson: \" + mapjsonStr);\n        //if (mapjsonStr  !== null){\n        component = \"map\";\n        for (var c in mapjsonObj.values) {\n            mapStr = mapjsonObj.values[c] + \"&size=500x300\";\n            actionsArr.push({\"text\": buttonMTArr[c] +\" \",\"type\":\"link\",\"uri\": mapStr});\n        }\n   }\n }\n\n //json button - Note for WCS - can't have a mixed array of Link and Reply. Smooch-limitation\n // Can implement postback buttons, but must handle postback api call. Stubbed at the moment.\n //var buttonjsonStr = Watson_context.match(/\\\"button.*Yes\\\"/);\n var found_link = 0;\n //node.log(\"buttonjson: \" + buttonjsonStr);\n if (typeof Watson_contextOBJ.button != 'undefined') {\n    buttonjsonObj = Watson_contextOBJ.button;\n    if (typeof buttonjsonObj.values != \"undefined\") {\n       for (var c in buttonjsonObj.values) {\n           buttonStr = buttonjsonObj.values[c];\n           if (buttonStr.lastIndexOf(\"|\") >= 0 ) {\n              found_link = 1;\n              buttonItems = buttonStr.split(\"|\");\n              button_title = buttonItems[0];\n              button_url = buttonItems[1];\n              actionsArr.push({\"type\": \"link\",\"text\": button_title,\"uri\": button_url}); \n            }\n            else {\n              button_title = buttonStr;  \n              actionsRArr.push({\"type\": \"reply\",\"text\": button_title,\"payload\": button_title}); \n            }\n        }  \n        if (found_link > 0) {\n           component = \"buttonLink\"; \n        }else {\n           component = \"buttonReply\";   \n        }\n    }\n}\n\n //old maps\n if (Newmsg.lastIndexOf(\"InsMap\") >= 0 ) {\n     findindex = Newmsg.lastIndexOf(\"InsMap\");\n     Newmsg = Newmsg.substring(0,findindex);\n } \n\n // Dennis added because SSML tag was escaping the \" with \\\" and the replace command fixes it!!!!\n Newmsg = Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n Newmsg = Newmsg.replace(/<[^>]+>/g, \"\");\n\n// node.log(\"User ** \" + msg.user + \" Says ** \" +  msg.payload.input.text +  \" ** Response ** \" + Newmsg)\n\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\n\nvar nk_texts = msg.payload.output.text\n\n//if (nk_texts == \"\") {\n//    nk_texts = \"Sorry I am not trained on that topic yet\";\n//}\n\n \nfor (i = 0; i < nk_texts.length; i++) {\n nk_Newmsg = nk_texts[i]; \n //node.error(\"nk_Newmsg :[\"+ i+\"]\"+nk_Newmsg);\n nk_Newmsg = nk_Newmsg.replace(/\\\\/g, \"\");\n //Dennis - Remove XML SSML tags from chat systems\n nk_Newmsg = nk_Newmsg.replace(/<[^>]+>/g, \"\");\n switch(component) {\n    case 'buttonReply':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n        };\n        break;\n    case 'buttonLink':\n     response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsArr\n        };\n        break;\n    case 'map':\n    response = {\n        role : \"appMaker\",\n        type : \"image\",\n        text : Newmsg,\n        email: \"dennisnoto@gmail.com\",\n        mediaUrl: mapStr,\n        mediaType: \"image/jpeg\",\n        actions : actionsArr\n        };\n        break;\n    default:\n    response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : nk_Newmsg,\n        email: \"watson40985@gmail.com\",\n        actions : actionsArr};\n }\n\n if (i != texts.length -1) {\n   response.actions = [];  \n }     \n\n//node.error(\"Response-2\");\n  msg.payload = response;\n//node.error(msg);  \n  node.send(msg);\n  \n if (actionsRArr.length > 0 &&  component == \"buttonLink\"){\n  response = {\n        role : \"appMaker\",\n        type : \"text\",\n        text : \"\",\n        email: \"dennisnoto@gmail.com\",\n        actions : actionsRArr\n      \n  };\n \n  if (i == texts.length -1) {\n    msg.payload = response;\n    node.send(msg);  \n  }\n }\n \n }\n}\n//node.error(\"Before sending response\");\n//node.error(msg);\nreturn [null,msg];","outputs":2,"noerr":0,"x":1520,"y":620,"wires":[["c2f5c453.6c6d2","e57e8349.4461d8"],[]]},{"id":"38a474eb.bb895c","type":"debug","z":"35062497.981924","name":"Response msg payload smooch","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1710,"y":900,"wires":[]},{"id":"68c28dda.2549f4","type":"http request","z":"35062497.981924","name":"","method":"POST","ret":"txt","url":"","tls":"","x":707.0000305175781,"y":1261.0000305175781,"wires":[["c125a732.bb3e1"]]},{"id":"b8e0993c.3fba18","type":"function","z":"35062497.981924","name":"Send post message","func":"\nmsg.headers = {\n    'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g'\n     };\n\nmsg.url = \"https://api.smooch.io/v1/appusers/\" + \"02aaa89716d5b27e3a37aab3\" + \"/messages\";\n\nvar response = {\n    role : \"appMaker\",\n    type : \"text\",\n    text : \"hey what's up!!!\",\n    email: \"watson40985@gmail.com\",\n    //email: \"dennisnoto@gmail.com\",\n    actions : []\n};\n\nmsg.payload = response;\n\nreturn msg;","outputs":1,"noerr":0,"x":472.00001525878906,"y":1261.0000114440918,"wires":[["68c28dda.2549f4"]]},{"id":"c125a732.bb3e1","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"payload","x":910,"y":1260,"wires":[]},{"id":"d03d9685.6f5388","type":"inject","z":"35062497.981924","name":"","topic":"go","payload":"","payloadType":"str","repeat":"","crontab":"","once":false,"x":234.00001525878906,"y":1266.0000114440918,"wires":[["b8e0993c.3fba18"]]},{"id":"d14f94bd.de80c","type":"http response","z":"35062497.981924","name":"HTTP-Postback","statusCode":"","headers":{},"x":416.7142791748047,"y":663.000002861023,"wires":[]},{"id":"c2f5c453.6c6d2","type":"debug","z":"35062497.981924","name":"smooch out of response msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1800,"y":560,"wires":[]},{"id":"b6ce05ce.cdbed","type":"debug","z":"35062497.981924","name":"smooch out of convo","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1440,"y":460,"wires":[]},{"id":"5c606f93.e4acc8","type":"http in","z":"35062497.981924","name":"Postbacks","url":"/smooch-postback","method":"post","swaggerDoc":"","x":210.7143096923828,"y":719.1250257492065,"wires":[["abfb69df.26e8","d14f94bd.de80c","cd3e3451.d8f4"]]},{"id":"cd3e3451.d8f4","type":"function","z":"35062497.981924","name":"actionPayload","func":"msg.headers = {\n      'authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6ImFwcF81OTZmYmZmNjZjOGZjYjQ1MDBhYmMwZjUifQ.eyJzY29wZSI6ImFwcCJ9.X6jgajAzjrVv2dmVARDV-w9iy2mZMC_AW1XuckScD-g',\n      'content-type': 'application/json'\n     };\n\nmsg.user = msg.payload.appUser.userId;\n//msg.url = \"https://api.smooch.io/v1/appusers/\" + msg.user + \"/messages\";\nmsg.url = \"https://api.smooch.io/v1/apps/\"+msg.save_payload.app._id+\"/appusers/\"+msg.save_payload.appUser._id+\"/messages\"; \n\nmsg.actionPayload = msg.payload.postbacks[0].action.payload;\n\nresponse = {\n        role : \"appUser\",\n        type : \"text\",\n        text : msg.actionPayload\n};\n\nmsg.payload = response;\nreturn msg;","outputs":1,"noerr":0,"x":264.9834976196289,"y":811.9999990463257,"wires":[[]]},{"id":"abfb69df.26e8","type":"debug","z":"35062497.981924","name":"PostBack Messsage","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":430,"y":739,"wires":[]},{"id":"15d9c54e.94e9fb","type":"http in","z":"35062497.981924","name":"","url":"/getchatdata","method":"get","swaggerDoc":"","x":292,"y":1363,"wires":[["58900df8.a36d24"]]},{"id":"58900df8.a36d24","type":"http response","z":"35062497.981924","name":"","x":732,"y":1363,"wires":[]},{"id":"6a89b6b9.84a9","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":732,"y":1423,"wires":[]},{"id":"4f76e52d.4d4c24","type":"inject","z":"35062497.981924","name":"","topic":"02b79c84-2504-4e96-a48e-eeac02f5e368","payload":"8163b5e5-0b90-4270-9c2a-c660eae3c2e9","payloadType":"str","repeat":"","crontab":"","once":false,"x":292,"y":1423,"wires":[[]]},{"id":"9fd0cd42.0cd638","type":"natural-language-understanding","z":"35062497.981924","name":"alchemy_test","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":true,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":527,"y":1484,"wires":[["a7bf984f.5c4908"]]},{"id":"e66b68f7.f4035","type":"inject","z":"35062497.981924","name":"","topic":"","payload":"Boss this is Nitin","payloadType":"str","repeat":"","crontab":"","once":false,"x":278,"y":1482.75,"wires":[["9fd0cd42.0cd638","3a93a915.13c4b6"]]},{"id":"a7bf984f.5c4908","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":852,"y":1483,"wires":[]},{"id":"1b701897.451cbf","type":"natural-language-understanding","z":"35062497.981924","name":"extract concepts","categories":true,"concepts":true,"maxconcepts":"8","doc-emotion":false,"doc-emotion-target":"","doc-sentiment":false,"doc-sentiment-target":"","entity":false,"entity-emotion":false,"entity-sentiment":false,"maxentities":"50","keyword":true,"keyword-emotion":false,"keyword-sentiment":false,"maxkeywords":"50","metadata":false,"relation":false,"semantic":false,"semantic-entities":false,"semantic-keywords":false,"maxsemantics":"50","x":1550,"y":1240,"wires":[["b03f05d7.786778","5d76e042.b4288"]]},{"id":"3a93a915.13c4b6","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":488,"y":1540,"wires":[]},{"id":"c28e8824.d92e38","type":"switch","z":"35062497.981924","name":"ALC or Reg","property":"m_node_path","propertyType":"global","rules":[{"t":"eq","v":"Alc","vt":"str"},{"t":"else"}],"checkall":"true","outputs":2,"x":1101,"y":1246.25,"wires":[["2f403c0.1fcedc4","f508c941.c42ce8"],["367ab7fe.825b18"]]},{"id":"2f403c0.1fcedc4","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":1249,"y":1193,"wires":[]},{"id":"ebb091a5.85762","type":"debug","z":"35062497.981924","name":"NK-SWTCH","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1410,"y":500,"wires":[]},{"id":"b03f05d7.786778","type":"debug","z":"35062497.981924","name":"post_WNLU_message","active":true,"console":"false","complete":"true","x":1677,"y":1110,"wires":[]},{"id":"f508c941.c42ce8","type":"function","z":"35062497.981924","name":"Transform payload","func":"var m_name = msg.payload;\nmsg.payload = m_name;\nmsg.payload.topic = \"\";\nreturn msg;","outputs":1,"noerr":0,"x":1298,"y":1240.25,"wires":[["b6df79f.e582908","1b701897.451cbf"]]},{"id":"b6df79f.e582908","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":1470,"y":1169,"wires":[]},{"id":"367ab7fe.825b18","type":"debug","z":"35062497.981924","name":"NAKNAK","active":true,"console":"false","complete":"true","x":1161,"y":1329,"wires":[]},{"id":"5d76e042.b4288","type":"function","z":"35062497.981924","name":"push message","func":"//var m_entity_type = msg.features.entities.type[0];\n//var m_entity_name = msg.features.entities.text[0];\nvar acl_payload = global.get(\"prev_msg\");\nvar m_user_name = \" \";\nvar m_cnt = 0;\n/**\n\n\nif (\"text\" in msg.features.keywords[0]) {\n  m_user_name = msg.features.keywords[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"2nd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"2nd-else compare\";\n}\n\n\nif (m_cnt === 0 ) {\nif (\"text\" in msg.features.entities[0]) {\n  m_user_name = msg.features.entities[0].text;  \n         m_cnt = 1;\n          msg.additional_context.joyName =\"3rd compare\";\n}\nelse {\n     msg.additional_context.joyName =\"3rd-else compare\";\n}\n}\nelse {\n     msg.additional_context.joyName =\"4th-else compare\";\n}\n**/\n\nif (typeof(msg.features.keywords) !== \"undefined\") { \n    node.error(\"I am here-1\");\nif (typeof(msg.features.keywords[0]) !== \"undefined\") { \n      node.error(\"I am here-2\");\n    msg.additional_context.joyName =\"1st compare\";\n    m_user_name = msg.features.keywords[0].text; \n   node.error(\"I am here-3\", msg.features.keywords[0].text);\n    m_cnt = 1;\n}\n}\n\nif (m_cnt === 0) {\n    if (typeof(msg.features.entities) !== \"undefined\") {\n            node.error(\"I am here-4\");\nif (typeof(msg.features.entities[0].text) !== \"undefined\") { \n                node.error(\"I am here-41\");\n         m_user_name = msg.features.entities[0].text; \n         m_cnt = 2;\n          msg.additional_context.joyName =\"4th compare\";\n                        node.error(\"I am here-42\", msg.features.entities[0].text);\n}\n}\n}\n\nif (m_cnt === 0) {\n    m_user_name = \"there\";\n}\n\nmsg.payload = acl_payload;\nmsg.payload.text = \"Hello \" + m_user_name + \"..!! What can I do for you today\";\n//node.send(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1800,"y":1240,"wires":[["fc57c729.49b41"]]},{"id":"fc57c729.49b41","type":"debug","z":"35062497.981924","name":"","active":true,"console":"false","complete":"true","x":1723,"y":1161,"wires":[]},{"id":"7cbf83f8.19c284","type":"http request","z":"35062497.981924","name":"","method":"POST","ret":"txt","url":"","tls":"","x":1750,"y":780,"wires":[["38a474eb.bb895c"]]},{"id":"e57e8349.4461d8","type":"delay","z":"35062497.981924","name":"Send one message at a time","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1760,"y":680,"wires":[["7cbf83f8.19c284"]]},{"id":"4156bc33.8c29bc","type":"inject","z":"35062497.981924","name":"@start","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"","x":233,"y":109,"wires":[["5aec5aa5.19ea1c"]]},{"id":"5aec5aa5.19ea1c","type":"function","z":"35062497.981924","name":"clear global_var","func":"var m1 = undefined;\nnode.error(m1);\nglobal.set(\"wcs_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"global_Check_context\",m1);\nglobal.set(\"wcs_tag_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"wcs_id_02aaa89716d5b27e3a37aab3\",m1);\nglobal.set(\"Check_NLC_02aaa89716d5b27e3a37aab3\", m1);\nglobal.set(\"Save_Context_02aaa89716d5b27e3a37aab3\",m1);\n\nglobal.set(\"wcs_tag_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"wcs_id_846ebb6b596dbe429b3e1c87\",m1);\nglobal.set(\"Check_NLC_846ebb6b596dbe429b3e1c87\", m1)\nglobal.set(\"Save_Context_846ebb6b596dbe429b3e1c87\",m1);\n\nglobal.set(\"wcs_tag_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"wcs_id_5ab2aac0df704a0022810445\",m1);\nglobal.set(\"Check_NLC_5ab2aac0df704a0022810445\", m1)\nglobal.set(\"Save_Context_5ab2aac0df704a0022810445\",m1);\n\nglobal.set(\"wcs_tag_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"wcs_id_5ab2a36c8716ad0023ae4beb\",m1);\nglobal.set(\"Check_NLC_5ab2a36c8716ad0023ae4beb\", m1)\nglobal.set(\"Save_Context_5ab2a36c8716ad0023ae4beb\",m1);\n\nglobal.set(\"wcs_tag_43f74556a555baef5ef95b28\",m1);\nglobal.set(\"wcs_id_43f74556a555baef5ef95b28\",m1);\nglobal.set(\"Check_NLC_43f74556a555baef5ef95b28\", m1)\nglobal.set(\"Save_Context_43f74556a555baef5ef95b28\",m1);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":483,"y":109,"wires":[[]]},{"id":"3484b2e9.73a07e","type":"switch","z":"35062497.981924","name":"","property":"payload.context.Skip_Output","propertyType":"msg","rules":[{"t":"neq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1250,"y":640,"wires":[["82806c96.b2b9c"],["771a509b.c95718"]]},{"id":"6911f084.e82a68","type":"function","z":"35062497.981924","name":"Check","func":"node.error(\"Inside Check Node - Response from WCS\");\n//node.error(msg);\nmsg.tmp_Switch_Workspace = \"No\";\nif (typeof msg.payload.context.Switch_Workspace !== 'undefined') {\n    //node.error(\"Check-1\");\n    if (msg.payload.context.Switch_Workspace.length > 0 ) {\n        msg.tmp_Switch_Workspace = \"Yes\";\n         //node.error(\"Check-2\");\n    }\n}\nif (msg.tmp_Switch_Workspace === \"Yes\") {\n    if (msg.curr_wcs_num === msg.payload.context.Switch_Workspace) {\n        msg.tmp_Switch_Workspace = \"No\";\n    }\n    else {\n       var user_glob_var = \"wcs_\" + msg.save_payload.appUser._id ;\n       var m_get_wcs_id = global.get('\"'+user_glob_var+'\"');\n       if (msg.payload.context.Switch_Workspace !== \"\") {\n           global.set('\"'+user_glob_var+'\"',msg.payload.context.Switch_Workspace);\n           global.set(\"global_Check_context\", \"Yes\");\n           global.set(\"global_Root\", msg.payload.context.Root);\n           global.set(\"global_Child\",msg.payload.context.Child);\n           node.error(\"Workspace Swtiched initiated\");\n       } \n        \n    }\n}\nnode.error(\"Check - Switch Workspace ? \" + msg.tmp_Switch_Workspace);\n\nreturn msg;","outputs":1,"noerr":0,"x":1370,"y":360,"wires":[[]]},{"id":"93a92bba.02a36","type":"function","z":"35062497.981924","name":"Restore MSG Payload","func":"msg.match_found = \"No\";\n\nif (msg.payload.context.Switch_Workspace !== msg.wcs_setup.curr_wcs_tag) {\n   if (msg.payload.context.Switch_Workspace === msg.wcs_setup.router_wcs_tag) {\n       msg.wcs_setup.cur_wcs_id = msg.wcs_setup.router_wcs_id;\n       msg.wcs_setup,cur_wcs_tag = msg.wcs_setup.router_wcs_tag;\n       msg.match_found = \"Yes\";\n   } \n   else {\n       for (i=0;i<msg.wcs_setup.wcs_set.length;i++){\n           node.error(\"NAK - \" + msg.wcs_setup.wcs_set[i].wcs_tag + \"/\"+ msg.payload.context.Switch_Workspace );\n           if (msg.wcs_setup.wcs_set[i].wcs_tag === msg.payload.context.Switch_Workspace) {\n               msg.wcs_setup.cur_wcs_id = msg.wcs_setup.wcs_set[i].wcs_id;\n               msg.wcs_setup.cur_wcs_tag = msg.wcs_setup.wcs_set[i].wcs_tag;\n               msg.match_found = \"Yes\";\n           }\n       }\n   }\n}\nif (msg.match_found === \"No\") {\n    node.error(\"Requested Workspace Not found : \");\n} else {\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nglobal.set('\"'+user_glob_Context+'\"',msg.payload.context);\nmsg.payload = msg.save_payload;\nnode.error(\"Switched Workspace to \" + msg.wcs_setup.cur_wcs_id);\n}\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":640,"wires":[["771a509b.c95718"]]},{"id":"7abc725c.2ead34","type":"debug","z":"35062497.981924","name":"NLC-Output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1050,"y":380,"wires":[]},{"id":"30765c4.3982724","type":"function","z":"35062497.981924","name":"Set Params-WCS","func":"node.error(\"Nak-Inside setparms wcs\");\nnode.error(msg);\nmsg.save_payload = msg.payload;\n\nmsg.fromUrl = msg.payload.appUser.devices[0].info.currentUrl;\nvar fname = msg.req.query.fname;\n\n\nif (typeof(msg.actionPayload) !== \"undefined\"){\n   input = msg.actionPayload;  \n   user = msg.user;\n}else {\n   input = msg.payload.messages[0].text; \n   if (typeof msg.payload.appUser.userId !== \"undefined\") {\n     \n     user = msg.payload.appUser.userId;\n       \n   }\n   else { \n     user = msg.payload.appUser._id;  \n   }\n}\n\nvar test  = JSON.stringify(msg.payload);\n\n//Zero out map Json \nvar map = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\n\nmsg.app = \"RegionsAssist\";\n\nvar additional_context = {\n    fname: fname,\n    map : map,\n    button: button \n    \n};\n\nif (input.lastIndexOf('/') >= 0 ) {\n     var myindex = input.lastIndexOf('/')\n     node.log(\"index at: \" + myindex)\n     var dateString = input\n     node.log(\"dateString : \" + dateString)\n     \n     var d = new Date(dateString)\n     node.log(\"d : \" + d)\n     var now = new Date()\n     node.log(\"today: \" + now)\n     var years = now.getFullYear() - d.getFullYear()\n     node.log(\"years: \" + years)\n     \n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     node.log(\"days: \" + days)\n     var age = years + days /365\n    \n     additional_context.age = Math.round(age *100)/100\n     node.log(\"age: \"+ context.age)\n \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"12\")\n     now.setDate(\"31\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageEOY = years + days /365\n     additional_context.ageEOY = Math.round(ageEOY * 100)/100\n     node.log(\"ageEOY: \"+ context.ageEOY)\n     \n     var d = new Date(dateString)\n     var now = new Date()\n     now.setMonth(\"01\")\n     now.setDate(\"01\")\n     var years = now.getFullYear() - d.getFullYear()\n     d.setFullYear(d.getFullYear() + years)\n     var days = (now.getTime() - d.getTime()) / (3600 * 24 * 1000.00)\n     var ageBOY = years + days /365\n     additional_context.ageBOY = Math.round(ageBOY * 100)/100\n     node.log(\"ageBOY: \"+ context.ageBOY)\n}\nmsg.payload = input;\nmsg.params.workspace_id = msg.wcs_setup.cur_wcs_id;\nmsg.params.username = msg.wcs_setup.wcs_user       \nmsg.params.password = msg.wcs_setup.wcs_password;  \nmsg.user = user;\nmsg.additional_context = additional_context;\n\n \ndelete msg.params.context.Switch_Workspace;\ndelete msg.params.context.Skip_Output;\n\nnode.error(\"msg object - input using \" + msg.wcs_setup.cur_wcs_tag);\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":580,"wires":[["576eb557.db4b54"]]},{"id":"523c9f3d.86a328","type":"switch","z":"35062497.981924","name":"","property":"Check_NLC","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":500,"wires":[["bdef9ba7.277388"],["30765c4.3982724"]]},{"id":"ec96076d.d0d158","type":"function","z":"35062497.981924","name":"Get WCS","func":"var wcs_1_tag = \"Regions_NK_Test_1_Greeter\";\nvar wcs_1_id  = \"ceb151b4-5702-48c8-8bd5-e1758852ec79\"\nvar wcs_2_tag = \"Regions-NK-Test-2-OLB\"\nvar wcs_2_id  = \"9e53d515-48de-4a7b-9af3-27f74a4bf043\"\nvar wcs_3_tag = \"Regions_NK_Test_3_FeeRefund\"\nvar wcs_3_id  = \"fa66ecc7-1528-45ea-9094-135b2f513fab\";\n\nglobal.set(\"global_default_wcs_tag\", wcs_1_tag);\nglobal.set(\"global_default_wcs_id\", wcs_1_id);\nnode.error(\"Inside Get WCS\");\nvar class_array = msg.payload.classes\nvar m_wcs_tag = \"\";\nvar m_wcs_id = \"\";\nvar m_wcs_confidence = 0;\n\nvar m_string = \"\"; \nvar m_validate_repeat = \"No\";\nvar m_proceed = \"Yes\";\n//var m_Skip_Output = \"No\";\nnode.error(\"Inside Get WCS\");\nif (typeof msg.params.context.last_wcs_tag === 'undefined') {\n    msg.params.context.last_wcs_tag = \"\";\n    msg.params.context.last_user_input = \"\";\n    msg.params.context.last_nlc_repeat_count = 0;\n    msg.params.context.skip_loop_break = \"No\";\n}\nelse {\n   if ((msg.params.context.last_user_input === msg.save_payload.messages[0].text) && (msg.params.context.Skip_Output === \"Yes\")) {\n      m_validate_repeat = \"Yes\";\n      //m_Skip_Output = \"Yes\";\n      m_string = msg.params.context.last_wcs_tag;\n      msg.params.context.last_nlc_repeat_count++;\n      node.error(\"Validate Repeat - Yes [\" + m_string + \"]\" );\n   }\n   else {\n      msg.params.context.last_nlc_repeat_count = 1;\n      msg.params.context.last_user_input = msg.save_payload.messages[0].text;\n   }\n}\n\nfor (i = 0; i < class_array.length; i++) {\n    if (m_validate_repeat === \"Yes\") {\n        if (m_string.indexOf(class_array[i].class_name) >= 0) {\n            m_proceed = \"No\";\n        }\n    }   \n    if (m_proceed === \"Yes\") {\n        \n        for (j=0;j<msg.wcs_setup.wcs_set.length;j++) {\n            if (class_array[i].class_name === msg.wcs_setup.wcs_set[j].wcs_tag &&\n               (class_array[i].confidence > m_wcs_confidence) ) {\n                m_wcs_tag = class_array[i].class_name;\n                m_wcs_confidence = class_array[i].confidence;\n                m_wcs_id = msg.wcs_setup.wcs_set[j].wcs_id;\n            }\n        }\n    } else {m_proceed = \"Yes\";}\n}\n\nnode.error(\"m_wcs_tag \" + m_wcs_tag);\nif (m_wcs_tag === \"\") {\n    if (m_validate_repeat === \"Yes\") {\n        msg.params.context.skip_loop_break = \"Yes\";\n        node.error(\"Set for loop break\");\n    }\n    m_wcs_tag = \"Default_WCS\";  \n    m_wcs_id  = msg.wcs_setup.default_wcs_id;\n}    \nelse {\n     msg.params.context.skip_loop_break = \"No\";\n     if (m_validate_repeat === \"Yes\") {\n        msg.params.context.last_wcs_tag = msg.params.context.last_wcs_tag + \";\" + m_wcs_tag;\n     } \n     else { \n        msg.params.context.last_wcs_tag = m_wcs_tag; \n     }\n}\n\nmsg.cur_wcs_tag=m_wcs_tag;\nmsg.params.context.cur_wcs_tag = m_wcs_tag;\nmsg.params.context.cur_wcs_id = m_wcs_id;\n\nvar user_glob_wcs_tag = \"wcs_tag_\" + msg.save_payload .appUser._id ;\nvar user_glob_wcs_id = \"wcs_id_\" + msg.save_payload .appUser._id ;\nvar user_glob_Check_NLC = \"Check_NLC_\" + msg.save_payload .appUser._id;\n//node.error(\"NAK user_glob_var ==>[\" + user_glob_var +\"]\");\n/*\nglobal.set('\"'+user_glob_wcs_tag+'\"',m_wcs_tag);\nglobal.set('\"'+user_glob_wcs_id+'\"',m_wcs_id);\nglobal.set('\"'+user_glob_Check_NLC+'\"',\"No\");\n\nvar m_get_wcs_tag = global.get('\"'+user_glob_wcs_tag+'\"');\nvar m_get_wcs_id = global.get('\"'+user_glob_wcs_id+'\"');\nnode.error(\"Global Var : \" + m_get_wcs_tag + \"==> WCS Tag ==> \" + m_get_wcs_tag + \" [\"+m_get_wcs_id+\"]\");\n*/\nmsg.cur_wcs_tag = m_wcs_tag;\nmsg.cur_wcs_id  = m_wcs_id;\n\n//Restore msg.payload\n\nmsg.payload = msg.save_payload;\n    \nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":520,"wires":[["30765c4.3982724"]]},{"id":"c4cbef75.344a98","type":"function","z":"35062497.981924","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'cc312dbc-a4cf-4bc0-acae-3a303585142e';\nmsg.wcs_setup.setup_wcs_tag = 'UCG_Router_Setup_WCS';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.router_wcs_id = \"\";\nmsg.wcs_setup.nls_start = Date();\nmsg.load_wcs_setup = \"Yes\";\nreturn msg; \n\n ","outputs":1,"noerr":0,"x":240,"y":280,"wires":[["95186651.46f1f"]]},{"id":"59269e85.cfbcf","type":"inject","z":"35062497.981924","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":180,"wires":[["c4cbef75.344a98"]]},{"id":"bbd3e8fd.2d62e8","type":"debug","z":"35062497.981924","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":920,"y":240,"wires":[]},{"id":"a06a7c44.6f97b8","type":"function","z":"35062497.981924","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nmsg.payload = \"overdraft charges on my account\" ;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":900,"y":860,"wires":[[]]},{"id":"6680dc1f.eb6094","type":"inject","z":"35062497.981924","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":480,"y":840,"wires":[["c225e617.154c5"]]},{"id":"c225e617.154c5","type":"subflow:c14accc6.1cca2","z":"35062497.981924","x":650,"y":780,"wires":[["a06a7c44.6f97b8","6c418576.125b94"]]},{"id":"6c418576.125b94","type":"debug","z":"35062497.981924","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":840,"y":780,"wires":[]},{"id":"bdef9ba7.277388","type":"function","z":"35062497.981924","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\n \nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":840,"y":480,"wires":[["ec96076d.d0d158"]]},{"id":"e7639610.c702e8","type":"function","z":"35062497.981924","name":"dt1","func":"    var d = new Date();\n    var n = d.getTime();\n    node.error(n);\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":980,"wires":[["e6c77856.bba9d8"]]},{"id":"aa9bc7ea.d4c218","type":"inject","z":"35062497.981924","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":340,"y":980,"wires":[["e7639610.c702e8"]]},{"id":"cc3bba73.ac56a8","type":"function","z":"35062497.981924","name":"dt2","func":"    var d = new Date();\n    var n = d.getTime();\n    node.error(n);\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":1000,"wires":[[]]},{"id":"e6c77856.bba9d8","type":"delay","z":"35062497.981924","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":700,"y":1040,"wires":[["cc3bba73.ac56a8"]]},{"id":"d44bfadc.4421d8","type":"function","z":"35062497.981924","name":"Restore Context ?","func":"msg.save_payload = msg.payload;\nnode.error(\"Nak-Incoming Message-Router-WCS\");\nnode.error(msg);\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\nvar user_glob_wcs_setup = \"Save_wcs_setup_\" + msg.save_payload .appUser._id;\nvar user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload .appUser._id;\n\nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nif (typeof global.get('\"'+user_glob_Context_time+'\"') !== 'undefined') {\n    var m_time_elapsed = cur_time - global.get('\"'+user_glob_Context_time+'\"');\n    if ((m_time_elapsed > 600000) || (msg.payload.messages[0].text.trim().toUpperCase() === \"HELLO\"))  {\n        var m1 = undefined;\n        global.set('\"'+user_glob_Context+'\"',m1);\n        global.set('\"'+user_glob_wcs_setup+'\"',m1);\n        global.set('\"'+user_glob_Context_time+'\"',m1);\n        node.error(\"Cleared old Context variables\");\n    }\n    else {\n        if (typeof global.get('\"'+user_glob_wcs_setup+'\"') !== 'undefined'){\n            msg.wcs_setup = global.get('\"'+user_glob_wcs_setup+'\"');\n            node.error(\"Restored from global context\");\n        }\n            \n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":230,"y":380,"wires":[["ace69fac.8b6f68"]]},{"id":"d39908de.9f475","type":"function","z":"35062497.981924","name":"Clasify the Utterance","func":"//var nclib is defined in settings.js require('/usr/src/node-red/node_modules/watson-developer-cloud/natural-language-classifier/v1')\n// var fs is defined in settings.js require('fs'),\nvar watson2 = context.global.watson;\nvar NaturalLanguageClassifierV1 = context.global.nlclib; \nvar fs     = context.global.fsstream;\n\nvar natural_language_classifier = new NaturalLanguageClassifierV1({\n  username: msg.wcs_setup.nls_userid,\n  password: msg.wcs_setup.nls_password\n});\nmsg.payload = \"i received fee\" ;\nvar params = {\n  text: msg.payload,\n  classifier_id: msg.wcs_setup.nlc_classifier_id\n    \n}\n    \nnatural_language_classifier.classify(params, \n    function\n     (err, response) {\n     if (err) {\n         node.error(\"Inside Get info about Classifer - err\");\n         node.error(err);\n         //console.log(err);\n     }\n     else {\n       node.error(\"Inside Get info about Classifer - response\");  \n       node.error(response);\n       msg.payload = response;\n       node.send(msg);\n     }   \n});\nreturn null;\n\n","outputs":1,"noerr":0,"x":680,"y":1160,"wires":[["4a599017.b86258"]]},{"id":"8ddbd2ba.1e3b1","type":"subflow:c14accc6.1cca2","z":"35062497.981924","name":"","x":450,"y":1160,"wires":[["e0267baf.ef92a","d39908de.9f475"]]},{"id":"4a599017.b86258","type":"debug","z":"35062497.981924","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":870,"y":1120,"wires":[]},{"id":"1d9c5a68.824c8e","type":"inject","z":"35062497.981924","name":"","topic":"","payload":"I received fee","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":250,"y":1160,"wires":[["8ddbd2ba.1e3b1"]]},{"id":"e0267baf.ef92a","type":"debug","z":"35062497.981924","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":610,"y":1120,"wires":[]},{"id":"dee15.82cd59eb8","type":"comment","z":"35062497.981924","name":"Smooch Chat flow which uses multiple workspaces and NLC. - Readme before use","info":"The flow uses following-\n\n1) Setup Workspace: This is special workspace which keeps followng-   \n\n   a) WorspaceTag (as Intent) and WorksSpace ID (as example) \n   b) One of the Workspace Tag must start with word \"Defult_\"   \n   c) WorkspaceTag - must not include include blanks   \n   d) Each WorkspaceTag must be assoicated with single WorkspaceID \n      Similarly one WorkspaceID should only have one WCSTagThe flow assumes, \n      all Workspaces are listed under Setup Workspace and those will be used, \n      to create training data set. \n      There is no limit on number of workspaces which can be included under \n      Setup Workspace, as long as above rules are followed. \n      In the flow \"setup workspace ID\" used is \"UCG-Setup-WCS-NLC\"; if this     \n      needs to have different name, then pl. remember to update name in    \n      'get-ready' node.    \n\n2) The flow needs to NLC classifer ID, which can also be defined in   \n   setup workspace with special intent as 'NLC_Classifier_ID' and example    \n   will have NLC traning set value. The flow will update NLC Classifer ID in    \n   example, once generated.       T\n   The flow will delete existing NLC Classifer, before running   new training set.  \n\n3) The flow also assumes, all workspaces have same set of   credentials and are defined in 'get-ready' node. The flow, can be    modified to pickup credentials from SOE Environment file.   ","x":490,"y":40,"wires":[]},{"id":"1aa87e9a.9b7721","type":"function","z":"9f8a000b.6be7d","name":"Prepare Data for Router Scan","func":"node.error(\"Prepare Data for Router Scan\");\nnode.error(msg);\n \nvar i = 0;\nvar j_len = 0;\nfor (i=0; i<msg.payload.intents.length;i++) {\n    j_len = msg.payload.intents[i].examples.length;\n    if (j_len > 0) {\n        if (msg.payload.intents[i].intent === \"Router_WCS\") {\n            msg.wcs_setup.router_wcs_id = msg.payload.intents[i].examples[j_len-1].text;\n            msg.wcs_setup.router_wcs_tag = \"Router_WCS\";\n        }\n        else {\n             if (typeof msg.wcs_setup.wcs_set === 'undefined') {\n                 msg.wcs_setup.wcs_set = [{}];\n                 msg.wcs_setup.wcs_set[0] = {\n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                }\n             }\n             else {\n                msg.wcs_setup.wcs_set.push({     \n                    \"wcs_tag\" : msg.payload.intents[i].intent,\n                    \"wcs_id\"  : msg.payload.intents[i].examples[j_len-1].text\n                })\n            }\n            msg.wcs_setup.wcs_count = msg.wcs_setup.wcs_count + 1;\n            if (msg.payload.intents[i].intent === \"Router_WCS\") {\n               msg.wcs_setup.router_wcs_id = msg.payload.intents[i].examples[j_len-1].text;\n            }\n        }\n    }\n}\nmsg.wcs_setup.continue_flag = \"Yes\";\nif (msg.wcs_setup.wcs_count === 0) {\n    node.error(\"Pl. check WCS Setup Workspace - No Workspaces are defined for NLC Training set\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nif (msg.wcs_setup.nlc_classifier_id === \"\") {\n    node.error(\"Pl. check WCS Setup Workspace - NLC_Classifier_Id has not defined\");\n    msg.wcs_setup.continue_flag = \"No\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":180,"wires":[[]]},{"id":"767efd2f.fac03c","type":"function","z":"9f8a000b.6be7d","name":"Scan Setup Workspace","func":"var watson2 = context.global.watson;  \n\nconst workspace_id2 = msg.wcs_setup.setup_wcs_id ;\nconst username2     = msg.wcs_setup.wcs_user;  \nconst password2     = msg.wcs_setup.wcs_password;  \n \nvar conversation = new watson2.ConversationV1({\n  username: username2,\n  password: password2,\n  version_date: '2018-02-16'\n});\n\nvar params = {\n  workspace_id: workspace_id2,\n  export:true\n};\n\nconversation.listIntents(params, function(err, response) {\n  if (err) {\n    console.error(err);\n  } else {\n      //node.error(response);\n      msg.payload = response;\n      node.send(msg);\n  }\n\n});\nreturn null;","outputs":1,"noerr":0,"x":530,"y":100,"wires":[["1aa87e9a.9b7721"]]},{"id":"a3369fca.793e58","type":"function","z":"9f8a000b.6be7d","name":"Check if WCS_setup to be loaded?","func":"if (typeof msg.wcs_setup == 'undefined') {\n    msg.load_wcs_setup = \"Yes\";\n}\nreturn msg;","outputs":1,"noerr":0,"x":180,"y":100,"wires":[["590a5e85.b8153"]]},{"id":"590a5e85.b8153","type":"switch","z":"9f8a000b.6be7d","name":"","property":"load_wcs_setup","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":310,"y":240,"wires":[["fdd09321.8e61d"],[]]},{"id":"ace69fac.8b6f68","type":"subflow:9f8a000b.6be7d","z":"35062497.981924","name":"","x":330,"y":460,"wires":[["76eacda7.a05a2c"]]},{"id":"95186651.46f1f","type":"subflow:9f8a000b.6be7d","z":"35062497.981924","name":"","x":470,"y":280,"wires":[["bbd3e8fd.2d62e8"]]},{"id":"68a71760.6842e","type":"function","z":"a434a319.cafa2","name":"USPS","func":"var uspsaddr = context.global.usps;  \nvar newAddress = new uspsaddr.AddressBuilder();\n\nnewAddress.BusinessName = '';\nnewAddress.StreetNumber = '40985';\nnewAddress.StreetName = 'Indigo Pl';\nnewAddress.SecondaryUnitIndicator = '';\nnewAddress.SecondaryUnitNumber = '';\nnewAddress.City = 'Leesburg';\nnewAddress.State = 'Virgnia';\nnewAddress.PostalCode = '20175';\n\n\nreturn msg;","outputs":1,"noerr":0,"x":320,"y":200,"wires":[[]]},{"id":"af0713b0.d1651","type":"function","z":"a434a319.cafa2","name":"google-geo","func":"var addressValidator2 = context.global.addressValidator;\nvar _ = context.global._;\nvar Address3 = addressValidator2.Address;\n\n//any of the props in this object are optional, also spelling does not have to be exact.\nvar address = new Address3({\n    street: '100 North Washington St',\n    city: 'Bostont',\n    state: 'Mass',\n    country: 'US'\n});\n\n//the passed in address does not need to be an address object it can be a string. (address objects will give you a better likelihood of finding an exact match)\naddress = '100 North Washington St, Boston, MA, US';\n\n//`addressValidator.match.streetAddress` -> tells the validator that you think the input should be a street address. This data makes the validator more accurate.\n// But, sometimes you dont know.. in that cause you should use `addressValidator.match.unknown`\naddressValidator.validate(address, addressValidator.match.streetAddress, function(err, exact, inexact){\n    console.log('input: ', address.toString())\n    console.log('match: ', _.map(exact, function(a) {\n      return a.toString();\n    }));\n    console.log('did you mean: ', _.map(inexact, function(a) {\n      return a.toString();\n    }));\n\n    //access some props on the exact match\n    var first = exact[0];\n    console.log(first.streetNumber + ' '+ first.street);\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":360,"wires":[["c8808389.bcffe"]]},{"id":"c8808389.bcffe","type":"debug","z":"a434a319.cafa2","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":580,"y":360,"wires":[]},{"id":"40d994b3.275844","type":"inject","z":"a434a319.cafa2","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":360,"wires":[["af0713b0.d1651"]]},{"id":"ea1ab6fc.7a7c3","type":"function","z":"35062497.981924","name":"Check Response","func":"msg.match_found = \"N/A\";\n\nif (typeof msg.payload.context.Skip_Output == 'undefined') {\n    msg.payload.context.Skip_Output = \"No\";\n}    \nif (typeof msg.payload.context.Switch_Workspace !== 'undefined') {\n   msg.match_found = \"No\"; \n   if (msg.payload.context.Switch_Workspace !== msg.wcs_setup.curr_wcs_tag) {\n      if (msg.payload.context.Switch_Workspace === msg.wcs_setup.router_wcs_tag) {\n         msg.wcs_setup.cur_wcs_id = msg.wcs_setup.router_wcs_id;\n         msg.wcs_setup,cur_wcs_tag = msg.wcs_setup.router_wcs_tag;\n         msg.match_found = \"Yes\";\n       } \n       else {\n           for (i=0;i<msg.wcs_setup.wcs_set.length;i++){\n                node.error(\"NAK - \" + msg.wcs_setup.wcs_set[i].wcs_tag + \"/\"+ msg.payload.context.Switch_Workspace );\n                if (msg.wcs_setup.wcs_set[i].wcs_tag === msg.payload.context.Switch_Workspace) {\n                  msg.wcs_setup.cur_wcs_id = msg.wcs_setup.wcs_set[i].wcs_id;\n                  msg.wcs_setup.cur_wcs_tag = msg.wcs_setup.wcs_set[i].wcs_tag;\n                  msg.match_found = \"Yes\";\n                }\n            }\n        }\n    }\n}\nif (msg.match_found === \"No\") {\n    node.error(\"Requested Workspace Not found : \");\n} \nelse {\n    var user_glob_Context = \"Save_Context_\" + msg.save_payload .appUser._id;\n    global.set('\"'+user_glob_Context+'\"',msg.payload.context);\n    node.error(\"Switched Workspace to \" + msg.wcs_setup.cur_wcs_id);\n}\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1270,"y":580,"wires":[["3484b2e9.73a07e"]]},{"id":"fdd09321.8e61d","type":"function","z":"9f8a000b.6be7d","name":"get-ready","func":"//** This node includes setup information needed to run the flow **/\n\nmsg.wcs_setup = {};\nmsg.wcs_setup.wcs_user = '3461c175-52b5-4c38-b1be-e9f3d458a701';\nmsg.wcs_setup.wcs_password = 'UplCjXHkuLgj';\nmsg.wcs_setup.setup_wcs_id = 'cc312dbc-a4cf-4bc0-acae-3a303585142e';\nmsg.wcs_setup.setup_wcs_tag = 'UCG_Router_Setup_WCS';    // for Information purpose only //\nmsg.wcs_setup.wcs_count = 0;                      // This will be updated latter in the flow  \nmsg.wcs_setup.wcs_cur_count = 0;                  // This will be updated latter in the flow\nmsg.wcs_setup.nls_start = Date();\n\nreturn msg;\n\n ","outputs":1,"noerr":0,"x":400,"y":180,"wires":[["767efd2f.fac03c"]]},{"id":"771a509b.c95718","type":"switch","z":"35062497.981924","name":"","property":"match_found","propertyType":"msg","rules":[{"t":"eq","v":"Yes","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":700,"wires":[["76eacda7.a05a2c"],["22aaa25c.3fad3e"]]},{"id":"22aaa25c.3fad3e","type":"debug","z":"35062497.981924","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":960,"y":720,"wires":[]},{"id":"aa59b403.91b648","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":260,"y":280,"wires":[["77b806a8.3baa1"]]},{"id":"77b806a8.3baa1","type":"function","z":"178b1591.56303a","name":"call watson assistant","func":"var watson = global.get('watson');\n\nvar assistant = new watson.AssistantV1({\n  iam_apikey: 'p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv',\n  version: '2018-09-20' //,\n  //url: 'https://gateway.watsonplatform.net/assistant/api/v1'\n});\n\nassistant.message({\n  workspace_id: 'bf9900bd-41f5-4e38-9b65-f928cd50e8d8',\n  input: {'text': 'Hello'}\n},  function(err, response) {\n  if (err)\n    console.log('error:', err);\n  else\n  msg.payload = response;\n  node.send(msg);\n    console.log(JSON.stringify(response, null, 2));\n});\nreturn msg;","outputs":1,"noerr":0,"x":504,"y":288,"wires":[["99a08882.7547e8"]]},{"id":"39cfc4a5.658ffc","type":"csv to json ext","z":"68b0d95d.ae26b8","name":"Convert Content CSV","version":"0.1","source":"payload","delimiter":",","quote":"\"","escape":"\"","ignoreEmpty":false,"checkType":false,"trim":false,"noheader":false,"includeColumns":"","headers":"","debug":false,"x":590.1345596313477,"y":258.11702156066895,"wires":[["7fe24eb8.04616"]]},{"id":"409ca907.d83068","type":"multipart-encoder","z":"68b0d95d.ae26b8","name":"Stream HTTP Response","statusCode":"","ignoreMessages":true,"outputIfSingle":false,"outputIfAll":false,"globalHeaders":{"Context-Type":"text/html"},"partHeaders":{},"destination":"single","x":1514.521198272705,"y":545.2918138504028,"wires":[[]]},{"id":"11596027.7090e","type":"multipart-encoder","z":"68b0d95d.ae26b8","name":"Stream HTTP Response","statusCode":"","ignoreMessages":true,"outputIfSingle":false,"outputIfAll":false,"globalHeaders":{"Content-Type":"text/html"},"partHeaders":{},"destination":"single","x":1512.479248046875,"y":311.0000514984131,"wires":[[]]},{"id":"99a08882.7547e8","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":679,"y":203,"wires":[]},{"id":"6cff7c2b.3e249c","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":793,"y":440,"wires":[]},{"id":"c2471f56.77efd8","type":"http request","z":"178b1591.56303a","name":"get-answer-wa","method":"use","ret":"obj","url":"","tls":"","x":583,"y":460,"wires":[["6cff7c2b.3e249c"]]},{"id":"28b65b86.28b65c","type":"function","z":"178b1591.56303a","name":"Get-answer-WA-http-request","func":"//node.error(msg);\n//var m_global_conv_wks =  msg.wcs_setup.cur_wcs_id;  \nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\nvar m_workspace =  'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; //msg.wcs_setup.cur_wcs_id; //\"b7c8b08b-6045-42ae-922b-37164734e80b\";\nm_context = msg.params.context;\ndelete msg.params;\nm_input = msg.payload;\n\nmsg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Basic MGUxMjVjYzEtYWYzYy00ZjJjLWJjMzEtMTRkMjU5NWZlOWVhOkxESDNNc2MwbVdHUg==\",\n    \"write-out\" : {\n     \"lookup\": \"%{time_namelookup}\",\n     \"nconnect\" : \"%{time_connect}\",\n     \"nappconnect\": \"%{time_appconnect}\",\n     \"npretransfer\": \"%{time_pretransfer}\",\n     \"nredirect\": \"%{time_redirect}\",\n     \"nstarttransfer\": \"%{time_starttransfer}\",\n     \"ntotal\": \"%{time_total}\",\n     \"socket-timeout\" : 20000,\n    }\n    \n};\nmsg.url = \"https://gateway.watsonplatform.net/assistant/api/v1/workspaces/\"+ m_workspace + \"/message?version=2018-09-20\"; //global.get(\"global_conv_url\");  \nmsg.method = \"POST\";\nmsg.payload = {\n    \"input\" : {\"text\" : m_input},\n    \"context\" : m_context\n\n};\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":397.9339828491211,"y":394.2778253555298,"wires":[["c2471f56.77efd8"]]},{"id":"3a4035f4.4c7932","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":163,"y":360,"wires":[["28b65b86.28b65c"]]},{"id":"5f018fa2.3a28b8","type":"function","z":"178b1591.56303a","name":"Get Token","func":"msg.headers={\"Content-Type\":\"application/x-www-form-urlencoded\",\n             \"Accept\" : \"application/json\"\n    \n};\nmsg.url = \"https://iam.bluemix.net/identity/token\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"grant_type\" : \"urn:ibm:params:oauth:grant-type:apikey\",\n     \"apikey\" : \"p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv\"\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":353,"y":531,"wires":[["23b47134.f4080e"]]},{"id":"122902b2.ddcc85","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":133,"y":521,"wires":[["5f018fa2.3a28b8"]]},{"id":"4ff1f400.08d8c4","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":613,"y":585,"wires":[]},{"id":"23b47134.f4080e","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":545,"y":530,"wires":[["4ff1f400.08d8c4"]]},{"id":"69907853.b116e8","type":"function","z":"178b1591.56303a","name":"Get-answer-WA-http-request","func":"//node.error(msg);\n//var m_global_conv_wks =  msg.wcs_setup.cur_wcs_id;  \n\nvar m_token = msg.payload.access_token;\nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\nvar m_workspace =  'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; //msg.wcs_setup.cur_wcs_id; //\"b7c8b08b-6045-42ae-922b-37164734e80b\";\nmsg.params = {context : {}};\nm_context = msg.params.context;\n//delete msg.params;\nm_input = \"Hello\";\n \n\nmsg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer \" + m_token,\n    \"write-out\" : {\n     \"lookup\": \"%{time_namelookup}\",\n     \"nconnect\" : \"%{time_connect}\",\n     \"nappconnect\": \"%{time_appconnect}\",\n     \"npretransfer\": \"%{time_pretransfer}\",\n     \"nredirect\": \"%{time_redirect}\",\n     \"nstarttransfer\": \"%{time_starttransfer}\",\n     \"ntotal\": \"%{time_total}\",\n     \"socket-timeout\" : 20000,\n    }\n    \n};\nmsg.url = \"https://gateway.watsonplatform.net/assistant/api/v1/workspaces/\"+ m_workspace + \"/message?version=2018-09-20\"; //global.get(\"global_conv_url\");  \nmsg.method = \"POST\";\nmsg.payload = {\n    \"input\" : {\"text\" : m_input},\n    \"context\" : m_context\n\n};\nnode.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":319,"y":704,"wires":[["2bef2f14.0542e"]]},{"id":"92f2148e.2046e8","type":"function","z":"178b1591.56303a","name":"Get Token","func":"msg.headers={\"Content-Type\":\"application/x-www-form-urlencoded\",\n             \"Accept\" : \"application/json\"\n    \n};\nmsg.url = \"https://iam.bluemix.net/identity/token\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"grant_type\" : \"urn:ibm:params:oauth:grant-type:apikey\",\n     \"apikey\" : \"p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv\"\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":315,"y":627,"wires":[["854fcba9.2f30a8"]]},{"id":"97417f62.562778","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":119,"y":633,"wires":[["92f2148e.2046e8"]]},{"id":"854fcba9.2f30a8","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":494,"y":631,"wires":[["69907853.b116e8","b2ad3831.7cca38"]]},{"id":"2bef2f14.0542e","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":535,"y":705,"wires":[["e77f69ac.c9714"]]},{"id":"b2ad3831.7cca38","type":"debug","z":"178b1591.56303a","name":"Display token","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":695,"y":634,"wires":[]},{"id":"e77f69ac.c9714","type":"debug","z":"178b1591.56303a","name":"Display WA Response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":611,"y":767,"wires":[]},{"id":"4e672f5f.a85c48","type":"function","z":"178b1591.56303a","name":"Google flow","func":"const dialogflow = context.global.dialogflow;\n\nconst uuid = context.global.google_uuid;\n\n/**\n * Send a query to the dialogflow agent, and return the query result.\n * @param {string} projectId The project to be used\n */\n console.log(\"nak\");\nasync function runSample(projectId = 'nak-room-rservation') {\n//function runSample(projectId = 'nak-room-rservation') {    \n  // A unique identifier for the given session\n  const sessionId = uuid.v4();\n \n  // Create a new session\n  const sessionClient = new dialogflow.SessionsClient();\n  const sessionPath = sessionClient.sessionPath(projectId, sessionId);\n \n  // The text query request.\n  const request = {\n    session: sessionPath,\n    queryInput: {\n      text: {\n        // The query to send to the dialogflow agent\n        text: 'hello',\n        // The language used by the client (en-US)\n        languageCode: 'en-US',\n      },\n    },\n  };\n \n  // Send request and log result\n  runSample();\n  //const responses = await sessionClient.detectIntent(request);\n    const responses = sessionClient.detectIntent(request);\n  msg.payload = responses;\n  node.send(msg);\n  console.log('Detected intent');\n  const result = responses[0].queryResult;\n  console.log(`  Query: ${result.queryText}`);\n  console.log(`  Response: ${result.fulfillmentText}`);\n  if (result.intent) {\n    console.log(`  Intent: ${result.intent.displayName}`);\n  } else {\n    console.log(`  No intent matched.`);\n  }\n}\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":980,"wires":[["5f2f58c3.13fff8"]]},{"id":"5f2f58c3.13fff8","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":640,"y":980,"wires":[]},{"id":"54dd0d4.2b4d774","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":980,"wires":[["4e672f5f.a85c48"]]},{"id":"c4c946ce.d53ab","type":"function","z":"178b1591.56303a","name":"google-pepare-request","func":"msg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer 50010e3f903d4351a3dc67259676ac25\"\n    \n};\nmsg.url = \"https://api.dialogflow.com/v1/query?v=20150910\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"contexts\": [\n      \"shop\"\n    ],\n    \"lang\": \"en\",\n    \"query\": \"Hello\",\n    \"sessionId\": \"12345\",\n    \"timezone\": \"America/New_York\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":1060,"wires":[["b7e9da16.6bc1b"]]},{"id":"b7e9da16.6bc1b","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":610,"y":1060,"wires":[["8562f471.38ebb8"]]},{"id":"3c58bf1a.088c9","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1060,"wires":[["c4c946ce.d53ab"]]},{"id":"8562f471.38ebb8","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":1060,"wires":[]},{"id":"23c62ebe.fd160a","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":1380,"wires":[]},{"id":"277860c1.eb2f","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":510,"y":1360,"wires":[["23c62ebe.fd160a","3e38b035.4ebb88"]]},{"id":"27b3345a.5880e4","type":"function","z":"178b1591.56303a","name":"google-pepare-request-pizza-order","func":"msg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer 39911804021741f08646a1b90bd2afaf\"\n    \n};\nmsg.url = \"https://api.dialogflow.com/v1/query?v=20150910\";\nmsg.method = \"POST\";\nnode.warn(\"user utterance : \" + msg.payload);\nvar m_query = msg.payload;\nmsg.payload = {\n    \"contexts\": [\n      \"shop\"\n    ],\n    \"lang\": \"en\",\n    \"query\": m_query,\n   \"sessionId\": \"12345\",\n    \"timezone\": \"America/New_York\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":620,"y":1540,"wires":[["277860c1.eb2f"]]},{"id":"a2176bb6.1563f","type":"inject","z":"178b1591.56303a","name":"Hello","topic":"","payload":"Hello","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":1340,"wires":[["27b3345a.5880e4"]]},{"id":"593af658.a5ab","type":"inject","z":"178b1591.56303a","name":"Check for pizza","topic":"","payload":"Can I have pizza please","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":1380,"wires":[["27b3345a.5880e4"]]},{"id":"3e38b035.4ebb88","type":"function","z":"178b1591.56303a","name":"display response","func":"node.error(\"BOT response : \" + msg.payload.result.fulfillment.speech);\nreturn msg;","outputs":0,"noerr":0,"x":710,"y":1300,"wires":[]},{"id":"683c356c.e72ef4","type":"inject","z":"178b1591.56303a","name":"pizza pickup Time","topic":"","payload":"4:30","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":1420,"wires":[["27b3345a.5880e4"]]},{"id":"e50059f6.afd8d","type":"inject","z":"178b1591.56303a","name":"pizza pickup Date","topic":"","payload":"2019-04-15","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":1460,"wires":[["27b3345a.5880e4"]]},{"id":"629c711a.211d7","type":"inject","z":"178b1591.56303a","name":"Toppings","topic":"","payload":"Chicken, Cheese","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":1500,"wires":[["27b3345a.5880e4"]]},{"id":"243f2992.1f3d9e","type":"inject","z":"178b1591.56303a","name":"Order size","topic":"","payload":"large","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":1540,"wires":[["27b3345a.5880e4"]]},{"id":"9a0790a4.3f2328","type":"inject","z":"178b1591.56303a","name":"side order for drink - yes","topic":"","payload":"sure","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1580,"wires":[["27b3345a.5880e4"]]},{"id":"d6a72ac9.67cb1","type":"inject","z":"178b1591.56303a","name":"side order for drink - No","topic":"","payload":"No","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1620,"wires":[["27b3345a.5880e4"]]},{"id":"44b2cc80.108b1c","type":"inject","z":"178b1591.56303a","name":"","topic":"","payload":"Thank you","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":1660,"wires":[["27b3345a.5880e4"]]},{"id":"c3c7072b.3b0158","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":670,"y":1840,"wires":[]},{"id":"7fd6775c.068478","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","url":"","tls":"","x":510,"y":1840,"wires":[["c3c7072b.3b0158"]]},{"id":"88919d0.51233e","type":"function","z":"178b1591.56303a","name":"google-get-list-of-APIs","func":"msg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer 39911804021741f08646a1b90bd2afaf\"\n    \n};\n//msg.url = \"https://api.dialogflow.com/v1/query?v=20150910\";\n//msg.url = \"https://dialogflow.googleapis.com/v2/projects/nak-pizza-order/agent/intents\"\n\nm_base_url =\"https://www.googleapis.com/discovery/v1/\";\nmsg.url = m_base_url +\"apis\";\n//msg.url = m_base_url + \"api/v1/rest\";\n\nmsg.method = \"GET\";\n\n/* node.warn(\"user utterance : \" + msg.payload);\nvar m_query = msg.payload;\nmsg.payload = {\n    \"contexts\": [\n      \"shop\"\n    ],\n    \"lang\": \"en\",\n    \"query\": m_query,\n    \"sessionId\": \"12345\",\n    \"timezone\": \"America/New_York\"\n};\n*/\nreturn msg;","outputs":1,"noerr":0,"x":300,"y":1840,"wires":[["7fd6775c.068478"]]},{"id":"dcd20074.19d0b8","type":"inject","z":"178b1591.56303a","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":1840,"wires":[["88919d0.51233e"]]},{"id":"fce44f67.6e81d","type":"inject","z":"178b1591.56303a","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":1920,"wires":[["9ce9b7a1.a7df3"]]},{"id":"9ce9b7a1.a7df3","type":"function","z":"178b1591.56303a","name":"google-get-api-documenation","func":"msg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer 39911804021741f08646a1b90bd2afaf\"\n    \n};\n\n//m_base_url =\"https://www.googleapis.com/discovery/v1/\";\n//msg.url = m_base_url +\"apis\";\nmsg.url = \"https://abusiveexperiencereport.googleapis.com/$discovery/rest?version=v1\";\n\n \n//msg.url = m_base_url + \"api/v1/rest\";\n\nmsg.method = \"GET\";\n\n/* node.warn(\"user utterance : \" + msg.payload);\nvar m_query = msg.payload;\nmsg.payload = {\n    \"contexts\": [\n      \"shop\"\n    ],\n    \"lang\": \"en\",\n    \"query\": m_query,\n    \"sessionId\": \"12345\",\n    \"timezone\": \"America/New_York\"\n};\n*/\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":1920,"wires":[["9f24e079.d178a"]]},{"id":"9f24e079.d178a","type":"http request","z":"178b1591.56303a","name":"","method":"use","ret":"obj","url":"","tls":"","x":570,"y":1920,"wires":[["d860a19e.f855b8"]]},{"id":"d860a19e.f855b8","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":710,"y":1920,"wires":[]},{"id":"9165e989.851fa","type":"debug","z":"178b1591.56303a","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":1140,"wires":[]},{"id":"d32e66ba.f1dd28","type":"function","z":"178b1591.56303a","name":"Google flow - SDK","func":"const g_apiai = context.global.apiai;\n\nvar app = g_apiai(\"39911804021741f08646a1b90bd2afaf\");\n\nvar options = {\n    sessionId: '12345678-a-002',\n    contexts: [\n        {\n            name: 'order_pizza_dialog_context',\n            parameters: {\n                'pizza_topping' : 'onions',\n                'size' : 'large',\n                'time' : '8:30'\n            }\n        }\n]\n};\n\n\n//var request = app.textRequest('Hello', {\n//    sessionId: '1234567'\n//});\n\nvar user_utterance = msg.payload;\n\nvar request = app.textRequest(user_utterance, options);\n\nrequest.on('response', function(response) {\n    \n    msg.payload = response;\n    //node.warn(msg);\n    node.send(msg);\n});\n\nrequest.on('error', function(error) {\n   // msg.payload = error;\n    node.error(msg);\n});\n\nrequest.end();\n\n\n//return msg;","outputs":1,"noerr":0,"x":430,"y":1140,"wires":[["9165e989.851fa"]]},{"id":"fd3d0268.b3c2a8","type":"inject","z":"178b1591.56303a","name":"Hello","topic":"","payload":"Hello","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1140,"wires":[["d32e66ba.f1dd28"]]},{"id":"18c28b69.3aee95","type":"inject","z":"178b1591.56303a","name":"Pizza Order","topic":"","payload":"Can i have pizza for today please","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":1200,"wires":[["57f8c890.e0063"]]},{"id":"57f8c890.e0063","type":"function","z":"178b1591.56303a","name":"Google flow - SDK","func":"const g_apiai = context.global.apiai;\n\nvar app = g_apiai(\"39911804021741f08646a1b90bd2afaf\");\n\nvar options = {\n    sessionId: '12345678-a-002'\n    /*,\n    contexts: [\n        {\n            name: 'order_pizza_dialog_context',\n            parameters: {\n                'pizza_topping' : 'onions',\n                'size' : 'large',\n                'time' : '8:30'\n            }\n        }\n] */\n};\n\nconst gfd_request = {\n//    session: sessionPath,\n    queryInput: {\n      text: {\n        // The query to send to the dialogflow agent\n        text: 'hello',\n        // The language used by the client (en-US)\n        languageCode: 'en-US',\n      },\n    },\n  };\n  \n//var request = app.textRequest('Hello', {\n//    sessionId: '1234567'\n//});\n\nvar user_utterance = msg.payload;\n\nvar request = app.textRequest(user_utterance, options);\n\nrequest.on('response', function(response) {\n    \n    msg.payload = response;\n    //node.warn(msg);\n    node.send(msg);\n});\n\nrequest.on('error', function(error) {\n   // msg.payload = error;\n    node.error(msg);\n});\n\nrequest.end();\n\n\n//return msg;","outputs":1,"noerr":0,"x":430,"y":1200,"wires":[["9165e989.851fa"]]},{"id":"4aa812b0.2683e4","type":"function","z":"453809ed.2e486","name":"Get-answer-WA-http-request","func":"//node.error(msg);\n//var m_global_conv_wks =  msg.wcs_setup.cur_wcs_id;  \n\n//var m_token = msg.payload.access_token |\n\nvar now     = new Date(); \nvar time_in_ms = now.getTime();\nmsg.getsession.wcs_start_time = time_in_ms; \n\nvar m_soe_wcs_call_id = Math.floor(10000000 + Math.random() * 80000000);\nglobal.set(\"soe_wcs_call_id_http_token\",m_soe_wcs_call_id.toString());\nglobal.set(\"wcs_retry_http_token\",0);\nmsg.params.context.soe_wcs_call_id = m_soe_wcs_call_id.toString();\n\n\nvar m_token = global.get(\"wa_access_token\"); \n\nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\nvar m_workspace =  'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; //msg.wcs_setup.cur_wcs_id; //\"b7c8b08b-6045-42ae-922b-37164734e80b\";\n//msg.curr_time = msg.payload;\n//msg.params = {context : {}};\nvar m_context = msg.params.context;\n//delete msg.params;\nm_input = \"Hello\";\n \n\nmsg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\" : \"Bearer \" + m_token,\n    \"write-out\" : {\n     \"lookup\": \"%{time_namelookup}\",\n     \"nconnect\" : \"%{time_connect}\",\n     \"nappconnect\": \"%{time_appconnect}\",\n     \"npretransfer\": \"%{time_pretransfer}\",\n     \"nredirect\": \"%{time_redirect}\",\n     \"nstarttransfer\": \"%{time_starttransfer}\",\n     \"ntotal\": \"%{time_total}\",\n     \"socket-timeout\" : (global.get(\"global_watson_timeOut\") * 4),\n    }\n    \n};\nmsg.url = \"https://gateway.watsonplatform.net/assistant/api/v1/workspaces/\"+ m_workspace + \"/message?version=2018-09-20\"; //global.get(\"global_conv_url\");  \nmsg.method = \"POST\";\nmsg.payload = {\n    \"input\" : {\"text\" : m_input},\n    \"context\" : m_context\n\n};\n\nmsg.requestTimeout = global.get(\"global_watson_timeOut\") ;\n//var now     = new Date(); \n// m_atpoint_Time = context.global.get_date_string();\n//var time_in_ms = now.getTime();\n\n//msg.getsession = {wcs_start_time : time_in_ms}; \n\n//node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":560,"wires":[["4c423992.6ff8c","5a0cd27b.62884c"]]},{"id":"4c423992.6ff8c","type":"http request","z":"453809ed.2e486","name":"","method":"use","ret":"obj","url":"","tls":"","x":1081,"y":384,"wires":[["6916087f.f53fa"]]},{"id":"5a0cd27b.62884c","type":"debug","z":"453809ed.2e486","name":"Display WA Request","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1077,"y":659,"wires":[]},{"id":"311c859b.6498d2","type":"inject","z":"453809ed.2e486","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":348,"y":645,"wires":[["e22b2574.273eb8"]]},{"id":"5fa73a62.42ca14","type":"function","z":"453809ed.2e486","name":"inject_time","func":"function right(m_string,m_cut) {\nvar m_result = m_string;\nif (m_string.length > m_cut) {\n       m_result = m_string.substring((m_string.length-m_cut),m_string.length);\n}\nreturn m_result\n}\n \nvar m_now = Date.now();\n\nvar m_dt = new Date( Date.now() - (4 * 60 * 60 * 1000)) ;\nvar m_sec = right(\"0\"+m_dt.getSeconds(),2);\nvar m_min = right(\"0\"+m_dt.getMinutes(),2);\nvar m_hrs = right(\"0\"+m_dt.getHours(),2);\nvar m_day = right(\"0\"+m_dt.getDate(),2);\nvar m_mon = right(\"0\"+String(Number(m_dt.getMonth())+1),2);\nvar dt_string_new = m_dt.getFullYear() + \"-\" +\n                    m_mon+\"-\"+m_day+\" \" + m_hrs+\":\"+m_min+\":\"+m_sec;\nmsg.payload = dt_string_new;\nglobal.set(\"global_watson_timeOut\", 900);\n\nreturn msg;","outputs":1,"noerr":0,"x":110,"y":415,"wires":[["92eee923.df23b","e22b2574.273eb8","2596307f.ad85b8"]]},{"id":"2596307f.ad85b8","type":"function","z":"453809ed.2e486","name":"set context-sdk-api","func":"msg.curr_time = msg.payload;\nmsg.call_type = \"sdk_api\";\nmsg.wcs_call_retry_cnt = 0;\nmsg.payload =  {input : {text : \"Hello\"}};\nmsg.payload.context = {\n\"vgwSIPCustomInviteHeader\":\"615CE586100001685E20A7D90AA42C2E\",\n\"vgwSIPFromURI\":\"sip:6468917965@10.188.32.10:5060\",\n\"vgwSessionID\":\"d8ec0531eee229922b8031a8b92bd766@209.165.0.45\",\n\"timezone\":\"America/Chicago\",\n\"authenticated\":\"Yes\",\n\"fee_eligibility\":\"No\",\n\"fee_refund_status\":\"None\",\n\"optout\":\"Yes\",\n\"channel\":\"SIP\",\n\"conversation_id\":\"24547ca6-68fb-454a-8c78-08fe0c2fbdb6\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":437,"y":236,"wires":[["e98153e4.16ab5"]]},{"id":"92eee923.df23b","type":"function","z":"453809ed.2e486","name":"set context-sdk-token","func":"msg.curr_time = msg.payload;\nmsg.call_type = \"sdk_token\";\nmsg.wcs_call_retry_cnt = 0;\n\nmsg.curr_time = msg.payload;\nmsg.payload =  {input : {text : \"Hello\"}};\nmsg.payload.context = {\n\"vgwSIPCustomInviteHeader\":\"615CE586100001685E20A7D90AA42C2E\",\n\"vgwSIPFromURI\":\"sip:6468917965@10.188.32.10:5060\",\n\"vgwSessionID\":\"d8ec0531eee229922b8031a8b92bd766@209.165.0.45\",\n\"timezone\":\"America/Chicago\",\n\"authenticated\":\"Yes\",\n\"fee_eligibility\":\"No\",\n\"fee_refund_status\":\"None\",\n\"optout\":\"Yes\",\n\"channel\":\"SIP\",\n\"conversation_id\":\"24547ca6-68fb-454a-8c78-08fe0c2fbdb6\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":435,"y":476,"wires":[["2057d9e0.a67f9e"]]},{"id":"2de3f327.5045b4","type":"inject","z":"453809ed.2e486","name":"Test-All-Repeats every 5 minutes","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":"15","x":190,"y":120,"wires":[["5fa73a62.42ca14"]]},{"id":"498748fe.41d53","type":"inject","z":"453809ed.2e486","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":389,"y":169,"wires":[["2596307f.ad85b8"]]},{"id":"e98153e4.16ab5","type":"function","z":"453809ed.2e486","name":"Set Params for Conversation (MWS)-nak","func":"//node.warn(\"Set Params for Conversation\");\n \n\n//***** Added by Nitin K to retrive Global Variables ****//\n\n//var m_global_conv_wks =  global.get(\"global_conv_wks\");\n\n//node.warn(\"Set Params for Conversation (MWS) : \" +msg.wcs_setup.cur_wcs_tag );\n//node.warn(msg);\n\n//node.warn(\"NAK-00\");\n\n//global.set(\"global_watson_timeOut\", 500);\n//var m_global_conv_wks = 'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; // msg.wcs_setup.cur_wcs_id;  \nvar m_global_conv_wks = '755b62ba-ce44-4ecf-ad18-432be1be8c8c';\nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\n\n//******Added by Nitin K upto Here ****/\nvar input = msg.payload.input.text;\n\n\n\nm_context = {};\nparams = {};\n\n\nm_context = msg.payload.context;\n\n \nparams = {\n     context: m_context,\n     workspace_id : m_global_conv_wks,\n     timeout  : m_global_watson_timeOut\n\n};\n\n\n\n//msg.payload.input.text = input;\n\nmsg.payload = input;\nmsg.workspace_id=m_global_conv_wks;\nmsg.params = params;\nmsg.user = \"615CE586100001685E20A7D90AA42C2E\"; //msg.getsession.session_user;\nmsg.params.context.timezone = m_global_timezone;\n//msg.params.endpoint = m_global_conv_url;\n\nglobal.set(\"wcs_call_retry_cnt_sdk_api\",1);\n \nvar now     = new Date(); \n// m_atpoint_Time = context.global.get_date_string();\nvar time_in_ms = now.getTime();\n\nmsg.getsession = {wcs_start_time : time_in_ms}; \n\n\nreturn msg;","outputs":1,"noerr":0,"x":701.25,"y":178.0625,"wires":[["f293abd5.97a4a"]]},{"id":"2057d9e0.a67f9e","type":"function","z":"453809ed.2e486","name":"Set Params for Conversation (MWS)-nak","func":"//node.warn(\"Set Params for Conversation\");\n \n\n//***** Added by Nitin K to retrive Global Variables ****//\n\n//var m_global_conv_wks =  global.get(\"global_conv_wks\");\n\n//node.warn(\"Set Params for Conversation (MWS) : \" +msg.wcs_setup.cur_wcs_tag );\n//node.warn(msg);\n\n//node.warn(\"NAK-00\");\n\n//global.set(\"global_watson_timeOut\", 300);\nvar m_global_conv_wks = 'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; // msg.wcs_setup.cur_wcs_id;  \nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\n\n//******Added by Nitin K upto Here ****/\nvar input = msg.payload.input.text;\n\n\n\nm_context = {};\nparams = {};\n\n\nm_context = msg.payload.context;\n\n \nparams = {\n     context: m_context,\n     workspace_id : m_global_conv_wks,\n     timeout  : m_global_watson_timeOut\n\n};\n\n\n\n//msg.payload.input.text = input;\n\nmsg.payload = input;\nmsg.workspace_id=m_global_conv_wks;\nmsg.params = params;\nmsg.user = \"615CE586100001685E20A7D90AA42C2E\"; //msg.getsession.session_user;\nmsg.params.context.timezone = m_global_timezone;\n//msg.params.endpoint = m_global_conv_url;\n\nglobal.set(\"wcs_call_retry_cnt_sdk_token\",1);\n \nvar now     = new Date(); \n// m_atpoint_Time = context.global.get_date_string();\nvar time_in_ms = now.getTime();\n\nmsg.getsession = {wcs_start_time : time_in_ms}; \n\n\nreturn msg;","outputs":1,"noerr":0,"x":643.25,"y":403.0625,"wires":[["49af0581.01ac34"]]},{"id":"2801f715.69c648","type":"inject","z":"453809ed.2e486","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"x":349,"y":409,"wires":[["92eee923.df23b"]]},{"id":"1755f031.692a3","type":"function","z":"453809ed.2e486","name":"Write to file","func":"\nmsg.payload = '\"'+msg.curr_time + '\", time-out-setting, ' +\n              global.get(\"global_watson_timeOut\") + ','   +\n              '\"'+ \",\" + msg.getsession.write_to_file;\nreturn msg;","outputs":1,"noerr":0,"x":1625,"y":346,"wires":[["607025fa.78f8a4"]]},{"id":"6916087f.f53fa","type":"function","z":"453809ed.2e486","name":"get-value-of-global","func":"msg.rcvd_response_in_time = \"\";\n//node.error(msg);\nif (typeof msg.payload.context !== 'undefined') {\n    var m_call_id = 0;\n    switch (msg.call_type) {\n       case 'sdk_api':\n           m_call_id = global.get(\"soe_wcs_call_id_sdk_api\");\n           break;\n       case 'sdk_token':\n           m_call_id = global.get(\"soe_wcs_call_id_sdk_token\");\n           break;\n       default:\n           m_call_id = global.get(\"soe_wcs_call_id_http_token\");\n           break;\n    }\n\n    if (msg.payload.context.soe_wcs_call_id ===  m_call_id ) {\n        msg.rcvd_response_in_time = \"Yes\";\n        var now     = new Date(); \n        // m_atpoint_Time = context.global.get_date_string();\n        var time_in_ms = now.getTime();\n        msg.getsession.wcs_end_time = time_in_ms; \n        msg.getsession.wcs_total_time = time_in_ms - msg.getsession.wcs_start_time;\n        msg.getsession.write_to_file = '\"' + msg.call_type + '\",' + msg.getsession.wcs_total_time + \", retry_count ,\" + msg.wcs_call_retry_cnt;\n        //node.warn(msg.getsession.write_to_file);    \n        return [null,msg];\n    }\n    else {\n        msg.rcvd_response_in_time = \"No\";\n        return [msg,null];\n    }    \n\n}\n//return msg;\n\n","outputs":2,"noerr":0,"x":1309,"y":377,"wires":[["c6f62fff.656a7"],["1755f031.692a3"]]},{"id":"f293abd5.97a4a","type":"function","z":"453809ed.2e486","name":"call watson assistant - using SDK & API Key-bak","func":"//var watson = global.get('watson');\nvar AssistantV1 = global.get('watson');\n\nvar now     = new Date(); \nvar time_in_ms = now.getTime();\nmsg.getsession.wcs_start_time = time_in_ms; \n\nvar m_soe_wcs_call_id = Math.floor(10000000 + Math.random() * 80000000);\nglobal.set(\"soe_wcs_call_id_sdk_api\",m_soe_wcs_call_id.toString());\nglobal.set(\"wcs_retry_sdk_api\",0);\nmsg.params.context.soe_wcs_call_id = m_soe_wcs_call_id.toString();\n//node.warn(\"wcs_call_id \" + m_soe_wcs_call_id + \" from variable : \" + global.get(\"soe_wcs_call_id\") );\n//node.error(msg);\n\n\nvar assistant = new AssistantV1({\n  iam_apikey: 'PATrV1y3jHyHgYg0dxL0r7KNA86PnOpNC7oaMzUlAeLM',\n  version: '2018-09-28', //,\n   url: 'https://gateway.watsonplatform.net/assistant/api'\n});\n\nvar myTM = setTimeout(function() {\n         node.error(\"UCG Error : WCS message API reached time out\", msg);\n    }, global.get(\"global_watson_timeOut\")\n);\n\nassistant.message(msg.params,\n  function(err, response) {\n  if (err) {\n     console.log('error:', err);\n     msg.nak_error = \"Yes\"; \n     //node.send(msg);\n  }\n  else {\n     msg.payload = response; \n      node.send(msg);\n  }\n  \n  //node.send(msg);\n  clearTimeout(myTM);\n  //console.log(JSON.stringify(response, null, 2));\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1029,"y":242,"wires":[["6916087f.f53fa","79c5a40f.9a8d14"]]},{"id":"49af0581.01ac34","type":"function","z":"453809ed.2e486","name":"call watson assistant - using SDK & API Token","func":"var watson = global.get('watson');\n\nvar now     = new Date(); \nvar time_in_ms = now.getTime();\nmsg.getsession.wcs_start_time = time_in_ms; \n\nvar m_soe_wcs_call_id = Math.floor(10000000 + Math.random() * 80000000);\nglobal.set(\"soe_wcs_call_id_sdk_token\",m_soe_wcs_call_id.toString());\nglobal.set(\"wcs_retry_sdk_token\",0);\nmsg.params.context.soe_wcs_call_id = m_soe_wcs_call_id.toString();\n\n\nvar assistant = new watson.AssistantV1({\n  //iam_apikey: 'p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv',\n  iam_access_token : global.get(\"wa_access_token\"),\n  version: '2018-09-20' //,\n  //url: 'https://gateway.watsonplatform.net/assistant/api/v1'\n});\n\nvar myTM = setTimeout(function() {\n         node.error(\"UCG Error : WCS message API reached time out\", msg);\n    }, global.get(\"global_watson_timeOut\")\n);\n\nassistant.message(msg.params,\n  function(err, response) {\n  if (err) {\n     console.log('error:', err);\n     msg.nak_error = \"Yes\"; \n     node.warn(err);\n     //node.send(msg);\n  }\n  else {\n     msg.payload = response; \n      node.send(msg);\n  }\n  \n  //node.send(msg);\n  clearTimeout(myTM);\n  //console.log(JSON.stringify(response, null, 2));\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":947,"y":319,"wires":[["6916087f.f53fa"]]},{"id":"607025fa.78f8a4","type":"file","z":"453809ed.2e486","name":"test","filename":"/usr/src/node-red/logs/wa_call_test_20190323.csv","appendNewline":true,"createDir":false,"overwriteFile":"false","x":1606,"y":405,"wires":[["d5da9dc6.e9b878"]]},{"id":"fc1d63c.82c4fa","type":"catch","z":"453809ed.2e486","name":"","scope":null,"x":458,"y":49,"wires":[["adffdf83.ce778"]]},{"id":"adffdf83.ce778","type":"function","z":"453809ed.2e486","name":"Error-func-node","func":"//node.warn(msg);\nvar m_wcs_call_retry_cnt = 0;\nmsg.nak_error = \"Yes\";\n\nswitch (msg.call_type) {\n    case 'sdk_api':\n         m_wcs_call_retry_cnt = global.get(\"wcs_call_retry_cnt_sdk_api\") + 1;\n         global.set(\"wcs_call_retry_cnt_sdk_api\",m_wcs_call_retry_cnt);\n         global.set(\"soe_wcs_call_id_sdk_api\",-1);\n         break;\n    case 'sdk_token':\n         m_wcs_call_retry_cnt = global.get(\"wcs_call_retry_cnt_sdk_token\") + 1;\n         global.set(\"wcs_call_retry_cnt_sdk_token\",m_wcs_call_retry_cnt);\n         global.set(\"soe_wcs_call_id_sdk_token\",-1);\n         break;\n    default:     \n         m_wcs_call_retry_cnt = global.get(\"wcs_call_retry_cnt_http_token\") + 1;\n         global.set(\"wcs_call_retry_cnt_http_token\",m_wcs_call_retry_cnt);\n         global.set(\"soe_wcs_call_id_sdk_token\",-1);\n         break;\n}\nmsg.wcs_call_retry_cnt = m_wcs_call_retry_cnt;\n\n//if (msg.call_type === \"sdk_api\") {\n//    m_wcs_call_retry_cnt = global.get(\"wcs_call_retry_cnt_sdk_api\") + 1;\n//    global.set(\"wcs_call_retry_cnt_sdk_api\",m_wcs_call_retry_cnt);\n//    msg.wcs_call_retry_cnt = m_wcs_call_retry_cnt;\n    \n//}    \n//node.warn(\"Retry counter: \" + m_wcs_call_retry_cnt);\nreturn msg;","outputs":1,"noerr":0,"x":674.5867919921875,"y":49.72205352783203,"wires":[["a11a3438.4c6c68"]]},{"id":"a11a3438.4c6c68","type":"switch","z":"453809ed.2e486","name":"","property":"wcs_call_retry_cnt","propertyType":"msg","rules":[{"t":"gt","v":"3","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":857,"y":49,"wires":[["6c47012b.b4395"],["be6cf076.1b99e8"]]},{"id":"6c47012b.b4395","type":"function","z":"453809ed.2e486","name":"reset wcs_call_id","func":"switch (msg.call_type) {\n    case 'sdk_api':\n        global.set(\"soe_wcs_call_id_sdk_api\",-1);\n        break;\n    case 'sdk_token':\n        global.set(\"soe_wcs_call_id_sdk_token\",-1);\n        break;\n    default:\n        global.set(\"soe_wcs_call_id_http_token\",-1);\n        break;\n}\nmsg.getsession.write_to_file = '\"' + msg.call_type + '\",' + \"API-Timeout\" + \", retry_count ,\" + msg.wcs_call_retry_cnt;\nnode.warn(msg.getsession.write_to_file);  \nnode.warn(\"UCG Error : WCS message API reached time out\");   \nreturn msg;","outputs":1,"noerr":0,"x":1141,"y":43,"wires":[["a678585f.568648","1755f031.692a3"]]},{"id":"a678585f.568648","type":"debug","z":"453809ed.2e486","name":"Error_Max","active":false,"console":"false","complete":"true","x":1396,"y":43,"wires":[]},{"id":"be6cf076.1b99e8","type":"switch","z":"453809ed.2e486","name":"","property":"call_type","propertyType":"msg","rules":[{"t":"eq","v":"sdk_api","vt":"str"},{"t":"eq","v":"sdk_token","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":601,"y":318,"wires":[["f293abd5.97a4a","1056ab8a.8a1a5c"],["49af0581.01ac34"],["4aa812b0.2683e4"]]},{"id":"c6f62fff.656a7","type":"debug","z":"453809ed.2e486","name":"WA-Response-null","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":1339,"y":306,"wires":[]},{"id":"e22b2574.273eb8","type":"function","z":"453809ed.2e486","name":"set context-http-token","func":"msg.curr_time = msg.payload;\nmsg.call_type = \"http_token\";\nmsg.wcs_call_retry_cnt = 0;\n\nmsg.curr_time = msg.payload;\nmsg.payload =  {input : {text : \"Hello\"}};\nmsg.payload.context = {\n\"vgwSIPCustomInviteHeader\":\"615CE586100001685E20A7D90AA42C2E\",\n\"vgwSIPFromURI\":\"sip:6468917965@10.188.32.10:5060\",\n\"vgwSessionID\":\"d8ec0531eee229922b8031a8b92bd766@209.165.0.45\",\n\"timezone\":\"America/Chicago\",\n\"authenticated\":\"Yes\",\n\"fee_eligibility\":\"No\",\n\"fee_refund_status\":\"None\",\n\"optout\":\"Yes\",\n\"channel\":\"SIP\",\n\"conversation_id\":\"24547ca6-68fb-454a-8c78-08fe0c2fbdb6\"\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":433,"y":585,"wires":[["19adaac6.1a7c7d"]]},{"id":"19adaac6.1a7c7d","type":"function","z":"453809ed.2e486","name":"Set Params for Conversation (MWS)-nak","func":"\n//global.set(\"global_watson_timeOut\", 300);\nvar m_global_conv_wks = 'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; // msg.wcs_setup.cur_wcs_id;  \n//var m_global_conv_usr = global.get(\"global_conv_usr\");\n//var m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\n\n//******Added by Nitin K upto Here ****/\nvar input = msg.payload.input.text;\n\n//msg.payload.input.text = input;\n\n//msg.payload = input;\nmsg.workspace_id=m_global_conv_wks;\nmsg.params = {context : msg.payload.context};\n\nmsg.user = \"615CE586100001685E20A7D90AA42C2E\"; //msg.getsession.session_user;\nmsg.params.context.timezone = m_global_timezone;\n//msg.params.endpoint = m_global_conv_url;\n\nglobal.set(\"wcs_call_retry_cnt_http_token\",1);\n \nvar now     = new Date(); \n// m_atpoint_Time = context.global.get_date_string();\nvar time_in_ms = now.getTime();\n\nmsg.getsession = {wcs_start_time : time_in_ms}; \n\n\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":656,"wires":[["4aa812b0.2683e4"]]},{"id":"f0aaabb4.e73ec8","type":"debug","z":"453809ed.2e486","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":882,"y":939,"wires":[]},{"id":"78f9b467.262844","type":"function","z":"453809ed.2e486","name":"Save WA-Token","func":"global.set(\"wa_access_token\", msg.payload.access_token);\nreturn msg;","outputs":1,"noerr":0,"x":705,"y":940,"wires":[["f0aaabb4.e73ec8"]]},{"id":"c2197399.6357d8","type":"http request","z":"453809ed.2e486","name":"","method":"use","ret":"obj","url":"","tls":"","x":505,"y":898,"wires":[["78f9b467.262844"]]},{"id":"9529a581.d52d8","type":"function","z":"453809ed.2e486","name":"Get Token","func":"msg.headers={\"Content-Type\":\"application/x-www-form-urlencoded\",\n             \"Accept\" : \"application/json\"\n    \n};\nmsg.url = \"https://iam.bluemix.net/identity/token\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"grant_type\" : \"urn:ibm:params:oauth:grant-type:apikey\",\n     \"apikey\" : \"p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv\"\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":301,"y":940,"wires":[["1f3e2798.9944e8","c2197399.6357d8"]]},{"id":"2514ce56.41a7ea","type":"inject","z":"453809ed.2e486","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":95,"y":938,"wires":[["9529a581.d52d8"]]},{"id":"d5da9dc6.e9b878","type":"debug","z":"453809ed.2e486","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1620,"y":474,"wires":[]},{"id":"1f3e2798.9944e8","type":"http request","z":"453809ed.2e486","name":"","method":"use","ret":"obj","url":"","tls":"","x":501,"y":992,"wires":[["6e095df6.b65114"]]},{"id":"6e095df6.b65114","type":"debug","z":"453809ed.2e486","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":883,"y":989,"wires":[]},{"id":"d27b23d1.91ca5","type":"debug","z":"d8b750b4.55a42","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":400,"wires":[]},{"id":"e25fbaa8.a264c","type":"http request","z":"d8b750b4.55a42","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":490,"y":400,"wires":[["d27b23d1.91ca5"]]},{"id":"e7dd50e1.e81958","type":"function","z":"d8b750b4.55a42","name":"my-local-url","func":"msg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\"\n\n};\n//msg.url = \"https://api.dialogflow.com/v1/query?v=20150910\";\n//msg.url = \"https://dialogflow.googleapis.com/v2/projects/nak-pizza-order/agent/intents\"\n\nmsg.url =\"http://localhost:8090/users/create_new_User\";\n\nmsg.method = \"POST\";\n\nmsg.payload = {\n\"firstname\" : \"Jonn\",\n\"lastname\" : \"D'souza\",\n\"email\": \"nitintest@email.com\",\n\"password\" : \"test123\"\n};\nreturn msg;","outputs":1,"noerr":0,"x":250,"y":400,"wires":[["e25fbaa8.a264c","72480e6c.1e4a28"]]},{"id":"f92faee6.66e9e8","type":"inject","z":"d8b750b4.55a42","name":"Inject","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":400,"wires":[["e7dd50e1.e81958"]]},{"id":"72480e6c.1e4a28","type":"debug","z":"d8b750b4.55a42","name":"request","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":320,"wires":[]},{"id":"daaca709.8b01c8","type":"function","z":"72cea9e2.279df","name":"Set Params for WCS Call","func":"//msg.source = \"LivePerson\"\n//msg.region = \"US-SOUTH\";\n//Passed params are the primary config, will be used in the dynamic WCS router subflow to switch back\nmsg.primary_region = msg.region;\n\n\n\n//var workspace_id = \"755b62ba-ce44-4ecf-ad18-432be1be8c8c\";\n//var wcs_user_name = \"3461c175-52b5-4c38-b1be-e9f3d458a701\"; // \"4acac659-e820-4ef6-8421-e88f517c9c4c\";\n//var wcs_password = \"UplCjXHkuLgj\";\n\n\nvar m_global_timezone = global.get(\"global_timezone\");\nvar m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\nvar m_global_conv_url = global.get(\"global_conv_url\");\n\n\nvar fname = \"NitinK\"; //msg.req.query.fname\n\n//create a null context and test for session existance\nvar context_obj = {};\nmsg.session = {};\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload.dialogId;\nif (typeof global.get('\"'+user_glob_Context+'\"') !== 'undefined') {\n    context_obj = global.get('\"'+user_glob_Context+'\"');\n    node.error(\"Display Context\");\n    node.error(context_obj);\n}\n\n\n\nvar newmsg = msg.payload.utterance;  //msg.req.query.text\nnewmsg = newmsg.replace(/'/g, \"\");  \n\nvar map = JSON.parse(\"{}\");\nvar image = JSON.parse(\"{}\");  \nvar button = JSON.parse(\"{}\");\n\nmsg.payload = newmsg\n\ncontext_obj.fname = fname;\ncontext_obj.map = map;\ncontext_obj.image = image;\ncontext_obj.button = button;\ncontext_obj.source = msg.source\n\nmsg.params = {};\nmsg.params.input = {\n      text: msg.payload\n    };\nmsg.params.context = context_obj;\nif (msg.cloud === \"IBMCLOUD\") {\n    msg.params.workspace_id = global.get(\"global_ibm_workspace\"); //workspace_id;\n}\nelse {\n    msg.params.workspace_id = global.get(\"global_icp_workspace\"); //workspace_id;\n}\n//msg.params.username = wcs_user_name;\n//msg.params.password = wcs_password;\n\n\n//node.error(\"before display\");\n//node.error(msg);\n//node.error(\"After display\");\n\n//msg.payload = newmsg\n//msg.params = params\n//node.error(msg);\nreturn msg\n","outputs":1,"noerr":0,"x":390,"y":400,"wires":[["e6fc0a11.c5479"]]},{"id":"a8d2de3a.31b56","type":"function","z":"72cea9e2.279df","name":"Call WCS to get Answer-ICP","func":"//var watson = global.get('watson');\nvar AssistantV1 = global.get('watson');\n\n\nmsg.params.input = {\n      text:  msg.payload\n    };\nmsg.params.workspace_id = global.get(\"global_icp_workspace\");\nnode.warn(msg);\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 30 second time out\", msg)}, 30000 );\n\nconst service = new AssistantV1({\n  version: '2018-09-20',  \n  username: \"apikey\",\n  password: \"icp-PNAi36qLdWZA3MeiZP81z8AZggceGaiTLo2i9Jtd1Igg\", //global.get(\"global_ibm_api_key\"),     \n  url: \"https://mycluster.icp:8443/assistant/api\",  \n  disable_ssl_verification: true\n});\n\n\n/*\nservice.message(msg.params,\n  function(err, response) {\n  if (err) {\n     console.log('error:', err);\n    //node.send(msg);\n  }\n  else {\n     msg.payload = response; \n      node.send(msg);\n  }\n  \n  //node.send(msg);\n  clearTimeout(myTM);\n  //console.log(JSON.stringify(response, null, 2));\n});\n*/\n\n\n\n\n/**/\nservice.message({\n   workspace_id: \"50cf8ab7-4ba6-45e7-a50d-a49d39014cc3\", //global.get(\"global_icp_workspace\"),\n   input: {text : msg.payload},\n   context : msg.params.context\n   })\n  .then(res => {\n    //console.log(JSON.stringify(res, null, 2));\n    node.error(res);\n    msg.payload = res;\n    node.send(msg);\n  })\n  .catch(err => {\n    console.log(err)\n});\n/**/\n","outputs":1,"noerr":0,"x":760,"y":340,"wires":[["a267a3f7.2c802","be5277f6.0fbb9"]]},{"id":"8f60069a.3ae218","type":"inject","z":"72cea9e2.279df","name":"Hello","topic":"","payload":"{\"dialogId\":\"35c3e92f-ad53-42bd-81ef-bf9fe3313e82\",\"utterance\":\"Hello\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":420,"wires":[["22564804.b2103"]]},{"id":"a267a3f7.2c802","type":"debug","z":"72cea9e2.279df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1190,"y":340,"wires":[]},{"id":"7649347a.601fdc","type":"function","z":"72cea9e2.279df","name":"Get-answer-WA-http-request","func":"//node.error(msg);\n//var m_global_conv_wks =  msg.wcs_setup.cur_wcs_id;  \n\n//var m_token = msg.payload.access_token |\n\nvar now     = new Date(); \nvar time_in_ms = now.getTime();\n//msg.getsession.wcs_start_time = time_in_ms; \n\n//var m_soe_wcs_call_id = Math.floor(10000000 + Math.random() * 80000000);\n//global.set(\"soe_wcs_call_id_http_token\",m_soe_wcs_call_id.toString());\n//global.set(\"wcs_retry_http_token\",0);\n//msg.params.context.soe_wcs_call_id = m_soe_wcs_call_id.toString();\n\n\nvar m_token = global.get(\"wa_access_token\"); \n\nvar m_global_conv_usr = global.get(\"global_conv_usr\");\nvar m_global_conv_pass = global.get(\"global_conv_pass\");\nvar m_global_timezone = global.get(\"global_timezone\");\n//var m_global_watson_timeOut = global.get(\"global_watson_timeOut\");\n//var m_global_conv_url = global.get(\"global_conv_url\");\n\nvar m_workspace =  global.get(\"global_workspace\"); //'bf9900bd-41f5-4e38-9b65-f928cd50e8d8'; //msg.wcs_setup.cur_wcs_id; //\"b7c8b08b-6045-42ae-922b-37164734e80b\";\n//msg.curr_time = msg.payload;\n//msg.params = {context : {}};\n//var m_context = msg.params.context;\n//delete msg.params;\nm_input = \"Hello\";\n \n\nmsg.headers={\"Content-Type\":\"application/json\",\n             \"Accept\" : \"application/json\",\n             \"Authorization\": \"Basic YXBpa2V5OmljcC1QTkFpMzZxTGRXWkEzTWVpWlA4MXo4QVpnZ2NlR2FpVExvMmk5SnRkMUlnZw==\",\n             strictSSL: false,\n             //\"Authorization\" : \"Bearer \" + m_token,\n    \"write-out\" : {\n     \"lookup\": \"%{time_namelookup}\",\n     \"nconnect\" : \"%{time_connect}\",\n     \"nappconnect\": \"%{time_appconnect}\",\n     \"npretransfer\": \"%{time_pretransfer}\",\n     \"nredirect\": \"%{time_redirect}\",\n     \"nstarttransfer\": \"%{time_starttransfer}\",\n     \"ntotal\": \"%{time_total}\",\n     \"socket-timeout\" : (global.get(\"global_watson_timeOut\") * 4),\n    }\n};\nmsg.url = \"https://mycluster.icp:8443/assistant/api/v1/workspaces/\"+ m_workspace + \"/message?version=2018-09-20\"; //global.get(\"global_conv_url\");  \nmsg.method = \"POST\";\nmsg.rejectUnauthorized = false;\nmsg.payload = {\n    \"input\" : {\"text\" : m_input}\n\n};\n\nmsg.requestTimeout = \"60000\"; //global.get(\"global_watson_timeOut\") ;\n//var now     = new Date(); \n// m_atpoint_Time = context.global.get_date_string();\n//var time_in_ms = now.getTime();\n\n//msg.getsession = {wcs_start_time : time_in_ms}; \n\n//node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":980,"wires":[["d730c143.a237"]]},{"id":"d730c143.a237","type":"http request","z":"72cea9e2.279df","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":530,"y":880,"wires":[["da3962f1.ab42f8"]]},{"id":"22564804.b2103","type":"function","z":"72cea9e2.279df","name":"Restore Context  and set global variables","func":"msg.cloud = \"PIBMCLOUD\";\nmsg.save_payload = msg.payload;\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload.dialogId;\nvar user_glob_wcs_setup = \"Save_wcs_setup_\" + msg.save_payload.dialogId;\nvar user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload.dialogId;\n\nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nif (typeof global.get('\"'+user_glob_Context_time+'\"') !== 'undefined') {\n    var m_time_elapsed = cur_time - global.get('\"'+user_glob_Context_time+'\"');\n    var str = msg.payload.utterance.toUpperCase();\n    var n_found = str.search(\"HELLO\");\n    //node.error(\"checking to initialize var -\"+ n_found);\n    if ((m_time_elapsed > 600000) || (n_found > 0))  {\n       // node.error(\"inside initialize var -\"+ n_found);\n        var m1 = undefined;\n        global.set('\"'+user_glob_Context+'\"',m1);\n        global.set('\"'+user_glob_wcs_setup+'\"',m1);\n        global.set('\"'+user_glob_Context_time+'\"',m1);\n        node.error(\"Cleared old Context variables\");\n    }\n}\n//node.error(msg);\n/** Workspaces in IBM Bluemix **/\nglobal.set(\"global_ibm_workspace\",\"755b62ba-ce44-4ecf-ad18-432be1be8c8c\");\nglobal.set(\"global_ibm_api_key\",'PATrV1y3jHyHgYg0dxL0r7KNA86PnOpNC7oaMzUlAeLM');\nglobal.set(\"global_ibm_conv_usr\",\"3461c175-52b5-4c38-b1be-e9f3d458a701\");\nglobal.set(\"global_ibm_conv_pass\",\"UplCjXHkuLgj\");\n//global.set(\"global_ibm_wa_url_US_South\",\"https://gateway.watsonplatform.net/conversation/api\");\nglobal.set(\"global_ibm_wa_url_US_South\",'https://gateway.watsonplatform.net/assistant/api');\nglobal.set(\"global_ibm_api_version\",'2018-09-28')\n\n/** Workspaces in Staefarm ICP **/\n\nglobal.set(\"global_icp_workspace\",\"50cf8ab7-4ba6-45e7-a50d-a49d39014cc3\");\nglobal.set(\"global_icp_api_key\",\"icp-PNAi36qLdWZA3MeiZP81z8AZggceGaiTLo2i9Jtd1Igg\");\nglobal.set(\"global_icp_wa_icp_url\",\"https://mycluster.icp:8443/assistant/api\");\nglobal.set(\"global_icp_api_version\",'2018-09-20');\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":480,"wires":[["daaca709.8b01c8"]]},{"id":"be5277f6.0fbb9","type":"function","z":"72cea9e2.279df","name":"Check Response and save session data","func":"var user_glob_Context_time = \"Save_Context_time_\" + msg.save_payload.dialogId;\nvar cur_dt = new Date();\nvar cur_time = cur_dt.getTime();\n\nvar user_glob_Context = \"Save_Context_\" + msg.save_payload.dialogId;\nglobal.set('\"'+user_glob_Context+'\"',msg.payload.context);\nglobal.set('\"'+user_glob_Context_time+'\"',cur_time);\n\n//node.error(msg);\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":440,"wires":[["90807606.264428"]]},{"id":"9a3c1b0d.5669d8","type":"inject","z":"72cea9e2.279df","name":"2nd utterance","topic":"","payload":"{\"dialogId\":\"35c3e92f-ad53-42bd-81ef-bf9fe3313e82\",\"utterance\":\"Open bank account\"}","payloadType":"json","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":480,"wires":[["22564804.b2103"]]},{"id":"df3b1120.8ddeb","type":"http in","z":"72cea9e2.279df","name":"","url":"/lpsdk","method":"post","upload":false,"swaggerDoc":"","x":130,"y":540,"wires":[["22564804.b2103"]]},{"id":"90807606.264428","type":"function","z":"72cea9e2.279df","name":"create response","func":"//var obj_response = msg.payload.result.fulfillment.speech.split(\"|\");\n//m_response = obj_response[obj_response.length-1];\n\nif (typeof msg.payload.event !== 'undefined') {\n    msg.payload = [{\"text\" : msg.payload.output.text[0]}]; \n}\nelse {\n    msg.payload = msg.payload.output.text[0];\n    //obj_response[obj_response.length-1];\n}\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":540,"wires":[["846698d9.62e758","55edce23.57f3a"]]},{"id":"846698d9.62e758","type":"debug","z":"72cea9e2.279df","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":870,"y":600,"wires":[]},{"id":"55edce23.57f3a","type":"http response","z":"72cea9e2.279df","name":"lpsdk response","statusCode":"200","headers":{},"x":900,"y":540,"wires":[]},{"id":"4b0580e7.ec4d38","type":"function","z":"72cea9e2.279df","name":"Call WCS to get Answer - call to Cloud WA","func":"/* New param to added to all front-ends - wcs_region = USSOUTH, GERMANY\nWill be used to set the url\nUSSOUTH - https://gateway.watsonplatform.net/conversation/api\nGERMANY - https://gateway-fra.watsonplatform.net/conversation/api\n*/\nmsg.region = \"US-SOUTH\";\nvar watson = global.get('watson');\nmsg.params.input = {\n      text: msg.payload\n    };\n\n/*\nif (msg.region === \"US-SOUTH\"){ \n    msg.params.endpoint = \"https://gateway.watsonplatform.net/conversation/api\"\n}\nelse if (msg.region === \"GERMANY\"){\n    msg.params.endpoint = \"https://gateway-fra.watsonplatform.net/conversation/api\"\n}\n*/\nvar conversation = new watson.ConversationV1({\n//var conversation = new watson({\n  username :    global.get(\"global_ibm_conv_usr\"),     \n  password :    global.get(\"global_ibm_conv_pass\"),  \n  url :         global.set(\"global_ibm_wa_url_US_South\"),  \n  version_date: global.get(\"global_ibm_api_version\") \n});\n\n\nvar myTM = setTimeout(function() { node.error(\"WCS message API reached 15 second time out\", msg)}, 300000 );\n\nconversation.message(msg.params,function(err, response) {\n    if (err) {\n      node.error(err);\n    } else {\n      msg.payload = response;\n      node.send(msg);\n      clearTimeout(myTM)\n     // console.log(JSON.stringify(response, null, 2));\n    }\n  }\n);\n","outputs":1,"noerr":0,"x":790,"y":60,"wires":[[]]},{"id":"e6fc0a11.c5479","type":"switch","z":"72cea9e2.279df","name":"","property":"cloud","propertyType":"msg","rules":[{"t":"eq","v":"IBMCLOUD","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":280,"wires":[["d81f51e1.3ecb1"],["a8d2de3a.31b56"]]},{"id":"57c3efe7.f6c22","type":"catch","z":"72cea9e2.279df","name":"","scope":null,"uncaught":false,"x":660,"y":200,"wires":[["6aba3043.da6dc8"]]},{"id":"6aba3043.da6dc8","type":"debug","z":"72cea9e2.279df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":840,"y":200,"wires":[]},{"id":"1056ab8a.8a1a5c","type":"function","z":"453809ed.2e486","name":"call watson assistant - using SDK & API Key","func":"var AssistantV1 = global.get('watson');\n\nvar now     = new Date(); \nvar time_in_ms = now.getTime();\nmsg.getsession.wcs_start_time = time_in_ms; \n\nvar m_soe_wcs_call_id = Math.floor(10000000 + Math.random() * 80000000);\nglobal.set(\"soe_wcs_call_id_sdk_api\",m_soe_wcs_call_id.toString());\nglobal.set(\"wcs_retry_sdk_api\",0);\nmsg.params.context.soe_wcs_call_id = m_soe_wcs_call_id.toString();\n\n/*\nvar service = new AssistantV1 ({\n  //iam_apikey: 'p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv',\n  iam_apikey: 'PATrV1y3jHyHgYg0dxL0r7KNA86PnOpNC7oaMzUlAeLM',\n  //iam_access_token : global.get(\"wa_access_token\"),\n  version: '2018-09-28',\n  url: 'https://gateway.watsonplatform.net/assistant/api'\n});\n*/\n\nvar service = new AssistantV1 ({\n  //iam_apikey: 'p9fYRjPtPX6BmqyDZm4A_ZjOTjXwr60FeGbJqcMg6xfv',\n  iam_apikey: 'PATrV1y3jHyHgYg0dxL0r7KNA86PnOpNC7oaMzUlAeLM',\n  //iam_access_token : global.get(\"wa_access_token\"),\n  version: '2018-09-28',\n  url: 'https://gateway.watsonplatform.net/assistant/api'\n});\n\n\nvar myTM = setTimeout(function() {\n         node.error(\"UCG Error : WCS message API reached time out\", msg);\n    }, global.get(\"global_watson_timeOut\")\n);\n\n//node.warn(msg);\nservice.message(msg.params,\n  function(err, response) {\n  if (err) {\n     console.log('error:', err);\n//     msg.nak_error = \"Yes\"; \n     node.warn(err);\n     //node.send(msg);\n  }\n  else {\n     msg.payload = response; \n      //node.send(msg);\n  }\n  \n  node.send(msg);\n  clearTimeout(myTM);\n  //console.log(JSON.stringify(response, null, 2));\n});\n\nreturn;","outputs":1,"noerr":0,"x":1090,"y":180,"wires":[["79c5a40f.9a8d14"]]},{"id":"79c5a40f.9a8d14","type":"debug","z":"453809ed.2e486","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1420,"y":160,"wires":[]},{"id":"d81f51e1.3ecb1","type":"function","z":"72cea9e2.279df","name":"call watson assistant - using SDK & API Key","func":"//var watson = global.get('watson');\nvar AssistantV1 = global.get('watson');\n\nvar assistant = new AssistantV1({\n  iam_apikey: global.get(\"global_ibm_api_key\"),     \n  version: global.get(\"global_ibm_api_version\"),    \n   url: global.get(\"global_ibm_wa_url_US_South\")   \n});\n\nvar myTM = setTimeout(function() {\n         node.error(\"UCG Error : WCS message API reached time out\", msg);\n    }, global.get(\"global_watson_timeOut\")\n);\n\nassistant.message(msg.params,\n  function(err, response) {\n  if (err) {\n     console.log('error:', err);\n    //node.send(msg);\n  }\n  else {\n     msg.payload = response; \n      node.send(msg);\n  }\n  \n  //node.send(msg);\n  clearTimeout(myTM);\n  //console.log(JSON.stringify(response, null, 2));\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":260,"wires":[["a267a3f7.2c802","be5277f6.0fbb9"]]},{"id":"6f0a2bfb.25eaa4","type":"debug","z":"72cea9e2.279df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":740,"wires":[]},{"id":"617e66b4.fac4","type":"function","z":"72cea9e2.279df","name":"Save WA-Token","func":"global.set(\"wa_access_token\", msg.payload.access_token);\nreturn msg;","outputs":1,"noerr":0,"x":560,"y":740,"wires":[["6f0a2bfb.25eaa4"]]},{"id":"ee910d27.1fa3a8","type":"http request","z":"72cea9e2.279df","name":"","method":"use","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":430,"y":680,"wires":[["617e66b4.fac4"]]},{"id":"5c3830fd.347558","type":"function","z":"72cea9e2.279df","name":"Get Token","func":"msg.headers={\"Content-Type\":\"application/x-www-form-urlencoded\",\n             \"Accept\" : \"application/json\"\n    \n};\nmsg.url = \"https://iam.bluemix.net/identity/token\";\nmsg.method = \"POST\";\nmsg.payload = {\n    \"grant_type\" : \"urn:ibm:params:oauth:grant-type:apikey\",\n     \"apikey\" : \"icp-PNAi36qLdWZA3MeiZP81z8AZggceGaiTLo2i9Jtd1Igg\"\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":290,"y":760,"wires":[["ee910d27.1fa3a8"]]},{"id":"e264cf21.bb5b8","type":"inject","z":"72cea9e2.279df","name":"","topic":"","payload":"","payloadType":"date","repeat":"3300","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":680,"wires":[["5c3830fd.347558"]]},{"id":"da3962f1.ab42f8","type":"debug","z":"72cea9e2.279df","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":700,"y":880,"wires":[]},{"id":"e2881130.5a841","type":"inject","z":"72cea9e2.279df","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":920,"wires":[["7649347a.601fdc"]]}]